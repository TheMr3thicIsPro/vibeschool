(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,32341,66745,e=>{"use strict";e.i(47167);var r=e.i(43476),t=e.i(71645),o=e.i(7471);let n=null,a=new BroadcastChannel("auth");function l(e,r){r&&console.error(e,{status:r.status,code:r.code,message:r.message,details:r.details,hint:r.hint})}async function s(e,r){if(!r?.id)throw Error("ensureProfile called without user");let{data:t,error:o}=await e.from("profiles").select("*").eq("id",r.id).maybeSingle();if(o)throw l("ensureProfile fetch error",o),o;if(t)return console.log("ensureProfile: Found existing profile for user:",r.id),t;console.log("ensureProfile: No existing profile found, creating for user:",r.id);let n=r.email??"",a=r.user_metadata?.username,s="string"==typeof a&&a.trim()||(n.includes("@")?n.split("@")[0]:"")||`user_${r.id.slice(0,8)}`,{data:i,error:u}=await e.from("profiles").upsert({id:r.id,email:n||null,username:s,role:"student",plan:"free",trial_started_at:new Date().toISOString(),trial_expires_at:new Date(Date.now()+6e4).toISOString(),account_locked:!1},{onConflict:"id"}).select("*").single();if(u)throw l("ensureProfile upsert error",u),u;return console.log("ensureProfile: Successfully created profile for user:",r.id),i}e.s(["ensureProfile",()=>s],66745);let i={user:null,session:null,authLoading:!0,profileLoading:!1,error:null,profile:null,authStatus:"checking",offlineRetryCount:0},u=(0,t.createContext)(null),c=(e,r)=>{switch(r.type){case"SET_USER":return{...e,user:r.payload};case"SET_SESSION":return{...e,session:r.payload};case"SET_AUTH_LOADING":return{...e,authLoading:r.payload};case"SET_PROFILE_LOADING":return{...e,profileLoading:r.payload};case"SET_ERROR":return{...e,error:r.payload};case"SET_PROFILE":return{...e,profile:r.payload};case"SET_AUTH_STATUS":return{...e,authStatus:r.payload};case"INCREMENT_OFFLINE_RETRY":return{...e,offlineRetryCount:e.offlineRetryCount+1};case"RESET_OFFLINE_RETRY":return{...e,offlineRetryCount:0};case"RESET":return{...i};default:return e}},d=()=>{let e=(0,t.useContext)(u);if(null===e)throw Error("useAuthStore must be used within an AuthProvider");return e};e.s(["AuthProvider",0,({children:l})=>{let[d,p]=(0,t.useReducer)(c,i),[S,E]=(0,t.useState)(!1),T=(0,t.useRef)(null),f=(0,t.useRef)(null),g=(0,t.useRef)(!1),y=(0,t.useRef)(null),h=(0,t.useRef)(0),_=(0,t.useRef)(null),A=(0,t.useRef)(!1);(0,t.useEffect)(()=>{E(!0)},[]),(0,t.useEffect)(()=>{if(!S)return;console.log("[AUTH] BUILD-DEBUG: Starting auth initialization - window available");let r=!0,t=async(n=!1)=>{if(A.current)return void console.log("[AUTH] init already in flight, skipping");if(r){A.current=!0,console.log("[AUTH] init start",{isRetry:n,retryCount:h.current,timestamp:new Date().toISOString()});try{var a;console.log("[AUTH] supabase url:","https://toorbxzuursbcykjujhh.supabase.co");let{testSupabaseReachability:n}=await e.A(60959),l=await n("https://toorbxzuursbcykjujhh.supabase.co",5e3);console.log("[AUTH] reachability result",l);let s=l.error&&(l.error.includes("AbortError")||l.error.includes("TypeError"));if(!l.ok&&l.error&&!l.error.includes("401")&&!l.error.includes("403")||s){if(p({type:"SET_AUTH_STATUS",payload:"offline"}),p({type:"SET_ERROR",payload:`Auth offline: ${l.error||"Cannot reach Supabase"}`}),p({type:"SET_AUTH_LOADING",payload:!1}),!s&&h.current<10){h.current+=1;let e=Math.min(1e3*Math.pow(2,h.current-1),1e4);console.log("[AUTH] offline retry scheduled",{attempt:h.current,delay:e,nextRetry:new Date(Date.now()+e).toISOString()}),_.current&&clearTimeout(_.current),_.current=setTimeout(()=>{r&&(A.current=!1,t(!0))},e)}else s?console.log("[AUTH] soft offline detected (likely CORS/blocked in IDE). Suppressing aggressive retries."):(console.log("[AUTH] max retry attempts reached, staying offline permanently"),p({type:"SET_ERROR",payload:"Auth permanently offline: Maximum retry attempts exceeded"}));A.current=!1;return}p({type:"SET_AUTH_STATUS",payload:"online"}),h.current=0,console.log("[AUTH] getSession start");let i=(0,o.getSupabaseClient)(),{data:{session:u},error:c}=await (a=i.auth.getSession(),Promise.race([a,new Promise((e,r)=>setTimeout(()=>r(Error("Timeout: getSession")),5e3))]));if(c){console.error("[AUTH] getSession error",{name:c.name,message:c.message,stack:c.stack?.split("\n")[0]}),p({type:"SET_ERROR",payload:`Auth error: ${c.message}`}),p({type:"SET_AUTH_LOADING",payload:!1});return}console.log("[AUTH] getSession success",{userId:u?.user?.id}),u?(p({type:"SET_USER",payload:u.user}),p({type:"SET_SESSION",payload:u}),console.log("[AUTH] kicking off profile load"),R(u.user)):console.log("[AUTH] no session found"),p({type:"SET_AUTH_LOADING",payload:!1})}catch(e){console.error("[AUTH] init failed",{name:e.name,message:e.message,stack:e.stack?.split("\n")[0]}),e.message.includes("Failed to fetch")||e.message.includes("ERR_NAME_NOT_RESOLVED")?(p({type:"SET_AUTH_STATUS",payload:"offline"}),p({type:"SET_ERROR",payload:"Network error: Cannot connect to authentication service. Check your internet connection and Supabase configuration."})):p({type:"SET_ERROR",payload:`Auth initialization failed: ${e.message}`}),p({type:"SET_AUTH_LOADING",payload:!1})}finally{A.current=!1}}};return t(),()=>{r=!1,_.current&&clearTimeout(_.current)}},[S]);let R=async e=>{if(e?.id){p({type:"SET_PROFILE_LOADING",payload:!0});try{console.log("loadProfile start for user:",e.id);let r=new Promise((e,r)=>{setTimeout(()=>r(Error("Timeout: ensureProfile")),1e4)}),t=(0,o.getSupabaseClient)(),n=await Promise.race([s(t,e),r]),a=n?.plan==="free"&&n?.trial_expires_at&&new Date(n.trial_expires_at)<new Date,l={...n,isTrialExpired:a,account_locked:n?.account_locked||a};p({type:"SET_PROFILE",payload:l});let i={...e,role:l?.role,plan:l?.plan,username:l?.username,isTrialExpired:l?.isTrialExpired,account_locked:l?.account_locked};p({type:"SET_USER",payload:i}),console.log("loadProfile end for user:",e.id)}catch(e){console.error("loadProfile error:",e),p({type:"SET_ERROR",payload:e.message})}finally{p({type:"SET_PROFILE_LOADING",payload:!1})}}};return(0,t.useEffect)(()=>{let e=!0;f.current=n?(console.log("Auth listener already initialized, returning existing instance"),n.unsubscribe):(console.log("Initializing auth listener"),a.onmessage=e=>{let r=e.data;console.log("Received auth message from other tab:",r),"SIGNED_OUT"===r.type?(console.log("Other tab signed out, resetting local state"),p({type:"RESET"}),window.dispatchEvent(new CustomEvent("authStateChangeFromOtherTab",{detail:{type:"SIGNED_OUT"}}))):"AUTH_STATE_CHANGED"===r.type&&(console.log("Other tab changed auth state, updating local state"),r.email&&window.dispatchEvent(new CustomEvent("authStateChangeFromOtherTab",{detail:{type:"AUTH_STATE_CHANGED",email:r.email}})))},(n={unsubscribe:()=>{console.log("Cleaning up auth listener"),a.close(),n=null}}).unsubscribe);let{data:{subscription:r}}=(0,o.getSupabaseClient)().auth.onAuthStateChange(async(r,t)=>{if(!e)return;console.log("[AUTH] listener event",{type:r,userId:t?.user?.id,timestamp:new Date().toISOString()});let o=t?.user?.id,n=Date.now();if(y.current&&y.current.type===r&&y.current.userId===o&&n-y.current.ts<500)return void console.log("AuthProvider: Duplicate event detected, skipping");if(g.current)return void console.log("AuthProvider: Auth event already being handled, skipping duplicate");g.current=!0,y.current={type:r,userId:o,ts:n};try{switch(r){case"INITIAL_SESSION":console.log("AuthProvider: Handling INITIAL_SESSION event"),t&&(p({type:"SET_USER",payload:t.user}),p({type:"SET_SESSION",payload:t}),console.log("AuthProvider: Kicking off profile load in background for INITIAL_SESSION"),R(t.user),p({type:"SET_AUTH_LOADING",payload:!1}));break;case"SIGNED_IN":console.log("AuthProvider: Handling SIGNED_IN event for user:",t?.user?.id),t?.user&&(p({type:"SET_USER",payload:t.user}),p({type:"SET_SESSION",payload:t}),console.log("AuthProvider: Kicking off profile load in background for SIGNED_IN"),R(t.user),p({type:"SET_AUTH_LOADING",payload:!1}));break;case"SIGNED_OUT":console.log("AuthProvider: Handling SIGNED_OUT event"),p({type:"RESET"}),p({type:"SET_AUTH_LOADING",payload:!1}),g.current=!1;break;case"TOKEN_REFRESHED":console.log("AuthProvider: Handling TOKEN_REFRESHED event"),t&&p({type:"SET_SESSION",payload:t});break;case"USER_UPDATED":console.log("AuthProvider: Handling USER_UPDATED event"),t?.user&&(p({type:"SET_USER",payload:t.user}),console.log("AuthProvider: Kicking off profile load in background for USER_UPDATED"),R(t.user));break;default:console.log("AuthProvider: Unhandled auth event:",r)}}catch(e){console.error("AuthProvider: Error in auth state change handler:",e),p({type:"SET_ERROR",payload:e.message})}finally{g.current=!1}});return T.current=r,()=>{e=!1,A.current=!1,_.current&&(clearTimeout(_.current),_.current=null,console.log("[AUTH] cleanup: cleared retry timer")),console.log("[AUTH] cleaning up auth subscription"),T.current&&(T.current.unsubscribe?.(),T.current=null),f.current&&(f.current(),f.current=null),h.current=0,console.log("[AUTH] cleanup: reset retry count")}},[]),(0,r.jsx)(u.Provider,{value:{state:d,dispatch:p},children:l})},"useAuthDispatch",0,()=>{let{dispatch:e}=d();return e},"useAuthState",0,()=>{let{state:e}=d();return e},"useAuthStore",0,d],32341)},60959,e=>{e.v(e=>Promise.resolve().then(()=>e(7471)))}]);