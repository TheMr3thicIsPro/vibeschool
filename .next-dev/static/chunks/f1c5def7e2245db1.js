(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,86099,e=>{"use strict";e.i(47167);var r=e.i(43476),s=e.i(71645),t=e.i(32341),a=e.i(7471);let n=async()=>{console.log("getOrCreateGlobalHelpConversation: Starting...");try{let{data:{session:e},error:r}=await a.supabase.auth.getSession();if(r)throw console.error("getOrCreateGlobalHelpConversation: Error getting session:",r),r;if(!e)throw console.error("getOrCreateGlobalHelpConversation: No session found"),Error("No session found");console.log("getOrCreateGlobalHelpConversation: Session token available, calling API...");let s=await fetch("/api/conversations/global-help",{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.access_token}`}});if(console.log("getOrCreateGlobalHelpConversation: API response status:",s.status),console.log("getOrCreateGlobalHelpConversation: API response ok:",s.ok),!s.ok){let e,r=await s.text();console.error("getOrCreateGlobalHelpConversation: API response error text:",r);try{e=JSON.parse(r)}catch{e={error:r}}throw Error(e.error||`Failed to get or create global help conversation. Status: ${s.status}`)}let{conversation:t,membershipCreated:n}=await s.json();return console.log("getOrCreateGlobalHelpConversation: Returning conversation:",t),console.log("getOrCreateGlobalHelpConversation: Membership created flag:",n),t}catch(e){throw console.error("getOrCreateGlobalHelpConversation: Error:",e),console.error("getOrCreateGlobalHelpConversation: Error details:",{message:e.message,stack:e.stack}),e}},i=async e=>{console.log("getUserConversations: Fetching conversations for user:",e);let{data:r,error:s}=await a.supabase.from("conversation_members").select("conversation_id").eq("user_id",e);if(s)throw console.error("getUserConversations: Error fetching member data:",s),s;if(!r||0===r.length)return[];let t=r.map(e=>e.conversation_id),{data:n,error:i}=await a.supabase.from("conversations").select("*").in("id",t);if(console.log("getUserConversations: Result",{data:n,error:i}),i)throw console.error("getUserConversations: Error fetching conversations:",i),i;return n},l=async(e,r)=>{console.log("getConversationMessages: Fetching messages for conversation:",e,"since:",r?.since);let s=a.supabase.from("messages").select(`
      id,
      content,
      created_at,
      sender_id,
      conversation_id,
      client_generated_id,
      profiles:sender_id (
        id,
        username,
        avatar_url
      )
    `).eq("conversation_id",e);r?.since&&(s=s.gt("created_at",r.since));let{data:t,error:n}=await s.order("created_at",{ascending:!0}).limit(r?.limit??50);if(console.log("getConversationMessages: Raw result",{data:t,error:n}),n)throw console.error("getConversationMessages: Error fetching messages:",n),n;let i=t?.map(e=>({id:e.id,content:e.content,created_at:e.created_at,sender_id:e.sender_id,conversation_id:e.conversation_id,client_generated_id:e.client_generated_id,username:e.profiles?.username??"Unknown User",avatar_url:e.profiles?.avatar_url??null}))??[];return console.log("getConversationMessages: Normalized messages",i),i},o=async(e,r,s,t)=>{console.log("sendMessage: Attempting to send message",{userId:e,conversationId:r,content:s,clientGeneratedId:t});let n={conversation_id:r,sender_id:e,content:s};t&&(n.client_generated_id=t);let{data:i,error:l}=await a.supabase.from("messages").insert(n).select("*").single();if(console.log("sendMessage: Result",{data:i,error:l}),l)throw console.error("sendMessage: Error sending message:",l),l;return i},c=async(e,r)=>{console.log("createDirectMessageConversation: Creating DM between users:",{userId:e,otherUserId:r});let{data:s,error:t}=await a.supabase.from("conversations").select(`
      id
    `).eq("type","dm");if(t)throw console.error("createDirectMessageConversation: Error fetching user DMs:",t),t;let n=null;for(let t of s){let{data:s,error:i}=await a.supabase.from("conversation_members").select("user_id").eq("conversation_id",t.id);if(!i&&s){let a=s.map(e=>e.user_id);if(a.includes(e)&&a.includes(r)&&2===a.length){n=t;break}}}if(console.log("createDirectMessageConversation: Check existing result:",{existingConversation:n}),n)return console.log("createDirectMessageConversation: Found existing conversation, returning:",n),n;let{data:i,error:l}=await a.supabase.from("conversations").insert([{type:"dm"}]).select().maybeSingle();if(console.log("createDirectMessageConversation: Created new conversation:",{conversation:i,convError:l}),l)throw console.error("createDirectMessageConversation: Error creating conversation:",l),l;let{error:o}=await a.supabase.from("conversation_members").insert([{conversation_id:i.id,user_id:e},{conversation_id:i.id,user_id:r}]);if(console.log("createDirectMessageConversation: Added members:",{membersError:o}),o)throw console.error("createDirectMessageConversation: Error adding members:",o),o;return console.log("createDirectMessageConversation: Successfully created DM conversation:",i),i},d=async e=>{console.log("getUserByUsername: Fetching user with username:",e);let{data:r,error:s}=await a.supabase.from("profiles").select("id, username, avatar_url").eq("username",e).maybeSingle();if(console.log("getUserByUsername: Result:",{data:r,error:s}),s)throw console.error("getUserByUsername: Error fetching user:",s),s;return r},u=async(e,r)=>{console.log("checkConversationMembership: Checking if user is member of conversation:",{conversationId:e,userId:r});let{data:s,error:t}=await a.supabase.from("conversation_members").select("user_id").eq("conversation_id",e).eq("user_id",r).maybeSingle();if(console.log("checkConversationMembership: Result:",{data:s,error:t}),t)throw console.error("checkConversationMembership: Error checking membership:",t),t;return!!s};var m=e.i(66745),g=e.i(94983),h=e.i(54089),h=h,p=e.i(61911),x=e.i(55436),f=e.i(75254);let b=(0,f.default)("plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]);var y=e.i(84614);let v=(0,f.default)("hash",[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]]);var j=e.i(27330),j=j,w=e.i(77386),w=w,N=e.i(69141),N=N;let _=(0,f.default)("user-search",[["circle",{cx:"10",cy:"7",r:"4",key:"e45bow"}],["path",{d:"M10.3 15H7a4 4 0 0 0-4 4v2",key:"3bnktk"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["path",{d:"m21 21-1.9-1.9",key:"1g2n9r"}]]);var C=e.i(86108),C=C;let S=(0,f.default)("file",[["path",{d:"M6 22a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h8a2.4 2.4 0 0 1 1.704.706l3.588 3.588A2.4 2.4 0 0 1 20 8v12a2 2 0 0 1-2 2z",key:"1oefj6"}],["path",{d:"M14 2v5a1 1 0 0 0 1 1h5",key:"wfsgrz"}]]);var k=e.i(26524),k=k,E=e.i(48010),M=e.i(10400);let U=({message:e,isVisible:s,onClose:t,onReload:a})=>s?(0,r.jsx)("div",{className:"fixed top-4 right-4 z-50",children:(0,r.jsxs)("div",{className:"bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-4 max-w-sm flex items-start",children:[(0,r.jsx)("div",{className:"flex-1",children:(0,r.jsx)("p",{className:"text-white text-sm",children:e})}),(0,r.jsxs)("div",{className:"ml-4 flex gap-2",children:[a&&(0,r.jsx)("button",{onClick:a,className:"px-3 py-1 bg-accent-primary text-white text-xs rounded hover:bg-accent-primary/90 transition-colors hover-lift",children:"Reload"}),(0,r.jsx)("button",{onClick:t,className:"px-3 py-1 bg-gray-700 text-white text-xs rounded hover:bg-gray-600 transition-colors hover-lift",children:"Close"})]})]})}):null;var R=e.i(83823);e.s(["default",0,()=>{let{state:e,dispatch:f}=(0,t.useAuthStore)(),{user:D}=e,[F,T]=(0,s.useState)([]),[q,P]=(0,s.useState)([]),[I,A]=(0,s.useState)([]),[O,z]=(0,s.useState)(null),[G,$]=(0,s.useState)(""),[H,L]=(0,s.useState)(!0),[B,W]=(0,s.useState)(!1),[K,Y]=(0,s.useState)(null),[V,J]=(0,s.useState)(null),[Q,X]=(0,s.useState)(!1),[Z,ee]=(0,s.useState)(""),[er,es]=(0,s.useState)("idle"),et=(0,s.useRef)(null),ea=(0,s.useRef)(null),en=(0,s.useRef)(null),ei=(0,s.useRef)(null),el=(0,s.useRef)(null),[eo,ec]=(0,s.useState)([]),[ed,eu]=(0,s.useState)([]),[em,eg]=(0,s.useState)({}),[eh,ep]=(0,s.useState)(null),[ex,ef]=(0,s.useState)(!1),[eb,ey]=(0,s.useState)("chat"),[ev,ej]=(0,s.useState)(""),[ew,eN]=(0,s.useState)([]),[e_,eC]=(0,s.useState)(!1),[eS,ek]=(0,s.useState)({}),eE=(0,s.useRef)(null),eM=(0,s.useRef)(!1);(0,s.useEffect)(()=>{!D||eM.current||(eM.current=!0,(async()=>{try{let{data:e,error:r}=await a.supabase.auth.getSession(),s=e?.session;if(!s?.access_token){console.warn("No session yet, skipping profile ensure for now"),eT();return}await (0,m.ensureProfile)(a.supabase,D),console.log("SocialPage: Profile ensured, now loading conversations"),eT()}catch(e){console.error("Failed to ensure profile",e),eT()}})())},[D,a.supabase]),(0,s.useEffect)(()=>{let e=O?.id??null;console.log("SocialPage useEffect: Active conversation changed:",e),e&&el.current!==e&&(el.current=e,eq())},[O?.id]),(0,s.useEffect)(()=>{eP()},[q]),(0,s.useEffect)(()=>{D&&eT()},[D?.id]),(0,s.useEffect)(()=>{let e=e=>{let{type:r,email:s}=e.detail;"AUTH_STATE_CHANGED"===r&&s?(ee(`Account switched to user: ${s}`),X(!0)):"SIGNED_OUT"===r&&(ee("Account signed out from another tab"),X(!0))};return window.addEventListener("authStateChangeFromOtherTab",e),()=>{window.removeEventListener("authStateChangeFromOtherTab",e)}},[]),(0,s.useEffect)(()=>()=>{en.current&&(en.current(),en.current=null),ei.current&&(clearInterval(ei.current),ei.current=null),eE.current&&(clearTimeout(eE.current),eE.current=null)},[]),(0,s.useEffect)(()=>{if(!eh||!O||!D)return;let e=()=>{eh&&O&&D&&(eh.setTypingStatus(O.id,D.id,!0),eE.current&&clearTimeout(eE.current),eE.current=setTimeout(()=>{eh.setTypingStatus(O.id,D.id,!1)},2e3))},r=document.querySelector('textarea[placeholder="Type your message here..."]');if(r)return r.addEventListener("input",e),()=>{r.removeEventListener("input",e),eE.current&&(clearTimeout(eE.current),eE.current=null),eh&&O&&D&&eh.setTypingStatus(O.id,D.id,!1)}},[eh,O,D]),(0,s.useEffect)(()=>{if(!eh||!O||!D)return;let e=async()=>{try{let e=await eh.getTypingUsers(O.id),r={};e.forEach(e=>{r[e]=!0}),ek(r)}catch(e){console.error("Error getting typing users:",e)}},r=setInterval(e,2e3);return e(),()=>{clearInterval(r)}},[eh,O,D]);let[eU,eR]=(0,s.useState)(!1);(0,s.useEffect)(()=>{D&&console.log("SocialPage: User changed, user ID:",D.id)},[D?.id]);let eD=(0,s.useCallback)((e,r)=>{let s=new Set(e.map(e=>e.id)),t=r.filter(e=>!s.has(e.id));return 0===t.length?e:[...e,...t].sort((e,r)=>new Date(e.created_at).getTime()-new Date(r.created_at).getTime())},[]),eF=(0,s.useCallback)(async e=>{try{let r=a.supabase.from("messages").select("id, conversation_id, sender_id, content, created_at, client_generated_id").eq("conversation_id",e).order("created_at",{ascending:!0});ea.current&&(r=r.gt("created_at",ea.current));let{data:s,error:t}=await r;if(t)return console.error("fetchLatestMessages: Error fetching messages:",t),[];return s&&s.length>0&&(ea.current=s[s.length-1].created_at),s||[]}catch(e){return console.error("fetchLatestMessages: Error in catch block:",e),[]}},[]);(0,s.useEffect)(()=>{if(!O?.id||!D){ei.current&&(clearInterval(ei.current),ei.current=null);return}return ei.current&&clearInterval(ei.current),ei.current=setInterval(async()=>{if(O?.id)try{let e=await eF(O.id);e.length>0&&P(r=>eD(r,e))}catch(e){console.error("Polling error:",e)}},3e3),()=>{ei.current&&(clearInterval(ei.current),ei.current=null)}},[O?.id,D?.id,eF,eD]),(0,s.useEffect)(()=>{var e,r;let s,t,n=O?.id;return(console.log("SocialPage useEffect: Active conversation changed:",n,"User ID:",D?.id),D&&n)?(en.current&&(console.log("SocialPage: Removing previous subscription for conversation:",n),en.current(),en.current=null),console.log("SocialPage: Setting up new subscription for conversation:",n),es("idle"),e=e=>{console.log("SocialPage: Received message via realtime:",e),P(r=>eD(r,[e]))},r=(e,r)=>{console.log("SocialPage: Channel status:",e,"Error:",r),"SUBSCRIBED"===e?(es("subscribed"),console.log("SocialPage: Realtime subscription ready")):"CHANNEL_ERROR"===e||"TIMED_OUT"===e?(es("error"),console.log("SocialPage: Realtime subscription error, status:",e)):"CLOSED"===e&&(es("closed"),console.log("SocialPage: Realtime subscription closed"))},s=!1,console.log("subscribeToMessages: Setting up subscription for conversation:",n),t=a.supabase.channel(`messages:${n}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${n}`},async r=>{console.log("subscribeToMessages: Received new message via realtime:",r);let s=r.new;try{let{data:r,error:t}=await a.supabase.from("profiles").select("username, avatar_url").eq("id",s.sender_id).single();t&&console.error("subscribeToMessages: Error fetching profile for sender:",t);let n={...s,username:r?.username??"Unknown User",avatar_url:r?.avatar_url??null};e(n)}catch(r){console.error("subscribeToMessages: Error processing profile data:",r),e({...s,username:"Unknown User",avatar_url:null})}}).subscribe((e,t)=>{console.log("subscribeToMessages: Subscription status:",e),"CLOSED"===e&&s||("CHANNEL_ERROR"===e||"TIMED_OUT"===e?r?.("CHANNEL_ERROR",t):"SUBSCRIBED"===e?r?.("SUBSCRIBED"):"CLOSED"===e&&r?.("CLOSED"))}),en.current=()=>{s=!0,console.log("subscribeToMessages: Removing subscription intentionally"),a.supabase.removeChannel(t)},()=>{console.log("SocialPage: Cleaning up subscription for conversation:",n),en.current&&(en.current(),en.current=null)}):void console.log("SocialPage: Missing user or conversation, returning")},[D?.id,O?.id,eD]);let eT=async()=>{try{let e;console.log("loadConversations: Starting to load conversations..."),L(!0),console.log("loadConversations: Fetching global help conversation");try{e=await n(),console.log("loadConversations: Got global help conversation:",e)}catch(r){console.error("loadConversations: Error getting global help conversation:",r),e=null}if(!D)return void console.log("loadConversations: No user found, returning");console.log("loadConversations: Fetching user conversations for user:",D.id);let r=await i(D.id);console.log("loadConversations: Got user conversations:",r);let s=[];e?(s=[e,...r],console.log("loadConversations: Setting conversations with global help:",s)):(s=r,console.log("loadConversations: Setting conversations without global help:",s)),T(s),e?(console.log("loadConversations: Setting active conversation to global help:",e),z(e)):s.length>0?(console.log("loadConversations: Setting active conversation to first available:",s[0]),z(s[0])):console.log("loadConversations: No conversations available");let t=await (0,R.getCommunityDB)();if(ep(t),t){let e=await t.getFriends(D.id);ec(e);let r=(await t.getFriendRequests(D.id)).filter(e=>"pending"===e.status);eu(r);let s={};for(let r of e){let e=r.friend_id,a=await t.getProfile(e);a&&(s[e]=a)}for(let e of r){let r=e.requester_id===D?.id?e.addressee_id:e.requester_id,a=await t.getProfile(r);a&&!s[r]&&(s[r]=a)}eg(s)}}catch(e){console.error("Failed to load conversations:",e)}finally{L(!1)}},eq=async()=>{if(!O?.id){console.log("loadMessages: No active conversation, returning"),P([]);return}console.log("loadMessages: Loading messages for conversation:",O.id);try{let e=await l(O.id);if(console.log("loadMessages: Got messages:",e.length,"messages"),P(e),e.length>0){let r=e[e.length-1];ea.current=r.created_at,console.log("loadMessages: Set lastCreatedAtRef to:",r.created_at)}console.log("loadMessages: Loading members for conversation:",O.id);let r=await a.supabase.from("conversation_members").select(`
          user_id,
          role,
          profiles:user_id (
            username,
            email,
            avatar_url
          )
        `).eq("conversation_id",O.id);r.error?console.error("loadMessages: Error loading members:",r.error):(console.log("loadMessages: Got members:",r.data.length,"members",r.data),A(r.data))}catch(e){console.error("loadMessages: Error loading messages:",e)}};(0,s.useEffect)(()=>{eq();let e=setInterval(()=>{eA()},3e4);return()=>{clearInterval(e)}},[O?.id]);let eP=()=>{et.current?.scrollIntoView({behavior:"smooth"})},eI=async()=>{if(!G.trim()&&!V||!O||!D)return void console.log("handleSendMessage: Message not sent, validation failed:",{hasMessage:!!G.trim(),hasAttachment:!!V,hasActiveConversation:!!O,hasUser:!!D});try{if(eh&&O&&D&&eh.setTypingStatus(O.id,D.id,!1),V){let e=new FormData;e.append("file",V),e.append("conversationId",O.id);let r=await fetch("/api/upload",{method:"POST",body:e});if(!r.ok)throw Error("Upload failed");let s=await r.json();eh&&await eh.createMessage({conversation_id:O.id,sender_id:D.id,body:G||`Shared a file: ${V.name}`,attachment_url:s.url,attachment_type:V.type}),J(null);let t=document.getElementById("attachment-input");t&&(t.value="")}else{let e=crypto.randomUUID();console.log("handleSendMessage: Attempting to send message:",{userId:D.id,conversationId:O.id,content:G});let r={id:"optimistic-"+e,conversation_id:O.id,sender_id:D.id,content:G,created_at:new Date().toISOString(),client_generated_id:e,pending:!0};P(e=>{console.log("handleSendMessage: Adding optimistic message to UI, previous count:",e.length);let s=[...e,r];return console.log("handleSendMessage: Optimistic message added, new count:",s.length),s}),$(""),W(!0);let s=await u(O.id,D.id);console.log("handleSendMessage: User membership check result:",s),s||(console.log("handleSendMessage: User not a member, ensuring membership via global help API"),await n());let t=await o(D.id,O.id,G,e);console.log("handleSendMessage: Message sent to Supabase, replacing optimistic message with server response:",t),P(r=>{console.log("handleSendMessage: Replacing optimistic message in UI, previous count:",r.length);let s=r.map(r=>r.client_generated_id===e?(console.log("handleSendMessage: Found optimistic message to replace with server response"),{...t,pending:!1}):r);return console.log("handleSendMessage: Optimistic message replaced, new count:",s.length),s})}}catch(e){console.error("Failed to send message:",e),Y("Message failed to send. Please try again."),setTimeout(()=>Y(null),3e3)}finally{W(!1)}},eA=async()=>{if(O?.id)try{console.log("refreshMembers: Refreshing member data for conversation:",O.id);let e=await a.supabase.from("conversation_members").select(`
          user_id,
          role,
          profiles:user_id (
            username,
            email,
            avatar_url
          )
        `).eq("conversation_id",O.id);e.error?console.error("refreshMembers: Error refreshing members:",e.error):(console.log("refreshMembers: Refreshed members:",e.data.length,"members"),A(e.data))}catch(e){console.error("refreshMembers: Unexpected error:",e)}};return((0,s.useEffect)(()=>{console.log("Setting up profile change listener");let e=new BroadcastChannel("profile_changes");return e.onmessage=e=>{console.log("handleProfileChange: Received message from broadcast channel:",e.data),"USERNAME_CHANGED"===e.data.type&&e.data.userId&&(console.log("handleProfileChange: Processing username change:",e.data),A(r=>{console.log("handleProfileChange: Updating members with new username",{userId:e.data.userId,newUsername:e.data.newUsername,oldMembers:r});let s=r.map(r=>r.user_id===e.data.userId?(console.log("handleProfileChange: Found matching member to update",{oldUsername:r.profiles?.username,newUsername:e.data.newUsername}),{...r,profiles:{...r.profiles,username:e.data.newUsername}}):r);return console.log("handleProfileChange: Updated members result",s),s}),P(r=>r.map(r=>r.sender_id===e.data.userId?(console.log("handleProfileChange: Updating message username",{oldUsername:r.username,newUsername:e.data.newUsername}),{...r,username:e.data.newUsername}):r)),console.log("handleProfileChange: Updated both members and messages"))},()=>{console.log("Cleaning up profile change listener"),e.close()}},[I]),(0,s.useEffect)(()=>{console.log("Setting up real-time profile updates subscription");let e=a.supabase.channel("profile-updates").on("postgres_changes",{event:"UPDATE",schema:"public",table:"profiles"},e=>{console.log("Real-time profile update received:",e),A(r=>r.map(r=>r.user_id===e.new.id?(console.log("Updating member profile with new data:",{oldUsername:r.profiles?.username,newUsername:e.new.username}),{...r,profiles:{...r.profiles,username:e.new.username,avatar_url:e.new.avatar_url}}):r)),P(r=>r.map(r=>r.sender_id===e.new.id?(console.log("Updating message username from real-time profile update",{oldUsername:r.username,newUsername:e.new.username}),{...r,username:e.new.username,avatar_url:e.new.avatar_url}):r))}).subscribe();return()=>{console.log("Cleaning up real-time profile updates subscription"),a.supabase.removeChannel(e)}},[]),H)?(0,r.jsx)(E.default,{children:(0,r.jsx)(M.default,{children:(0,r.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,r.jsx)("div",{className:"text-2xl font-bold text-accent-primary",children:"Loading chat..."})})})}):D?(0,r.jsx)(E.default,{children:(0,r.jsxs)(M.default,{children:[eU&&(0,r.jsx)("div",{className:"fixed top-16 left-0 right-0 z-50 bg-yellow-900 border-b border-yellow-700 p-2 text-center",children:(0,r.jsx)("p",{className:"text-yellow-200 text-sm",children:"Multiple accounts in same browser profile share one session. Use different profiles for isolation."})}),(0,r.jsxs)("div",{className:"flex h-full bg-background",children:[(0,r.jsxs)("div",{className:"w-80 bg-card-bg border-r border-card-border flex flex-col",children:[(0,r.jsx)("div",{className:"p-4 border-b border-card-border",children:(0,r.jsxs)("h2",{className:"text-lg font-bold text-white flex items-center gap-2",children:[(0,r.jsx)(g.MessageCircle,{className:"text-accent-primary",size:20}),"Conversations"]})}),(0,r.jsxs)("div",{className:"p-3",children:[(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)(x.Search,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500",size:16}),(0,r.jsx)("input",{type:"text",placeholder:"Search conversations...",className:"w-full pl-10 pr-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-accent-primary focus:border-transparent"})]}),(0,r.jsxs)("button",{className:"w-full mt-3 flex items-center justify-center gap-2 py-2 bg-accent-primary text-white rounded-lg hover:bg-accent-primary/90 transition-colors hover-lift border border-accent-primary",children:[(0,r.jsx)(b,{size:16}),"New Conversation"]})]}),(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto",children:[(0,r.jsxs)("div",{className:"p-2",children:[(0,r.jsx)("h3",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider px-2 py-1",children:"Channels"}),(0,r.jsxs)("div",{className:`p-3 rounded-lg cursor-pointer mb-1 flex items-center gap-3 ${O?.name==="Global Help"?"bg-accent-primary/10 border border-accent-primary":"hover:bg-gray-800"}`,onClick:()=>{z(F.find(e=>"Global Help"===e.name))},children:[(0,r.jsx)(v,{className:"text-accent-primary",size:18}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"font-medium text-white",children:"Global Help"}),(0,r.jsx)("p",{className:"text-xs text-gray-500",children:"General help channel"})]})]})]}),(0,r.jsxs)("div",{className:"p-2 border-t border-gray-800",children:[(0,r.jsx)("h3",{className:"text-xs font-semibold text-gray-500 uppercase tracking-wider px-2 py-1",children:"Direct Messages"}),(0,r.jsxs)("div",{className:"space-y-1",children:[F.filter(e=>"dm"===e.type).map(e=>(0,r.jsxs)("div",{className:`p-3 rounded-lg cursor-pointer mb-1 flex items-center gap-3 ${O?.id===e.id?"bg-accent-primary/10 border border-accent-primary":"hover:bg-gray-800"}`,onClick:()=>z(e),children:[(0,r.jsx)(y.User,{className:"text-gray-400",size:18}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"font-medium text-white",children:"DM"}),(0,r.jsx)("p",{className:"text-xs text-gray-500",children:"Direct message"})]})]},e.id)),(0,r.jsxs)("button",{className:"w-full p-3 rounded-lg cursor-pointer flex items-center gap-3 hover:bg-gray-800 hover-lift",onClick:async()=>{let e=prompt("Enter username to start a DM with:");if(e&&D)try{let r=await d(e);if(r&&r.id!==D.id){let e=await c(D.id,r.id);T(r=>[...r,e]),z(e)}else alert("User not found or cannot message yourself")}catch(e){console.error("Failed to create DM:",e),alert("Failed to create DM: "+e.message)}},children:[(0,r.jsx)(b,{className:"text-gray-400",size:18}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"font-medium text-white",children:"New DM"}),(0,r.jsx)("p",{className:"text-xs text-gray-500",children:"Start a new conversation"})]})]})]})]})]})]}),(0,r.jsxs)("div",{className:"flex-1 flex",children:[ex&&(0,r.jsxs)("div",{className:"w-80 bg-card-bg border-r border-card-border flex flex-col",children:[(0,r.jsxs)("div",{className:"p-4 border-b border-card-border flex justify-between items-center",children:[(0,r.jsxs)("h2",{className:"text-lg font-bold text-white flex items-center gap-2",children:[(0,r.jsx)(p.Users,{className:"text-accent-primary",size:20}),"Community"]}),(0,r.jsx)("button",{onClick:()=>ef(!1),className:"text-gray-400 hover:text-white",children:(0,r.jsx)(N.default,{size:20})})]}),(0,r.jsx)("div",{className:"flex-1 overflow-y-auto p-4",children:(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex justify-between items-center mb-3",children:[(0,r.jsxs)("h3",{className:"text-md font-semibold text-white flex items-center gap-2",children:[(0,r.jsx)(w.default,{className:"text-accent-primary",size:16}),"Friends (",eo.length,")"]}),(0,r.jsx)("button",{onClick:async()=>{if(eh&&D)try{let e=await eh.createConversation(!0,D.id,"My Group Chat",[]);T(r=>[...r,e]),z(e),ef(!1)}catch(e){console.error("Failed to create group chat:",e)}},className:"text-xs bg-accent-primary/20 hover:bg-accent-primary/30 text-accent-primary px-2 py-1 rounded",children:"Create Group"})]}),(0,r.jsx)("div",{className:"space-y-2",children:eo.length>0?eo.map(e=>{let s=e.friend_id,t=em[s],a=t?.username||`User ${s.substring(0,8)}`,n=t?.avatar_url||a.charAt(0).toUpperCase();return(0,r.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800",children:[(0,r.jsx)("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-accent-primary to-purple-600 flex items-center justify-center text-white text-xs font-bold",children:"string"==typeof n&&n.startsWith("http")?(0,r.jsx)("img",{src:n,alt:a,className:"w-full h-full rounded-full object-cover"}):(0,r.jsx)("span",{children:n})}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"font-medium text-white text-sm",children:a}),(0,r.jsx)("p",{className:"text-xs text-gray-500",children:t?.display_name||"Online"})]}),(0,r.jsx)("button",{onClick:async()=>{if(eh&&D)try{let e=await c(D.id,s);T(r=>[...r,e]),z(e),ef(!1)}catch(e){console.error("Failed to create DM:",e)}},className:"p-1 rounded hover:bg-gray-700",children:(0,r.jsx)(g.MessageCircle,{size:16})})]},s)}):(0,r.jsx)("p",{className:"text-gray-500 text-sm py-2",children:"No friends yet"})})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("h3",{className:"text-md font-semibold text-white mb-3 flex items-center gap-2",children:[(0,r.jsx)(j.default,{className:"text-accent-primary",size:16}),"Requests (",ed.length,")"]}),(0,r.jsx)("div",{className:"space-y-2",children:ed.length>0?ed.map(e=>{let s=e.requester_id===D?.id,t=s?e.addressee_id:e.requester_id,a=em[t],n=a?.username||`User ${t.substring(0,8)}`,i=a?.avatar_url||n.charAt(0).toUpperCase();return(0,r.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-lg bg-gray-800",children:[(0,r.jsx)("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-accent-primary to-purple-600 flex items-center justify-center text-white text-xs font-bold",children:"string"==typeof i&&i.startsWith("http")?(0,r.jsx)("img",{src:i,alt:n,className:"w-full h-full rounded-full object-cover"}):(0,r.jsx)("span",{children:i})}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"font-medium text-white text-sm",children:n}),(0,r.jsx)("p",{className:"text-xs text-gray-500",children:s?"Sent":"Received"})]}),!s&&(0,r.jsxs)("div",{className:"flex gap-1",children:[(0,r.jsx)("button",{onClick:async()=>{if(eh){await eh.updateFriendRequest(e.id,"accepted"),eu((await eh.getFriendRequests(D.id)).filter(e=>"pending"===e.status));let r={user_id:D.id,friend_id:t,created_at:new Date().toISOString()};ec(e=>[...e,r]),a&&eg(e=>({...e,[t]:a}))}},className:"p-1 rounded bg-green-600 hover:bg-green-500",children:(0,r.jsx)(w.default,{size:14})}),(0,r.jsx)("button",{onClick:async()=>{eh&&(await eh.updateFriendRequest(e.id,"declined"),eu((await eh.getFriendRequests(D.id)).filter(e=>"pending"===e.status)))},className:"p-1 rounded bg-red-600 hover:bg-red-500",children:(0,r.jsx)(N.default,{size:14})})]})]},e.id)}):(0,r.jsx)("p",{className:"text-gray-500 text-sm py-2",children:"No pending requests"})})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("h3",{className:"text-md font-semibold text-white mb-3 flex items-center gap-2",children:[(0,r.jsx)(_,{className:"text-accent-primary",size:16}),"Add Friend"]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("input",{type:"text",placeholder:"Username",value:ev,onChange:e=>ej(e.target.value),className:"flex-1 bg-gray-800 text-white rounded px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-accent-primary",onKeyPress:async e=>{if("Enter"===e.key&&eh&&ev.trim()){eC(!0);try{let e=await eh.searchProfiles(ev.trim());eN(e)}catch(e){console.error("Error searching profiles:",e)}finally{eC(!1)}}}}),(0,r.jsx)("button",{className:"px-3 py-2 bg-accent-primary text-white rounded text-sm hover:bg-accent-primary/90 border border-accent-primary",onClick:async()=>{if(eh&&ev.trim()){eC(!0);try{let e=await eh.searchProfiles(ev.trim());eN(e)}catch(e){console.error("Error searching profiles:",e)}finally{eC(!1)}}},children:e_?"Searching...":"Search"})]}),ew.length>0&&(0,r.jsx)("div",{className:"mt-3 space-y-2 max-h-40 overflow-y-auto",children:ew.map(e=>{let s=eo.some(r=>r.friend_id===e.id),t=e.id===D?.id,a=ed.some(r=>r.requester_id===D?.id&&r.addressee_id===e.id);return(0,r.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-lg bg-gray-800",children:[(0,r.jsx)("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-accent-primary to-purple-600 flex items-center justify-center text-white text-xs font-bold",children:"string"==typeof e.avatar_url&&e.avatar_url.startsWith("http")?(0,r.jsx)("img",{src:e.avatar_url,alt:e.username,className:"w-full h-full rounded-full object-cover"}):(0,r.jsx)("span",{children:e.username.charAt(0).toUpperCase()})}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"font-medium text-white text-sm",children:e.username}),(0,r.jsx)("p",{className:"text-xs text-gray-500",children:e.display_name})]}),!s&&!t&&!a&&(0,r.jsx)("button",{onClick:async()=>{if(eh&&D)try{await eh.createFriendRequest(D.id,e.id),ee("Friend request sent!"),X(!0),setTimeout(()=>X(!1),3e3)}catch(e){console.error("Error sending friend request:",e),ee("Failed to send friend request"),X(!0),setTimeout(()=>X(!1),3e3)}},className:"p-1 rounded bg-accent-primary hover:bg-accent-primary/90 mr-1",children:(0,r.jsx)(j.default,{size:14})}),(s||t)&&(0,r.jsx)("span",{className:"text-xs text-gray-500",children:t?"You":"Friend"}),a&&(0,r.jsx)("span",{className:"text-xs text-yellow-500",children:"Sent"}),s&&(0,r.jsx)("button",{onClick:async()=>{if(eh&&D)try{let r=await c(D.id,e.id);T(e=>[...e,r]),z(r),ef(!1)}catch(e){console.error("Failed to create DM:",e)}},className:"p-1 rounded hover:bg-gray-700",children:(0,r.jsx)(g.MessageCircle,{size:14})})]},e.id)})})]})]})})]}),(0,r.jsxs)("div",{className:"flex-1 flex flex-col",children:[(0,r.jsxs)("div",{className:"h-16 bg-card-bg border-b border-card-border flex items-center px-6",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("button",{onClick:()=>ef(!ex),className:"mr-2 p-2 rounded hover:bg-gray-800",title:"Community",children:(0,r.jsx)(p.Users,{size:20})}),(0,r.jsxs)("div",{className:"flex space-x-1",children:[(0,r.jsx)("button",{className:`px-3 py-1 rounded-md text-sm ${"chat"===eb?"bg-accent-primary text-white border border-accent-primary":"text-gray-400 hover:text-white"}`,onClick:()=>ey("chat"),children:"Chat"}),(0,r.jsx)("button",{className:`px-3 py-1 rounded-md text-sm ${"discover"===eb?"bg-accent-primary text-white border border-accent-primary":"text-gray-400 hover:text-white"}`,onClick:()=>ey("discover"),children:"Discover"}),(0,r.jsx)("button",{className:`px-3 py-1 rounded-md text-sm ${"friends"===eb?"bg-accent-primary text-white border border-accent-primary":"text-gray-400 hover:text-white"}`,onClick:()=>ey("friends"),children:"Friends"}),(0,r.jsx)("button",{className:`px-3 py-1 rounded-md text-sm ${"requests"===eb?"bg-accent-primary text-white border border-accent-primary":"text-gray-400 hover:text-white"}`,onClick:()=>ey("requests"),children:"Requests"})]})]}),(0,r.jsxs)("div",{className:"ml-auto flex items-center gap-2",children:[(0,r.jsx)("div",{className:`w-2 h-2 rounded-full ${"subscribed"===er?"bg-green-500":"error"===er||"closed"===er?"bg-red-500":"bg-yellow-500"}`}),(0,r.jsx)("span",{className:"text-xs text-gray-400",children:"subscribed"===er?"Connected":"error"===er||"closed"===er?"Reconnecting...":"Connecting..."})]})]}),(0,r.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:["chat"===eb&&(0,r.jsxs)(r.Fragment,{children:[q.map((e,s)=>{let t=e.sender_id===D?.id,a=I.find(r=>r.user_id===e.sender_id)?.profiles,n=t?"You":e.username||a?.username||a?.email?.split("@")[0]||"Unknown User",i=e.avatar_url||a?.avatar_url||e.username?.charAt(0).toUpperCase()||a?.username?.charAt(0).toUpperCase()||"M";return console.log("SocialPage: Rendering message",s,"ID:",e.id,"Content:",e.content,"Sender:",e.sender_id,"IsMe:",t),(0,r.jsxs)("div",{className:"flex gap-3",children:[(0,r.jsx)("div",{className:"w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center flex-shrink-0",children:"string"==typeof i&&i.startsWith("http")?(0,r.jsx)("img",{src:i,alt:n,className:"w-full h-full rounded-full object-cover"}):(0,r.jsx)("span",{className:"text-accent-primary font-bold",children:i})}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("div",{className:"flex items-baseline gap-2",children:[(0,r.jsx)("span",{className:"font-medium text-white",children:n}),(0,r.jsx)("span",{className:"text-xs text-gray-500",children:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}),e.read_at&&(0,r.jsx)("span",{className:"text-xs text-blue-400",children:"✓✓"})]}),(0,r.jsx)("div",{className:`mt-1 text-gray-300 bg-gray-800 p-3 rounded-lg max-w-3xl ${e.pending?"opacity-60 italic":""}`,children:e.is_attachment_upload?(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-accent-primary"}),(0,r.jsx)("span",{children:e.content})]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{children:e.content}),e.attachment_url&&(0,r.jsx)("div",{className:"mt-2",children:e.attachment_type?.startsWith("image/")?(0,r.jsx)("img",{src:e.attachment_url,alt:"Attachment",className:"max-w-xs max-h-48 rounded-lg border border-gray-700",onError:e=>{let r=e.target;r.onerror=null,r.style.display="none",r.previousElementSibling?.classList.add("text-red-500")}}):(0,r.jsxs)("a",{href:e.attachment_url,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center gap-2 text-blue-400 hover:text-blue-300",children:[(0,r.jsx)(S,{size:16}),"Download File"]})}),e.pending&&(0,r.jsx)("span",{className:"ml-2 text-xs text-gray-400",children:"Sending..."})]})})]})]},e.id)}),(0,r.jsx)("div",{ref:et}),Object.entries(eS).length>0&&(0,r.jsxs)("div",{className:"px-4 py-2 text-sm text-gray-400 flex items-center",children:[(0,r.jsx)("div",{className:"flex space-x-1",children:[void 0,void 0,void 0].map((e,s)=>(0,r.jsx)("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-bounce",style:{animationDelay:`${.1*s}s`}},s))}),(0,r.jsx)("span",{className:"ml-2",children:1===Object.keys(eS).length?"Someone is typing...":`${Object.keys(eS).length} people are typing...`})]})]}),"discover"===eb&&(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:(0,r.jsx)(x.Search,{className:"h-5 w-5 text-gray-400"})}),(0,r.jsx)("input",{type:"text",placeholder:"Search users by username or display name...",value:ev,onChange:e=>ej(e.target.value),className:"block w-full pl-10 pr-3 py-2 border border-gray-700 rounded-lg bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-accent-primary focus:border-transparent",onKeyPress:async e=>{if("Enter"===e.key&&eh&&ev.trim()){eC(!0);try{let e=await eh.searchProfiles(ev.trim());eN(e)}catch(e){console.error("Error searching profiles:",e)}finally{eC(!1)}}}})]}),(0,r.jsx)("button",{className:"px-4 py-2 bg-accent-primary text-white rounded-lg hover:bg-accent-primary/90 border border-accent-primary",onClick:async()=>{if(eh&&ev.trim()){eC(!0);try{let e=await eh.searchProfiles(ev.trim());eN(e)}catch(e){console.error("Error searching profiles:",e)}finally{eC(!1)}}},children:e_?"Searching...":"Search Users"}),(0,r.jsx)("div",{className:"space-y-3",children:ew.length>0?ew.map(e=>{let s=eo.some(r=>r.friend_id===e.id),t=e.id===D?.id,a=ed.some(r=>r.requester_id===D?.id&&r.addressee_id===e.id);return(0,r.jsxs)("div",{className:"flex items-center gap-3 p-3 rounded-lg bg-gray-800",children:[(0,r.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-accent-primary to-purple-600 flex items-center justify-center text-white font-bold",children:"string"==typeof e.avatar_url&&e.avatar_url.startsWith("http")?(0,r.jsx)("img",{src:e.avatar_url,alt:e.username,className:"w-full h-full rounded-full object-cover"}):(0,r.jsx)("span",{children:e.username.charAt(0).toUpperCase()})}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("p",{className:"font-medium text-white truncate",children:e.username}),(0,r.jsx)("p",{className:"text-xs text-gray-400 truncate",children:e.display_name})]}),!s&&!t&&!a&&(0,r.jsx)("button",{onClick:async()=>{if(eh&&D)try{await eh.createFriendRequest(D.id,e.id),ee("Friend request sent!"),X(!0),setTimeout(()=>X(!1),3e3)}catch(e){console.error("Error sending friend request:",e),ee("Failed to send friend request"),X(!0),setTimeout(()=>X(!1),3e3)}},className:"px-3 py-1 bg-accent-primary text-white rounded text-sm hover:bg-accent-primary/90 border border-accent-primary",children:"Add Friend"}),s&&(0,r.jsx)("button",{onClick:async()=>{if(eh&&D)try{let r=await c(D.id,e.id);T(e=>[...e,r]),z(r)}catch(e){console.error("Failed to create DM:",e)}},className:"px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-500",children:"Message"}),t&&(0,r.jsx)("span",{className:"px-3 py-1 bg-gray-600 text-gray-300 rounded text-sm",children:"You"}),a&&(0,r.jsx)("span",{className:"px-3 py-1 bg-yellow-600 text-yellow-100 rounded text-sm",children:"Pending"})]},e.id)}):(0,r.jsx)("div",{className:"text-center py-8 text-gray-500",children:(0,r.jsx)("p",{children:"Search for users to connect with them"})})})]}),"friends"===eb&&(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("h2",{className:"text-xl font-semibold",children:["Friends (",eo.length,")"]}),(0,r.jsx)("button",{onClick:async()=>{if(eh&&D)try{let e=await eh.createConversation(!0,D.id,"My Group Chat",[]);T(r=>[...r,e]),z(e)}catch(e){console.error("Failed to create group chat:",e)}},className:"px-4 py-2 bg-accent-primary text-white rounded-lg hover:bg-accent-primary/90 text-sm border border-accent-primary",children:"Create Group"})]}),(0,r.jsx)("div",{className:"space-y-3",children:eo.length>0?eo.map(e=>{let s=e.friend_id,t=em[s],a=t?.username||`User ${s.substring(0,8)}`,n=t?.avatar_url||a.charAt(0).toUpperCase();return(0,r.jsxs)("div",{className:"flex items-center gap-3 p-3 rounded-lg bg-gray-800",children:[(0,r.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-accent-primary to-purple-600 flex items-center justify-center text-white font-bold",children:"string"==typeof n&&n.startsWith("http")?(0,r.jsx)("img",{src:n,alt:a,className:"w-full h-full rounded-full object-cover"}):(0,r.jsx)("span",{children:n})}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("p",{className:"font-medium text-white truncate",children:a}),(0,r.jsx)("p",{className:"text-xs text-gray-400 truncate",children:t?.display_name||"Online"})]}),(0,r.jsx)("button",{onClick:async()=>{if(eh&&D)try{let e=await c(D.id,s);T(r=>[...r,e]),z(e)}catch(e){console.error("Failed to create DM:",e)}},className:"px-3 py-1 bg-accent-primary text-white rounded text-sm hover:bg-accent-primary/90 border border-accent-primary",children:"Message"})]},s)}):(0,r.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,r.jsx)(p.Users,{className:"w-12 h-12 mx-auto text-gray-600 mb-4"}),(0,r.jsx)("p",{children:"You don't have any friends yet"}),(0,r.jsx)("p",{className:"text-sm mt-2",children:"Search for users to add friends"})]})})]}),"requests"===eb&&(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)("div",{className:"flex items-center justify-between",children:(0,r.jsx)("h2",{className:"text-xl font-semibold",children:"Friend Requests"})}),(0,r.jsx)("div",{className:"space-y-3",children:ed.length>0?ed.map(e=>{let s=e.requester_id===D?.id,t=s?e.addressee_id:e.requester_id,a=em[t],n=a?.username||`User ${t.substring(0,8)}`,i=a?.avatar_url||n.charAt(0).toUpperCase();return(0,r.jsxs)("div",{className:"flex items-center gap-3 p-3 rounded-lg bg-gray-800",children:[(0,r.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-accent-primary to-purple-600 flex items-center justify-center text-white font-bold",children:"string"==typeof i&&i.startsWith("http")?(0,r.jsx)("img",{src:i,alt:n,className:"w-full h-full rounded-full object-cover"}):(0,r.jsx)("span",{children:i})}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("p",{className:"font-medium text-white truncate",children:n}),(0,r.jsx)("p",{className:"text-xs text-gray-400 truncate",children:s?"Sent":"Received"})]}),s?(0,r.jsx)("span",{className:"px-3 py-1 bg-yellow-600 text-yellow-100 rounded text-sm",children:"Pending"}):(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{onClick:async()=>{if(eh){await eh.updateFriendRequest(e.id,"accepted"),eu((await eh.getFriendRequests(D.id)).filter(e=>"pending"===e.status));let r={user_id:D.id,friend_id:t,created_at:new Date().toISOString()};ec(e=>[...e,r]),a&&eg(e=>({...e,[t]:a}))}},className:"px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-500",children:"Accept"}),(0,r.jsx)("button",{onClick:async()=>{eh&&(await eh.updateFriendRequest(e.id,"declined"),eu((await eh.getFriendRequests(D.id)).filter(e=>"pending"===e.status)))},className:"px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-500",children:"Decline"})]})]},e.id)}):(0,r.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,r.jsx)(j.default,{className:"w-12 h-12 mx-auto text-gray-600 mb-4"}),(0,r.jsx)("p",{children:"No pending friend requests"}),(0,r.jsx)("p",{className:"text-sm mt-2",children:"Friend requests will appear here"})]})})]})]}),"chat"===eb&&(0,r.jsxs)("div",{className:"p-4 border-t border-card-border",children:[K&&(0,r.jsx)("div",{className:"mb-2 p-2 bg-red-900/50 border border-red-700 rounded text-red-200 text-sm",children:K}),(0,r.jsxs)("div",{className:"flex gap-3",children:[(0,r.jsx)("div",{className:"flex-1 relative",children:(0,r.jsx)("textarea",{value:G,onChange:e=>{$(e.target.value),eh&&O&&D&&""!==e.target.value.trim()&&(eh.setTypingStatus(O.id,D.id,!0),eE.current&&clearTimeout(eE.current),eE.current=setTimeout(()=>{eh.setTypingStatus(O.id,D.id,!1)},2e3))},onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),eI())},placeholder:"Type your message here...",className:"w-full min-h-12 max-h-32 p-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-accent-primary focus:border-transparent resize-none",rows:1})}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsxs)("button",{type:"button",className:"self-end p-2 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600",onClick:()=>{document.getElementById("attachment-input")?.click()},children:[(0,r.jsx)(k.default,{size:18}),(0,r.jsx)("input",{id:"attachment-input",type:"file",className:"hidden",onChange:e=>{let r=e.target.files?.[0];if(r&&(J(r),r&&O&&D)){let e={id:"temp-"+Date.now(),conversation_id:O.id,sender_id:D.id,content:`Uploading: ${r.name}`,created_at:new Date().toISOString(),is_attachment_upload:!0};P(r=>[...r,e])}}})]}),(0,r.jsx)("button",{onClick:eI,disabled:B||!G.trim()&&!V,className:`self-end px-4 py-2 rounded-lg flex items-center gap-2 hover-lift ${B||!G.trim()&&!V?"bg-gray-700 text-gray-500 cursor-not-allowed":"bg-accent-primary text-white hover:bg-accent-primary/90"}`,children:(0,r.jsx)(h.default,{size:18})})]})]}),(0,r.jsx)("p",{className:"text-xs text-gray-500 mt-2",children:"Press Enter to send, Shift+Enter for new line"})]})]}),(0,r.jsxs)("div",{className:"w-80 bg-card-bg border-l border-card-border flex flex-col",children:[(0,r.jsx)("div",{className:"p-4 border-b border-card-border",children:(0,r.jsxs)("h2",{className:"text-lg font-bold text-white flex items-center gap-2",children:[(0,r.jsx)(p.Users,{className:"text-accent-primary",size:20}),"Members (",I.length,")"]})}),(0,r.jsx)("div",{className:"flex-1 overflow-y-auto p-4",children:(0,r.jsx)("div",{className:"space-y-3",children:I.map(e=>{let s=e.user_id===D?.id,t=s?`${e.profiles?.username} (You)`:e.profiles?.username,a=e.profiles?.avatar_url||e.profiles?.username?.charAt(0).toUpperCase()||"M";return(0,r.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-lg hover:bg-gray-800",children:[(0,r.jsx)("div",{className:"w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center flex-shrink-0",children:"string"==typeof a&&a.startsWith("http")?(0,r.jsx)("img",{src:a,alt:t,className:"w-full h-full rounded-full object-cover"}):(0,r.jsx)("span",{className:"text-accent-primary font-bold",children:a})}),(0,r.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,r.jsx)("p",{className:"font-medium text-white truncate",children:t}),(0,r.jsx)("p",{className:"text-xs text-gray-500 truncate",children:e.profiles?.email})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-700 text-gray-300",children:e.role}),!s&&(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("button",{className:"p-1 rounded hover:bg-gray-700",onClick:()=>{let r=document.getElementById(`dropdown-${e.user_id}`);r&&r.classList.toggle("hidden")},children:(0,r.jsx)(C.default,{size:14})}),(0,r.jsx)("div",{id:`dropdown-${e.user_id}`,className:"hidden absolute right-0 mt-1 w-40 bg-gray-800 border border-gray-700 rounded-lg shadow-lg z-10",children:(0,r.jsxs)("div",{className:"py-1",children:[(0,r.jsx)("button",{className:"block w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-red-900/50 hover:text-red-400",onClick:async()=>{if(eh&&D)try{await eh.blockUser(D.id,e.user_id),ee("User blocked successfully"),X(!0),setTimeout(()=>X(!1),3e3)}catch(e){console.error("Error blocking user:",e),ee("Failed to block user"),X(!0),setTimeout(()=>X(!1),3e3)}},children:"Block User"}),(0,r.jsx)("button",{className:"block w-full text-left px-4 py-2 text-sm text-orange-500 hover:bg-orange-900/50 hover:text-orange-400",onClick:async()=>{let r=prompt("Enter reason for reporting this user:");if(r&&eh&&D)try{await eh.reportUser(D.id,e.user_id,r),ee("User reported successfully"),X(!0),setTimeout(()=>X(!1),3e3)}catch(e){console.error("Error reporting user:",e),ee("Failed to report user"),X(!0),setTimeout(()=>X(!1),3e3)}},children:"Report User"})]})})]})]})]},e.user_id)})})})]})]})]}),(0,r.jsx)(U,{message:Z,isVisible:Q,onClose:()=>X(!1),onReload:()=>{window.location.reload()}})]})}):(0,r.jsx)(E.default,{children:(0,r.jsx)("div",{children:"Redirecting..."})})}],86099)}]);