module.exports=[18622,(a,b,c)=>{b.exports=a.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},42602,(a,b,c)=>{"use strict";b.exports=a.r(18622)},87924,(a,b,c)=>{"use strict";b.exports=a.r(42602).vendored["react-ssr"].ReactJsxRuntime},72131,(a,b,c)=>{"use strict";b.exports=a.r(42602).vendored["react-ssr"].React},56025,2159,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(10849);let e=null,f=new BroadcastChannel("auth");function g(a,b){b&&console.error(a,{status:b.status,code:b.code,message:b.message,details:b.details,hint:b.hint})}async function h(a,b){if(!b?.id)throw Error("ensureProfile called without user");let{data:c,error:d}=await a.from("profiles").select("*").eq("id",b.id).maybeSingle();if(d)throw g("ensureProfile fetch error",d),d;if(c)return console.log("ensureProfile: Found existing profile for user:",b.id),c;console.log("ensureProfile: No existing profile found, creating for user:",b.id);let e=b.email??"",f=b.user_metadata?.username,h="string"==typeof f&&f.trim()||(e.includes("@")?e.split("@")[0]:"")||`user_${b.id.slice(0,8)}`,{data:i,error:j}=await a.from("profiles").upsert({id:b.id,email:e||null,username:h,role:"student",plan:"free",trial_started_at:new Date().toISOString(),trial_expires_at:new Date(Date.now()+6e4).toISOString(),account_locked:!1},{onConflict:"id"}).select("*").single();if(j)throw g("ensureProfile upsert error",j),j;return console.log("ensureProfile: Successfully created profile for user:",b.id),i}a.s(["ensureProfile",()=>h],2159);let i={user:null,session:null,authLoading:!0,profileLoading:!1,error:null,profile:null,authStatus:"checking",offlineRetryCount:0},j=(0,c.createContext)(null),k=(a,b)=>{switch(b.type){case"SET_USER":return{...a,user:b.payload};case"SET_SESSION":return{...a,session:b.payload};case"SET_AUTH_LOADING":return{...a,authLoading:b.payload};case"SET_PROFILE_LOADING":return{...a,profileLoading:b.payload};case"SET_ERROR":return{...a,error:b.payload};case"SET_PROFILE":return{...a,profile:b.payload};case"SET_AUTH_STATUS":return{...a,authStatus:b.payload};case"INCREMENT_OFFLINE_RETRY":return{...a,offlineRetryCount:a.offlineRetryCount+1};case"RESET_OFFLINE_RETRY":return{...a,offlineRetryCount:0};case"RESET":return{...i};default:return a}},l=()=>{let a=(0,c.useContext)(j);if(null===a)throw Error("useAuthStore must be used within an AuthProvider");return a};a.s(["AuthProvider",0,({children:a})=>{let[g,l]=(0,c.useReducer)(k,i),[m,n]=(0,c.useState)(!1),o=(0,c.useRef)(null),p=(0,c.useRef)(null),q=(0,c.useRef)(!1),r=(0,c.useRef)(null),s=(0,c.useRef)(0),t=(0,c.useRef)(null),u=(0,c.useRef)(!1);(0,c.useEffect)(()=>{n(!0)},[]),(0,c.useEffect)(()=>{console.log("[AUTH] BUILD-DEBUG: Skipping auth init during build time - window undefined"),console.log("[AUTH] BUILD-DEBUG: Setting authLoading to false for static render"),l({type:"SET_AUTH_LOADING",payload:!1}),console.log("[AUTH] BUILD-DEBUG: Auth init skipped successfully")},[m]);let v=async a=>{if(a?.id){l({type:"SET_PROFILE_LOADING",payload:!0});try{console.log("loadProfile start for user:",a.id);let b=new Promise((a,b)=>{setTimeout(()=>b(Error("Timeout: ensureProfile")),1e4)}),c=(0,d.getSupabaseClient)(),e=await Promise.race([h(c,a),b]),f=e?.plan==="free"&&e?.trial_expires_at&&new Date(e.trial_expires_at)<new Date,g={...e,isTrialExpired:f,account_locked:e?.account_locked||f};l({type:"SET_PROFILE",payload:g});let i={...a,role:g?.role,plan:g?.plan,username:g?.username,isTrialExpired:g?.isTrialExpired,account_locked:g?.account_locked};l({type:"SET_USER",payload:i}),console.log("loadProfile end for user:",a.id)}catch(a){console.error("loadProfile error:",a),l({type:"SET_ERROR",payload:a.message})}finally{l({type:"SET_PROFILE_LOADING",payload:!1})}}};return(0,c.useEffect)(()=>{let a=!0;p.current=e?(console.log("Auth listener already initialized, returning existing instance"),e.unsubscribe):(console.log("Initializing auth listener"),f.onmessage=a=>{let b=a.data;console.log("Received auth message from other tab:",b),"SIGNED_OUT"===b.type?(console.log("Other tab signed out, resetting local state"),l({type:"RESET"})):"AUTH_STATE_CHANGED"===b.type&&(console.log("Other tab changed auth state, updating local state"),b.email)},(e={unsubscribe:()=>{console.log("Cleaning up auth listener"),f.close(),e=null}}).unsubscribe);let{data:{subscription:b}}=(0,d.getSupabaseClient)().auth.onAuthStateChange(async(b,c)=>{if(!a)return;console.log("[AUTH] listener event",{type:b,userId:c?.user?.id,timestamp:new Date().toISOString()});let d=c?.user?.id,e=Date.now();if(r.current&&r.current.type===b&&r.current.userId===d&&e-r.current.ts<500)return void console.log("AuthProvider: Duplicate event detected, skipping");if(q.current)return void console.log("AuthProvider: Auth event already being handled, skipping duplicate");q.current=!0,r.current={type:b,userId:d,ts:e};try{switch(b){case"INITIAL_SESSION":console.log("AuthProvider: Handling INITIAL_SESSION event"),c&&(l({type:"SET_USER",payload:c.user}),l({type:"SET_SESSION",payload:c}),console.log("AuthProvider: Kicking off profile load in background for INITIAL_SESSION"),v(c.user),l({type:"SET_AUTH_LOADING",payload:!1}));break;case"SIGNED_IN":console.log("AuthProvider: Handling SIGNED_IN event for user:",c?.user?.id),c?.user&&(l({type:"SET_USER",payload:c.user}),l({type:"SET_SESSION",payload:c}),console.log("AuthProvider: Kicking off profile load in background for SIGNED_IN"),v(c.user),l({type:"SET_AUTH_LOADING",payload:!1}));break;case"SIGNED_OUT":console.log("AuthProvider: Handling SIGNED_OUT event"),l({type:"RESET"}),l({type:"SET_AUTH_LOADING",payload:!1}),q.current=!1;break;case"TOKEN_REFRESHED":console.log("AuthProvider: Handling TOKEN_REFRESHED event"),c&&l({type:"SET_SESSION",payload:c});break;case"USER_UPDATED":console.log("AuthProvider: Handling USER_UPDATED event"),c?.user&&(l({type:"SET_USER",payload:c.user}),console.log("AuthProvider: Kicking off profile load in background for USER_UPDATED"),v(c.user));break;default:console.log("AuthProvider: Unhandled auth event:",b)}}catch(a){console.error("AuthProvider: Error in auth state change handler:",a),l({type:"SET_ERROR",payload:a.message})}finally{q.current=!1}});return o.current=b,()=>{a=!1,u.current=!1,t.current&&(clearTimeout(t.current),t.current=null,console.log("[AUTH] cleanup: cleared retry timer")),console.log("[AUTH] cleaning up auth subscription"),o.current&&(o.current.unsubscribe?.(),o.current=null),p.current&&(p.current(),p.current=null),s.current=0,console.log("[AUTH] cleanup: reset retry count")}},[]),(0,b.jsx)(j.Provider,{value:{state:g,dispatch:l},children:a})},"useAuthDispatch",0,()=>{let{dispatch:a}=l();return a},"useAuthState",0,()=>{let{state:a}=l();return a},"useAuthStore",0,l],56025)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__165b5b64._.js.map