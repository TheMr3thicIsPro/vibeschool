module.exports=[26680,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(56025),e=a.i(86299),f=a.i(1304),f=f,g=a.i(82826),g=g,h=a.i(84218),h=h,i=a.i(37565),i=i,j=a.i(39355),j=j,k=a.i(87055),k=k,l=a.i(34437),l=l,m=a.i(86351),m=m,n=a.i(50537),n=n,o=a.i(90925),p=a.i(33759);a.s(["default",0,({db:a,currentUser:q})=>{let{state:r}=(0,d.useAuthStore)(),s=q||r.user,[t,u]=(0,c.useState)(a),[v,w]=(0,c.useState)("messages"),[x,y]=(0,c.useState)([]),[z,A]=(0,c.useState)(null),[B,C]=(0,c.useState)([]),[D,E]=(0,c.useState)(""),[F,G]=(0,c.useState)(!0),[H,I]=(0,c.useState)(null),[J,K]=(0,c.useState)(!1),[L,M]=(0,c.useState)([]),N=(0,c.useRef)(null),[O,P]=(0,c.useState)([]),[Q,R]=(0,c.useState)([]),[S,T]=(0,c.useState)(""),[U,V]=(0,c.useState)([]),[W,X]=(0,c.useState)(!1);(0,c.useEffect)(()=>{let b=async()=>{if(!a)try{let a=await (0,e.getCommunityDB)();u(a)}catch(a){console.error("[COMMUNITY] Error initializing community DB:",a),I("Failed to initialize community system")}};s&&!a?b():a&&u(a)},[s,a]),(0,c.useEffect)(()=>{t&&s&&Y()},[t,s]),(0,c.useEffect)(()=>{z&&t&&s&&Z(z.id)},[z,t,s]),(0,c.useEffect)(()=>{_()},[B]),(0,c.useEffect)(()=>{t&&s&&$()},[t,s,v]);let Y=async()=>{try{G(!0);let a=await t.getConversations(s.id);y(a),G(!1)}catch(a){console.error("[COMMUNITY] Error loading conversations:",a),I("Failed to load conversations"),G(!1)}},Z=async a=>{try{let b=await t.getMessages(a);C(b)}catch(a){console.error("[COMMUNITY] Error loading messages:",a),I("Failed to load messages")}},$=async()=>{if(t&&s)try{let a=await t.getFriends(s.id),b=await Promise.all(a.map(async a=>{let b=await t.getProfile(a.friend_id);return{...a,profile:b}}));P(b);let c=await t.getFriendRequests(s.id);R(c)}catch(a){console.error("[COMMUNITY] Error loading friends/requests:",a)}},_=()=>{N.current?.scrollIntoView({behavior:"smooth"})},aa=async()=>{if(D.trim()&&z&&t)try{let a=await t.createMessage({conversation_id:z.id,sender_id:s.id,body:D.trim()});C(b=>[...b,a]),E(""),y(b=>b.map(b=>b.id===z.id?{...b,updated_at:a.created_at}:b))}catch(a){console.error("[COMMUNITY] Error sending message:",a),I("Failed to send message")}},ab=async a=>{if(a.trim()&&t)try{X(!0);let b=await t.searchProfiles(a);V(b.filter(a=>a.id!==s.id))}catch(a){console.error("[COMMUNITY] Error searching users:",a)}finally{X(!1)}},ac=async a=>{try{console.log("[FRIENDREQ] send to",a);let b=await fetch("/api/friends/requests",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({toUserId:a})}),c=await b.json();console.log("[FRIENDREQ] response",b.status,c),b.ok&&c.ok?($(),V([]),T(""),console.log("[FRIENDREQ] request sent successfully")):console.error("[FRIENDREQ] Failed to send request:",c.error)}catch(a){console.error("[FRIENDREQ] Error sending friend request:",a)}},ad=async(a,b)=>{try{console.log("[FRIENDREQ] update request",{requestId:a,status:b});let c=await fetch(`/api/friends/requests/${a}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:b})}),d=await c.json();console.log("[FRIENDREQ] update response",c.status,d),c.ok&&d.ok?$():console.error("[FRIENDREQ] Failed to update request:",d.error)}catch(a){console.error("[FRIENDREQ] Error updating friend request:",a)}},ae=B.reduce((a,b)=>{let c,d,e,f=(c=new Date(b.created_at),((e=new Date(d=new Date)).setDate(e.getDate()-1),c.toDateString()===d.toDateString())?"Today":c.toDateString()===e.toDateString()?"Yesterday":c.toLocaleDateString());return a[f]||(a[f]=[]),a[f].push(b),a},{});return(0,b.jsx)(o.default,{children:(0,b.jsxs)("div",{className:"min-h-screen bg-gray-900 text-white flex",children:[(0,b.jsxs)("div",{className:"w-1/3 border-r border-gray-700 flex flex-col",children:[(0,b.jsx)("div",{className:"p-4 border-b border-gray-700",children:(0,b.jsxs)("div",{className:"flex space-x-1 bg-gray-800 rounded-lg p-1",children:[(0,b.jsx)("button",{onClick:()=>w("messages"),className:`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${"messages"===v?"bg-accent-primary text-white border border-accent-primary":"text-gray-300 hover:text-white hover:bg-gray-700"}`,children:"Messages"}),(0,b.jsx)("button",{onClick:()=>w("friends"),className:`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors ${"friends"===v?"bg-accent-primary text-white border border-accent-primary":"text-gray-300 hover:text-white hover:bg-gray-700"}`,children:"Friends"}),(0,b.jsxs)("button",{onClick:()=>w("requests"),className:`flex-1 py-2 px-3 rounded-md text-sm font-medium transition-colors relative ${"requests"===v?"bg-accent-primary text-white border border-accent-primary":"text-gray-300 hover:text-white hover:bg-gray-700"}`,children:["Requests",Q.filter(a=>a.addressee_id===s.id&&"pending"===a.status).length>0&&(0,b.jsx)("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center",children:Q.filter(a=>a.addressee_id===s.id&&"pending"===a.status).length})]})]})}),"messages"===v&&(0,b.jsxs)(b.Fragment,{children:[F&&(0,b.jsx)("div",{className:"flex-1 overflow-y-auto p-4",children:(0,b.jsx)("div",{className:"space-y-4",children:[0,1,2,3,4].map((a,c)=>(0,b.jsx)("div",{className:"p-4 border-b border-gray-700",children:(0,b.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,b.jsx)(p.default,{className:"w-10 h-10 rounded-full"}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)(p.default,{className:"h-4 w-3/4 mb-2"}),(0,b.jsx)(p.default,{className:"h-3 w-1/2"})]})]})},c))})}),!F&&(0,b.jsx)("div",{className:"flex-1 overflow-y-auto",children:x.map(a=>(0,b.jsx)("div",{className:`p-4 border-b border-gray-700 cursor-pointer hover:bg-gray-800 ${z?.id===a.id?"bg-gray-800":""}`,onClick:()=>A(a),children:(0,b.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,b.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-accent-primary to-purple-600 flex items-center justify-center text-white font-bold",children:a.title||a.is_group?(0,b.jsx)(i.default,{className:"w-4 h-4"}):(0,b.jsx)(j.default,{className:"w-4 h-4"})}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsx)("h3",{className:"font-medium truncate",children:a.title||"Direct Message"}),(0,b.jsx)("p",{className:"text-sm text-gray-400 truncate",children:"No messages yet"})]}),(0,b.jsx)("div",{className:"text-right",children:(0,b.jsx)("p",{className:"text-xs text-gray-500",children:a.updated_at?new Date(a.updated_at).toLocaleDateString():""})})]})},a.id))})]}),"friends"===v&&(0,b.jsxs)("div",{className:"flex-1 overflow-y-auto",children:[(0,b.jsxs)("div",{className:"p-4 border-b border-gray-700",children:[(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)(n.default,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),(0,b.jsx)("input",{type:"text",placeholder:"Search users...",value:S,onChange:a=>T(a.target.value),onKeyPress:a=>"Enter"===a.key&&ab(S),className:"w-full bg-gray-800 text-white rounded-lg py-2 px-4 pl-10 focus:outline-none focus:ring-2 focus:ring-accent-primary"})]}),S&&(0,b.jsx)("button",{onClick:()=>ab(S),disabled:W,className:"mt-2 w-full py-2 bg-accent-primary text-white rounded-lg hover:bg-accent-primary/90 disabled:opacity-50 border border-accent-primary",children:W?"Searching...":"Search"})]}),U.length>0&&(0,b.jsxs)("div",{className:"p-4 border-b border-gray-700",children:[(0,b.jsx)("h3",{className:"font-medium mb-2",children:"Search Results"}),(0,b.jsx)("div",{className:"space-y-2",children:U.map(a=>(0,b.jsxs)("div",{className:"flex items-center justify-between p-2 bg-gray-800 rounded-lg",children:[(0,b.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,b.jsx)("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-accent-primary to-purple-600 flex items-center justify-center text-white text-sm font-bold",children:a.username.charAt(0).toUpperCase()}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"font-medium",children:a.username}),(0,b.jsx)("p",{className:"text-sm text-gray-400",children:a.display_name})]})]}),(0,b.jsx)("button",{onClick:()=>ac(a.id),className:"p-2 bg-accent-primary text-white rounded-full hover:bg-accent-primary/90 border border-accent-primary",children:(0,b.jsx)(k.default,{className:"w-4 h-4"})})]},a.id))})]}),(0,b.jsxs)("div",{className:"p-4",children:[(0,b.jsxs)("h3",{className:"font-medium mb-2",children:["Your Friends (",O.length,")"]}),0===O.length?(0,b.jsx)("p",{className:"text-gray-500 text-sm",children:"No friends yet. Search for users to add friends!"}):(0,b.jsx)("div",{className:"space-y-2",children:O.map(a=>(0,b.jsxs)("div",{className:"flex items-center justify-between p-2 bg-gray-800 rounded-lg",children:[(0,b.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,b.jsx)("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-accent-primary to-purple-600 flex items-center justify-center text-white text-sm font-bold",children:a.profile?.username.charAt(0).toUpperCase()||"U"}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"font-medium",children:a.profile?.username||"Unknown User"}),(0,b.jsx)("p",{className:"text-sm text-gray-400",children:a.profile?.display_name||"No display name"})]})]}),(0,b.jsxs)("div",{className:"text-xs text-gray-500",children:["Friends since ",new Date(a.created_at).toLocaleDateString()]})]},a.friend_id))})]})]}),"requests"===v&&(0,b.jsx)("div",{className:"flex-1 overflow-y-auto",children:(0,b.jsxs)("div",{className:"p-4",children:[(0,b.jsx)("h3",{className:"font-medium mb-2",children:"Friend Requests"}),(0,b.jsxs)("div",{className:"mb-4",children:[(0,b.jsx)("h4",{className:"text-sm font-medium text-gray-400 mb-2",children:"Sent Requests"}),0===Q.filter(a=>a.requester_id===s.id).length?(0,b.jsx)("p",{className:"text-gray-500 text-sm",children:"No sent requests"}):(0,b.jsx)("div",{className:"space-y-2",children:Q.filter(a=>a.requester_id===s.id).map(a=>(0,b.jsx)("div",{className:"p-2 bg-gray-800 rounded-lg",children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,b.jsx)("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-accent-primary to-purple-600 flex items-center justify-center text-white text-sm font-bold",children:a.addressee_id.charAt(0).toUpperCase()}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("p",{className:"font-medium",children:["User ",a.addressee_id.substring(0,8)]}),(0,b.jsxs)("p",{className:"text-sm text-gray-400 capitalize",children:["Status: ",a.status]})]})]}),"pending"===a.status&&(0,b.jsx)("button",{onClick:()=>ad(a.id,"cancelled"),className:"p-1 text-red-500 hover:bg-red-500/20 rounded",children:(0,b.jsx)(m.default,{className:"w-4 h-4"})})]})},a.id))})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("h4",{className:"text-sm font-medium text-gray-400 mb-2",children:"Received Requests"}),0===Q.filter(a=>a.addressee_id===s.id&&"pending"===a.status).length?(0,b.jsx)("p",{className:"text-gray-500 text-sm",children:"No pending requests"}):(0,b.jsx)("div",{className:"space-y-2",children:Q.filter(a=>a.addressee_id===s.id&&"pending"===a.status).map(a=>(0,b.jsx)("div",{className:"p-2 bg-gray-800 rounded-lg",children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,b.jsx)("div",{className:"w-8 h-8 rounded-full bg-gradient-to-br from-accent-primary to-purple-600 flex items-center justify-center text-white text-sm font-bold",children:a.requester_id.charAt(0).toUpperCase()}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("p",{className:"font-medium",children:["User ",a.requester_id.substring(0,8)]}),(0,b.jsxs)("p",{className:"text-sm text-gray-400",children:["Sent ",new Date(a.created_at).toLocaleDateString()]})]})]}),(0,b.jsxs)("div",{className:"flex space-x-1",children:[(0,b.jsx)("button",{onClick:()=>ad(a.id,"accepted"),className:"p-1 text-green-500 hover:bg-green-500/20 rounded",children:(0,b.jsx)(l.default,{className:"w-4 h-4"})}),(0,b.jsx)("button",{onClick:()=>ad(a.id,"declined"),className:"p-1 text-red-500 hover:bg-red-500/20 rounded",children:(0,b.jsx)(m.default,{className:"w-4 h-4"})})]})]})},a.id))})]})]})})]}),(0,b.jsx)("div",{className:"flex-1 flex flex-col",children:"messages"===v&&z?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{className:"p-4 border-b border-gray-700 flex items-center justify-between",children:[(0,b.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,b.jsx)("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-accent-primary to-purple-600 flex items-center justify-center text-white font-bold",children:z.title||z.is_group?(0,b.jsx)(i.default,{className:"w-4 h-4"}):(0,b.jsx)(j.default,{className:"w-4 h-4"})}),(0,b.jsxs)("div",{children:[(0,b.jsx)("h3",{className:"font-medium",children:z.title||"Direct Message"}),(0,b.jsx)("p",{className:"text-sm text-gray-400",children:z.is_group?"Group chat":"Direct message"})]})]}),(0,b.jsx)("button",{className:"p-2 rounded-full hover:bg-gray-700",children:(0,b.jsx)(h.default,{className:"w-5 h-5"})})]}),(0,b.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[Object.entries(ae).map(([a,c])=>(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-center my-4",children:(0,b.jsx)("span",{className:"text-xs bg-gray-800 text-gray-400 px-3 py-1 rounded-full",children:a})}),c.map(a=>(0,b.jsx)("div",{className:`flex ${a.sender_id===s.id?"justify-end":"justify-start"}`,children:(0,b.jsxs)("div",{className:`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${a.sender_id===s.id?"bg-accent-primary text-white":"bg-gray-800 text-white"}`,children:[(0,b.jsx)("p",{children:a.body}),(0,b.jsx)("p",{className:`text-xs mt-1 ${a.sender_id===s.id?"text-black/70":"text-gray-400"}`,children:new Date(a.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})},a.id))]},a)),(0,b.jsx)("div",{ref:N})]}),L.length>0&&(0,b.jsx)("div",{className:"px-4 py-2 text-sm text-gray-500",children:1===L.length?(0,b.jsxs)("span",{children:[L[0]," is typing..."]}):(0,b.jsxs)("span",{children:[L.length," people are typing..."]})}),(0,b.jsx)("div",{className:"p-4 border-t border-gray-700",children:(0,b.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,b.jsx)("button",{className:"p-2 rounded-full hover:bg-gray-700",children:(0,b.jsx)(g.default,{className:"w-5 h-5"})}),(0,b.jsxs)("div",{className:"flex-1 relative",children:[(0,b.jsx)("textarea",{value:D,onChange:a=>{E(a.target.value),!J&&z&&K(!0)},onKeyDown:a=>{"Enter"!==a.key||a.shiftKey||(a.preventDefault(),aa())},onBlur:()=>{J&&K(!1)},placeholder:"Type a message...",className:"w-full bg-gray-800 text-white rounded-lg py-2 px-4 pr-12 resize-none focus:outline-none focus:ring-2 focus:ring-accent-primary",rows:1}),(0,b.jsx)("button",{onClick:aa,disabled:!D.trim(),className:`absolute right-3 bottom-2 p-1 rounded-full ${D.trim()?"text-accent-primary hover:bg-accent-primary/20":"text-gray-500"}`,children:(0,b.jsx)(f.default,{className:"w-5 h-5"})})]})]})})]}):"messages"===v?(0,b.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)("div",{className:"w-16 h-16 rounded-full bg-gray-800 flex items-center justify-center mx-auto mb-4",children:(0,b.jsx)(i.default,{className:"w-8 h-8 text-gray-600"})}),(0,b.jsx)("h3",{className:"text-xl font-medium mb-2",children:"No Conversation Selected"}),(0,b.jsx)("p",{className:"text-gray-500",children:"Select a conversation from the list or start a new one"})]})}):(0,b.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)("div",{className:"w-16 h-16 rounded-full bg-gray-800 flex items-center justify-center mx-auto mb-4",children:"friends"===v?(0,b.jsx)(j.default,{className:"w-8 h-8 text-gray-600"}):(0,b.jsx)(k.default,{className:"w-8 h-8 text-gray-600"})}),(0,b.jsx)("h3",{className:"text-xl font-medium mb-2",children:"friends"===v?"Friends":"Friend Requests"}),(0,b.jsx)("p",{className:"text-gray-500",children:"friends"===v?"Manage your friends and search for new ones":"Manage your friend requests"})]})})})]})})}],26680)}];

//# sourceMappingURL=src_app_messages_page_tsx_77cf07ec._.js.map