{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/lib/utils.ts"],"sourcesContent":["import { clsx, type ClassValue } from \"clsx\";\r\nimport { twMerge } from \"tailwind-merge\";\r\n\r\nexport function cn(...inputs: ClassValue[]) {\r\n  return twMerge(clsx(inputs));\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,SAAS,GAAG,GAAG,MAAoB;IACxC,OAAO,IAAA,yKAAO,EAAC,IAAA,gJAAI,EAAC;AACtB"}},
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/components/layout/Sidebar.tsx"],"sourcesContent":["'use client';\r\n\r\nimport Link from 'next/link';\r\nimport { usePathname } from 'next/navigation';\r\nimport { Home, BookOpen, MessageCircle, User } from 'lucide-react';\r\nimport { cn } from '@/lib/utils';\r\n\r\nconst Sidebar = () => {\r\n  const pathname = usePathname();\r\n\r\n  const navItems = [\r\n    { \r\n      href: '/dashboard', \r\n      icon: Home, \r\n      label: 'Home' \r\n    },\r\n    { \r\n      href: '/courses', \r\n      icon: BookOpen, \r\n      label: 'Courses' \r\n    },\r\n    { \r\n      href: '/social', \r\n      icon: MessageCircle, \r\n      label: 'Social' \r\n    },\r\n    { \r\n      href: '/profile', \r\n      icon: User, \r\n      label: 'Profile' \r\n    },\r\n  ];\r\n\r\n  return (\r\n    <div className=\"w-16 bg-sidebar-bg flex flex-col items-center py-4 space-y-6\">\r\n      <div className=\"flex-1 flex flex-col items-center space-y-6\">\r\n        {navItems.map((item) => {\r\n          const Icon = item.icon;\r\n          const isActive = pathname === item.href;\r\n          \r\n          return (\r\n            <Link \r\n              key={item.href}\r\n              href={item.href}\r\n              className={cn(\r\n                'p-2 rounded-lg transition-all duration-200 flex items-center justify-center hover-lift',\r\n                'text-gray-400 hover:text-accent-primary hover:bg-gray-800',\r\n                isActive \r\n                  ? 'text-accent-primary bg-gray-800 active-glow' \r\n                  : 'hover:glow-button'\r\n              )}\r\n              title={item.label}\r\n            >\r\n              <Icon size={24} />\r\n            </Link>\r\n          );\r\n        })}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default Sidebar;"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AAAA;AAAA;AAAA;AACA;;;AALA;;;;;AAOA,MAAM,UAAU;;IACd,MAAM,WAAW,IAAA,oJAAW;IAE5B,MAAM,WAAW;QACf;YACE,MAAM;YACN,MAAM,8MAAI;YACV,OAAO;QACT;QACA;YACE,MAAM;YACN,MAAM,6NAAQ;YACd,OAAO;QACT;QACA;YACE,MAAM;YACN,MAAM,4OAAa;YACnB,OAAO;QACT;QACA;YACE,MAAM;YACN,MAAM,6MAAI;YACV,OAAO;QACT;KACD;IAED,qBACE,6LAAC;QAAI,WAAU;kBACb,cAAA,6LAAC;YAAI,WAAU;sBACZ,SAAS,GAAG,CAAC,CAAC;gBACb,MAAM,OAAO,KAAK,IAAI;gBACtB,MAAM,WAAW,aAAa,KAAK,IAAI;gBAEvC,qBACE,6LAAC,0KAAI;oBAEH,MAAM,KAAK,IAAI;oBACf,WAAW,IAAA,4HAAE,EACX,0FACA,6DACA,WACI,gDACA;oBAEN,OAAO,KAAK,KAAK;8BAEjB,cAAA,6LAAC;wBAAK,MAAM;;;;;;mBAXP,KAAK,IAAI;;;;;YAcpB;;;;;;;;;;;AAIR;GArDM;;QACa,oJAAW;;;KADxB;uCAuDS"}},
    {"offset": {"line": 117, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/components/TrialTimer.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { useAuthStore } from '@/context/AuthContext';\r\nimport { Clock } from 'lucide-react';\r\n\r\nconst TrialTimer = () => {\r\n  const { state } = useAuthStore();\r\n  const user = state.user;\r\n  const profile = state.profile;\r\n  \r\n  const [timeLeft, setTimeLeft] = useState<string>('');\r\n  const [isExpiringSoon, setIsExpiringSoon] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (!user || !profile?.trial_expires_at || profile.plan !== 'free') {\r\n      return;\r\n    }\r\n\r\n    const calculateTimeLeft = () => {\r\n      const expiryDate = new Date(profile.trial_expires_at);\r\n      const now = new Date();\r\n      const difference = expiryDate.getTime() - now.getTime();\r\n\r\n      if (difference <= 0) {\r\n        setTimeLeft('Trial Expired');\r\n        setIsExpiringSoon(true);\r\n        return;\r\n      }\r\n\r\n      const days = Math.floor(difference / (1000 * 60 * 60 * 24));\r\n      const hours = Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));\r\n      const minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));\r\n      const seconds = Math.floor((difference % (1000 * 60)) / 1000);\r\n\r\n      if (days === 0 && hours === 0 && minutes < 5) {\r\n        setIsExpiringSoon(true);\r\n      } else {\r\n        setIsExpiringSoon(false);\r\n      }\r\n\r\n      let timeString = '';\r\n      if (days > 0) {\r\n        timeString += `${days}d `;\r\n      }\r\n      if (hours > 0) {\r\n        timeString += `${hours}h `;\r\n      }\r\n      if (minutes > 0) {\r\n        timeString += `${minutes}m `;\r\n      }\r\n      timeString += `${seconds}s`;\r\n      \r\n      setTimeLeft(timeString);\r\n    };\r\n\r\n    // Calculate immediately\r\n    calculateTimeLeft();\r\n\r\n    // Update every second\r\n    const interval = setInterval(calculateTimeLeft, 1000);\r\n\r\n    return () => clearInterval(interval);\r\n  }, [user, profile]);\r\n\r\n  if (!user || !profile?.trial_expires_at || profile.plan !== 'free') {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <div className={`flex items-center gap-2 px-3 py-1 rounded-full text-sm font-medium ${\r\n      isExpiringSoon \r\n        ? 'bg-red-500/20 text-red-400 border border-red-500/30' \r\n        : 'bg-blue-500/20 text-blue-400 border border-blue-500/30'\r\n    }`}>\r\n      <Clock size={16} />\r\n      <span>Trial: {timeLeft}</span>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default TrialTimer;"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;;;AAJA;;;;AAMA,MAAM,aAAa;;IACjB,MAAM,EAAE,KAAK,EAAE,GAAG,IAAA,iJAAY;IAC9B,MAAM,OAAO,MAAM,IAAI;IACvB,MAAM,UAAU,MAAM,OAAO;IAE7B,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,yKAAQ,EAAS;IACjD,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,IAAA,yKAAQ,EAAC;IAErD,IAAA,0KAAS;gCAAC;YACR,IAAI,CAAC,QAAQ,CAAC,SAAS,oBAAoB,QAAQ,IAAI,KAAK,QAAQ;gBAClE;YACF;YAEA,MAAM;0DAAoB;oBACxB,MAAM,aAAa,IAAI,KAAK,QAAQ,gBAAgB;oBACpD,MAAM,MAAM,IAAI;oBAChB,MAAM,aAAa,WAAW,OAAO,KAAK,IAAI,OAAO;oBAErD,IAAI,cAAc,GAAG;wBACnB,YAAY;wBACZ,kBAAkB;wBAClB;oBACF;oBAEA,MAAM,OAAO,KAAK,KAAK,CAAC,aAAa,CAAC,OAAO,KAAK,KAAK,EAAE;oBACzD,MAAM,QAAQ,KAAK,KAAK,CAAC,AAAC,aAAa,CAAC,OAAO,KAAK,KAAK,EAAE,IAAK,CAAC,OAAO,KAAK,EAAE;oBAC/E,MAAM,UAAU,KAAK,KAAK,CAAC,AAAC,aAAa,CAAC,OAAO,KAAK,EAAE,IAAK,CAAC,OAAO,EAAE;oBACvE,MAAM,UAAU,KAAK,KAAK,CAAC,AAAC,aAAa,CAAC,OAAO,EAAE,IAAK;oBAExD,IAAI,SAAS,KAAK,UAAU,KAAK,UAAU,GAAG;wBAC5C,kBAAkB;oBACpB,OAAO;wBACL,kBAAkB;oBACpB;oBAEA,IAAI,aAAa;oBACjB,IAAI,OAAO,GAAG;wBACZ,cAAc,GAAG,KAAK,EAAE,CAAC;oBAC3B;oBACA,IAAI,QAAQ,GAAG;wBACb,cAAc,GAAG,MAAM,EAAE,CAAC;oBAC5B;oBACA,IAAI,UAAU,GAAG;wBACf,cAAc,GAAG,QAAQ,EAAE,CAAC;oBAC9B;oBACA,cAAc,GAAG,QAAQ,CAAC,CAAC;oBAE3B,YAAY;gBACd;;YAEA,wBAAwB;YACxB;YAEA,sBAAsB;YACtB,MAAM,WAAW,YAAY,mBAAmB;YAEhD;wCAAO,IAAM,cAAc;;QAC7B;+BAAG;QAAC;QAAM;KAAQ;IAElB,IAAI,CAAC,QAAQ,CAAC,SAAS,oBAAoB,QAAQ,IAAI,KAAK,QAAQ;QAClE,OAAO;IACT;IAEA,qBACE,6LAAC;QAAI,WAAW,CAAC,mEAAmE,EAClF,iBACI,wDACA,0DACJ;;0BACA,6LAAC,gNAAK;gBAAC,MAAM;;;;;;0BACb,6LAAC;;oBAAK;oBAAQ;;;;;;;;;;;;;AAGpB;GAzEM;;QACc,iJAAY;;;KAD1B;uCA2ES"}},
    {"offset": {"line": 234, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/components/layout/AppShell.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { ReactNode, useEffect, useState } from 'react';\r\nimport { useAuthStore } from '@/context/AuthContext';\r\nimport Sidebar from './Sidebar';\r\nimport TrialTimer from '@/components/TrialTimer';\r\nimport { Menu } from 'lucide-react';\r\nimport { cn } from '@/lib/utils';\r\n\r\ninterface AppShellProps {\r\n  children: ReactNode;\r\n}\r\n\r\nconst AppShell = ({ children }: AppShellProps) => {\r\n  // Hydration guard: ensure first client render matches SSR to avoid mismatch\r\n  // NOTE: SSR build-time guard removed to preserve consistent hook order across renders.\r\n  const [hydrated, setHydrated] = useState(false);\r\n  useEffect(() => {\r\n    setHydrated(true);\r\n  }, []);\r\n  \r\n  // IMPORTANT: Call hooks unconditionally on every render to maintain consistent order\r\n  const { state } = useAuthStore();\r\n  const user = state.user;\r\n  const authLoading = state.authLoading;\r\n  const profile = state.profile;\r\n  const [sidebarOpen, setSidebarOpen] = useState(true);\r\n  \r\n  // Until hydrated, render SSR-equivalent wrapper\r\n  if (!hydrated) {\r\n    return (\r\n      <div className=\"min-h-screen bg-background\">\r\n        {children}\r\n      </div>\r\n    );\r\n  }\r\n  \r\n  // Show sidebar only when user is authenticated\r\n  if (authLoading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-background flex items-center justify-center\">\r\n        <div className=\"text-2xl font-bold text-accent-primary\">Loading...</div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!user) {\r\n    // For non-authenticated users, just render children without sidebar\r\n    return <div>{children}</div>;\r\n  }\r\n  \r\n  // Check if account is locked due to expired trial\r\n  if (user.account_locked) {\r\n    const trialExpiredAt = profile?.trial_expires_at ? new Date(profile.trial_expires_at) : null;\r\n    const formattedExpiration = trialExpiredAt ? trialExpiredAt.toLocaleString() : 'Unknown';\r\n    \r\n    return (\r\n      <div className=\"min-h-screen bg-background flex items-center justify-center p-4\">\r\n        <div className=\"max-w-md w-full bg-card rounded-xl shadow-lg p-6 text-center\">\r\n          <h2 className=\"text-2xl font-bold text-red-500 mb-4\">Account Locked</h2>\r\n          <p className=\"text-foreground mb-4\">\r\n            Your free trial expired on {formattedExpiration}. Please upgrade to a membership to continue accessing the platform.\r\n          </p>\r\n          <div className=\"mb-6 p-3 bg-red-500/10 rounded-lg border border-red-500/20\">\r\n            <p className=\"text-sm text-red-400\">\r\n              Trial Duration: 5 minutes â€¢ Expired: {formattedExpiration}\r\n            </p>\r\n          </div>\r\n          <a \r\n            href=\"/payments\"\r\n            className=\"px-6 py-3 bg-accent-primary text-white rounded-lg hover:bg-accent-primary/90 transition-colors font-medium inline-block\"\r\n          >\r\n            Upgrade to Member\r\n          </a>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex h-screen bg-background text-foreground overflow-hidden\">\r\n      {/* Mobile menu button - shown when sidebar is collapsed */}\r\n      <div className=\"md:hidden absolute top-4 left-4 z-50\">\r\n        <button\r\n          onClick={() => setSidebarOpen(!sidebarOpen)}\r\n          className=\"p-2 rounded-lg bg-sidebar-bg text-accent-primary hover:glow-button hover-lift\"\r\n        >\r\n          <Menu size={24} />\r\n        </button>\r\n      </div>\r\n\r\n      {/* Sidebar */}\r\n      <div \r\n        className={cn(\r\n          \"h-full transition-all duration-300 ease-in-out\",\r\n          sidebarOpen ? \"block\" : \"hidden md:block\",\r\n          \"md:block md:translate-x-0\"\r\n        )}\r\n      >\r\n        <Sidebar />\r\n      </div>\r\n\r\n      {/* Header bar with trial timer */}\r\n      <div className=\"fixed top-0 right-0 z-40 p-4\">\r\n        <TrialTimer />\r\n      </div>\r\n      \r\n      {/* Main content */}\r\n      <main className=\"flex-1 h-full overflow-auto md:ml-0 transition-all duration-300\">\r\n        <div className=\"h-full\">\r\n          {children}\r\n        </div>\r\n      </main>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default AppShell;"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AACA;AACA;AACA;;;AAPA;;;;;;;AAaA,MAAM,WAAW,CAAC,EAAE,QAAQ,EAAiB;;IAC3C,4EAA4E;IAC5E,uFAAuF;IACvF,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,yKAAQ,EAAC;IACzC,IAAA,0KAAS;8BAAC;YACR,YAAY;QACd;6BAAG,EAAE;IAEL,qFAAqF;IACrF,MAAM,EAAE,KAAK,EAAE,GAAG,IAAA,iJAAY;IAC9B,MAAM,OAAO,MAAM,IAAI;IACvB,MAAM,cAAc,MAAM,WAAW;IACrC,MAAM,UAAU,MAAM,OAAO;IAC7B,MAAM,CAAC,aAAa,eAAe,GAAG,IAAA,yKAAQ,EAAC;IAE/C,gDAAgD;IAChD,IAAI,CAAC,UAAU;QACb,qBACE,6LAAC;YAAI,WAAU;sBACZ;;;;;;IAGP;IAEA,+CAA+C;IAC/C,IAAI,aAAa;QACf,qBACE,6LAAC;YAAI,WAAU;sBACb,cAAA,6LAAC;gBAAI,WAAU;0BAAyC;;;;;;;;;;;IAG9D;IAEA,IAAI,CAAC,MAAM;QACT,oEAAoE;QACpE,qBAAO,6LAAC;sBAAK;;;;;;IACf;IAEA,kDAAkD;IAClD,IAAI,KAAK,cAAc,EAAE;QACvB,MAAM,iBAAiB,SAAS,mBAAmB,IAAI,KAAK,QAAQ,gBAAgB,IAAI;QACxF,MAAM,sBAAsB,iBAAiB,eAAe,cAAc,KAAK;QAE/E,qBACE,6LAAC;YAAI,WAAU;sBACb,cAAA,6LAAC;gBAAI,WAAU;;kCACb,6LAAC;wBAAG,WAAU;kCAAuC;;;;;;kCACrD,6LAAC;wBAAE,WAAU;;4BAAuB;4BACN;4BAAoB;;;;;;;kCAElD,6LAAC;wBAAI,WAAU;kCACb,cAAA,6LAAC;4BAAE,WAAU;;gCAAuB;gCACI;;;;;;;;;;;;kCAG1C,6LAAC;wBACC,MAAK;wBACL,WAAU;kCACX;;;;;;;;;;;;;;;;;IAMT;IAEA,qBACE,6LAAC;QAAI,WAAU;;0BAEb,6LAAC;gBAAI,WAAU;0BACb,cAAA,6LAAC;oBACC,SAAS,IAAM,eAAe,CAAC;oBAC/B,WAAU;8BAEV,cAAA,6LAAC,6MAAI;wBAAC,MAAM;;;;;;;;;;;;;;;;0BAKhB,6LAAC;gBACC,WAAW,IAAA,4HAAE,EACX,kDACA,cAAc,UAAU,mBACxB;0BAGF,cAAA,6LAAC,qJAAO;;;;;;;;;;0BAIV,6LAAC;gBAAI,WAAU;0BACb,cAAA,6LAAC,8IAAU;;;;;;;;;;0BAIb,6LAAC;gBAAK,WAAU;0BACd,cAAA,6LAAC;oBAAI,WAAU;8BACZ;;;;;;;;;;;;;;;;;AAKX;GAtGM;;QASc,iJAAY;;;KAT1B;uCAwGS"}},
    {"offset": {"line": 464, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/courseActions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\nimport { revalidatePath } from 'next/cache';\r\nimport { parseYouTube } from '@/lib/youtubeParser';\r\n\r\n// Type definitions\r\ntype Course = {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\ntype Module = {\r\n  id: string;\r\n  course_id: string;\r\n  title: string;\r\n  order_index: number;\r\n};\r\n\r\ntype Lesson = {\r\n  id: string;\r\n  module_id: string;\r\n  title: string;\r\n  description: string;\r\n  order_index: number;\r\n  video_provider: string;\r\n  video_url: string | null;\r\n  youtube_video_id: string | null;\r\n  is_preview: boolean;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin' || profile.role === 'teacher';\r\n}\r\n\r\n// Course Actions\r\nexport async function listCourses(): Promise<{ data: Course[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: listCourses - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: listCourses - Fetching all courses for admin');\r\n    \r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n    \r\n    console.log('DEBUG: listCourses - Query result:', { data: data?.length, error });\r\n    \r\n    if (error) {\r\n      console.error('DEBUG: listCourses - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    console.log('DEBUG: listCourses - Returning courses:', data?.length);\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: listCourses - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createCourse(title: string, description: string): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: createCourse - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: createCourse - Creating course:', { title, description });\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .insert([{ title, description }])\r\n      .select()\r\n      .single();\r\n    \r\n    console.log('DEBUG: createCourse - Insert result:', { data: !!data, error });\r\n\r\n    if (error) {\r\n      console.error('DEBUG: createCourse - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    console.log('DEBUG: createCourse - Course created successfully, cache invalidated');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: createCourse - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateCourse(id: string, updates: Partial<Course>): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteCourse(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('courses')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function publishCourse(id: string, isPublished: boolean): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update({ is_published: isPublished })\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\n// Module Actions\r\nexport async function listModules(courseId: string): Promise<{ data: Module[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .select('*')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createModule(courseId: string, title: string): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingModules } = await supabase\r\n      .from('modules')\r\n      .select('order_index')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingModules && existingModules.length > 0 \r\n      ? existingModules[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .insert([{ course_id: courseId, title, order_index: newOrderIndex }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateModule(id: string, updates: Partial<Module>): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteModule(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('modules')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderModules(courseId: string, moduleIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all modules with their new positions in a single transaction\r\n    const updates = moduleIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('modules')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('course_id', courseId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\n// Lesson Actions\r\nexport async function listLessons(moduleId: string): Promise<{ data: Lesson[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .select('*')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createLesson(\r\n  moduleId: string, \r\n  title: string, \r\n  description: string, \r\n  youtubeUrl: string\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Parse the YouTube URL\r\n    const parsed = parseYouTube(youtubeUrl);\r\n    if (parsed.error) {\r\n      return { data: null, error: parsed.error };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingLessons } = await supabase\r\n      .from('lessons')\r\n      .select('order_index')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingLessons && existingLessons.length > 0 \r\n      ? existingLessons[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .insert([{\r\n        module_id: moduleId,\r\n        title,\r\n        description,\r\n        youtube_video_id: parsed.videoId,\r\n        video_url: parsed.embedUrl,\r\n        order_index: newOrderIndex,\r\n        is_preview: false,\r\n        is_published: true\r\n      }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateLesson(\r\n  id: string, \r\n  updates: Partial<Omit<Lesson, 'id' | 'module_id' | 'created_at' | 'updated_at'>>\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // If updating YouTube URL, parse it first\r\n    if (updates.video_url) {\r\n      const parsed = parseYouTube(updates.video_url);\r\n      if (parsed.error) {\r\n        return { data: null, error: parsed.error };\r\n      }\r\n      updates.youtube_video_id = parsed.videoId;\r\n      updates.video_url = parsed.embedUrl;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteLesson(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('lessons')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderLessons(moduleId: string, lessonIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all lessons with their new positions in a single transaction\r\n    const updates = lessonIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('lessons')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('module_id', moduleId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MAiFsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,+CAAA"}},
    {"offset": {"line": 481, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/courseActions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\nimport { revalidatePath } from 'next/cache';\r\nimport { parseYouTube } from '@/lib/youtubeParser';\r\n\r\n// Type definitions\r\ntype Course = {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\ntype Module = {\r\n  id: string;\r\n  course_id: string;\r\n  title: string;\r\n  order_index: number;\r\n};\r\n\r\ntype Lesson = {\r\n  id: string;\r\n  module_id: string;\r\n  title: string;\r\n  description: string;\r\n  order_index: number;\r\n  video_provider: string;\r\n  video_url: string | null;\r\n  youtube_video_id: string | null;\r\n  is_preview: boolean;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin' || profile.role === 'teacher';\r\n}\r\n\r\n// Course Actions\r\nexport async function listCourses(): Promise<{ data: Course[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: listCourses - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: listCourses - Fetching all courses for admin');\r\n    \r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n    \r\n    console.log('DEBUG: listCourses - Query result:', { data: data?.length, error });\r\n    \r\n    if (error) {\r\n      console.error('DEBUG: listCourses - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    console.log('DEBUG: listCourses - Returning courses:', data?.length);\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: listCourses - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createCourse(title: string, description: string): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: createCourse - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: createCourse - Creating course:', { title, description });\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .insert([{ title, description }])\r\n      .select()\r\n      .single();\r\n    \r\n    console.log('DEBUG: createCourse - Insert result:', { data: !!data, error });\r\n\r\n    if (error) {\r\n      console.error('DEBUG: createCourse - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    console.log('DEBUG: createCourse - Course created successfully, cache invalidated');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: createCourse - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateCourse(id: string, updates: Partial<Course>): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteCourse(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('courses')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function publishCourse(id: string, isPublished: boolean): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update({ is_published: isPublished })\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\n// Module Actions\r\nexport async function listModules(courseId: string): Promise<{ data: Module[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .select('*')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createModule(courseId: string, title: string): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingModules } = await supabase\r\n      .from('modules')\r\n      .select('order_index')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingModules && existingModules.length > 0 \r\n      ? existingModules[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .insert([{ course_id: courseId, title, order_index: newOrderIndex }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateModule(id: string, updates: Partial<Module>): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteModule(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('modules')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderModules(courseId: string, moduleIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all modules with their new positions in a single transaction\r\n    const updates = moduleIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('modules')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('course_id', courseId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\n// Lesson Actions\r\nexport async function listLessons(moduleId: string): Promise<{ data: Lesson[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .select('*')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createLesson(\r\n  moduleId: string, \r\n  title: string, \r\n  description: string, \r\n  youtubeUrl: string\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Parse the YouTube URL\r\n    const parsed = parseYouTube(youtubeUrl);\r\n    if (parsed.error) {\r\n      return { data: null, error: parsed.error };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingLessons } = await supabase\r\n      .from('lessons')\r\n      .select('order_index')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingLessons && existingLessons.length > 0 \r\n      ? existingLessons[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .insert([{\r\n        module_id: moduleId,\r\n        title,\r\n        description,\r\n        youtube_video_id: parsed.videoId,\r\n        video_url: parsed.embedUrl,\r\n        order_index: newOrderIndex,\r\n        is_preview: false,\r\n        is_published: true\r\n      }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateLesson(\r\n  id: string, \r\n  updates: Partial<Omit<Lesson, 'id' | 'module_id' | 'created_at' | 'updated_at'>>\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // If updating YouTube URL, parse it first\r\n    if (updates.video_url) {\r\n      const parsed = parseYouTube(updates.video_url);\r\n      if (parsed.error) {\r\n        return { data: null, error: parsed.error };\r\n      }\r\n      updates.youtube_video_id = parsed.videoId;\r\n      updates.video_url = parsed.embedUrl;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteLesson(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('lessons')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderLessons(moduleId: string, lessonIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all lessons with their new positions in a single transaction\r\n    const updates = lessonIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('lessons')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('module_id', moduleId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MAkHsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,gDAAA"}},
    {"offset": {"line": 498, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/courseActions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\nimport { revalidatePath } from 'next/cache';\r\nimport { parseYouTube } from '@/lib/youtubeParser';\r\n\r\n// Type definitions\r\ntype Course = {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\ntype Module = {\r\n  id: string;\r\n  course_id: string;\r\n  title: string;\r\n  order_index: number;\r\n};\r\n\r\ntype Lesson = {\r\n  id: string;\r\n  module_id: string;\r\n  title: string;\r\n  description: string;\r\n  order_index: number;\r\n  video_provider: string;\r\n  video_url: string | null;\r\n  youtube_video_id: string | null;\r\n  is_preview: boolean;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin' || profile.role === 'teacher';\r\n}\r\n\r\n// Course Actions\r\nexport async function listCourses(): Promise<{ data: Course[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: listCourses - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: listCourses - Fetching all courses for admin');\r\n    \r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n    \r\n    console.log('DEBUG: listCourses - Query result:', { data: data?.length, error });\r\n    \r\n    if (error) {\r\n      console.error('DEBUG: listCourses - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    console.log('DEBUG: listCourses - Returning courses:', data?.length);\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: listCourses - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createCourse(title: string, description: string): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: createCourse - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: createCourse - Creating course:', { title, description });\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .insert([{ title, description }])\r\n      .select()\r\n      .single();\r\n    \r\n    console.log('DEBUG: createCourse - Insert result:', { data: !!data, error });\r\n\r\n    if (error) {\r\n      console.error('DEBUG: createCourse - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    console.log('DEBUG: createCourse - Course created successfully, cache invalidated');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: createCourse - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateCourse(id: string, updates: Partial<Course>): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteCourse(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('courses')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function publishCourse(id: string, isPublished: boolean): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update({ is_published: isPublished })\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\n// Module Actions\r\nexport async function listModules(courseId: string): Promise<{ data: Module[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .select('*')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createModule(courseId: string, title: string): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingModules } = await supabase\r\n      .from('modules')\r\n      .select('order_index')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingModules && existingModules.length > 0 \r\n      ? existingModules[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .insert([{ course_id: courseId, title, order_index: newOrderIndex }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateModule(id: string, updates: Partial<Module>): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteModule(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('modules')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderModules(courseId: string, moduleIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all modules with their new positions in a single transaction\r\n    const updates = moduleIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('modules')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('course_id', courseId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\n// Lesson Actions\r\nexport async function listLessons(moduleId: string): Promise<{ data: Lesson[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .select('*')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createLesson(\r\n  moduleId: string, \r\n  title: string, \r\n  description: string, \r\n  youtubeUrl: string\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Parse the YouTube URL\r\n    const parsed = parseYouTube(youtubeUrl);\r\n    if (parsed.error) {\r\n      return { data: null, error: parsed.error };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingLessons } = await supabase\r\n      .from('lessons')\r\n      .select('order_index')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingLessons && existingLessons.length > 0 \r\n      ? existingLessons[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .insert([{\r\n        module_id: moduleId,\r\n        title,\r\n        description,\r\n        youtube_video_id: parsed.videoId,\r\n        video_url: parsed.embedUrl,\r\n        order_index: newOrderIndex,\r\n        is_preview: false,\r\n        is_published: true\r\n      }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateLesson(\r\n  id: string, \r\n  updates: Partial<Omit<Lesson, 'id' | 'module_id' | 'created_at' | 'updated_at'>>\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // If updating YouTube URL, parse it first\r\n    if (updates.video_url) {\r\n      const parsed = parseYouTube(updates.video_url);\r\n      if (parsed.error) {\r\n        return { data: null, error: parsed.error };\r\n      }\r\n      updates.youtube_video_id = parsed.videoId;\r\n      updates.video_url = parsed.embedUrl;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteLesson(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('lessons')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderLessons(moduleId: string, lessonIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all lessons with their new positions in a single transaction\r\n    const updates = lessonIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('lessons')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('module_id', moduleId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MAwLsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,gDAAA"}},
    {"offset": {"line": 515, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/courseActions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\nimport { revalidatePath } from 'next/cache';\r\nimport { parseYouTube } from '@/lib/youtubeParser';\r\n\r\n// Type definitions\r\ntype Course = {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\ntype Module = {\r\n  id: string;\r\n  course_id: string;\r\n  title: string;\r\n  order_index: number;\r\n};\r\n\r\ntype Lesson = {\r\n  id: string;\r\n  module_id: string;\r\n  title: string;\r\n  description: string;\r\n  order_index: number;\r\n  video_provider: string;\r\n  video_url: string | null;\r\n  youtube_video_id: string | null;\r\n  is_preview: boolean;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin' || profile.role === 'teacher';\r\n}\r\n\r\n// Course Actions\r\nexport async function listCourses(): Promise<{ data: Course[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: listCourses - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: listCourses - Fetching all courses for admin');\r\n    \r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n    \r\n    console.log('DEBUG: listCourses - Query result:', { data: data?.length, error });\r\n    \r\n    if (error) {\r\n      console.error('DEBUG: listCourses - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    console.log('DEBUG: listCourses - Returning courses:', data?.length);\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: listCourses - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createCourse(title: string, description: string): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: createCourse - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: createCourse - Creating course:', { title, description });\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .insert([{ title, description }])\r\n      .select()\r\n      .single();\r\n    \r\n    console.log('DEBUG: createCourse - Insert result:', { data: !!data, error });\r\n\r\n    if (error) {\r\n      console.error('DEBUG: createCourse - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    console.log('DEBUG: createCourse - Course created successfully, cache invalidated');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: createCourse - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateCourse(id: string, updates: Partial<Course>): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteCourse(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('courses')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function publishCourse(id: string, isPublished: boolean): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update({ is_published: isPublished })\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\n// Module Actions\r\nexport async function listModules(courseId: string): Promise<{ data: Module[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .select('*')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createModule(courseId: string, title: string): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingModules } = await supabase\r\n      .from('modules')\r\n      .select('order_index')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingModules && existingModules.length > 0 \r\n      ? existingModules[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .insert([{ course_id: courseId, title, order_index: newOrderIndex }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateModule(id: string, updates: Partial<Module>): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteModule(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('modules')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderModules(courseId: string, moduleIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all modules with their new positions in a single transaction\r\n    const updates = moduleIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('modules')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('course_id', courseId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\n// Lesson Actions\r\nexport async function listLessons(moduleId: string): Promise<{ data: Lesson[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .select('*')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createLesson(\r\n  moduleId: string, \r\n  title: string, \r\n  description: string, \r\n  youtubeUrl: string\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Parse the YouTube URL\r\n    const parsed = parseYouTube(youtubeUrl);\r\n    if (parsed.error) {\r\n      return { data: null, error: parsed.error };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingLessons } = await supabase\r\n      .from('lessons')\r\n      .select('order_index')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingLessons && existingLessons.length > 0 \r\n      ? existingLessons[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .insert([{\r\n        module_id: moduleId,\r\n        title,\r\n        description,\r\n        youtube_video_id: parsed.videoId,\r\n        video_url: parsed.embedUrl,\r\n        order_index: newOrderIndex,\r\n        is_preview: false,\r\n        is_published: true\r\n      }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateLesson(\r\n  id: string, \r\n  updates: Partial<Omit<Lesson, 'id' | 'module_id' | 'created_at' | 'updated_at'>>\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // If updating YouTube URL, parse it first\r\n    if (updates.video_url) {\r\n      const parsed = parseYouTube(updates.video_url);\r\n      if (parsed.error) {\r\n        return { data: null, error: parsed.error };\r\n      }\r\n      updates.youtube_video_id = parsed.videoId;\r\n      updates.video_url = parsed.embedUrl;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteLesson(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('lessons')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderLessons(moduleId: string, lessonIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all lessons with their new positions in a single transaction\r\n    const updates = lessonIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('lessons')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('module_id', moduleId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MAqNsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,iDAAA"}},
    {"offset": {"line": 532, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/components/admin/CourseList.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Course } from '@/types/course';\r\nimport { listCourses, createCourse, updateCourse, deleteCourse, publishCourse } from '@/actions/courseActions';\r\nimport { PlusIcon, TrashIcon, EyeIcon, EyeOffIcon } from 'lucide-react';\r\n\r\ninterface CourseListProps {\r\n  selectedCourseId: string | null;\r\n  onSelectCourse: (courseId: string | null) => void;\r\n  onCourseCreated: () => void;\r\n  onCourseUpdated: () => void;\r\n}\r\n\r\nconst CourseList = ({ \r\n  selectedCourseId, \r\n  onSelectCourse, \r\n  onCourseCreated,\r\n  onCourseUpdated\r\n}: CourseListProps) => {\r\n  const [courses, setCourses] = useState<Course[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [newCourseTitle, setNewCourseTitle] = useState('');\r\n  const [newCourseDescription, setNewCourseDescription] = useState('');\r\n  const [showCreateForm, setShowCreateForm] = useState(false);\r\n\r\n  useEffect(() => {\r\n    loadCourses();\r\n  }, []);\r\n\r\n  const loadCourses = async () => {\r\n    console.log('DEBUG: CourseList - Loading courses');\r\n    setLoading(true);\r\n    setError(null);\r\n    try {\r\n      const result = await listCourses();\r\n      console.log('DEBUG: CourseList - listCourses result:', result);\r\n      if (result.error) {\r\n        console.error('DEBUG: CourseList - Error loading courses:', result.error);\r\n        setError(result.error);\r\n      } else if (result.data) {\r\n        console.log('DEBUG: CourseList - Loaded courses:', result.data);\r\n        setCourses(result.data);\r\n      }\r\n    } catch (err) {\r\n      console.error('DEBUG: CourseList - Exception loading courses:', err);\r\n      setError('Failed to load courses');\r\n    } finally {\r\n      console.log('DEBUG: CourseList - Finished loading courses, loading state:', false);\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleCreateCourse = async () => {\r\n    if (!newCourseTitle.trim()) {\r\n      setError('Course title is required');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      console.log('DEBUG: CourseList - Creating course:', newCourseTitle, newCourseDescription);\r\n      const result = await createCourse(newCourseTitle, newCourseDescription);\r\n      console.log('DEBUG: CourseList - Create course result:', result);\r\n      if (result.error) {\r\n        console.error('DEBUG: CourseList - Error creating course:', result.error);\r\n        setError(result.error);\r\n      } else if (result.data) {\r\n        console.log('DEBUG: CourseList - Course created successfully:', result.data);\r\n        setCourses([...courses, result.data]);\r\n        setNewCourseTitle('');\r\n        setNewCourseDescription('');\r\n        setShowCreateForm(false);\r\n        console.log('DEBUG: CourseList - Calling onCourseCreated callback');\r\n        onCourseCreated();\r\n      }\r\n    } catch (err) {\r\n      console.error('DEBUG: CourseList - Exception creating course:', err);\r\n      setError('Failed to create course');\r\n    }\r\n  };\r\n\r\n  const handleDeleteCourse = async (id: string) => {\r\n    if (!confirm('Are you sure you want to delete this course? This will also delete all modules and lessons.')) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const result = await deleteCourse(id);\r\n      if (result.error) {\r\n        setError(result.error);\r\n      } else {\r\n        setCourses(courses.filter(course => course.id !== id));\r\n        if (selectedCourseId === id) {\r\n          onSelectCourse(null);\r\n        }\r\n        onCourseUpdated();\r\n      }\r\n    } catch (err) {\r\n      setError('Failed to delete course');\r\n    }\r\n  };\r\n\r\n  const handleTogglePublish = async (id: string, isPublished: boolean) => {\r\n    try {\r\n      const result = await publishCourse(id, !isPublished);\r\n      if (result.error) {\r\n        setError(result.error);\r\n      } else if (result.data) {\r\n        setCourses(courses.map(course => \r\n          course.id === id ? result.data! : course\r\n        ));\r\n        onCourseUpdated();\r\n        \r\n        // After publish/unpublish, refresh the admin list and trigger public UI refresh\r\n        if (result.data.is_published && !isPublished) {\r\n          // Course was just published - make it visible to students immediately\r\n          console.log('Course published - refreshing UI');\r\n        } else if (!result.data.is_published && isPublished) {\r\n          // Course was just unpublished - hide it from students\r\n          console.log('Course unpublished - updating UI');\r\n        }\r\n      }\r\n    } catch (err) {\r\n      setError('Failed to update course publication status');\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"border-r border-gray-700 h-full flex flex-col\">\r\n      <div className=\"p-4 border-b border-gray-700\">\r\n        <div className=\"flex justify-between items-center mb-4\">\r\n          <h3 className=\"text-lg font-semibold text-white\">Courses</h3>\r\n          <button\r\n            onClick={() => setShowCreateForm(!showCreateForm)}\r\n            className=\"bg-accent-primary hover:bg-accent-primary/90 text-white px-3 py-1 rounded-md text-sm font-medium transition-colors hover-lift border border-accent-primary\"\r\n          >\r\n            <PlusIcon size={16} />\r\n          </button>\r\n        </div>\r\n\r\n        {showCreateForm && (\r\n          <div className=\"mb-4 p-3 bg-gray-800 rounded-lg\">\r\n            <input\r\n              type=\"text\"\r\n              value={newCourseTitle}\r\n              onChange={(e) => setNewCourseTitle(e.target.value)}\r\n              placeholder=\"Course title\"\r\n              className=\"w-full p-2 mb-2 rounded bg-gray-700 border border-gray-600 text-white\"\r\n            />\r\n            <textarea\r\n              value={newCourseDescription}\r\n              onChange={(e) => setNewCourseDescription(e.target.value)}\r\n              placeholder=\"Course description\"\r\n              className=\"w-full p-2 mb-2 rounded bg-gray-700 border border-gray-600 text-white\"\r\n              rows={2}\r\n            />\r\n            <div className=\"flex gap-2\">\r\n              <button\r\n                onClick={handleCreateCourse}\r\n                className=\"bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm hover-lift\"\r\n              >\r\n                Create\r\n              </button>\r\n              <button\r\n                onClick={() => {\r\n                  setShowCreateForm(false);\r\n                  setNewCourseTitle('');\r\n                  setNewCourseDescription('');\r\n                }}\r\n                className=\"bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm hover-lift\"\r\n              >\r\n                Cancel\r\n              </button>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {error && (\r\n          <div className=\"mb-4 p-2 bg-red-900/30 border border-red-700 rounded text-red-300 text-sm\">\r\n            {error}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"flex-1 overflow-y-auto\">\r\n        {loading ? (\r\n          <div className=\"p-4 text-center text-gray-400\">Loading courses...</div>\r\n        ) : courses.length === 0 ? (\r\n          <div className=\"p-4 text-center text-gray-400\">No courses found</div>\r\n        ) : (\r\n          <ul className=\"divide-y divide-gray-700\">\r\n            {courses.map((course) => (\r\n              <li \r\n                key={course.id}\r\n                className={`p-3 cursor-pointer transition-colors ${\r\n                  selectedCourseId === course.id \r\n                    ? 'bg-accent-primary/10 border-l-4 border-accent-primary' \r\n                    : 'hover:bg-gray-800/50'\r\n                }`}\r\n                onClick={() => onSelectCourse(course.id)}\r\n              >\r\n                <div className=\"flex justify-between items-start\">\r\n                  <div className=\"flex-1 min-w-0\">\r\n                    <h4 className=\"font-medium text-white truncate\">{course.title}</h4>\r\n                    <p className=\"text-xs text-gray-400 truncate\">{course.description}</p>\r\n                    <div className=\"mt-1 flex items-center gap-2\">\r\n                      <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${\r\n                        course.is_published \r\n                          ? 'bg-green-900/30 text-green-400 border border-green-800' \r\n                          : 'bg-yellow-900/30 text-yellow-400 border border-yellow-800'\r\n                      }`}>\r\n                        {course.is_published ? 'Published' : 'Draft'}\r\n                      </span>\r\n                      <span className=\"text-xs text-gray-500\">\r\n                        {new Date(course.created_at).toLocaleDateString()}\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n                  <div className=\"flex gap-1 ml-2\">\r\n                    <button\r\n                      onClick={(e) => {\r\n                        e.stopPropagation();\r\n                        handleTogglePublish(course.id, course.is_published);\r\n                      }}\r\n                      className={`p-1 rounded hover-lift ${\r\n                        course.is_published \r\n                          ? 'text-green-400 hover:bg-green-900/20' \r\n                          : 'text-gray-400 hover:bg-gray-700'\r\n                      }`}\r\n                      title={course.is_published ? 'Unpublish' : 'Publish'}\r\n                    >\r\n                      {course.is_published ? <EyeOffIcon size={14} /> : <EyeIcon size={14} />}\r\n                    </button>\r\n                    <button\r\n                      onClick={(e) => {\r\n                        e.stopPropagation();\r\n                        handleDeleteCourse(course.id);\r\n                      }}\r\n                      className=\"p-1 rounded text-red-400 hover:bg-red-900/20 hover-lift\"\r\n                      title=\"Delete\"\r\n                    >\r\n                      <TrashIcon size={14} />\r\n                    </button>\r\n                  </div>\r\n                </div>\r\n              </li>\r\n            ))}\r\n          </ul>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default CourseList;"],"names":[],"mappings":";;;;;AAEA;AAEA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;;;AALA;;;;AAcA,MAAM,aAAa,CAAC,EAClB,gBAAgB,EAChB,cAAc,EACd,eAAe,EACf,eAAe,EACC;;IAChB,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,yKAAQ,EAAW,EAAE;IACnD,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,yKAAQ,EAAC;IACvC,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,yKAAQ,EAAgB;IAClD,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,IAAA,yKAAQ,EAAC;IACrD,MAAM,CAAC,sBAAsB,wBAAwB,GAAG,IAAA,yKAAQ,EAAC;IACjE,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,IAAA,yKAAQ,EAAC;IAErD,IAAA,0KAAS;gCAAC;YACR;QACF;+BAAG,EAAE;IAEL,MAAM,cAAc;QAClB,QAAQ,GAAG,CAAC;QACZ,WAAW;QACX,SAAS;QACT,IAAI;YACF,MAAM,SAAS,MAAM,IAAA,wKAAW;YAChC,QAAQ,GAAG,CAAC,2CAA2C;YACvD,IAAI,OAAO,KAAK,EAAE;gBAChB,QAAQ,KAAK,CAAC,8CAA8C,OAAO,KAAK;gBACxE,SAAS,OAAO,KAAK;YACvB,OAAO,IAAI,OAAO,IAAI,EAAE;gBACtB,QAAQ,GAAG,CAAC,uCAAuC,OAAO,IAAI;gBAC9D,WAAW,OAAO,IAAI;YACxB;QACF,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,kDAAkD;YAChE,SAAS;QACX,SAAU;YACR,QAAQ,GAAG,CAAC,gEAAgE;YAC5E,WAAW;QACb;IACF;IAEA,MAAM,qBAAqB;QACzB,IAAI,CAAC,eAAe,IAAI,IAAI;YAC1B,SAAS;YACT;QACF;QAEA,IAAI;YACF,QAAQ,GAAG,CAAC,wCAAwC,gBAAgB;YACpE,MAAM,SAAS,MAAM,IAAA,yKAAY,EAAC,gBAAgB;YAClD,QAAQ,GAAG,CAAC,6CAA6C;YACzD,IAAI,OAAO,KAAK,EAAE;gBAChB,QAAQ,KAAK,CAAC,8CAA8C,OAAO,KAAK;gBACxE,SAAS,OAAO,KAAK;YACvB,OAAO,IAAI,OAAO,IAAI,EAAE;gBACtB,QAAQ,GAAG,CAAC,oDAAoD,OAAO,IAAI;gBAC3E,WAAW;uBAAI;oBAAS,OAAO,IAAI;iBAAC;gBACpC,kBAAkB;gBAClB,wBAAwB;gBACxB,kBAAkB;gBAClB,QAAQ,GAAG,CAAC;gBACZ;YACF;QACF,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,kDAAkD;YAChE,SAAS;QACX;IACF;IAEA,MAAM,qBAAqB,OAAO;QAChC,IAAI,CAAC,QAAQ,gGAAgG;YAC3G;QACF;QAEA,IAAI;YACF,MAAM,SAAS,MAAM,IAAA,yKAAY,EAAC;YAClC,IAAI,OAAO,KAAK,EAAE;gBAChB,SAAS,OAAO,KAAK;YACvB,OAAO;gBACL,WAAW,QAAQ,MAAM,CAAC,CAAA,SAAU,OAAO,EAAE,KAAK;gBAClD,IAAI,qBAAqB,IAAI;oBAC3B,eAAe;gBACjB;gBACA;YACF;QACF,EAAE,OAAO,KAAK;YACZ,SAAS;QACX;IACF;IAEA,MAAM,sBAAsB,OAAO,IAAY;QAC7C,IAAI;YACF,MAAM,SAAS,MAAM,IAAA,0KAAa,EAAC,IAAI,CAAC;YACxC,IAAI,OAAO,KAAK,EAAE;gBAChB,SAAS,OAAO,KAAK;YACvB,OAAO,IAAI,OAAO,IAAI,EAAE;gBACtB,WAAW,QAAQ,GAAG,CAAC,CAAA,SACrB,OAAO,EAAE,KAAK,KAAK,OAAO,IAAI,GAAI;gBAEpC;gBAEA,gFAAgF;gBAChF,IAAI,OAAO,IAAI,CAAC,YAAY,IAAI,CAAC,aAAa;oBAC5C,sEAAsE;oBACtE,QAAQ,GAAG,CAAC;gBACd,OAAO,IAAI,CAAC,OAAO,IAAI,CAAC,YAAY,IAAI,aAAa;oBACnD,sDAAsD;oBACtD,QAAQ,GAAG,CAAC;gBACd;YACF;QACF,EAAE,OAAO,KAAK;YACZ,SAAS;QACX;IACF;IAEA,qBACE,6LAAC;QAAI,WAAU;;0BACb,6LAAC;gBAAI,WAAU;;kCACb,6LAAC;wBAAI,WAAU;;0CACb,6LAAC;gCAAG,WAAU;0CAAmC;;;;;;0CACjD,6LAAC;gCACC,SAAS,IAAM,kBAAkB,CAAC;gCAClC,WAAU;0CAEV,cAAA,6LAAC,qNAAQ;oCAAC,MAAM;;;;;;;;;;;;;;;;;oBAInB,gCACC,6LAAC;wBAAI,WAAU;;0CACb,6LAAC;gCACC,MAAK;gCACL,OAAO;gCACP,UAAU,CAAC,IAAM,kBAAkB,EAAE,MAAM,CAAC,KAAK;gCACjD,aAAY;gCACZ,WAAU;;;;;;0CAEZ,6LAAC;gCACC,OAAO;gCACP,UAAU,CAAC,IAAM,wBAAwB,EAAE,MAAM,CAAC,KAAK;gCACvD,aAAY;gCACZ,WAAU;gCACV,MAAM;;;;;;0CAER,6LAAC;gCAAI,WAAU;;kDACb,6LAAC;wCACC,SAAS;wCACT,WAAU;kDACX;;;;;;kDAGD,6LAAC;wCACC,SAAS;4CACP,kBAAkB;4CAClB,kBAAkB;4CAClB,wBAAwB;wCAC1B;wCACA,WAAU;kDACX;;;;;;;;;;;;;;;;;;oBAON,uBACC,6LAAC;wBAAI,WAAU;kCACZ;;;;;;;;;;;;0BAKP,6LAAC;gBAAI,WAAU;0BACZ,wBACC,6LAAC;oBAAI,WAAU;8BAAgC;;;;;+DAC7C,QAAQ,MAAM,KAAK,kBACrB,6LAAC;oBAAI,WAAU;8BAAgC;;;;;6EAE/C,6LAAC;oBAAG,WAAU;8BACX,QAAQ,GAAG,CAAC,CAAC,uBACZ,6LAAC;4BAEC,WAAW,CAAC,qCAAqC,EAC/C,qBAAqB,OAAO,EAAE,GAC1B,0DACA,wBACJ;4BACF,SAAS,IAAM,eAAe,OAAO,EAAE;sCAEvC,cAAA,6LAAC;gCAAI,WAAU;;kDACb,6LAAC;wCAAI,WAAU;;0DACb,6LAAC;gDAAG,WAAU;0DAAmC,OAAO,KAAK;;;;;;0DAC7D,6LAAC;gDAAE,WAAU;0DAAkC,OAAO,WAAW;;;;;;0DACjE,6LAAC;gDAAI,WAAU;;kEACb,6LAAC;wDAAK,WAAW,CAAC,sEAAsE,EACtF,OAAO,YAAY,GACf,2DACA,6DACJ;kEACC,OAAO,YAAY,GAAG,cAAc;;;;;;kEAEvC,6LAAC;wDAAK,WAAU;kEACb,IAAI,KAAK,OAAO,UAAU,EAAE,kBAAkB;;;;;;;;;;;;;;;;;;kDAIrD,6LAAC;wCAAI,WAAU;;0DACb,6LAAC;gDACC,SAAS,CAAC;oDACR,EAAE,eAAe;oDACjB,oBAAoB,OAAO,EAAE,EAAE,OAAO,YAAY;gDACpD;gDACA,WAAW,CAAC,uBAAuB,EACjC,OAAO,YAAY,GACf,yCACA,mCACJ;gDACF,OAAO,OAAO,YAAY,GAAG,cAAc;0DAE1C,OAAO,YAAY,iBAAG,6LAAC,+NAAU;oDAAC,MAAM;;;;;6GAAS,6LAAC,kNAAO;oDAAC,MAAM;;;;;;;;;;;0DAEnE,6LAAC;gDACC,SAAS,CAAC;oDACR,EAAE,eAAe;oDACjB,mBAAmB,OAAO,EAAE;gDAC9B;gDACA,WAAU;gDACV,OAAM;0DAEN,cAAA,6LAAC,wNAAS;oDAAC,MAAM;;;;;;;;;;;;;;;;;;;;;;;2BAhDlB,OAAO,EAAE;;;;;;;;;;;;;;;;;;;;;AA2D9B;GA/OM;KAAA;uCAiPS"}},
    {"offset": {"line": 937, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/courseActions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\nimport { revalidatePath } from 'next/cache';\r\nimport { parseYouTube } from '@/lib/youtubeParser';\r\n\r\n// Type definitions\r\ntype Course = {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\ntype Module = {\r\n  id: string;\r\n  course_id: string;\r\n  title: string;\r\n  order_index: number;\r\n};\r\n\r\ntype Lesson = {\r\n  id: string;\r\n  module_id: string;\r\n  title: string;\r\n  description: string;\r\n  order_index: number;\r\n  video_provider: string;\r\n  video_url: string | null;\r\n  youtube_video_id: string | null;\r\n  is_preview: boolean;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin' || profile.role === 'teacher';\r\n}\r\n\r\n// Course Actions\r\nexport async function listCourses(): Promise<{ data: Course[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: listCourses - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: listCourses - Fetching all courses for admin');\r\n    \r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n    \r\n    console.log('DEBUG: listCourses - Query result:', { data: data?.length, error });\r\n    \r\n    if (error) {\r\n      console.error('DEBUG: listCourses - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    console.log('DEBUG: listCourses - Returning courses:', data?.length);\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: listCourses - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createCourse(title: string, description: string): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: createCourse - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: createCourse - Creating course:', { title, description });\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .insert([{ title, description }])\r\n      .select()\r\n      .single();\r\n    \r\n    console.log('DEBUG: createCourse - Insert result:', { data: !!data, error });\r\n\r\n    if (error) {\r\n      console.error('DEBUG: createCourse - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    console.log('DEBUG: createCourse - Course created successfully, cache invalidated');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: createCourse - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateCourse(id: string, updates: Partial<Course>): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteCourse(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('courses')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function publishCourse(id: string, isPublished: boolean): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update({ is_published: isPublished })\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\n// Module Actions\r\nexport async function listModules(courseId: string): Promise<{ data: Module[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .select('*')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createModule(courseId: string, title: string): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingModules } = await supabase\r\n      .from('modules')\r\n      .select('order_index')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingModules && existingModules.length > 0 \r\n      ? existingModules[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .insert([{ course_id: courseId, title, order_index: newOrderIndex }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateModule(id: string, updates: Partial<Module>): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteModule(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('modules')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderModules(courseId: string, moduleIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all modules with their new positions in a single transaction\r\n    const updates = moduleIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('modules')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('course_id', courseId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\n// Lesson Actions\r\nexport async function listLessons(moduleId: string): Promise<{ data: Lesson[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .select('*')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createLesson(\r\n  moduleId: string, \r\n  title: string, \r\n  description: string, \r\n  youtubeUrl: string\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Parse the YouTube URL\r\n    const parsed = parseYouTube(youtubeUrl);\r\n    if (parsed.error) {\r\n      return { data: null, error: parsed.error };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingLessons } = await supabase\r\n      .from('lessons')\r\n      .select('order_index')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingLessons && existingLessons.length > 0 \r\n      ? existingLessons[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .insert([{\r\n        module_id: moduleId,\r\n        title,\r\n        description,\r\n        youtube_video_id: parsed.videoId,\r\n        video_url: parsed.embedUrl,\r\n        order_index: newOrderIndex,\r\n        is_preview: false,\r\n        is_published: true\r\n      }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateLesson(\r\n  id: string, \r\n  updates: Partial<Omit<Lesson, 'id' | 'module_id' | 'created_at' | 'updated_at'>>\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // If updating YouTube URL, parse it first\r\n    if (updates.video_url) {\r\n      const parsed = parseYouTube(updates.video_url);\r\n      if (parsed.error) {\r\n        return { data: null, error: parsed.error };\r\n      }\r\n      updates.youtube_video_id = parsed.videoId;\r\n      updates.video_url = parsed.embedUrl;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteLesson(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('lessons')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderLessons(moduleId: string, lessonIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all lessons with their new positions in a single transaction\r\n    const updates = lessonIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('lessons')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('module_id', moduleId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MAqPsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,+CAAA"}},
    {"offset": {"line": 954, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/courseActions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\nimport { revalidatePath } from 'next/cache';\r\nimport { parseYouTube } from '@/lib/youtubeParser';\r\n\r\n// Type definitions\r\ntype Course = {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\ntype Module = {\r\n  id: string;\r\n  course_id: string;\r\n  title: string;\r\n  order_index: number;\r\n};\r\n\r\ntype Lesson = {\r\n  id: string;\r\n  module_id: string;\r\n  title: string;\r\n  description: string;\r\n  order_index: number;\r\n  video_provider: string;\r\n  video_url: string | null;\r\n  youtube_video_id: string | null;\r\n  is_preview: boolean;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin' || profile.role === 'teacher';\r\n}\r\n\r\n// Course Actions\r\nexport async function listCourses(): Promise<{ data: Course[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: listCourses - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: listCourses - Fetching all courses for admin');\r\n    \r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n    \r\n    console.log('DEBUG: listCourses - Query result:', { data: data?.length, error });\r\n    \r\n    if (error) {\r\n      console.error('DEBUG: listCourses - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    console.log('DEBUG: listCourses - Returning courses:', data?.length);\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: listCourses - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createCourse(title: string, description: string): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: createCourse - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: createCourse - Creating course:', { title, description });\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .insert([{ title, description }])\r\n      .select()\r\n      .single();\r\n    \r\n    console.log('DEBUG: createCourse - Insert result:', { data: !!data, error });\r\n\r\n    if (error) {\r\n      console.error('DEBUG: createCourse - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    console.log('DEBUG: createCourse - Course created successfully, cache invalidated');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: createCourse - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateCourse(id: string, updates: Partial<Course>): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteCourse(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('courses')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function publishCourse(id: string, isPublished: boolean): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update({ is_published: isPublished })\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\n// Module Actions\r\nexport async function listModules(courseId: string): Promise<{ data: Module[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .select('*')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createModule(courseId: string, title: string): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingModules } = await supabase\r\n      .from('modules')\r\n      .select('order_index')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingModules && existingModules.length > 0 \r\n      ? existingModules[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .insert([{ course_id: courseId, title, order_index: newOrderIndex }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateModule(id: string, updates: Partial<Module>): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteModule(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('modules')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderModules(courseId: string, moduleIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all modules with their new positions in a single transaction\r\n    const updates = moduleIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('modules')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('course_id', courseId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\n// Lesson Actions\r\nexport async function listLessons(moduleId: string): Promise<{ data: Lesson[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .select('*')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createLesson(\r\n  moduleId: string, \r\n  title: string, \r\n  description: string, \r\n  youtubeUrl: string\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Parse the YouTube URL\r\n    const parsed = parseYouTube(youtubeUrl);\r\n    if (parsed.error) {\r\n      return { data: null, error: parsed.error };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingLessons } = await supabase\r\n      .from('lessons')\r\n      .select('order_index')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingLessons && existingLessons.length > 0 \r\n      ? existingLessons[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .insert([{\r\n        module_id: moduleId,\r\n        title,\r\n        description,\r\n        youtube_video_id: parsed.videoId,\r\n        video_url: parsed.embedUrl,\r\n        order_index: newOrderIndex,\r\n        is_preview: false,\r\n        is_published: true\r\n      }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateLesson(\r\n  id: string, \r\n  updates: Partial<Omit<Lesson, 'id' | 'module_id' | 'created_at' | 'updated_at'>>\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // If updating YouTube URL, parse it first\r\n    if (updates.video_url) {\r\n      const parsed = parseYouTube(updates.video_url);\r\n      if (parsed.error) {\r\n        return { data: null, error: parsed.error };\r\n      }\r\n      updates.youtube_video_id = parsed.videoId;\r\n      updates.video_url = parsed.embedUrl;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteLesson(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('lessons')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderLessons(moduleId: string, lessonIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all lessons with their new positions in a single transaction\r\n    const updates = lessonIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('lessons')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('module_id', moduleId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MA+QsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,gDAAA"}},
    {"offset": {"line": 971, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/courseActions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\nimport { revalidatePath } from 'next/cache';\r\nimport { parseYouTube } from '@/lib/youtubeParser';\r\n\r\n// Type definitions\r\ntype Course = {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\ntype Module = {\r\n  id: string;\r\n  course_id: string;\r\n  title: string;\r\n  order_index: number;\r\n};\r\n\r\ntype Lesson = {\r\n  id: string;\r\n  module_id: string;\r\n  title: string;\r\n  description: string;\r\n  order_index: number;\r\n  video_provider: string;\r\n  video_url: string | null;\r\n  youtube_video_id: string | null;\r\n  is_preview: boolean;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin' || profile.role === 'teacher';\r\n}\r\n\r\n// Course Actions\r\nexport async function listCourses(): Promise<{ data: Course[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: listCourses - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: listCourses - Fetching all courses for admin');\r\n    \r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n    \r\n    console.log('DEBUG: listCourses - Query result:', { data: data?.length, error });\r\n    \r\n    if (error) {\r\n      console.error('DEBUG: listCourses - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    console.log('DEBUG: listCourses - Returning courses:', data?.length);\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: listCourses - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createCourse(title: string, description: string): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: createCourse - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: createCourse - Creating course:', { title, description });\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .insert([{ title, description }])\r\n      .select()\r\n      .single();\r\n    \r\n    console.log('DEBUG: createCourse - Insert result:', { data: !!data, error });\r\n\r\n    if (error) {\r\n      console.error('DEBUG: createCourse - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    console.log('DEBUG: createCourse - Course created successfully, cache invalidated');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: createCourse - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateCourse(id: string, updates: Partial<Course>): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteCourse(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('courses')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function publishCourse(id: string, isPublished: boolean): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update({ is_published: isPublished })\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\n// Module Actions\r\nexport async function listModules(courseId: string): Promise<{ data: Module[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .select('*')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createModule(courseId: string, title: string): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingModules } = await supabase\r\n      .from('modules')\r\n      .select('order_index')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingModules && existingModules.length > 0 \r\n      ? existingModules[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .insert([{ course_id: courseId, title, order_index: newOrderIndex }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateModule(id: string, updates: Partial<Module>): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteModule(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('modules')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderModules(courseId: string, moduleIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all modules with their new positions in a single transaction\r\n    const updates = moduleIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('modules')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('course_id', courseId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\n// Lesson Actions\r\nexport async function listLessons(moduleId: string): Promise<{ data: Lesson[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .select('*')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createLesson(\r\n  moduleId: string, \r\n  title: string, \r\n  description: string, \r\n  youtubeUrl: string\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Parse the YouTube URL\r\n    const parsed = parseYouTube(youtubeUrl);\r\n    if (parsed.error) {\r\n      return { data: null, error: parsed.error };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingLessons } = await supabase\r\n      .from('lessons')\r\n      .select('order_index')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingLessons && existingLessons.length > 0 \r\n      ? existingLessons[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .insert([{\r\n        module_id: moduleId,\r\n        title,\r\n        description,\r\n        youtube_video_id: parsed.videoId,\r\n        video_url: parsed.embedUrl,\r\n        order_index: newOrderIndex,\r\n        is_preview: false,\r\n        is_published: true\r\n      }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateLesson(\r\n  id: string, \r\n  updates: Partial<Omit<Lesson, 'id' | 'module_id' | 'created_at' | 'updated_at'>>\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // If updating YouTube URL, parse it first\r\n    if (updates.video_url) {\r\n      const parsed = parseYouTube(updates.video_url);\r\n      if (parsed.error) {\r\n        return { data: null, error: parsed.error };\r\n      }\r\n      updates.youtube_video_id = parsed.videoId;\r\n      updates.video_url = parsed.embedUrl;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteLesson(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('lessons')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderLessons(moduleId: string, lessonIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all lessons with their new positions in a single transaction\r\n    const updates = lessonIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('lessons')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('module_id', moduleId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MAwVsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,gDAAA"}},
    {"offset": {"line": 988, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/courseActions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\nimport { revalidatePath } from 'next/cache';\r\nimport { parseYouTube } from '@/lib/youtubeParser';\r\n\r\n// Type definitions\r\ntype Course = {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\ntype Module = {\r\n  id: string;\r\n  course_id: string;\r\n  title: string;\r\n  order_index: number;\r\n};\r\n\r\ntype Lesson = {\r\n  id: string;\r\n  module_id: string;\r\n  title: string;\r\n  description: string;\r\n  order_index: number;\r\n  video_provider: string;\r\n  video_url: string | null;\r\n  youtube_video_id: string | null;\r\n  is_preview: boolean;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin' || profile.role === 'teacher';\r\n}\r\n\r\n// Course Actions\r\nexport async function listCourses(): Promise<{ data: Course[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: listCourses - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: listCourses - Fetching all courses for admin');\r\n    \r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n    \r\n    console.log('DEBUG: listCourses - Query result:', { data: data?.length, error });\r\n    \r\n    if (error) {\r\n      console.error('DEBUG: listCourses - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    console.log('DEBUG: listCourses - Returning courses:', data?.length);\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: listCourses - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createCourse(title: string, description: string): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: createCourse - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: createCourse - Creating course:', { title, description });\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .insert([{ title, description }])\r\n      .select()\r\n      .single();\r\n    \r\n    console.log('DEBUG: createCourse - Insert result:', { data: !!data, error });\r\n\r\n    if (error) {\r\n      console.error('DEBUG: createCourse - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    console.log('DEBUG: createCourse - Course created successfully, cache invalidated');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: createCourse - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateCourse(id: string, updates: Partial<Course>): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteCourse(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('courses')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function publishCourse(id: string, isPublished: boolean): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update({ is_published: isPublished })\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\n// Module Actions\r\nexport async function listModules(courseId: string): Promise<{ data: Module[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .select('*')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createModule(courseId: string, title: string): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingModules } = await supabase\r\n      .from('modules')\r\n      .select('order_index')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingModules && existingModules.length > 0 \r\n      ? existingModules[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .insert([{ course_id: courseId, title, order_index: newOrderIndex }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateModule(id: string, updates: Partial<Module>): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteModule(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('modules')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderModules(courseId: string, moduleIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all modules with their new positions in a single transaction\r\n    const updates = moduleIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('modules')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('course_id', courseId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\n// Lesson Actions\r\nexport async function listLessons(moduleId: string): Promise<{ data: Lesson[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .select('*')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createLesson(\r\n  moduleId: string, \r\n  title: string, \r\n  description: string, \r\n  youtubeUrl: string\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Parse the YouTube URL\r\n    const parsed = parseYouTube(youtubeUrl);\r\n    if (parsed.error) {\r\n      return { data: null, error: parsed.error };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingLessons } = await supabase\r\n      .from('lessons')\r\n      .select('order_index')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingLessons && existingLessons.length > 0 \r\n      ? existingLessons[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .insert([{\r\n        module_id: moduleId,\r\n        title,\r\n        description,\r\n        youtube_video_id: parsed.videoId,\r\n        video_url: parsed.embedUrl,\r\n        order_index: newOrderIndex,\r\n        is_preview: false,\r\n        is_published: true\r\n      }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateLesson(\r\n  id: string, \r\n  updates: Partial<Omit<Lesson, 'id' | 'module_id' | 'created_at' | 'updated_at'>>\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // If updating YouTube URL, parse it first\r\n    if (updates.video_url) {\r\n      const parsed = parseYouTube(updates.video_url);\r\n      if (parsed.error) {\r\n        return { data: null, error: parsed.error };\r\n      }\r\n      updates.youtube_video_id = parsed.videoId;\r\n      updates.video_url = parsed.embedUrl;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteLesson(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('lessons')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderLessons(moduleId: string, lessonIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all lessons with their new positions in a single transaction\r\n    const updates = lessonIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('lessons')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('module_id', moduleId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MAqXsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,kDAAA"}},
    {"offset": {"line": 1005, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/components/admin/ModuleList.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Module } from '@/types/course';\r\nimport { listModules, createModule, updateModule, deleteModule } from '@/actions/courseActions';\r\nimport { PlusIcon, TrashIcon } from 'lucide-react';\r\nimport { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors, DragEndEvent } from '@dnd-kit/core';\r\nimport { arrayMove, SortableContext, sortableKeyboardCoordinates, useSortable, verticalListSortingStrategy } from '@dnd-kit/sortable';\r\nimport { CSS } from '@dnd-kit/utilities';\r\nimport { reorderModules } from '@/actions/courseActions';\r\n\r\ninterface ModuleListProps {\r\n  courseId: string | null;\r\n  selectedModuleId: string | null;\r\n  onSelectModule: (moduleId: string | null) => void;\r\n  onModuleCreated: () => void;\r\n  onModuleUpdated: () => void;\r\n}\r\n\r\n// Sortable Module Item Component\r\nconst SortableModuleItem = ({ \r\n  module, \r\n  isSelected, \r\n  onSelect,\r\n  onDelete\r\n}: { \r\n  module: Module; \r\n  isSelected: boolean; \r\n  onSelect: (id: string) => void;\r\n  onDelete: (id: string) => void;\r\n}) => {\r\n  const {\r\n    attributes,\r\n    listeners,\r\n    setNodeRef,\r\n    transform,\r\n    transition,\r\n    isDragging,\r\n  } = useSortable({ id: module.id });\r\n\r\n  const style = {\r\n    transform: CSS.Transform.toString(transform),\r\n    transition,\r\n    opacity: isDragging ? 0.5 : 1,\r\n  };\r\n\r\n  return (\r\n    <li\r\n      ref={setNodeRef}\r\n      style={style}\r\n      className={`p-3 cursor-pointer transition-colors ${\r\n        isSelected \r\n          ? 'bg-accent-primary/10 border-l-4 border-accent-primary' \r\n          : 'hover:bg-gray-800/50'\r\n      } ${isDragging ? 'shadow-lg' : ''}`}\r\n      onClick={() => onSelect(module.id)}\r\n    >\r\n      <div className=\"flex justify-between items-center\">\r\n        <div className=\"flex items-center gap-2\">\r\n          <button\r\n            {...attributes}\r\n            {...listeners}\r\n            className=\"cursor-grab active:cursor-grabbing text-gray-500 hover:text-gray-300 hover-lift\"\r\n            onClick={(e) => e.stopPropagation()}\r\n          >\r\n            <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\r\n              <circle cx=\"9\" cy=\"5\" r=\"1\"></circle>\r\n              <circle cx=\"9\" cy=\"12\" r=\"1\"></circle>\r\n              <circle cx=\"9\" cy=\"19\" r=\"1\"></circle>\r\n              <circle cx=\"15\" cy=\"5\" r=\"1\"></circle>\r\n              <circle cx=\"15\" cy=\"12\" r=\"1\"></circle>\r\n              <circle cx=\"15\" cy=\"19\" r=\"1\"></circle>\r\n            </svg>\r\n          </button>\r\n          <span className=\"font-medium text-white\">{module.title}</span>\r\n        </div>\r\n        <button\r\n          onClick={(e) => {\r\n            e.stopPropagation();\r\n            onDelete(module.id);\r\n          }}\r\n          className=\"p-1 rounded text-red-400 hover:bg-red-900/20 hover-lift\"\r\n          title=\"Delete\"\r\n        >\r\n          <TrashIcon size={14} />\r\n        </button>\r\n      </div>\r\n    </li>\r\n  );\r\n};\r\n\r\nconst ModuleList = ({ \r\n  courseId, \r\n  selectedModuleId, \r\n  onSelectModule, \r\n  onModuleCreated,\r\n  onModuleUpdated\r\n}: ModuleListProps) => {\r\n  const [modules, setModules] = useState<Module[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [newModuleTitle, setNewModuleTitle] = useState('');\r\n  const [showCreateForm, setShowCreateForm] = useState(false);\r\n\r\n  const sensors = useSensors(\r\n    useSensor(PointerSensor),\r\n    useSensor(KeyboardSensor, {\r\n      coordinateGetter: sortableKeyboardCoordinates,\r\n    })\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (courseId) {\r\n      loadModules();\r\n    } else {\r\n      setModules([]);\r\n      setLoading(false);\r\n    }\r\n  }, [courseId]);\r\n\r\n  const loadModules = async () => {\r\n    console.log('DEBUG: ModuleList - Loading modules for course:', courseId);\r\n    if (!courseId) return;\r\n    \r\n    setLoading(true);\r\n    setError(null);\r\n    try {\r\n      const result = await listModules(courseId);\r\n      console.log('DEBUG: ModuleList - listModules result:', result);\r\n      if (result.error) {\r\n        console.error('DEBUG: ModuleList - Error loading modules:', result.error);\r\n        setError(result.error);\r\n      } else if (result.data) {\r\n        console.log('DEBUG: ModuleList - Loaded modules:', result.data);\r\n        // Sort by order_index\r\n        const sortedModules = [...result.data].sort((a, b) => a.order_index - b.order_index);\r\n        setModules(sortedModules);\r\n      }\r\n    } catch (err) {\r\n      console.error('DEBUG: ModuleList - Exception loading modules:', err);\r\n      setError('Failed to load modules');\r\n    } finally {\r\n      console.log('DEBUG: ModuleList - Finished loading modules, loading state:', false);\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleCreateModule = async () => {\r\n    if (!newModuleTitle.trim()) {\r\n      setError('Module title is required');\r\n      return;\r\n    }\r\n\r\n    if (!courseId) {\r\n      setError('No course selected');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const result = await createModule(courseId, newModuleTitle);\r\n      if (result.error) {\r\n        setError(result.error);\r\n      } else if (result.data) {\r\n        setModules([...modules, result.data]);\r\n        setNewModuleTitle('');\r\n        setShowCreateForm(false);\r\n        onModuleCreated();\r\n      }\r\n    } catch (err) {\r\n      setError('Failed to create module');\r\n    }\r\n  };\r\n\r\n  const handleDeleteModule = async (id: string) => {\r\n    if (!confirm('Are you sure you want to delete this module? This will also delete all lessons in this module.')) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const result = await deleteModule(id);\r\n      if (result.error) {\r\n        setError(result.error);\r\n      } else {\r\n        setModules(modules.filter(module => module.id !== id));\r\n        if (selectedModuleId === id) {\r\n          onSelectModule(null);\r\n        }\r\n        onModuleUpdated();\r\n      }\r\n    } catch (err) {\r\n      setError('Failed to delete module');\r\n    }\r\n  };\r\n\r\n  const handleDragEnd = async (event: DragEndEvent) => {\r\n    const { active, over } = event;\r\n\r\n    if (over && active.id !== over.id) {\r\n      // Find the indices of the dragged and target items\r\n      const oldIndex = modules.findIndex(module => module.id === active.id);\r\n      const newIndex = modules.findIndex(module => module.id === over.id);\r\n\r\n      if (oldIndex !== -1 && newIndex !== -1) {\r\n        // Update the local state optimistically\r\n        const newModules = arrayMove(modules, oldIndex, newIndex);\r\n        setModules(newModules);\r\n\r\n        // Update the order on the server\r\n        const moduleIds = newModules.map(module => module.id);\r\n        const result = await reorderModules(courseId!, moduleIds);\r\n        if (result.error) {\r\n          setError(result.error);\r\n          // If reorder failed, revert the change\r\n          loadModules();\r\n        } else {\r\n          onModuleUpdated();\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"border-r border-gray-700 h-full flex flex-col\">\r\n      <div className=\"p-4 border-b border-gray-700\">\r\n        <div className=\"flex justify-between items-center mb-4\">\r\n          <h3 className=\"text-lg font-semibold text-white\">Modules</h3>\r\n          <button\r\n            onClick={() => setShowCreateForm(!showCreateForm)}\r\n            disabled={!courseId}\r\n            className={`hover-lift ${\r\n              courseId \r\n                ? 'bg-accent-primary hover:bg-accent-primary/90 text-white border border-accent-primary'\r\n                : 'bg-gray-700 text-gray-500 cursor-not-allowed'\r\n            } px-3 py-1 rounded-md text-sm font-medium transition-colors`}\r\n          >\r\n            <PlusIcon size={16} />\r\n          </button>\r\n        </div>\r\n\r\n        {showCreateForm && courseId && (\r\n          <div className=\"mb-4 p-3 bg-gray-800 rounded-lg\">\r\n            <input\r\n              type=\"text\"\r\n              value={newModuleTitle}\r\n              onChange={(e) => setNewModuleTitle(e.target.value)}\r\n              placeholder=\"Module title\"\r\n              className=\"w-full p-2 mb-2 rounded bg-gray-700 border border-gray-600 text-white\"\r\n            />\r\n            <div className=\"flex gap-2\">\r\n              <button\r\n                onClick={handleCreateModule}\r\n                className=\"bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm hover-lift\"\r\n              >\r\n                Create\r\n              </button>\r\n              <button\r\n                onClick={() => {\r\n                  setShowCreateForm(false);\r\n                  setNewModuleTitle('');\r\n                }}\r\n                className=\"bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm hover-lift\"\r\n              >\r\n                Cancel\r\n              </button>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {error && (\r\n          <div className=\"mb-4 p-2 bg-red-900/30 border border-red-700 rounded text-red-300 text-sm\">\r\n            {error}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"flex-1 overflow-y-auto\">\r\n        {loading ? (\r\n          <div className=\"p-4 text-center text-gray-400\">Loading modules...</div>\r\n        ) : modules.length === 0 ? (\r\n          <div className=\"p-4 text-center text-gray-400\">\r\n            {courseId ? 'No modules found' : 'Select a course to view modules'}\r\n          </div>\r\n        ) : (\r\n          <DndContext\r\n            sensors={sensors}\r\n            collisionDetection={closestCenter}\r\n            onDragEnd={handleDragEnd}\r\n          >\r\n            <SortableContext items={modules.map(m => m.id)} strategy={verticalListSortingStrategy}>\r\n              <ul className=\"divide-y divide-gray-700\">\r\n                {modules.map((module) => (\r\n                  <SortableModuleItem\r\n                    key={module.id}\r\n                    module={module}\r\n                    isSelected={selectedModuleId === module.id}\r\n                    onSelect={onSelectModule}\r\n                    onDelete={handleDeleteModule}\r\n                  />\r\n                ))}\r\n              </ul>\r\n            </SortableContext>\r\n          </DndContext>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default ModuleList;"],"names":[],"mappings":";;;;;AAEA;AAEA;AAAA;AAAA;AACA;AAAA;AACA;AACA;AACA;AACA;;;AATA;;;;;;;;AAmBA,iCAAiC;AACjC,MAAM,qBAAqB,CAAC,EAC1B,MAAM,EACN,UAAU,EACV,QAAQ,EACR,QAAQ,EAMT;;IACC,MAAM,EACJ,UAAU,EACV,SAAS,EACT,UAAU,EACV,SAAS,EACT,UAAU,EACV,UAAU,EACX,GAAG,IAAA,qLAAW,EAAC;QAAE,IAAI,OAAO,EAAE;IAAC;IAEhC,MAAM,QAAQ;QACZ,WAAW,+KAAG,CAAC,SAAS,CAAC,QAAQ,CAAC;QAClC;QACA,SAAS,aAAa,MAAM;IAC9B;IAEA,qBACE,6LAAC;QACC,KAAK;QACL,OAAO;QACP,WAAW,CAAC,qCAAqC,EAC/C,aACI,0DACA,uBACL,CAAC,EAAE,aAAa,cAAc,IAAI;QACnC,SAAS,IAAM,SAAS,OAAO,EAAE;kBAEjC,cAAA,6LAAC;YAAI,WAAU;;8BACb,6LAAC;oBAAI,WAAU;;sCACb,6LAAC;4BACE,GAAG,UAAU;4BACb,GAAG,SAAS;4BACb,WAAU;4BACV,SAAS,CAAC,IAAM,EAAE,eAAe;sCAEjC,cAAA,6LAAC;gCAAI,OAAM;gCAA6B,OAAM;gCAAK,QAAO;gCAAK,SAAQ;gCAAY,MAAK;gCAAO,QAAO;gCAAe,aAAY;gCAAI,eAAc;gCAAQ,gBAAe;;kDACxK,6LAAC;wCAAO,IAAG;wCAAI,IAAG;wCAAI,GAAE;;;;;;kDACxB,6LAAC;wCAAO,IAAG;wCAAI,IAAG;wCAAK,GAAE;;;;;;kDACzB,6LAAC;wCAAO,IAAG;wCAAI,IAAG;wCAAK,GAAE;;;;;;kDACzB,6LAAC;wCAAO,IAAG;wCAAK,IAAG;wCAAI,GAAE;;;;;;kDACzB,6LAAC;wCAAO,IAAG;wCAAK,IAAG;wCAAK,GAAE;;;;;;kDAC1B,6LAAC;wCAAO,IAAG;wCAAK,IAAG;wCAAK,GAAE;;;;;;;;;;;;;;;;;sCAG9B,6LAAC;4BAAK,WAAU;sCAA0B,OAAO,KAAK;;;;;;;;;;;;8BAExD,6LAAC;oBACC,SAAS,CAAC;wBACR,EAAE,eAAe;wBACjB,SAAS,OAAO,EAAE;oBACpB;oBACA,WAAU;oBACV,OAAM;8BAEN,cAAA,6LAAC,wNAAS;wBAAC,MAAM;;;;;;;;;;;;;;;;;;;;;;AAK3B;GArEM;;QAkBA,qLAAW;;;KAlBX;AAuEN,MAAM,aAAa,CAAC,EAClB,QAAQ,EACR,gBAAgB,EAChB,cAAc,EACd,eAAe,EACf,eAAe,EACC;;IAChB,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,yKAAQ,EAAW,EAAE;IACnD,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,yKAAQ,EAAC;IACvC,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,yKAAQ,EAAgB;IAClD,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,IAAA,yKAAQ,EAAC;IACrD,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,IAAA,yKAAQ,EAAC;IAErD,MAAM,UAAU,IAAA,4KAAU,EACxB,IAAA,2KAAS,EAAC,+KAAa,GACvB,IAAA,2KAAS,EAAC,gLAAc,EAAE;QACxB,kBAAkB,qMAA2B;IAC/C;IAGF,IAAA,0KAAS;gCAAC;YACR,IAAI,UAAU;gBACZ;YACF,OAAO;gBACL,WAAW,EAAE;gBACb,WAAW;YACb;QACF;+BAAG;QAAC;KAAS;IAEb,MAAM,cAAc;QAClB,QAAQ,GAAG,CAAC,mDAAmD;QAC/D,IAAI,CAAC,UAAU;QAEf,WAAW;QACX,SAAS;QACT,IAAI;YACF,MAAM,SAAS,MAAM,IAAA,wKAAW,EAAC;YACjC,QAAQ,GAAG,CAAC,2CAA2C;YACvD,IAAI,OAAO,KAAK,EAAE;gBAChB,QAAQ,KAAK,CAAC,8CAA8C,OAAO,KAAK;gBACxE,SAAS,OAAO,KAAK;YACvB,OAAO,IAAI,OAAO,IAAI,EAAE;gBACtB,QAAQ,GAAG,CAAC,uCAAuC,OAAO,IAAI;gBAC9D,sBAAsB;gBACtB,MAAM,gBAAgB;uBAAI,OAAO,IAAI;iBAAC,CAAC,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,WAAW,GAAG,EAAE,WAAW;gBACnF,WAAW;YACb;QACF,EAAE,OAAO,KAAK;YACZ,QAAQ,KAAK,CAAC,kDAAkD;YAChE,SAAS;QACX,SAAU;YACR,QAAQ,GAAG,CAAC,gEAAgE;YAC5E,WAAW;QACb;IACF;IAEA,MAAM,qBAAqB;QACzB,IAAI,CAAC,eAAe,IAAI,IAAI;YAC1B,SAAS;YACT;QACF;QAEA,IAAI,CAAC,UAAU;YACb,SAAS;YACT;QACF;QAEA,IAAI;YACF,MAAM,SAAS,MAAM,IAAA,yKAAY,EAAC,UAAU;YAC5C,IAAI,OAAO,KAAK,EAAE;gBAChB,SAAS,OAAO,KAAK;YACvB,OAAO,IAAI,OAAO,IAAI,EAAE;gBACtB,WAAW;uBAAI;oBAAS,OAAO,IAAI;iBAAC;gBACpC,kBAAkB;gBAClB,kBAAkB;gBAClB;YACF;QACF,EAAE,OAAO,KAAK;YACZ,SAAS;QACX;IACF;IAEA,MAAM,qBAAqB,OAAO;QAChC,IAAI,CAAC,QAAQ,mGAAmG;YAC9G;QACF;QAEA,IAAI;YACF,MAAM,SAAS,MAAM,IAAA,yKAAY,EAAC;YAClC,IAAI,OAAO,KAAK,EAAE;gBAChB,SAAS,OAAO,KAAK;YACvB,OAAO;gBACL,WAAW,QAAQ,MAAM,CAAC,CAAA,SAAU,OAAO,EAAE,KAAK;gBAClD,IAAI,qBAAqB,IAAI;oBAC3B,eAAe;gBACjB;gBACA;YACF;QACF,EAAE,OAAO,KAAK;YACZ,SAAS;QACX;IACF;IAEA,MAAM,gBAAgB,OAAO;QAC3B,MAAM,EAAE,MAAM,EAAE,IAAI,EAAE,GAAG;QAEzB,IAAI,QAAQ,OAAO,EAAE,KAAK,KAAK,EAAE,EAAE;YACjC,mDAAmD;YACnD,MAAM,WAAW,QAAQ,SAAS,CAAC,CAAA,SAAU,OAAO,EAAE,KAAK,OAAO,EAAE;YACpE,MAAM,WAAW,QAAQ,SAAS,CAAC,CAAA,SAAU,OAAO,EAAE,KAAK,KAAK,EAAE;YAElE,IAAI,aAAa,CAAC,KAAK,aAAa,CAAC,GAAG;gBACtC,wCAAwC;gBACxC,MAAM,aAAa,IAAA,mLAAS,EAAC,SAAS,UAAU;gBAChD,WAAW;gBAEX,iCAAiC;gBACjC,MAAM,YAAY,WAAW,GAAG,CAAC,CAAA,SAAU,OAAO,EAAE;gBACpD,MAAM,SAAS,MAAM,IAAA,2KAAc,EAAC,UAAW;gBAC/C,IAAI,OAAO,KAAK,EAAE;oBAChB,SAAS,OAAO,KAAK;oBACrB,uCAAuC;oBACvC;gBACF,OAAO;oBACL;gBACF;YACF;QACF;IACF;IAEA,qBACE,6LAAC;QAAI,WAAU;;0BACb,6LAAC;gBAAI,WAAU;;kCACb,6LAAC;wBAAI,WAAU;;0CACb,6LAAC;gCAAG,WAAU;0CAAmC;;;;;;0CACjD,6LAAC;gCACC,SAAS,IAAM,kBAAkB,CAAC;gCAClC,UAAU,CAAC;gCACX,WAAW,CAAC,WAAW,EACrB,WACI,yFACA,+CACL,2DAA2D,CAAC;0CAE7D,cAAA,6LAAC,qNAAQ;oCAAC,MAAM;;;;;;;;;;;;;;;;;oBAInB,kBAAkB,0BACjB,6LAAC;wBAAI,WAAU;;0CACb,6LAAC;gCACC,MAAK;gCACL,OAAO;gCACP,UAAU,CAAC,IAAM,kBAAkB,EAAE,MAAM,CAAC,KAAK;gCACjD,aAAY;gCACZ,WAAU;;;;;;0CAEZ,6LAAC;gCAAI,WAAU;;kDACb,6LAAC;wCACC,SAAS;wCACT,WAAU;kDACX;;;;;;kDAGD,6LAAC;wCACC,SAAS;4CACP,kBAAkB;4CAClB,kBAAkB;wCACpB;wCACA,WAAU;kDACX;;;;;;;;;;;;;;;;;;oBAON,uBACC,6LAAC;wBAAI,WAAU;kCACZ;;;;;;;;;;;;0BAKP,6LAAC;gBAAI,WAAU;0BACZ,wBACC,6LAAC;oBAAI,WAAU;8BAAgC;;;;;+DAC7C,QAAQ,MAAM,KAAK,kBACrB,6LAAC;oBAAI,WAAU;8BACZ,WAAW,qBAAqB;;;;;6EAGnC,6LAAC,4KAAU;oBACT,SAAS;oBACT,oBAAoB,+KAAa;oBACjC,WAAW;8BAEX,cAAA,6LAAC,yLAAe;wBAAC,OAAO,QAAQ,GAAG,CAAC,CAAA,IAAK,EAAE,EAAE;wBAAG,UAAU,qMAA2B;kCACnF,cAAA,6LAAC;4BAAG,WAAU;sCACX,QAAQ,GAAG,CAAC,CAAC,uBACZ,6LAAC;oCAEC,QAAQ;oCACR,YAAY,qBAAqB,OAAO,EAAE;oCAC1C,UAAU;oCACV,UAAU;mCAJL,OAAO,EAAE;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAclC;IAvNM;;QAaY,4KAAU;;;MAbtB;uCAyNS"}},
    {"offset": {"line": 1483, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/courseActions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\nimport { revalidatePath } from 'next/cache';\r\nimport { parseYouTube } from '@/lib/youtubeParser';\r\n\r\n// Type definitions\r\ntype Course = {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\ntype Module = {\r\n  id: string;\r\n  course_id: string;\r\n  title: string;\r\n  order_index: number;\r\n};\r\n\r\ntype Lesson = {\r\n  id: string;\r\n  module_id: string;\r\n  title: string;\r\n  description: string;\r\n  order_index: number;\r\n  video_provider: string;\r\n  video_url: string | null;\r\n  youtube_video_id: string | null;\r\n  is_preview: boolean;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin' || profile.role === 'teacher';\r\n}\r\n\r\n// Course Actions\r\nexport async function listCourses(): Promise<{ data: Course[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: listCourses - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: listCourses - Fetching all courses for admin');\r\n    \r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n    \r\n    console.log('DEBUG: listCourses - Query result:', { data: data?.length, error });\r\n    \r\n    if (error) {\r\n      console.error('DEBUG: listCourses - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    console.log('DEBUG: listCourses - Returning courses:', data?.length);\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: listCourses - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createCourse(title: string, description: string): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: createCourse - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: createCourse - Creating course:', { title, description });\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .insert([{ title, description }])\r\n      .select()\r\n      .single();\r\n    \r\n    console.log('DEBUG: createCourse - Insert result:', { data: !!data, error });\r\n\r\n    if (error) {\r\n      console.error('DEBUG: createCourse - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    console.log('DEBUG: createCourse - Course created successfully, cache invalidated');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: createCourse - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateCourse(id: string, updates: Partial<Course>): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteCourse(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('courses')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function publishCourse(id: string, isPublished: boolean): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update({ is_published: isPublished })\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\n// Module Actions\r\nexport async function listModules(courseId: string): Promise<{ data: Module[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .select('*')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createModule(courseId: string, title: string): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingModules } = await supabase\r\n      .from('modules')\r\n      .select('order_index')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingModules && existingModules.length > 0 \r\n      ? existingModules[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .insert([{ course_id: courseId, title, order_index: newOrderIndex }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateModule(id: string, updates: Partial<Module>): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteModule(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('modules')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderModules(courseId: string, moduleIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all modules with their new positions in a single transaction\r\n    const updates = moduleIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('modules')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('course_id', courseId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\n// Lesson Actions\r\nexport async function listLessons(moduleId: string): Promise<{ data: Lesson[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .select('*')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createLesson(\r\n  moduleId: string, \r\n  title: string, \r\n  description: string, \r\n  youtubeUrl: string\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Parse the YouTube URL\r\n    const parsed = parseYouTube(youtubeUrl);\r\n    if (parsed.error) {\r\n      return { data: null, error: parsed.error };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingLessons } = await supabase\r\n      .from('lessons')\r\n      .select('order_index')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingLessons && existingLessons.length > 0 \r\n      ? existingLessons[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .insert([{\r\n        module_id: moduleId,\r\n        title,\r\n        description,\r\n        youtube_video_id: parsed.videoId,\r\n        video_url: parsed.embedUrl,\r\n        order_index: newOrderIndex,\r\n        is_preview: false,\r\n        is_published: true\r\n      }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateLesson(\r\n  id: string, \r\n  updates: Partial<Omit<Lesson, 'id' | 'module_id' | 'created_at' | 'updated_at'>>\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // If updating YouTube URL, parse it first\r\n    if (updates.video_url) {\r\n      const parsed = parseYouTube(updates.video_url);\r\n      if (parsed.error) {\r\n        return { data: null, error: parsed.error };\r\n      }\r\n      updates.youtube_video_id = parsed.videoId;\r\n      updates.video_url = parsed.embedUrl;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteLesson(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('lessons')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderLessons(moduleId: string, lessonIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all lessons with their new positions in a single transaction\r\n    const updates = lessonIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('lessons')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('module_id', moduleId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MA6ZsB,yBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,gDAAA"}},
    {"offset": {"line": 1500, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/courseActions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\nimport { revalidatePath } from 'next/cache';\r\nimport { parseYouTube } from '@/lib/youtubeParser';\r\n\r\n// Type definitions\r\ntype Course = {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\ntype Module = {\r\n  id: string;\r\n  course_id: string;\r\n  title: string;\r\n  order_index: number;\r\n};\r\n\r\ntype Lesson = {\r\n  id: string;\r\n  module_id: string;\r\n  title: string;\r\n  description: string;\r\n  order_index: number;\r\n  video_provider: string;\r\n  video_url: string | null;\r\n  youtube_video_id: string | null;\r\n  is_preview: boolean;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin' || profile.role === 'teacher';\r\n}\r\n\r\n// Course Actions\r\nexport async function listCourses(): Promise<{ data: Course[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: listCourses - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: listCourses - Fetching all courses for admin');\r\n    \r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n    \r\n    console.log('DEBUG: listCourses - Query result:', { data: data?.length, error });\r\n    \r\n    if (error) {\r\n      console.error('DEBUG: listCourses - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    console.log('DEBUG: listCourses - Returning courses:', data?.length);\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: listCourses - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createCourse(title: string, description: string): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: createCourse - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: createCourse - Creating course:', { title, description });\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .insert([{ title, description }])\r\n      .select()\r\n      .single();\r\n    \r\n    console.log('DEBUG: createCourse - Insert result:', { data: !!data, error });\r\n\r\n    if (error) {\r\n      console.error('DEBUG: createCourse - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    console.log('DEBUG: createCourse - Course created successfully, cache invalidated');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: createCourse - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateCourse(id: string, updates: Partial<Course>): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteCourse(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('courses')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function publishCourse(id: string, isPublished: boolean): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update({ is_published: isPublished })\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\n// Module Actions\r\nexport async function listModules(courseId: string): Promise<{ data: Module[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .select('*')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createModule(courseId: string, title: string): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingModules } = await supabase\r\n      .from('modules')\r\n      .select('order_index')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingModules && existingModules.length > 0 \r\n      ? existingModules[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .insert([{ course_id: courseId, title, order_index: newOrderIndex }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateModule(id: string, updates: Partial<Module>): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteModule(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('modules')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderModules(courseId: string, moduleIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all modules with their new positions in a single transaction\r\n    const updates = moduleIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('modules')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('course_id', courseId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\n// Lesson Actions\r\nexport async function listLessons(moduleId: string): Promise<{ data: Lesson[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .select('*')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createLesson(\r\n  moduleId: string, \r\n  title: string, \r\n  description: string, \r\n  youtubeUrl: string\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Parse the YouTube URL\r\n    const parsed = parseYouTube(youtubeUrl);\r\n    if (parsed.error) {\r\n      return { data: null, error: parsed.error };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingLessons } = await supabase\r\n      .from('lessons')\r\n      .select('order_index')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingLessons && existingLessons.length > 0 \r\n      ? existingLessons[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .insert([{\r\n        module_id: moduleId,\r\n        title,\r\n        description,\r\n        youtube_video_id: parsed.videoId,\r\n        video_url: parsed.embedUrl,\r\n        order_index: newOrderIndex,\r\n        is_preview: false,\r\n        is_published: true\r\n      }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateLesson(\r\n  id: string, \r\n  updates: Partial<Omit<Lesson, 'id' | 'module_id' | 'created_at' | 'updated_at'>>\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // If updating YouTube URL, parse it first\r\n    if (updates.video_url) {\r\n      const parsed = parseYouTube(updates.video_url);\r\n      if (parsed.error) {\r\n        return { data: null, error: parsed.error };\r\n      }\r\n      updates.youtube_video_id = parsed.videoId;\r\n      updates.video_url = parsed.embedUrl;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteLesson(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('lessons')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderLessons(moduleId: string, lessonIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all lessons with their new positions in a single transaction\r\n    const updates = lessonIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('lessons')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('module_id', moduleId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MAiiBsB,yBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,iDAAA"}},
    {"offset": {"line": 1517, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/courseActions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\nimport { revalidatePath } from 'next/cache';\r\nimport { parseYouTube } from '@/lib/youtubeParser';\r\n\r\n// Type definitions\r\ntype Course = {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\ntype Module = {\r\n  id: string;\r\n  course_id: string;\r\n  title: string;\r\n  order_index: number;\r\n};\r\n\r\ntype Lesson = {\r\n  id: string;\r\n  module_id: string;\r\n  title: string;\r\n  description: string;\r\n  order_index: number;\r\n  video_provider: string;\r\n  video_url: string | null;\r\n  youtube_video_id: string | null;\r\n  is_preview: boolean;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin' || profile.role === 'teacher';\r\n}\r\n\r\n// Course Actions\r\nexport async function listCourses(): Promise<{ data: Course[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: listCourses - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: listCourses - Fetching all courses for admin');\r\n    \r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n    \r\n    console.log('DEBUG: listCourses - Query result:', { data: data?.length, error });\r\n    \r\n    if (error) {\r\n      console.error('DEBUG: listCourses - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    console.log('DEBUG: listCourses - Returning courses:', data?.length);\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: listCourses - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createCourse(title: string, description: string): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: createCourse - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: createCourse - Creating course:', { title, description });\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .insert([{ title, description }])\r\n      .select()\r\n      .single();\r\n    \r\n    console.log('DEBUG: createCourse - Insert result:', { data: !!data, error });\r\n\r\n    if (error) {\r\n      console.error('DEBUG: createCourse - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    console.log('DEBUG: createCourse - Course created successfully, cache invalidated');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: createCourse - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateCourse(id: string, updates: Partial<Course>): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteCourse(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('courses')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function publishCourse(id: string, isPublished: boolean): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update({ is_published: isPublished })\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\n// Module Actions\r\nexport async function listModules(courseId: string): Promise<{ data: Module[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .select('*')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createModule(courseId: string, title: string): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingModules } = await supabase\r\n      .from('modules')\r\n      .select('order_index')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingModules && existingModules.length > 0 \r\n      ? existingModules[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .insert([{ course_id: courseId, title, order_index: newOrderIndex }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateModule(id: string, updates: Partial<Module>): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteModule(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('modules')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderModules(courseId: string, moduleIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all modules with their new positions in a single transaction\r\n    const updates = moduleIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('modules')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('course_id', courseId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\n// Lesson Actions\r\nexport async function listLessons(moduleId: string): Promise<{ data: Lesson[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .select('*')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createLesson(\r\n  moduleId: string, \r\n  title: string, \r\n  description: string, \r\n  youtubeUrl: string\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Parse the YouTube URL\r\n    const parsed = parseYouTube(youtubeUrl);\r\n    if (parsed.error) {\r\n      return { data: null, error: parsed.error };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingLessons } = await supabase\r\n      .from('lessons')\r\n      .select('order_index')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingLessons && existingLessons.length > 0 \r\n      ? existingLessons[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .insert([{\r\n        module_id: moduleId,\r\n        title,\r\n        description,\r\n        youtube_video_id: parsed.videoId,\r\n        video_url: parsed.embedUrl,\r\n        order_index: newOrderIndex,\r\n        is_preview: false,\r\n        is_published: true\r\n      }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateLesson(\r\n  id: string, \r\n  updates: Partial<Omit<Lesson, 'id' | 'module_id' | 'created_at' | 'updated_at'>>\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // If updating YouTube URL, parse it first\r\n    if (updates.video_url) {\r\n      const parsed = parseYouTube(updates.video_url);\r\n      if (parsed.error) {\r\n        return { data: null, error: parsed.error };\r\n      }\r\n      updates.youtube_video_id = parsed.videoId;\r\n      updates.video_url = parsed.embedUrl;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteLesson(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('lessons')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderLessons(moduleId: string, lessonIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all lessons with their new positions in a single transaction\r\n    const updates = lessonIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('lessons')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('module_id', moduleId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MA8jBsB,yBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,mDAAA"}},
    {"offset": {"line": 1534, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/components/admin/LessonList.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Lesson } from '@/types/course';\r\nimport { listLessons, createLesson, updateLesson, deleteLesson } from '@/actions/courseActions';\r\nimport { PlusIcon, TrashIcon, PlayIcon } from 'lucide-react';\r\nimport { DndContext, closestCenter, KeyboardSensor, PointerSensor, useSensor, useSensors, DragEndEvent } from '@dnd-kit/core';\r\nimport { arrayMove, SortableContext, sortableKeyboardCoordinates, useSortable, verticalListSortingStrategy } from '@dnd-kit/sortable';\r\nimport { CSS } from '@dnd-kit/utilities';\r\nimport { reorderLessons } from '@/actions/courseActions';\r\n\r\ninterface LessonListProps {\r\n  moduleId: string | null;\r\n  selectedLessonId: string | null;\r\n  onSelectLesson: (lessonId: string | null) => void;\r\n  onLessonCreated: () => void;\r\n  onLessonUpdated: () => void;\r\n  onEditLesson: (lesson: Lesson) => void;\r\n}\r\n\r\n// Sortable Lesson Item Component\r\nconst SortableLessonItem = ({ \r\n  lesson, \r\n  isSelected, \r\n  onSelect,\r\n  onDelete,\r\n  onEdit\r\n}: { \r\n  lesson: Lesson; \r\n  isSelected: boolean; \r\n  onSelect: (id: string) => void;\r\n  onDelete: (id: string) => void;\r\n  onEdit: (lesson: Lesson) => void;\r\n}) => {\r\n  const {\r\n    attributes,\r\n    listeners,\r\n    setNodeRef,\r\n    transform,\r\n    transition,\r\n    isDragging,\r\n  } = useSortable({ id: lesson.id });\r\n\r\n  const style = {\r\n    transform: CSS.Transform.toString(transform),\r\n    transition,\r\n    opacity: isDragging ? 0.5 : 1,\r\n  };\r\n\r\n  return (\r\n    <li\r\n      ref={setNodeRef}\r\n      style={style}\r\n      className={`p-3 cursor-pointer transition-colors ${\r\n        isSelected \r\n          ? 'bg-accent-primary/10 border-l-4 border-accent-primary' \r\n          : 'hover:bg-gray-800/50'\r\n      } ${isDragging ? 'shadow-lg' : ''}`}\r\n      onClick={() => onSelect(lesson.id)}\r\n    >\r\n      <div className=\"flex justify-between items-start\">\r\n        <div className=\"flex items-start gap-2 flex-1 min-w-0\">\r\n          <button\r\n            {...attributes}\r\n            {...listeners}\r\n            className=\"cursor-grab active:cursor-grabbing text-gray-500 hover:text-gray-300 mt-0.5 hover-lift\"\r\n            onClick={(e) => e.stopPropagation()}\r\n          >\r\n            <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\r\n              <circle cx=\"9\" cy=\"5\" r=\"1\"></circle>\r\n              <circle cx=\"9\" cy=\"12\" r=\"1\"></circle>\r\n              <circle cx=\"9\" cy=\"19\" r=\"1\"></circle>\r\n              <circle cx=\"15\" cy=\"5\" r=\"1\"></circle>\r\n              <circle cx=\"15\" cy=\"12\" r=\"1\"></circle>\r\n              <circle cx=\"15\" cy=\"19\" r=\"1\"></circle>\r\n            </svg>\r\n          </button>\r\n          <div className=\"min-w-0 flex-1\">\r\n            <div className=\"flex items-center gap-2\">\r\n              {lesson.youtube_video_id && (\r\n                <PlayIcon size={14} className=\"text-blue-400 flex-shrink-0\" />\r\n              )}\r\n              <span className=\"font-medium text-white truncate\">{lesson.title}</span>\r\n            </div>\r\n            <div className=\"mt-1 flex flex-wrap gap-1\">\r\n              {lesson.is_preview && (\r\n                <span className=\"inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-purple-900/30 text-purple-400 border border-purple-800\">\r\n                  Preview\r\n                </span>\r\n              )}\r\n              {!lesson.is_published && (\r\n                <span className=\"inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-red-900/30 text-red-400 border border-red-800\">\r\n                  Draft\r\n                </span>\r\n              )}\r\n            </div>\r\n          </div>\r\n        </div>\r\n        <div className=\"flex gap-1\">\r\n          <button\r\n            onClick={(e) => {\r\n              e.stopPropagation();\r\n              onEdit(lesson);\r\n            }}\r\n            className=\"p-1 rounded text-blue-400 hover:bg-blue-900/20 flex-shrink-0 hover-lift\"\r\n            title=\"Edit\"\r\n          >\r\n            <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\r\n              <path d=\"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z\" />\r\n            </svg>\r\n          </button>\r\n          <button\r\n            onClick={(e) => {\r\n              e.stopPropagation();\r\n              onDelete(lesson.id);\r\n            }}\r\n            className=\"p-1 rounded text-red-400 hover:bg-red-900/20 flex-shrink-0 hover-lift\"\r\n            title=\"Delete\"\r\n          >\r\n            <TrashIcon size={14} />\r\n          </button>\r\n        </div>\r\n      </div>\r\n    </li>\r\n  );\r\n};\r\n\r\nconst LessonList = ({ \r\n  moduleId, \r\n  selectedLessonId, \r\n  onSelectLesson, \r\n  onLessonCreated,\r\n  onLessonUpdated,\r\n  onEditLesson\r\n}: LessonListProps) => {\r\n  const [lessons, setLessons] = useState<Lesson[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const sensors = useSensors(\r\n    useSensor(PointerSensor),\r\n    useSensor(KeyboardSensor, {\r\n      coordinateGetter: sortableKeyboardCoordinates,\r\n    })\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (moduleId) {\r\n      loadLessons();\r\n    } else {\r\n      setLessons([]);\r\n      setLoading(false);\r\n    }\r\n  }, [moduleId]);\r\n\r\n  const loadLessons = async () => {\r\n    console.log('DEBUG: LessonList - Loading lessons for module:', moduleId);\r\n    if (!moduleId) return;\r\n    \r\n    setLoading(true);\r\n    setError(null);\r\n    try {\r\n      const result = await listLessons(moduleId);\r\n      console.log('DEBUG: LessonList - listLessons result:', result);\r\n      if (result.error) {\r\n        console.error('DEBUG: LessonList - Error loading lessons:', result.error);\r\n        setError(result.error);\r\n      } else if (result.data) {\r\n        console.log('DEBUG: LessonList - Loaded lessons:', result.data);\r\n        // Sort by order_index\r\n        const sortedLessons = [...result.data].sort((a, b) => a.order_index - b.order_index);\r\n        setLessons(sortedLessons);\r\n      }\r\n    } catch (err) {\r\n      console.error('DEBUG: LessonList - Exception loading lessons:', err);\r\n      setError('Failed to load lessons');\r\n    } finally {\r\n      console.log('DEBUG: LessonList - Finished loading lessons, loading state:', false);\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleDeleteLesson = async (id: string) => {\r\n    if (!confirm('Are you sure you want to delete this lesson?')) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      console.log('DEBUG: LessonList - Deleting lesson:', id);\r\n      const result = await deleteLesson(id);\r\n      console.log('DEBUG: LessonList - deleteLesson result:', result);\r\n      if (result.error) {\r\n        console.error('DEBUG: LessonList - Error deleting lesson:', result.error);\r\n        setError(result.error);\r\n      } else {\r\n        console.log('DEBUG: LessonList - Lesson deleted successfully');\r\n        setLessons(lessons.filter(lesson => lesson.id !== id));\r\n        if (selectedLessonId === id) {\r\n          onSelectLesson(null);\r\n        }\r\n        onLessonUpdated();\r\n      }\r\n    } catch (err) {\r\n      console.error('DEBUG: LessonList - Exception deleting lesson:', err);\r\n      setError('Failed to delete lesson');\r\n    }\r\n  };\r\n\r\n  const handleDragEnd = async (event: DragEndEvent) => {\r\n    const { active, over } = event;\r\n\r\n    if (over && active.id !== over.id) {\r\n      // Find the indices of the dragged and target items\r\n      const oldIndex = lessons.findIndex(lesson => lesson.id === active.id);\r\n      const newIndex = lessons.findIndex(lesson => lesson.id === over.id);\r\n\r\n      if (oldIndex !== -1 && newIndex !== -1) {\r\n        // Update the local state optimistically\r\n        const newLessons = arrayMove(lessons, oldIndex, newIndex);\r\n        setLessons(newLessons);\r\n\r\n        // Update the order on the server\r\n        const lessonIds = newLessons.map(lesson => lesson.id);\r\n        const result = await reorderLessons(moduleId!, lessonIds);\r\n        if (result.error) {\r\n          setError(result.error);\r\n          // If reorder failed, revert the change\r\n          loadLessons();\r\n        } else {\r\n          onLessonUpdated();\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"h-full flex flex-col\">\r\n      <div className=\"p-4 border-b border-gray-700\">\r\n        <h3 className=\"text-lg font-semibold text-white\">Lessons</h3>\r\n        {error && (\r\n          <div className=\"mt-2 p-2 bg-red-900/30 border border-red-700 rounded text-red-300 text-sm\">\r\n            {error}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"flex-1 overflow-y-auto\">\r\n        {loading ? (\r\n          <div className=\"p-4 text-center text-gray-400\">Loading lessons...</div>\r\n        ) : lessons.length === 0 ? (\r\n          <div className=\"p-4 text-center text-gray-400\">\r\n            {moduleId ? 'No lessons found' : 'Select a module to view lessons'}\r\n          </div>\r\n        ) : (\r\n          <DndContext\r\n            sensors={sensors}\r\n            collisionDetection={closestCenter}\r\n            onDragEnd={handleDragEnd}\r\n          >\r\n            <SortableContext items={lessons.map(l => l.id)} strategy={verticalListSortingStrategy}>\r\n              <ul className=\"divide-y divide-gray-700\">\r\n                {lessons.map((lesson) => (\r\n                  <SortableLessonItem\r\n                    key={lesson.id}\r\n                    lesson={lesson}\r\n                    isSelected={selectedLessonId === lesson.id}\r\n                    onSelect={onSelectLesson}\r\n                    onDelete={handleDeleteLesson}\r\n                    onEdit={onEditLesson}\r\n                  />\r\n                ))}\r\n              </ul>\r\n            </SortableContext>\r\n          </DndContext>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default LessonList;"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2008, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/courseActions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\nimport { revalidatePath } from 'next/cache';\r\nimport { parseYouTube } from '@/lib/youtubeParser';\r\n\r\n// Type definitions\r\ntype Course = {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\ntype Module = {\r\n  id: string;\r\n  course_id: string;\r\n  title: string;\r\n  order_index: number;\r\n};\r\n\r\ntype Lesson = {\r\n  id: string;\r\n  module_id: string;\r\n  title: string;\r\n  description: string;\r\n  order_index: number;\r\n  video_provider: string;\r\n  video_url: string | null;\r\n  youtube_video_id: string | null;\r\n  is_preview: boolean;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin' || profile.role === 'teacher';\r\n}\r\n\r\n// Course Actions\r\nexport async function listCourses(): Promise<{ data: Course[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: listCourses - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: listCourses - Fetching all courses for admin');\r\n    \r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n    \r\n    console.log('DEBUG: listCourses - Query result:', { data: data?.length, error });\r\n    \r\n    if (error) {\r\n      console.error('DEBUG: listCourses - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    console.log('DEBUG: listCourses - Returning courses:', data?.length);\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: listCourses - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createCourse(title: string, description: string): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: createCourse - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: createCourse - Creating course:', { title, description });\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .insert([{ title, description }])\r\n      .select()\r\n      .single();\r\n    \r\n    console.log('DEBUG: createCourse - Insert result:', { data: !!data, error });\r\n\r\n    if (error) {\r\n      console.error('DEBUG: createCourse - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    console.log('DEBUG: createCourse - Course created successfully, cache invalidated');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: createCourse - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateCourse(id: string, updates: Partial<Course>): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteCourse(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('courses')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function publishCourse(id: string, isPublished: boolean): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update({ is_published: isPublished })\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\n// Module Actions\r\nexport async function listModules(courseId: string): Promise<{ data: Module[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .select('*')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createModule(courseId: string, title: string): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingModules } = await supabase\r\n      .from('modules')\r\n      .select('order_index')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingModules && existingModules.length > 0 \r\n      ? existingModules[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .insert([{ course_id: courseId, title, order_index: newOrderIndex }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateModule(id: string, updates: Partial<Module>): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteModule(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('modules')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderModules(courseId: string, moduleIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all modules with their new positions in a single transaction\r\n    const updates = moduleIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('modules')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('course_id', courseId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\n// Lesson Actions\r\nexport async function listLessons(moduleId: string): Promise<{ data: Lesson[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .select('*')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createLesson(\r\n  moduleId: string, \r\n  title: string, \r\n  description: string, \r\n  youtubeUrl: string\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Parse the YouTube URL\r\n    const parsed = parseYouTube(youtubeUrl);\r\n    if (parsed.error) {\r\n      return { data: null, error: parsed.error };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingLessons } = await supabase\r\n      .from('lessons')\r\n      .select('order_index')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingLessons && existingLessons.length > 0 \r\n      ? existingLessons[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .insert([{\r\n        module_id: moduleId,\r\n        title,\r\n        description,\r\n        youtube_video_id: parsed.videoId,\r\n        video_url: parsed.embedUrl,\r\n        order_index: newOrderIndex,\r\n        is_preview: false,\r\n        is_published: true\r\n      }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateLesson(\r\n  id: string, \r\n  updates: Partial<Omit<Lesson, 'id' | 'module_id' | 'created_at' | 'updated_at'>>\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // If updating YouTube URL, parse it first\r\n    if (updates.video_url) {\r\n      const parsed = parseYouTube(updates.video_url);\r\n      if (parsed.error) {\r\n        return { data: null, error: parsed.error };\r\n      }\r\n      updates.youtube_video_id = parsed.videoId;\r\n      updates.video_url = parsed.embedUrl;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteLesson(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('lessons')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderLessons(moduleId: string, lessonIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all lessons with their new positions in a single transaction\r\n    const updates = lessonIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('lessons')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('module_id', moduleId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MAqfsB,yBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,iDAAA"}},
    {"offset": {"line": 2025, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/courseActions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\nimport { revalidatePath } from 'next/cache';\r\nimport { parseYouTube } from '@/lib/youtubeParser';\r\n\r\n// Type definitions\r\ntype Course = {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\ntype Module = {\r\n  id: string;\r\n  course_id: string;\r\n  title: string;\r\n  order_index: number;\r\n};\r\n\r\ntype Lesson = {\r\n  id: string;\r\n  module_id: string;\r\n  title: string;\r\n  description: string;\r\n  order_index: number;\r\n  video_provider: string;\r\n  video_url: string | null;\r\n  youtube_video_id: string | null;\r\n  is_preview: boolean;\r\n  is_published: boolean;\r\n  created_at: string;\r\n  updated_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin' || profile.role === 'teacher';\r\n}\r\n\r\n// Course Actions\r\nexport async function listCourses(): Promise<{ data: Course[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: listCourses - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: listCourses - Fetching all courses for admin');\r\n    \r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n    \r\n    console.log('DEBUG: listCourses - Query result:', { data: data?.length, error });\r\n    \r\n    if (error) {\r\n      console.error('DEBUG: listCourses - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    console.log('DEBUG: listCourses - Returning courses:', data?.length);\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: listCourses - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createCourse(title: string, description: string): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      console.log('DEBUG: createCourse - Access denied, not admin/teacher');\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n    \r\n    console.log('DEBUG: createCourse - Creating course:', { title, description });\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .insert([{ title, description }])\r\n      .select()\r\n      .single();\r\n    \r\n    console.log('DEBUG: createCourse - Insert result:', { data: !!data, error });\r\n\r\n    if (error) {\r\n      console.error('DEBUG: createCourse - Supabase error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    console.log('DEBUG: createCourse - Course created successfully, cache invalidated');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    console.error('DEBUG: createCourse - Exception:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateCourse(id: string, updates: Partial<Course>): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteCourse(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('courses')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function publishCourse(id: string, isPublished: boolean): Promise<{ data: Course | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('courses')\r\n      .update({ is_published: isPublished })\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\n// Module Actions\r\nexport async function listModules(courseId: string): Promise<{ data: Module[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .select('*')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createModule(courseId: string, title: string): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingModules } = await supabase\r\n      .from('modules')\r\n      .select('order_index')\r\n      .eq('course_id', courseId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingModules && existingModules.length > 0 \r\n      ? existingModules[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .insert([{ course_id: courseId, title, order_index: newOrderIndex }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateModule(id: string, updates: Partial<Module>): Promise<{ data: Module | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('modules')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteModule(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('modules')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderModules(courseId: string, moduleIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all modules with their new positions in a single transaction\r\n    const updates = moduleIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('modules')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('course_id', courseId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\n// Lesson Actions\r\nexport async function listLessons(moduleId: string): Promise<{ data: Lesson[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .select('*')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createLesson(\r\n  moduleId: string, \r\n  title: string, \r\n  description: string, \r\n  youtubeUrl: string\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Parse the YouTube URL\r\n    const parsed = parseYouTube(youtubeUrl);\r\n    if (parsed.error) {\r\n      return { data: null, error: parsed.error };\r\n    }\r\n\r\n    // Get the highest order_index to determine the new position\r\n    const { data: existingLessons } = await supabase\r\n      .from('lessons')\r\n      .select('order_index')\r\n      .eq('module_id', moduleId)\r\n      .order('order_index', { ascending: false })\r\n      .limit(1);\r\n\r\n    const newOrderIndex = existingLessons && existingLessons.length > 0 \r\n      ? existingLessons[0].order_index + 10 \r\n      : 0;\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .insert([{\r\n        module_id: moduleId,\r\n        title,\r\n        description,\r\n        youtube_video_id: parsed.videoId,\r\n        video_url: parsed.embedUrl,\r\n        order_index: newOrderIndex,\r\n        is_preview: false,\r\n        is_published: true\r\n      }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateLesson(\r\n  id: string, \r\n  updates: Partial<Omit<Lesson, 'id' | 'module_id' | 'created_at' | 'updated_at'>>\r\n): Promise<{ data: Lesson | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // If updating YouTube URL, parse it first\r\n    if (updates.video_url) {\r\n      const parsed = parseYouTube(updates.video_url);\r\n      if (parsed.error) {\r\n        return { data: null, error: parsed.error };\r\n      }\r\n      updates.youtube_video_id = parsed.videoId;\r\n      updates.video_url = parsed.embedUrl;\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('lessons')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteLesson(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('lessons')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function reorderLessons(moduleId: string, lessonIds: string[]): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    // Update all lessons with their new positions in a single transaction\r\n    const updates = lessonIds.map((id, index) => ({\r\n      id,\r\n      order_index: index * 10 // Use increments of 10 to allow for future insertions between items\r\n    }));\r\n\r\n    // Perform updates in a batch\r\n    for (const update of updates) {\r\n      const { error } = await supabase\r\n        .from('lessons')\r\n        .update({ order_index: update.order_index })\r\n        .eq('id', update.id)\r\n        .eq('module_id', moduleId); // Additional safety check\r\n\r\n      if (error) {\r\n        return { error: error.message };\r\n      }\r\n    }\r\n\r\n    // Revalidate the cache to ensure frontend reflects changes\r\n    revalidatePath('/courses');\r\n    revalidatePath('/dashboard');\r\n    \r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MAubsB,yBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,iDAAA"}},
    {"offset": {"line": 2042, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/lib/youtubeParser.ts"],"sourcesContent":["/**\r\n * Parse YouTube URL or ID to extract video ID and create embed URL\r\n * @param input - Raw YouTube URL or video ID\r\n * @returns Object containing videoId, embedUrl, and optional error\r\n */\r\nexport function parseYouTube(input: string): { \r\n  videoId: string | null; \r\n  embedUrl: string | null; \r\n  error?: string \r\n} {\r\n  if (!input || typeof input !== 'string') {\r\n    return {\r\n      videoId: null,\r\n      embedUrl: null,\r\n      error: 'Input is required and must be a string'\r\n    };\r\n  }\r\n\r\n  // Clean the input by trimming whitespace\r\n  const cleanedInput = input.trim();\r\n\r\n  // Regular expression to validate YouTube video ID format (11 alphanumeric chars including hyphens and underscores)\r\n  const videoIdRegex = /^[a-zA-Z0-9_-]{11}$/;\r\n\r\n  // If input is exactly 11 characters and matches YouTube ID format, treat as raw ID\r\n  if (cleanedInput.length === 11 && videoIdRegex.test(cleanedInput)) {\r\n    return {\r\n      videoId: cleanedInput,\r\n      embedUrl: `https://www.youtube.com/embed/${cleanedInput}`,\r\n      error: undefined\r\n    };\r\n  }\r\n\r\n  // Regular expression to match various YouTube URL formats\r\n  const youtubeRegex = /(?:youtube\\.com\\/(?:[^\\/]+\\/.+\\/|(?:v|e(?:mbed)?)\\/|.*[?&]v=)|youtu\\.be\\/)([^\"&?\\/\\s]{11})/i;\r\n\r\n  const match = cleanedInput.match(youtubeRegex);\r\n\r\n  if (match && match[1]) {\r\n    const videoId = match[1];\r\n    return {\r\n      videoId,\r\n      embedUrl: `https://www.youtube.com/embed/${videoId}`,\r\n      error: undefined\r\n    };\r\n  }\r\n\r\n  // Check for YouTube Shorts format\r\n  const shortsRegex = /youtube\\.com\\/shorts\\/([^\"&?\\/\\s]{11})/i;\r\n  const shortsMatch = cleanedInput.match(shortsRegex);\r\n\r\n  if (shortsMatch && shortsMatch[1]) {\r\n    const videoId = shortsMatch[1];\r\n    return {\r\n      videoId,\r\n      embedUrl: `https://www.youtube.com/embed/${videoId}`,\r\n      error: undefined\r\n    };\r\n  }\r\n\r\n  // If no match found, return error\r\n  return {\r\n    videoId: null,\r\n    embedUrl: null,\r\n    error: 'Invalid YouTube URL or video ID. Please provide a valid YouTube URL or 11-character video ID.'\r\n  };\r\n}"],"names":[],"mappings":"AAAA;;;;CAIC;;;;AACM,SAAS,aAAa,KAAa;IAKxC,IAAI,CAAC,SAAS,OAAO,UAAU,UAAU;QACvC,OAAO;YACL,SAAS;YACT,UAAU;YACV,OAAO;QACT;IACF;IAEA,yCAAyC;IACzC,MAAM,eAAe,MAAM,IAAI;IAE/B,mHAAmH;IACnH,MAAM,eAAe;IAErB,mFAAmF;IACnF,IAAI,aAAa,MAAM,KAAK,MAAM,aAAa,IAAI,CAAC,eAAe;QACjE,OAAO;YACL,SAAS;YACT,UAAU,CAAC,8BAA8B,EAAE,cAAc;YACzD,OAAO;QACT;IACF;IAEA,0DAA0D;IAC1D,MAAM,eAAe;IAErB,MAAM,QAAQ,aAAa,KAAK,CAAC;IAEjC,IAAI,SAAS,KAAK,CAAC,EAAE,EAAE;QACrB,MAAM,UAAU,KAAK,CAAC,EAAE;QACxB,OAAO;YACL;YACA,UAAU,CAAC,8BAA8B,EAAE,SAAS;YACpD,OAAO;QACT;IACF;IAEA,kCAAkC;IAClC,MAAM,cAAc;IACpB,MAAM,cAAc,aAAa,KAAK,CAAC;IAEvC,IAAI,eAAe,WAAW,CAAC,EAAE,EAAE;QACjC,MAAM,UAAU,WAAW,CAAC,EAAE;QAC9B,OAAO;YACL;YACA,UAAU,CAAC,8BAA8B,EAAE,SAAS;YACpD,OAAO;QACT;IACF;IAEA,kCAAkC;IAClC,OAAO;QACL,SAAS;QACT,UAAU;QACV,OAAO;IACT;AACF"}},
    {"offset": {"line": 2106, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/services/quizService.ts"],"sourcesContent":["import { supabase } from '@/lib/supabase';\r\nimport { QuizWithQuestions, QuizQuestion, QuizOption } from '@/types/quiz';\r\n\r\nfunction isUuid(value: string | undefined | null) {\r\n  if (!value) return false\r\n  return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(value)\r\n}\r\n\r\n// Get quiz for a lesson\r\nexport const getQuizByLessonId = async (lessonId: string): Promise<QuizWithQuestions | null> => {\r\n  console.log('getQuizByLessonId: Fetching quiz for lesson:', lessonId);\r\n  \r\n  try {\r\n    // First, get the quiz itself\r\n    const { data: quizData, error: quizError } = await supabase\r\n      .from('quizzes')\r\n      .select('*')\r\n      .eq('lesson_id', lessonId)\r\n      .eq('is_active', true)\r\n      .maybeSingle();\r\n\r\n    if (quizError) {\r\n      console.error('getQuizByLessonId: Error fetching quiz:', {\r\n        name: quizError.name,\r\n        message: quizError.message,\r\n        details: quizError.details\r\n      });\r\n      throw quizError;\r\n    }\r\n\r\n  // If no quiz found for this lesson, return null\r\n  if (!quizData) {\r\n    return null;\r\n  }\r\n\r\n  // Then get the questions for this quiz\r\n  console.log('getQuizByLessonId: Fetching questions for lesson:', lessonId);\r\n  \r\n  // First, let's check what's actually in the database for this lesson\r\n  const { data: allQuestions, error: allQuestionsError } = await supabase\r\n    .from('quiz_questions')\r\n    .select('*')\r\n    .limit(10);\r\n  \r\n  if (allQuestions) {\r\n    console.log('getQuizByLessonId: All questions in DB:', allQuestions.map((q: any) => ({\r\n      id: q.id,\r\n      lesson_id: q.lesson_id,\r\n      text: q.question_text?.substring(0, 30) + '...'\r\n    })));\r\n  }\r\n  \r\n  const { data: questionsData, error: questionsError } = await supabase\r\n    .from('quiz_questions')\r\n    .select('*')\r\n    .eq('lesson_id', lessonId)\r\n    .order('order_index', { ascending: true });\r\n\r\n  if (questionsError) {\r\n    console.error('getQuizByLessonId: Error fetching questions:', questionsError);\r\n    throw questionsError;\r\n  }\r\n\r\n  console.log('getQuizByLessonId: Raw questions data:', questionsData?.length || 0, 'questions found');\r\n  if (questionsData) {\r\n    console.log('getQuizByLessonId: Questions sample:', questionsData.slice(0, 2).map((q: any) => ({\r\n      id: q.id,\r\n      text: q.question_text?.substring(0, 50) + '...'\r\n    })));\r\n  }\r\n\r\n  // Sort questions by order_index\r\n  const sortedQuestions = [...(questionsData || [])].sort((a, b) => a.order_index - b.order_index);\r\n  console.log('getQuizByLessonId: Sorted questions count:', sortedQuestions.length);\r\n\r\n  // Get options for each question\r\n  const questionsWithOptions = [];\r\n  console.log('getQuizByLessonId: Processing', sortedQuestions.length, 'questions');\r\n  \r\n  for (const [index, question] of sortedQuestions.entries()) {\r\n    console.log(`getQuizByLessonId: Processing question ${index + 1}/${sortedQuestions.length}:`, {\r\n      id: question.id,\r\n      text: question.question_text?.substring(0, 50) + '...'\r\n    });\r\n    \r\n    const { data: optionsData, error: optionsError } = await supabase\r\n      .from('quiz_options')\r\n      .select('*')\r\n      .eq('question_id', question.id)\r\n      .order('order_index', { ascending: true });\r\n    \r\n    if (optionsError) {\r\n      console.error('getQuizByLessonId: Error fetching options for question:', question.id, optionsError);\r\n      throw optionsError;\r\n    }\r\n    \r\n    console.log(`getQuizByLessonId: Question ${question.id} has ${optionsData?.length || 0} options`);\r\n    \r\n    questionsWithOptions.push({\r\n      ...question,\r\n      options: optionsData || []\r\n    });\r\n  }\r\n  \r\n  console.log('getQuizByLessonId: Built questionsWithOptions array with', questionsWithOptions.length, 'questions');\r\n\r\n  const quizWithQuestions: QuizWithQuestions = {\r\n    ...quizData,\r\n    questions: questionsWithOptions\r\n  };\r\n\r\n  console.log('getQuizByLessonId: Final result structure:', {\r\n    quizId: quizWithQuestions.id,\r\n    lessonId: quizWithQuestions.lesson_id,\r\n    title: quizWithQuestions.title,\r\n    questionsCount: quizWithQuestions.questions?.length || 0,\r\n    questionsSample: quizWithQuestions.questions?.slice(0, 2).map(q => ({\r\n      id: q.id,\r\n      text: q.question_text?.substring(0, 50) + '...',\r\n      optionsCount: q.options?.length || 0\r\n    }))\r\n  });\r\n  \r\n  return quizWithQuestions;\r\n  } catch (error: any) {\r\n    console.error('getQuizByLessonId: Unhandled error:', {\r\n      name: error?.name || 'UnknownError',\r\n      message: error?.message || 'Unknown error occurred',\r\n      stack: error?.stack\r\n    });\r\n    \r\n    // Enhanced error categorization\r\n    if (error?.name === 'TypeError' && error?.message?.includes('Failed to fetch')) {\r\n      if (typeof navigator !== 'undefined' && !navigator.onLine) {\r\n        throw new Error('Network error: You appear to be offline');\r\n      } else {\r\n        throw new Error('Network error: Unable to connect to database server');\r\n      }\r\n    }\r\n    \r\n    throw error;\r\n  }\r\n};\r\n\r\n// Create or update quiz for a lesson\r\nexport const upsertQuiz = async (lessonId: string, quizData: {\r\n  title: string;\r\n  description: string;\r\n  is_active: boolean;\r\n  questions: {\r\n    id?: string;\r\n    question_text: string;\r\n    question_type: 'multiple_choice' | 'short_answer';\r\n    is_required: boolean;\r\n    order_index: number;\r\n    options?: {\r\n      id?: string;\r\n      option_text: string;\r\n      is_correct: boolean;\r\n      order_index: number;\r\n    }[];\r\n  }[];\r\n}): Promise<void> => {\r\n  console.log('upsertQuiz: Upserting quiz for lesson:', lessonId, 'data:', quizData);\r\n\r\n  // Start a transaction-like approach\r\n  // First, check if quiz already exists\r\n  const { data: existingQuiz, error: fetchQuizError } = await supabase\r\n    .from('quizzes')\r\n    .select('id')\r\n    .eq('lesson_id', lessonId)\r\n    .maybeSingle();\r\n\r\n  if (fetchQuizError) {\r\n    console.error('upsertQuiz: Error checking existing quiz:', fetchQuizError);\r\n    throw fetchQuizError;\r\n  }\r\n\r\n  let quizId: string;\r\n\r\n  if (existingQuiz) {\r\n    // Update existing quiz\r\n    const { error: updateQuizError } = await supabase\r\n      .from('quizzes')\r\n      .update({\r\n        title: quizData.title,\r\n        description: quizData.description,\r\n        is_active: quizData.is_active,\r\n        updated_at: new Date().toISOString()\r\n      })\r\n      .eq('id', existingQuiz.id);\r\n\r\n    if (updateQuizError) {\r\n      console.error('upsertQuiz: Error updating quiz:', updateQuizError);\r\n      throw updateQuizError;\r\n    }\r\n    quizId = existingQuiz.id;\r\n  } else {\r\n    // Insert new quiz\r\n    const { data: newQuiz, error: insertQuizError } = await supabase\r\n      .from('quizzes')\r\n      .insert({\r\n        lesson_id: lessonId,\r\n        title: quizData.title,\r\n        description: quizData.description,\r\n        is_active: quizData.is_active\r\n      })\r\n      .select('id')\r\n      .single();\r\n\r\n    if (insertQuizError) {\r\n      console.error('upsertQuiz: Error inserting quiz:', insertQuizError);\r\n      throw insertQuizError;\r\n    }\r\n    quizId = newQuiz.id;\r\n  }\r\n\r\n  // Process questions\r\n  const questionIdMap: Record<string, string> = {};\r\n  for (const question of quizData.questions) {\r\n    let questionId: string;\r\n    const shouldUpdate = isUuid(question.id);\r\n\r\n    if (shouldUpdate && question.id) {\r\n      // Update existing question\r\n      console.log(`upsertQuiz: updating question (uuid ${question.id})`);\r\n      const { error: updateQuestionError } = await supabase\r\n        .from('quiz_questions')\r\n        .update({\r\n          question_text: question.question_text,\r\n          question_type: question.question_type,\r\n          is_required: question.is_required,\r\n          order_index: question.order_index,\r\n          updated_at: new Date().toISOString()\r\n        })\r\n        .eq('id', question.id);\r\n\r\n      if (updateQuestionError) {\r\n        console.error('upsertQuiz: update quiz_questions failed:', updateQuestionError);\r\n        throw updateQuestionError;\r\n      }\r\n      questionId = question.id;\r\n    } else {\r\n      // Insert new question\r\n      console.log(`upsertQuiz: inserting question (temp id ${question.id || 'undefined'})`);\r\n      const { data: newQuestion, error: insertQuestionError } = await supabase\r\n        .from('quiz_questions')\r\n        .insert({\r\n          lesson_id: lessonId,\r\n          question_text: question.question_text,\r\n          question_type: question.question_type,\r\n          is_required: question.is_required,\r\n          order_index: question.order_index\r\n        })\r\n        .select('id')\r\n        .single();\r\n\r\n      if (insertQuestionError) {\r\n        console.error('upsertQuiz: insert quiz_questions failed:', insertQuestionError);\r\n        throw insertQuestionError;\r\n      }\r\n      questionId = newQuestion.id;\r\n    }\r\n\r\n    // Map the temporary question ID to the real question ID\r\n    if (question.id && !shouldUpdate) {\r\n      questionIdMap[question.id] = questionId;\r\n    }\r\n\r\n    // Process options for this question (only for multiple choice)\r\n    if (question.question_type === 'multiple_choice' && question.options) {\r\n      // Replace all options strategy: delete all existing options first\r\n      console.log(`upsertQuiz: replacing options for question ${questionId}`);\r\n      const { error: deleteOptionsError } = await supabase\r\n        .from('quiz_options')\r\n        .delete()\r\n        .eq('question_id', questionId);\r\n\r\n      if (deleteOptionsError) {\r\n        console.error('upsertQuiz: delete quiz_options failed:', deleteOptionsError);\r\n        throw deleteOptionsError;\r\n      }\r\n\r\n      // Insert all current options fresh\r\n      for (const [index, option] of question.options.entries()) {\r\n        console.log(`upsertQuiz: inserting option ${index + 1} for question ${questionId}`);\r\n        const { error: insertOptionError } = await supabase\r\n          .from('quiz_options')\r\n          .insert({\r\n            question_id: questionId,\r\n            option_text: option.option_text,\r\n            is_correct: option.is_correct,\r\n            order_index: index\r\n          });\r\n\r\n        if (insertOptionError) {\r\n          console.error('upsertQuiz: insert quiz_options failed:', insertOptionError);\r\n          throw insertOptionError;\r\n        }\r\n      }\r\n    } else if (question.question_type === 'multiple_choice') {\r\n      // If it's multiple choice but no options provided, delete existing options\r\n      console.log(`upsertQuiz: deleting all options for question ${questionId} (no options provided)`);\r\n      const { error: deleteAllOptionsError } = await supabase\r\n        .from('quiz_options')\r\n        .delete()\r\n        .eq('question_id', questionId);\r\n\r\n      if (deleteAllOptionsError) {\r\n        console.error('upsertQuiz: delete all quiz_options failed:', deleteAllOptionsError);\r\n        throw deleteAllOptionsError;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Clean up deleted questions (if any)\r\n  console.log('upsertQuiz: Cleaning up questions for lesson:', lessonId);\r\n  console.log('upsertQuiz: Quiz data questions:', quizData.questions.map(q => ({\r\n    id: q.id,\r\n    isUuid: isUuid(q.id),\r\n    text: q.question_text?.substring(0, 30) + '...'\r\n  })));\r\n  \r\n  // Only clean up if there are existing questions to preserve\r\n  if (quizData.questions.length > 0) {\r\n    const existingQuestionIds = quizData.questions\r\n      .filter(q => isUuid(q.id)) // Only include real UUIDs, not temporary IDs\r\n      .map(q => q.id as string);\r\n    \r\n    console.log('upsertQuiz: Existing question IDs to preserve:', existingQuestionIds);\r\n    \r\n    if (existingQuestionIds.length > 0) {\r\n      console.log('upsertQuiz: Deleting questions NOT in:', existingQuestionIds);\r\n      const { error: deleteQuestionsError } = await supabase\r\n        .from('quiz_questions')\r\n        .delete()\r\n        .eq('lesson_id', lessonId)\r\n        .not('id', 'in', `(${existingQuestionIds.join(',')})`);\r\n\r\n      if (deleteQuestionsError) {\r\n        console.error('upsertQuiz: Error deleting questions:', deleteQuestionsError);\r\n      }\r\n    } else {\r\n      // If no existing questions to preserve, this means ALL questions are new\r\n      // So we should NOT delete anything - all questions are meant to be kept\r\n      console.log('upsertQuiz: All questions are new (temporary IDs), preserving all');\r\n    }\r\n  } else {\r\n    // If no questions remain, delete all questions for this lesson\r\n    console.log('upsertQuiz: No questions in quiz data, deleting all questions for lesson');\r\n    const { error: deleteAllQuestionsError } = await supabase\r\n      .from('quiz_questions')\r\n      .delete()\r\n      .eq('lesson_id', lessonId);\r\n\r\n    if (deleteAllQuestionsError) {\r\n      console.error('upsertQuiz: Error deleting all questions:', deleteAllQuestionsError);\r\n    }\r\n  }\r\n\r\n  console.log('upsertQuiz: Successfully upserted quiz for lesson:', lessonId);\r\n};\r\n\r\n// Submit quiz answers\r\nexport const submitQuizAnswers = async (\r\n  userId: string,\r\n  lessonId: string,\r\n  answers: {\r\n    question_id: string;\r\n    selected_option_id?: string; // For multiple choice\r\n    answer_text?: string; // For short answer\r\n  }[]\r\n): Promise<{ score: number; total: number }> => {\r\n  console.log('submitQuizAnswers: Submitting answers for user:', userId, 'lesson:', lessonId);\r\n\r\n  // First, get the quiz questions with correct answers\r\n  const quiz = await getQuizByLessonId(lessonId);\r\n  if (!quiz) {\r\n    throw new Error('Quiz not found for this lesson');\r\n  }\r\n\r\n  // Create a new submission\r\n  const { data: submission, error: submissionError } = await supabase\r\n    .from('quiz_submissions')\r\n    .insert({\r\n      user_id: userId,\r\n      lesson_id: lessonId,\r\n      score: 0, // Will update after grading\r\n      total_questions: quiz.questions.length\r\n    })\r\n    .select('id')\r\n    .single();\r\n\r\n  if (submissionError) {\r\n    console.error('submitQuizAnswers: Error creating submission:', submissionError);\r\n    throw submissionError;\r\n  }\r\n\r\n  let correctAnswers = 0;\r\n\r\n  // Process each answer\r\n  for (const answer of answers) {\r\n    const question = quiz.questions.find(q => q.id === answer.question_id);\r\n    if (!question) {\r\n      continue; // Skip if question doesn't exist\r\n    }\r\n\r\n    let isCorrect = false;\r\n\r\n    if (question.question_type === 'multiple_choice') {\r\n      // For multiple choice, check if the selected option is correct\r\n      if (answer.selected_option_id) {\r\n        const selectedOption = question.options?.find(opt => opt.id === answer.selected_option_id);\r\n        if (selectedOption?.is_correct) {\r\n          isCorrect = true;\r\n          correctAnswers++;\r\n        }\r\n      }\r\n    } else if (question.question_type === 'short_answer') {\r\n      // For short answer, we'll just save the answer and let instructors grade manually\r\n      // For now, we'll mark it as correct if an answer was provided\r\n      if (answer.answer_text && answer.answer_text.trim().length > 0) {\r\n        isCorrect = true;\r\n        correctAnswers++;\r\n      }\r\n    }\r\n\r\n    // Save the answer\r\n    const { error: answerError } = await supabase\r\n      .from('quiz_answers')\r\n      .insert({\r\n        submission_id: submission.id,\r\n        question_id: answer.question_id,\r\n        selected_option_id: answer.selected_option_id,\r\n        answer_text: answer.answer_text,\r\n        is_correct: isCorrect\r\n      });\r\n\r\n    if (answerError) {\r\n      console.error('submitQuizAnswers: Error saving answer:', answerError);\r\n      throw answerError;\r\n    }\r\n  }\r\n\r\n  // Update the submission with the final score\r\n  const finalScore = Math.round((correctAnswers / quiz.questions.length) * 100);\r\n  const { error: updateScoreError } = await supabase\r\n    .from('quiz_submissions')\r\n    .update({\r\n      score: finalScore,\r\n      completed_at: new Date().toISOString()\r\n    })\r\n    .eq('id', submission.id);\r\n\r\n  if (updateScoreError) {\r\n    console.error('submitQuizAnswers: Error updating score:', updateScoreError);\r\n    throw updateScoreError;\r\n  }\r\n\r\n  console.log('submitQuizAnswers: Successfully submitted answers for user:', userId, 'lesson:', lessonId, 'score:', finalScore);\r\n\r\n  return {\r\n    score: finalScore,\r\n    total: quiz.questions.length\r\n  };\r\n};\r\n\r\n// Get user's quiz submission for a lesson\r\nexport const getUserQuizSubmission = async (userId: string, lessonId: string) => {\r\n  console.log('getUserQuizSubmission: Fetching submission for user:', userId, 'lesson:', lessonId);\r\n\r\n  const { data, error } = await supabase\r\n    .from('quiz_submissions')\r\n    .select('*')\r\n    .eq('user_id', userId)\r\n    .eq('lesson_id', lessonId)\r\n    .order('created_at', { ascending: false })\r\n    .limit(1)\r\n    .maybeSingle();\r\n\r\n  if (error) {\r\n    console.error('getUserQuizSubmission: Error fetching submission:', error);\r\n    throw error;\r\n  }\r\n\r\n  return data;\r\n};\r\n\r\n// Get quiz submission by lesson ID for a user\r\nexport const getQuizSubmissionByLessonId = async (userId: string, lessonId: string) => {\r\n  console.log('getQuizSubmissionByLessonId: Fetching submission for user:', userId, 'lesson:', lessonId);\r\n\r\n  const { data, error } = await supabase\r\n    .from('quiz_submissions')\r\n    .select('*')\r\n    .eq('user_id', userId)\r\n    .eq('lesson_id', lessonId)\r\n    .order('created_at', { ascending: false })\r\n    .limit(1)\r\n    .maybeSingle();\r\n\r\n  if (error) {\r\n    console.error('getQuizSubmissionByLessonId: Error fetching submission:', error);\r\n    throw error;\r\n  }\r\n\r\n  return data;\r\n};"],"names":[],"mappings":"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"}},
    {"offset": {"line": 2470, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/components/admin/QuizEditor.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState } from 'react';\r\nimport { QuizWithQuestions } from '@/types/quiz';\r\n\r\ninterface QuizEditorProps {\r\n  quiz: QuizWithQuestions | null;\r\n  onSave: (quiz: QuizWithQuestions) => void;\r\n  onCancel: () => void;\r\n}\r\n\r\nexport const QuizEditor = ({ quiz, onSave, onCancel }: QuizEditorProps) => {\r\n  // Define a temporary question type for editing\r\n  type EditingQuestion = {\r\n    id: string;\r\n    lesson_id: string;\r\n    question_text: string;\r\n    question_type: 'multiple_choice' | 'short_answer';\r\n    order_index: number;\r\n    is_required: boolean;\r\n    created_at: string;\r\n    updated_at: string;\r\n    options?: {\r\n      id: string;\r\n      question_id: string;\r\n      option_text: string;\r\n      is_correct: boolean;\r\n      order_index: number;\r\n      created_at: string;\r\n      updated_at: string;\r\n    }[];\r\n  };\r\n\r\n  type EditingQuiz = Omit<QuizWithQuestions, 'questions'> & {\r\n    questions: EditingQuestion[];\r\n  };\r\n\r\n  const [quizData, setQuizData] = useState<EditingQuiz>(\r\n    quiz ? {\r\n      ...quiz,\r\n      questions: quiz.questions.map(q => ({\r\n        ...q,\r\n        lesson_id: quiz.lesson_id\r\n      }))\r\n    } : {\r\n      id: '',\r\n      lesson_id: '',\r\n      title: 'Knowledge Check',\r\n      description: 'Test your understanding of this lesson.',\r\n      is_active: true,\r\n      created_at: new Date().toISOString(),\r\n      updated_at: new Date().toISOString(),\r\n      questions: []\r\n    }\r\n  );\r\n\r\n  const [newQuestion, setNewQuestion] = useState({\r\n    question_text: '',\r\n    question_type: 'multiple_choice' as 'multiple_choice' | 'short_answer',\r\n    is_required: true,\r\n    order_index: 0,\r\n    options: [{ option_text: '', is_correct: false, order_index: 0 }]\r\n  });\r\n\r\n  const handleAddQuestion = () => {\r\n    const newQuestionObj: EditingQuestion = {\r\n      id: `new-${Date.now()}`,\r\n      lesson_id: quizData.lesson_id,\r\n      question_text: newQuestion.question_text,\r\n      question_type: newQuestion.question_type,\r\n      is_required: newQuestion.is_required,\r\n      order_index: quizData.questions.length,\r\n      created_at: new Date().toISOString(),\r\n      updated_at: new Date().toISOString(),\r\n      options: newQuestion.question_type === 'multiple_choice' ?\r\n        newQuestion.options.map((opt, idx) => ({\r\n          id: `opt-${Date.now()}-${idx}`,\r\n          question_id: `new-${Date.now()}`,\r\n          option_text: opt.option_text,\r\n          is_correct: opt.is_correct,\r\n          order_index: idx,\r\n          created_at: new Date().toISOString(),\r\n          updated_at: new Date().toISOString()\r\n        })) : undefined\r\n    };\r\n\r\n    setQuizData({\r\n      ...quizData,\r\n      questions: [...quizData.questions, newQuestionObj]\r\n    });\r\n\r\n    // Reset form\r\n    setNewQuestion({\r\n      question_text: '',\r\n      question_type: 'multiple_choice',\r\n      is_required: true,\r\n      order_index: 0,\r\n      options: [{ option_text: '', is_correct: false, order_index: 0 }]\r\n    });\r\n  };\r\n\r\n  const handleRemoveQuestion = (index: number) => {\r\n    const updatedQuestions = [...quizData.questions];\r\n    updatedQuestions.splice(index, 1);\r\n    setQuizData({\r\n      ...quizData,\r\n      questions: updatedQuestions.map((q, i) => ({ ...q, order_index: i }))\r\n    });\r\n  };\r\n\r\n  const handleAddOption = (questionIndex: number) => {\r\n    const updatedQuestions = [...quizData.questions];\r\n    const question = updatedQuestions[questionIndex];\r\n    if (question.question_type === 'multiple_choice') {\r\n      const options = question.options || [];\r\n      question.options = [\r\n        ...options,\r\n        { \r\n          id: `opt-${Date.now()}-${Math.random()}`, \r\n          question_id: question.id,\r\n          option_text: '', \r\n          is_correct: false, \r\n          order_index: options.length,\r\n          created_at: new Date().toISOString(),\r\n          updated_at: new Date().toISOString()\r\n        }\r\n      ];\r\n    }\r\n    setQuizData({\r\n      ...quizData,\r\n      questions: updatedQuestions\r\n    });\r\n  };\r\n\r\n  const handleRemoveOption = (questionIndex: number, optionIndex: number) => {\r\n    const updatedQuestions = [...quizData.questions];\r\n    const question = updatedQuestions[questionIndex];\r\n    if (question.question_type === 'multiple_choice' && question.options) {\r\n      question.options.splice(optionIndex, 1);\r\n      question.options = question.options.map((opt, i) => ({ ...opt, order_index: i }));\r\n    }\r\n    setQuizData({\r\n      ...quizData,\r\n      questions: updatedQuestions\r\n    });\r\n  };\r\n\r\n  const handleOptionChange = (questionIndex: number, optionIndex: number, field: string, value: any) => {\r\n    const updatedQuestions = [...quizData.questions];\r\n    const question = updatedQuestions[questionIndex];\r\n    if (question.question_type === 'multiple_choice' && question.options) {\r\n      question.options[optionIndex] = {\r\n        ...question.options[optionIndex],\r\n        [field]: value\r\n      };\r\n    }\r\n    setQuizData({\r\n      ...quizData,\r\n      questions: updatedQuestions\r\n    });\r\n  };\r\n\r\n  const handleSave = () => {\r\n    // Convert EditingQuiz back to QuizWithQuestions for saving\r\n    const finalQuiz: QuizWithQuestions = {\r\n      ...quizData,\r\n      questions: quizData.questions.map(q => {\r\n        const { lesson_id, ...rest } = q; // Remove lesson_id from question since it's in the parent\r\n        return rest as any; // Type assertion since we're handling options properly\r\n      })\r\n    };\r\n    onSave(finalQuiz as QuizWithQuestions);\r\n  };\r\n\r\n  return (\r\n    <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\r\n      <div \r\n        className=\"bg-gray-900 border border-gray-700 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto\"\r\n        onClick={(e) => e.stopPropagation()}\r\n      >\r\n        <div className=\"p-6\">\r\n          <div className=\"flex justify-between items-center mb-6\">\r\n            <h2 className=\"text-xl font-bold text-white\">\r\n              Edit Quiz\r\n            </h2>\r\n            <button \r\n              onClick={onCancel}\r\n              className=\"text-gray-400 hover:text-white hover-lift\"\r\n            >\r\n              <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-6 w-6\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n              </svg>\r\n            </button>\r\n          </div>\r\n\r\n          <div className=\"space-y-6\">\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-300 mb-1\">\r\n                Quiz Title\r\n              </label>\r\n              <input\r\n                type=\"text\"\r\n                value={quizData.title}\r\n                onChange={(e) => setQuizData({...quizData, title: e.target.value})}\r\n                className=\"w-full p-2 rounded bg-gray-800 border border-gray-600 text-white\"\r\n                placeholder=\"Quiz title\"\r\n              />\r\n            </div>\r\n\r\n            <div>\r\n              <label className=\"block text-sm font-medium text-gray-300 mb-1\">\r\n                Quiz Description\r\n              </label>\r\n              <textarea\r\n                value={quizData.description}\r\n                onChange={(e) => setQuizData({...quizData, description: e.target.value})}\r\n                className=\"w-full p-2 rounded bg-gray-800 border border-gray-600 text-white\"\r\n                placeholder=\"Quiz description\"\r\n                rows={2}\r\n              />\r\n            </div>\r\n\r\n            <div className=\"flex items-center\">\r\n              <input\r\n                type=\"checkbox\"\r\n                checked={quizData.is_active}\r\n                onChange={(e) => setQuizData({...quizData, is_active: e.target.checked})}\r\n                className=\"h-4 w-4 text-accent-primary bg-gray-700 border-gray-600 rounded focus:ring-accent-primary\"\r\n              />\r\n              <span className=\"ml-2 text-sm text-gray-300\">\r\n                Active (Quiz is available to students)\r\n              </span>\r\n            </div>\r\n\r\n            <div className=\"border-t border-gray-700 pt-4\">\r\n              <div className=\"flex justify-between items-center mb-4\">\r\n                <h3 className=\"text-lg font-medium text-white\">Questions</h3>\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={handleAddQuestion}\r\n                  className=\"px-3 py-1 bg-accent-primary text-white rounded text-sm hover:bg-accent-primary/90 hover-lift border border-accent-primary\"\r\n                >\r\n                  Add Question\r\n                </button>\r\n              </div>\r\n\r\n              {quizData.questions.length === 0 ? (\r\n                <div className=\"text-center py-4 text-gray-500\">\r\n                  No questions added yet. Click \"Add Question\" to get started.\r\n                </div>\r\n              ) : (\r\n                <div className=\"space-y-4\">\r\n                  {quizData.questions.map((question, qIndex) => (\r\n                    <div key={qIndex} className=\"border border-gray-700 rounded-lg p-4\">\r\n                      <div className=\"flex justify-between items-start mb-3\">\r\n                        <div className=\"flex-1\">\r\n                          <input\r\n                            type=\"text\"\r\n                            value={question.question_text}\r\n                            onChange={(e) => {\r\n                              const updatedQuestions = [...quizData.questions];\r\n                              updatedQuestions[qIndex].question_text = e.target.value;\r\n                              setQuizData({...quizData, questions: updatedQuestions});\r\n                            }}\r\n                            className=\"w-full p-2 rounded bg-gray-800 border border-gray-600 text-white mb-2\"\r\n                            placeholder=\"Question text\"\r\n                          />\r\n                          \r\n                          <div className=\"flex gap-4 mb-2\">\r\n                            <div className=\"flex items-center\">\r\n                              <input\r\n                                type=\"radio\"\r\n                                id={`mc-${qIndex}`}\r\n                                name={`type-${qIndex}`}\r\n                                checked={question.question_type === 'multiple_choice'}\r\n                                onChange={() => {\r\n                                  const updatedQuestions = [...quizData.questions];\r\n                                  updatedQuestions[qIndex].question_type = 'multiple_choice';\r\n                                  updatedQuestions[qIndex].options = updatedQuestions[qIndex].options || [\r\n                                    { \r\n                                      id: `opt-${Date.now()}-1`, \r\n                                      question_id: updatedQuestions[qIndex].id,\r\n                                      option_text: '', \r\n                                      is_correct: false, \r\n                                      order_index: 0,\r\n                                      created_at: new Date().toISOString(),\r\n                                      updated_at: new Date().toISOString()\r\n                                    }\r\n                                  ];\r\n                                  setQuizData({...quizData, questions: updatedQuestions});\r\n                                }}\r\n                                className=\"mr-2\"\r\n                              />\r\n                              <label htmlFor={`mc-${qIndex}`} className=\"text-sm text-gray-300\">Multiple Choice</label>\r\n                            </div>\r\n                            \r\n                            <div className=\"flex items-center\">\r\n                              <input\r\n                                type=\"radio\"\r\n                                id={`sa-${qIndex}`}\r\n                                name={`type-${qIndex}`}\r\n                                checked={question.question_type === 'short_answer'}\r\n                                onChange={() => {\r\n                                  const updatedQuestions = [...quizData.questions];\r\n                                  updatedQuestions[qIndex].question_type = 'short_answer';\r\n                                  updatedQuestions[qIndex].options = []; // Clear options for short answer\r\n                                  setQuizData({...quizData, questions: updatedQuestions});\r\n                                }}\r\n                                className=\"mr-2\"\r\n                              />\r\n                              <label htmlFor={`sa-${qIndex}`} className=\"text-sm text-gray-300\">Short Answer</label>\r\n                            </div>\r\n                          </div>\r\n\r\n                          <div className=\"flex items-center\">\r\n                            <input\r\n                              type=\"checkbox\"\r\n                              checked={question.is_required}\r\n                              onChange={(e) => {\r\n                                const updatedQuestions = [...quizData.questions];\r\n                                updatedQuestions[qIndex].is_required = e.target.checked;\r\n                                setQuizData({...quizData, questions: updatedQuestions});\r\n                              }}\r\n                              className=\"mr-2\"\r\n                            />\r\n                            <span className=\"text-sm text-gray-300\">Required question</span>\r\n                          </div>\r\n                        </div>\r\n                        \r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={() => handleRemoveQuestion(qIndex)}\r\n                          className=\"ml-2 text-red-500 hover:text-red-400 hover-lift\"\r\n                        >\r\n                          <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-5 w-5\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\r\n                            <path fillRule=\"evenodd\" d=\"M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z\" clipRule=\"evenodd\" />\r\n                          </svg>\r\n                        </button>\r\n                      </div>\r\n\r\n                      {question.question_type === 'multiple_choice' && question.options && (\r\n                        <div className=\"mt-3 space-y-2\">\r\n                          <div className=\"flex justify-between items-center\">\r\n                            <label className=\"text-sm font-medium text-gray-300\">Options:</label>\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => handleAddOption(qIndex)}\r\n                              className=\"px-2 py-1 bg-gray-700 text-white rounded text-xs hover:bg-gray-600 hover-lift\"\r\n                            >\r\n                              + Add Option\r\n                            </button>\r\n                          </div>\r\n                          \r\n                          {question.options.map((option, oIndex) => (\r\n                            <div key={oIndex} className=\"flex items-center gap-2\">\r\n                              <input\r\n                                type=\"checkbox\"\r\n                                checked={option.is_correct}\r\n                                onChange={(e) => handleOptionChange(qIndex, oIndex, 'is_correct', e.target.checked)}\r\n                                className=\"mr-2\"\r\n                              />\r\n                              <input\r\n                                type=\"text\"\r\n                                value={option.option_text}\r\n                                onChange={(e) => handleOptionChange(qIndex, oIndex, 'option_text', e.target.value)}\r\n                                className=\"flex-1 p-2 rounded bg-gray-800 border border-gray-600 text-white text-sm\"\r\n                                placeholder=\"Option text\"\r\n                              />\r\n                              <button\r\n                                type=\"button\"\r\n                                onClick={() => handleRemoveOption(qIndex, oIndex)}\r\n                                className=\"text-red-500 hover:text-red-400\"\r\n                              >\r\n                                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-4 w-4\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\r\n                                  <path fillRule=\"evenodd\" d=\"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z\" clipRule=\"evenodd\" />\r\n                                </svg>\r\n                              </button>\r\n                            </div>\r\n                          ))}\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"mt-6 flex justify-end space-x-3\">\r\n            <button\r\n              type=\"button\"\r\n              onClick={onCancel}\r\n              className=\"px-4 py-2 border border-gray-600 rounded-md text-gray-300 hover:bg-gray-800 hover-lift\"\r\n            >\r\n              Cancel\r\n            </button>\r\n            <button\r\n              type=\"button\"\r\n              onClick={handleSave}\r\n              className=\"px-4 py-2 bg-accent-primary hover:bg-accent-primary/90 text-white rounded-md font-medium hover-lift border border-accent-primary\"\r\n            >\r\n              Save Quiz\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3201, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/components/admin/LessonEditor.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Lesson } from '@/types/course';\r\nimport { updateLesson, createLesson } from '@/actions/courseActions';\r\nimport { parseYouTube } from '@/lib/youtubeParser';\r\nimport { getQuizByLessonId, upsertQuiz } from '@/services/quizService';\r\nimport { QuizEditor } from './QuizEditor';\r\n\r\ninterface LessonEditorProps {\r\n  lesson: Lesson | null;\r\n  moduleId: string | null;\r\n  onSave: (lesson: Lesson) => void;\r\n  onClose: () => void;\r\n  onCreate: (lesson: Lesson) => void;\r\n}\r\n\r\nconst LessonEditor = ({ lesson, moduleId, onSave, onClose, onCreate }: LessonEditorProps) => {\r\n  const [title, setTitle] = useState('');\r\n  const [description, setDescription] = useState('');\r\n  const [youtubeUrl, setYoutubeUrl] = useState('');\r\n  const [isPreview, setIsPreview] = useState(false);\r\n  const [isPublished, setIsPublished] = useState(true);\r\n  const [loading, setLoading] = useState(false);\r\n  const [errors, setErrors] = useState<Record<string, string>>({});\r\n  const [embedUrl, setEmbedUrl] = useState<string | null>(null);\r\n  const [quiz, setQuiz] = useState<any>(null);\r\n  const [quizLoading, setQuizLoading] = useState(false);\r\n  const [showQuizEditor, setShowQuizEditor] = useState(false);\r\n\r\n  useEffect(() => {\r\n    if (lesson) {\r\n      setTitle(lesson.title || '');\r\n      setDescription(lesson.description || '');\r\n      setYoutubeUrl(lesson.video_url || '');\r\n      setIsPreview(!!lesson.is_preview);\r\n      setIsPublished(!!lesson.is_published);\r\n      setEmbedUrl(lesson.video_url || null);\r\n      \r\n      // Load quiz for this lesson\r\n      loadQuiz(lesson.id);\r\n    } else {\r\n      // Reset form for new lesson\r\n      setTitle('');\r\n      setDescription('');\r\n      setYoutubeUrl('');\r\n      setIsPreview(false);\r\n      setIsPublished(true);\r\n      setEmbedUrl(null);\r\n      setQuiz(null);\r\n      setErrors({});\r\n    }\r\n  }, [lesson]);\r\n\r\n  // Monitor quiz state changes for debugging\r\n  useEffect(() => {\r\n    console.log('Quiz state changed:', quiz);\r\n    if (quiz) {\r\n      console.log(`Quiz has ${quiz.questions?.length || 0} questions`);\r\n    }\r\n  }, [quiz]);\r\n  \r\n  const loadQuiz = async (lessonId: string) => {\r\n    setQuizLoading(true);\r\n    try {\r\n      console.log('loadQuiz: Loading quiz for lesson:', lessonId);\r\n      const lessonQuiz = await getQuizByLessonId(lessonId);\r\n      console.log('loadQuiz: Loaded quiz data:', lessonQuiz);\r\n      setQuiz(lessonQuiz);\r\n      \r\n      // Force a re-render by updating state\r\n      if (lessonQuiz) {\r\n        console.log(`loadQuiz: Setting quiz with ${lessonQuiz.questions.length} questions`);\r\n      } else {\r\n        console.log('loadQuiz: No quiz found for this lesson');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading quiz:', error);\r\n    } finally {\r\n      setQuizLoading(false);\r\n    }\r\n  };\r\n\r\n  const validate = () => {\r\n    const newErrors: Record<string, string> = {};\r\n    \r\n    if (!title.trim()) {\r\n      newErrors.title = 'Title is required';\r\n    }\r\n    \r\n    if (!youtubeUrl.trim()) {\r\n      newErrors.youtubeUrl = 'YouTube URL is required';\r\n    } else {\r\n      const parsed = parseYouTube(youtubeUrl);\r\n      if (parsed.error) {\r\n        newErrors.youtubeUrl = parsed.error;\r\n      }\r\n    }\r\n    \r\n    setErrors(newErrors);\r\n    return Object.keys(newErrors).length === 0;\r\n  };\r\n\r\n  const handleSave = async () => {\r\n    if (!validate()) return;\r\n    \r\n    setLoading(true);\r\n    \r\n    try {\r\n      if (lesson) {\r\n        // Update existing lesson\r\n        const updates = {\r\n          title,\r\n          description,\r\n          video_url: youtubeUrl,\r\n          is_preview: isPreview,\r\n          is_published: isPublished\r\n        };\r\n        \r\n        const result = await updateLesson(lesson.id, updates);\r\n        if (result.error) {\r\n          setErrors({ general: result.error });\r\n        } else if (result.data) {\r\n          onSave(result.data);\r\n          onClose();\r\n        }\r\n      } else if (moduleId) {\r\n        // Create new lesson\r\n        const result = await createLesson(moduleId, title, description, youtubeUrl);\r\n        if (result.error) {\r\n          setErrors({ general: result.error });\r\n        } else if (result.data) {\r\n          onCreate(result.data);\r\n          onClose();\r\n        }\r\n      }\r\n    } catch (err) {\r\n      setErrors({ general: 'An unexpected error occurred' });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n  \r\n  const handleSaveQuiz = async (quizData: any) => {\r\n    if (!lesson) return;\r\n    \r\n    try {\r\n      console.log('handleSaveQuiz: Saving quiz data:', quizData);\r\n      await upsertQuiz(lesson.id, {\r\n        title: quizData.title,\r\n        description: quizData.description,\r\n        is_active: quizData.is_active,\r\n        questions: quizData.questions.map((q: any, index: number) => ({\r\n          id: q.id,\r\n          question_text: q.question_text,\r\n          question_type: q.question_type,\r\n          is_required: q.is_required,\r\n          order_index: index,\r\n          options: q.options?.map((opt: any, optIndex: number) => ({\r\n            id: opt.id,\r\n            option_text: opt.option_text,\r\n            is_correct: opt.is_correct,\r\n            order_index: optIndex\r\n          }))\r\n        }))\r\n      });\r\n      \r\n      // Reload quiz after saving\r\n      console.log('handleSaveQuiz: Reloading quiz after save');\r\n      await loadQuiz(lesson.id);\r\n      setShowQuizEditor(false);\r\n    } catch (error) {\r\n      console.error('Error saving quiz:', error);\r\n      setErrors({ general: 'Error saving quiz' });\r\n    }\r\n  };\r\n\r\n  const handleUrlChange = (value: string) => {\r\n    setYoutubeUrl(value);\r\n    \r\n    // Parse URL and show preview if valid\r\n    const parsed = parseYouTube(value);\r\n    if (!parsed.error) {\r\n      setEmbedUrl(parsed.embedUrl);\r\n    } else {\r\n      setEmbedUrl(null);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <>\r\n      <div className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\">\r\n        <div \r\n          className=\"bg-gray-900 border border-gray-700 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto\"\r\n          onClick={(e) => e.stopPropagation()}\r\n        >\r\n          <div className=\"p-6\">\r\n            <div className=\"flex justify-between items-center mb-6\">\r\n              <h2 className=\"text-xl font-bold text-white\">\r\n                {lesson ? 'Edit Lesson' : 'Create New Lesson'}\r\n              </h2>\r\n              <button \r\n                onClick={onClose}\r\n                className=\"text-gray-400 hover:text-white hover-lift\"\r\n              >\r\n                <svg xmlns=\"http://www.w3.org/2000/svg\" className=\"h-6 w-6\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\r\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\r\n                </svg>\r\n              </button>\r\n            </div>\r\n\r\n            {errors.general && (\r\n              <div className=\"mb-4 p-3 bg-red-900/30 border border-red-700 rounded text-red-300\">\r\n                {errors.general}\r\n              </div>\r\n            )}\r\n\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\r\n              <div className=\"space-y-4\">\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-300 mb-1\">\r\n                    Title *\r\n                  </label>\r\n                  <input\r\n                    type=\"text\"\r\n                    value={title}\r\n                    onChange={(e) => setTitle(e.target.value)}\r\n                    className={`w-full p-2 rounded bg-gray-800 border ${\r\n                      errors.title ? 'border-red-500' : 'border-gray-600'\r\n                    } text-white`}\r\n                    placeholder=\"Lesson title\"\r\n                  />\r\n                  {errors.title && (\r\n                    <p className=\"mt-1 text-sm text-red-400\">{errors.title}</p>\r\n                  )}\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-300 mb-1\">\r\n                    YouTube URL *\r\n                  </label>\r\n                  <input\r\n                    type=\"text\"\r\n                    value={youtubeUrl}\r\n                    onChange={(e) => handleUrlChange(e.target.value)}\r\n                    className={`w-full p-2 rounded bg-gray-800 border ${\r\n                      errors.youtubeUrl ? 'border-red-500' : 'border-gray-600'\r\n                    } text-white`}\r\n                    placeholder=\"Paste YouTube URL or video ID\"\r\n                  />\r\n                  {errors.youtubeUrl && (\r\n                    <p className=\"mt-1 text-sm text-red-400\">{errors.youtubeUrl}</p>\r\n                  )}\r\n                  <p className=\"mt-1 text-xs text-gray-500\">\r\n                    Supports: watch?v=, youtu.be/, embed/, shorts/\r\n                  </p>\r\n                </div>\r\n\r\n                <div className=\"grid grid-cols-2 gap-4\">\r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-300 mb-1\">\r\n                      Preview\r\n                    </label>\r\n                    <div className=\"flex items-center\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        checked={isPreview}\r\n                        onChange={(e) => setIsPreview(e.target.checked)}\r\n                        className=\"h-4 w-4 text-accent-primary bg-gray-700 border-gray-600 rounded focus:ring-accent-primary\"\r\n                      />\r\n                      <span className=\"ml-2 text-sm text-gray-300\">\r\n                        Available for free users\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n                  \r\n                  <div>\r\n                    <label className=\"block text-sm font-medium text-gray-300 mb-1\">\r\n                      Published\r\n                    </label>\r\n                    <div className=\"flex items-center\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        checked={isPublished}\r\n                        onChange={(e) => setIsPublished(e.target.checked)}\r\n                        className=\"h-4 w-4 text-accent-primary bg-gray-700 border-gray-600 rounded focus:ring-accent-primary\"\r\n                      />\r\n                      <span className=\"ml-2 text-sm text-gray-300\">\r\n                        Visible to users\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-300 mb-1\">\r\n                    Description\r\n                  </label>\r\n                  <textarea\r\n                    value={description}\r\n                    onChange={(e) => setDescription(e.target.value)}\r\n                    className=\"w-full p-2 rounded bg-gray-800 border border-gray-600 text-white\"\r\n                    placeholder=\"Lesson description (optional)\"\r\n                    rows={4}\r\n                  />\r\n                </div>\r\n                \r\n                {/* Quiz Section */}\r\n                <div className=\"pt-4 border-t border-gray-700\">\r\n                  <div className=\"flex justify-between items-center\">\r\n                    <h3 className=\"text-lg font-medium text-white mb-2\">Quiz</h3>\r\n                    <button\r\n                      type=\"button\"\r\n                      onClick={() => {\r\n                        if (lesson) {\r\n                          setShowQuizEditor(true);\r\n                        }\r\n                      }}\r\n                      disabled={!lesson}\r\n                      className=\"px-3 py-1 bg-accent-primary text-white rounded text-sm hover:bg-accent-primary/90 hover-lift disabled:opacity-50 disabled:cursor-not-allowed border border-accent-primary\"\r\n                    >\r\n                      {quiz ? 'Edit Quiz' : 'Create Quiz'}\r\n                    </button>\r\n                  </div>\r\n                  \r\n                  {quizLoading ? (\r\n                    <div className=\"text-gray-500 text-sm\">Loading quiz...</div>\r\n                  ) : quiz ? (\r\n                    <div className=\"mt-2 text-sm text-gray-400\">\r\n                      <div>Quiz: {quiz.title}</div>\r\n                      <div>Questions: {quiz.questions.length}</div>\r\n                      <div>Status: {quiz.is_active ? 'Active' : 'Inactive'}</div>\r\n                    </div>\r\n                  ) : (\r\n                    <div className=\"mt-2 text-sm text-gray-500\">\r\n                      No quiz created for this lesson yet.\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium text-gray-300 mb-1\">\r\n                  Preview\r\n                </label>\r\n                <div className=\"bg-gray-800 border border-gray-700 rounded-lg p-4\">\r\n                  {embedUrl ? (\r\n                    <div className=\"aspect-video w-full\">\r\n                      <iframe\r\n                        src={embedUrl}\r\n                        title=\"YouTube video player\"\r\n                        frameBorder=\"0\"\r\n                        allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\"\r\n                        allowFullScreen\r\n                        className=\"w-full h-full rounded\"\r\n                      ></iframe>\r\n                    </div>\r\n                  ) : (\r\n                    <div className=\"flex items-center justify-center h-48 border-2 border-dashed border-gray-600 rounded-lg\">\r\n                      <p className=\"text-gray-500\">Video preview will appear here</p>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n                <p className=\"mt-2 text-xs text-gray-500\">\r\n                  The video will be embedded using the provided YouTube URL\r\n                </p>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"mt-6 flex justify-end space-x-3\">\r\n              <button\r\n                type=\"button\"\r\n                onClick={onClose}\r\n                disabled={loading}\r\n                className=\"px-4 py-2 border border-gray-600 rounded-md text-gray-300 hover:bg-gray-800 disabled:opacity-50 hover-lift\"\r\n              >\r\n                Cancel\r\n              </button>\r\n              <button\r\n                type=\"button\"\r\n                onClick={handleSave}\r\n                disabled={loading}\r\n                className=\"px-4 py-2 bg-accent-primary hover:bg-accent-primary/90 text-white rounded-md font-medium disabled:opacity-50 hover-lift border border-accent-primary\"\r\n              >\r\n                {loading ? 'Saving...' : lesson ? 'Update Lesson' : 'Create Lesson'}\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      \r\n      {showQuizEditor && lesson && (\r\n        <QuizEditor\r\n          quiz={quiz}\r\n          onSave={handleSaveQuiz}\r\n          onCancel={() => setShowQuizEditor(false)}\r\n        />\r\n      )}\r\n    </>\r\n  );\r\n};\r\n\r\nexport default LessonEditor;"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3901, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/announcementActions.ts"],"sourcesContent":["'use server';\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\n\r\n// Type definitions\r\ntype Announcement = {\r\n  id: string;\r\n  title: string;\r\n  body: string;\r\n  created_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin' || profile.role === 'teacher';\r\n}\r\n\r\n// Announcement Actions\r\nexport async function listAnnouncements(): Promise<{ data: Announcement[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('announcements')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createAnnouncement(title: string, body: string): Promise<{ data: Announcement | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('announcements')\r\n      .insert([{ title, body }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateAnnouncement(id: string, updates: Partial<Announcement>): Promise<{ data: Announcement | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('announcements')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteAnnouncement(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('announcements')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MAuDsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,qDAAA"}},
    {"offset": {"line": 3918, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/announcementActions.ts"],"sourcesContent":["'use server';\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\n\r\n// Type definitions\r\ntype Announcement = {\r\n  id: string;\r\n  title: string;\r\n  body: string;\r\n  created_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin' || profile.role === 'teacher';\r\n}\r\n\r\n// Announcement Actions\r\nexport async function listAnnouncements(): Promise<{ data: Announcement[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('announcements')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createAnnouncement(title: string, body: string): Promise<{ data: Announcement | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('announcements')\r\n      .insert([{ title, body }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateAnnouncement(id: string, updates: Partial<Announcement>): Promise<{ data: Announcement | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('announcements')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteAnnouncement(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('announcements')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MAgFsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,sDAAA"}},
    {"offset": {"line": 3935, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/announcementActions.ts"],"sourcesContent":["'use server';\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\n\r\n// Type definitions\r\ntype Announcement = {\r\n  id: string;\r\n  title: string;\r\n  body: string;\r\n  created_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin' || profile.role === 'teacher';\r\n}\r\n\r\n// Announcement Actions\r\nexport async function listAnnouncements(): Promise<{ data: Announcement[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('announcements')\r\n      .select('*')\r\n      .order('created_at', { ascending: false });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function createAnnouncement(title: string, body: string): Promise<{ data: Announcement | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('announcements')\r\n      .insert([{ title, body }])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateAnnouncement(id: string, updates: Partial<Announcement>): Promise<{ data: Announcement | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('announcements')\r\n      .update(updates)\r\n      .eq('id', id)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    return { data, error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteAnnouncement(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin or teacher role required.' };\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('announcements')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MAqIsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,sDAAA"}},
    {"offset": {"line": 3952, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/components/admin/AnnouncementManager.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { listAnnouncements, createAnnouncement, deleteAnnouncement } from '@/actions/announcementActions';\r\n\r\ninterface Announcement {\r\n  id: string;\r\n  title: string;\r\n  body: string;\r\n  created_at: string;\r\n}\r\n\r\nconst AnnouncementManager = () => {\r\n  const [announcements, setAnnouncements] = useState<Announcement[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [showCreateForm, setShowCreateForm] = useState(false);\r\n  const [newTitle, setNewTitle] = useState('');\r\n  const [newBody, setNewBody] = useState('');\r\n\r\n  useEffect(() => {\r\n    loadAnnouncements();\r\n  }, []);\r\n\r\n  const loadAnnouncements = async () => {\r\n    setLoading(true);\r\n    setError(null);\r\n    try {\r\n      const result = await listAnnouncements();\r\n      if (result.error) {\r\n        setError(result.error);\r\n      } else if (result.data) {\r\n        setAnnouncements(result.data);\r\n      }\r\n    } catch (err) {\r\n      setError('Failed to load announcements');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleCreateAnnouncement = async () => {\r\n    if (!newTitle.trim() || !newBody.trim()) {\r\n      setError('Title and body are required');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const result = await createAnnouncement(newTitle, newBody);\r\n      if (result.error) {\r\n        setError(result.error);\r\n      } else if (result.data) {\r\n        setAnnouncements([result.data, ...announcements]);\r\n        setNewTitle('');\r\n        setNewBody('');\r\n        setShowCreateForm(false);\r\n      }\r\n    } catch (err) {\r\n      setError('Failed to create announcement');\r\n    }\r\n  };\r\n\r\n  const handleDeleteAnnouncement = async (id: string) => {\r\n    if (!confirm('Are you sure you want to delete this announcement?')) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const result = await deleteAnnouncement(id);\r\n      if (result.error) {\r\n        setError(result.error);\r\n      } else {\r\n        setAnnouncements(announcements.filter(announcement => announcement.id !== id));\r\n      }\r\n    } catch (err) {\r\n      setError('Failed to delete announcement');\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"h-full flex flex-col\">\r\n      <div className=\"p-4 border-b border-gray-700\">\r\n        <div className=\"flex justify-between items-center mb-4\">\r\n          <h3 className=\"text-lg font-semibold text-white\">Announcements</h3>\r\n          <button\r\n            onClick={() => setShowCreateForm(!showCreateForm)}\r\n            className=\"bg-accent-primary hover:bg-accent-primary/90 text-white px-3 py-1 rounded-md text-sm font-medium transition-colors hover-lift border border-accent-primary\"\r\n          >\r\n            + New\r\n          </button>\r\n        </div>\r\n\r\n        {showCreateForm && (\r\n          <div className=\"mb-4 p-3 bg-gray-800 rounded-lg\">\r\n            <input\r\n              type=\"text\"\r\n              value={newTitle}\r\n              onChange={(e) => setNewTitle(e.target.value)}\r\n              placeholder=\"Announcement title\"\r\n              className=\"w-full p-2 mb-2 rounded bg-gray-700 border border-gray-600 text-white\"\r\n            />\r\n            <textarea\r\n              value={newBody}\r\n              onChange={(e) => setNewBody(e.target.value)}\r\n              placeholder=\"Announcement content\"\r\n              className=\"w-full p-2 mb-2 rounded bg-gray-700 border border-gray-600 text-white\"\r\n              rows={3}\r\n            />\r\n            <div className=\"flex gap-2\">\r\n              <button\r\n                onClick={handleCreateAnnouncement}\r\n                className=\"bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm hover-lift\"\r\n              >\r\n                Create\r\n              </button>\r\n              <button\r\n                onClick={() => {\r\n                  setShowCreateForm(false);\r\n                  setNewTitle('');\r\n                  setNewBody('');\r\n                }}\r\n                className=\"bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm hover-lift\"\r\n              >\r\n                Cancel\r\n              </button>\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {error && (\r\n          <div className=\"mb-4 p-2 bg-red-900/30 border border-red-700 rounded text-red-300 text-sm\">\r\n            {error}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"flex-1 overflow-y-auto\">\r\n        {loading ? (\r\n          <div className=\"p-4 text-center text-gray-400\">Loading announcements...</div>\r\n        ) : announcements.length === 0 ? (\r\n          <div className=\"p-4 text-center text-gray-400\">No announcements found</div>\r\n        ) : (\r\n          <ul className=\"divide-y divide-gray-700\">\r\n            {announcements.map((announcement) => (\r\n              <li key={announcement.id} className=\"p-3 border-b border-gray-700\">\r\n                <div className=\"flex justify-between items-start\">\r\n                  <div className=\"flex-1\">\r\n                    <h4 className=\"font-medium text-white\">{announcement.title}</h4>\r\n                    <p className=\"text-sm text-gray-300 mt-1\">{announcement.body}</p>\r\n                    <div className=\"mt-2 text-xs text-gray-500\">\r\n                      {new Date(announcement.created_at).toLocaleString()}\r\n                    </div>\r\n                  </div>\r\n                  <button\r\n                    onClick={() => handleDeleteAnnouncement(announcement.id)}\r\n                    className=\"p-1 rounded text-red-400 hover:bg-red-900/20 ml-2 hover-lift\"\r\n                    title=\"Delete\"\r\n                  >\r\n                    <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\">\r\n                      <path d=\"M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2\"/>\r\n                    </svg>\r\n                  </button>\r\n                </div>\r\n              </li>\r\n            ))}\r\n          </ul>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default AnnouncementManager;"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4267, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/userActions.ts"],"sourcesContent":["'use server';\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\n\r\n// Type definitions\r\ntype User = {\r\n  id: string;\r\n  username: string;\r\n  email: string;\r\n  role: string;\r\n  plan: string;\r\n  created_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin';\r\n}\r\n\r\n// User Actions\r\nexport async function listUsers(): Promise<{ data: User[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin role required.' };\r\n    }\r\n\r\n    // Join with auth.users to get email\r\n    const { data, error } = await supabase\r\n      .from('profiles')\r\n      .select(`\r\n        id,\r\n        username,\r\n        role,\r\n        plan,\r\n        created_at\r\n      `)\r\n      .order('created_at', { ascending: false });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // For now, we'll return mock emails since we can't access auth.users directly from RLS\r\n    // In a real implementation, you'd need a service role key or a dedicated RPC function\r\n    const usersWithMockEmails = data.map((user: any) => ({\r\n      ...user,\r\n      email: `${user.username}@example.com` // Mock email for demo purposes\r\n    }));\r\n\r\n    return { data: usersWithMockEmails as User[], error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateUser(id: string, updates: Partial<User>): Promise<{ data: User | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin role required.' };\r\n    }\r\n\r\n    // Use the hardened service function\r\n    const { data, error } = await supabase\r\n      .from('profiles')\r\n      .update({\r\n        role: updates.role,\r\n        plan: updates.plan\r\n      })\r\n      .eq('id', id)\r\n      .select()\r\n      .maybeSingle(); // Changed from .single() to .maybeSingle()\r\n\r\n    if (error) {\r\n      console.error('[USER ACTION] Update error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n    \r\n    // Handle case where no rows were updated\r\n    if (!data) {\r\n      console.error('[USER ACTION] No profile found for update:', id);\r\n      return { data: null, error: 'No profile found for this user' };\r\n    }\r\n\r\n    // Add mock email\r\n    const userData = {\r\n      ...data,\r\n      email: `${data.username}@example.com`\r\n    };\r\n\r\n    return { data: userData as User, error: null };\r\n  } catch (error: any) {\r\n    console.error('[USER ACTION] Unexpected error:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteUser(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin role required.' };\r\n    }\r\n\r\n    // Note: In a real implementation, you'd want to properly delete the user\r\n    // from auth.users as well, but that typically requires a service role key\r\n    // For now, we'll just delete from profiles\r\n    const { error } = await supabase\r\n      .from('profiles')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function searchUsers(searchTerm: string): Promise<{ data: User[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('profiles')\r\n      .select(`\r\n        id,\r\n        username,\r\n        role,\r\n        plan,\r\n        created_at\r\n      `)\r\n      .or(`username.ilike.%${searchTerm}%,role.ilike.%${searchTerm}%`)\r\n      .order('created_at', { ascending: false });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Add mock emails\r\n    const usersWithMockEmails = data.map((user: any) => ({\r\n      ...user,\r\n      email: `${user.username}@example.com`\r\n    }));\r\n\r\n    return { data: usersWithMockEmails as User[], error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MAyDsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,6CAAA"}},
    {"offset": {"line": 4284, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/userActions.ts"],"sourcesContent":["'use server';\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\n\r\n// Type definitions\r\ntype User = {\r\n  id: string;\r\n  username: string;\r\n  email: string;\r\n  role: string;\r\n  plan: string;\r\n  created_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin';\r\n}\r\n\r\n// User Actions\r\nexport async function listUsers(): Promise<{ data: User[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin role required.' };\r\n    }\r\n\r\n    // Join with auth.users to get email\r\n    const { data, error } = await supabase\r\n      .from('profiles')\r\n      .select(`\r\n        id,\r\n        username,\r\n        role,\r\n        plan,\r\n        created_at\r\n      `)\r\n      .order('created_at', { ascending: false });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // For now, we'll return mock emails since we can't access auth.users directly from RLS\r\n    // In a real implementation, you'd need a service role key or a dedicated RPC function\r\n    const usersWithMockEmails = data.map((user: any) => ({\r\n      ...user,\r\n      email: `${user.username}@example.com` // Mock email for demo purposes\r\n    }));\r\n\r\n    return { data: usersWithMockEmails as User[], error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateUser(id: string, updates: Partial<User>): Promise<{ data: User | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin role required.' };\r\n    }\r\n\r\n    // Use the hardened service function\r\n    const { data, error } = await supabase\r\n      .from('profiles')\r\n      .update({\r\n        role: updates.role,\r\n        plan: updates.plan\r\n      })\r\n      .eq('id', id)\r\n      .select()\r\n      .maybeSingle(); // Changed from .single() to .maybeSingle()\r\n\r\n    if (error) {\r\n      console.error('[USER ACTION] Update error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n    \r\n    // Handle case where no rows were updated\r\n    if (!data) {\r\n      console.error('[USER ACTION] No profile found for update:', id);\r\n      return { data: null, error: 'No profile found for this user' };\r\n    }\r\n\r\n    // Add mock email\r\n    const userData = {\r\n      ...data,\r\n      email: `${data.username}@example.com`\r\n    };\r\n\r\n    return { data: userData as User, error: null };\r\n  } catch (error: any) {\r\n    console.error('[USER ACTION] Unexpected error:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteUser(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin role required.' };\r\n    }\r\n\r\n    // Note: In a real implementation, you'd want to properly delete the user\r\n    // from auth.users as well, but that typically requires a service role key\r\n    // For now, we'll just delete from profiles\r\n    const { error } = await supabase\r\n      .from('profiles')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function searchUsers(searchTerm: string): Promise<{ data: User[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('profiles')\r\n      .select(`\r\n        id,\r\n        username,\r\n        role,\r\n        plan,\r\n        created_at\r\n      `)\r\n      .or(`username.ilike.%${searchTerm}%,role.ilike.%${searchTerm}%`)\r\n      .order('created_at', { ascending: false });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Add mock emails\r\n    const usersWithMockEmails = data.map((user: any) => ({\r\n      ...user,\r\n      email: `${user.username}@example.com`\r\n    }));\r\n\r\n    return { data: usersWithMockEmails as User[], error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MAgGsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,8CAAA"}},
    {"offset": {"line": 4301, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/actions/userActions.ts"],"sourcesContent":["'use server';\r\n\r\nimport { cookies } from 'next/headers';\r\nimport { createServerClient } from '@supabase/ssr';\r\n\r\n// Type definitions\r\ntype User = {\r\n  id: string;\r\n  username: string;\r\n  email: string;\r\n  role: string;\r\n  plan: string;\r\n  created_at: string;\r\n};\r\n\r\n// Helper function to create Supabase client for server actions\r\nasync function createSupabaseClient() {\r\n  const cookieStore = await cookies();\r\n  return createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        get: (name: string) => {\r\n          const cookie = cookieStore.get(name);\r\n          return cookie ? cookie.value : undefined;\r\n        },\r\n      },\r\n    }\r\n  );\r\n}\r\n\r\n// Check if user is admin\r\nasync function isAdmin(supabase: any): Promise<boolean> {\r\n  const {\r\n    data: { user },\r\n    error: userError,\r\n  } = await supabase.auth.getUser();\r\n\r\n  if (userError || !user) {\r\n    return false;\r\n  }\r\n\r\n  const { data: profile, error: profileError } = await supabase\r\n    .from('profiles')\r\n    .select('role')\r\n    .eq('id', user.id)\r\n    .single();\r\n\r\n  if (profileError || !profile) {\r\n    return false;\r\n  }\r\n\r\n  return profile.role === 'admin';\r\n}\r\n\r\n// User Actions\r\nexport async function listUsers(): Promise<{ data: User[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin role required.' };\r\n    }\r\n\r\n    // Join with auth.users to get email\r\n    const { data, error } = await supabase\r\n      .from('profiles')\r\n      .select(`\r\n        id,\r\n        username,\r\n        role,\r\n        plan,\r\n        created_at\r\n      `)\r\n      .order('created_at', { ascending: false });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // For now, we'll return mock emails since we can't access auth.users directly from RLS\r\n    // In a real implementation, you'd need a service role key or a dedicated RPC function\r\n    const usersWithMockEmails = data.map((user: any) => ({\r\n      ...user,\r\n      email: `${user.username}@example.com` // Mock email for demo purposes\r\n    }));\r\n\r\n    return { data: usersWithMockEmails as User[], error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function updateUser(id: string, updates: Partial<User>): Promise<{ data: User | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin role required.' };\r\n    }\r\n\r\n    // Use the hardened service function\r\n    const { data, error } = await supabase\r\n      .from('profiles')\r\n      .update({\r\n        role: updates.role,\r\n        plan: updates.plan\r\n      })\r\n      .eq('id', id)\r\n      .select()\r\n      .maybeSingle(); // Changed from .single() to .maybeSingle()\r\n\r\n    if (error) {\r\n      console.error('[USER ACTION] Update error:', error);\r\n      return { data: null, error: error.message };\r\n    }\r\n    \r\n    // Handle case where no rows were updated\r\n    if (!data) {\r\n      console.error('[USER ACTION] No profile found for update:', id);\r\n      return { data: null, error: 'No profile found for this user' };\r\n    }\r\n\r\n    // Add mock email\r\n    const userData = {\r\n      ...data,\r\n      email: `${data.username}@example.com`\r\n    };\r\n\r\n    return { data: userData as User, error: null };\r\n  } catch (error: any) {\r\n    console.error('[USER ACTION] Unexpected error:', error);\r\n    return { data: null, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function deleteUser(id: string): Promise<{ error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { error: 'Access denied. Admin role required.' };\r\n    }\r\n\r\n    // Note: In a real implementation, you'd want to properly delete the user\r\n    // from auth.users as well, but that typically requires a service role key\r\n    // For now, we'll just delete from profiles\r\n    const { error } = await supabase\r\n      .from('profiles')\r\n      .delete()\r\n      .eq('id', id);\r\n\r\n    if (error) {\r\n      return { error: error.message };\r\n    }\r\n\r\n    return { error: null };\r\n  } catch (error: any) {\r\n    return { error: error.message };\r\n  }\r\n}\r\n\r\nexport async function searchUsers(searchTerm: string): Promise<{ data: User[] | null; error: string | null }> {\r\n  const supabase = await createSupabaseClient();\r\n  \r\n  try {\r\n    // Check admin access\r\n    const adminCheck = await isAdmin(supabase);\r\n    if (!adminCheck) {\r\n      return { data: null, error: 'Access denied. Admin role required.' };\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('profiles')\r\n      .select(`\r\n        id,\r\n        username,\r\n        role,\r\n        plan,\r\n        created_at\r\n      `)\r\n      .or(`username.ilike.%${searchTerm}%,role.ilike.%${searchTerm}%`)\r\n      .order('created_at', { ascending: false });\r\n\r\n    if (error) {\r\n      return { data: null, error: error.message };\r\n    }\r\n\r\n    // Add mock emails\r\n    const usersWithMockEmails = data.map((user: any) => ({\r\n      ...user,\r\n      email: `${user.username}@example.com`\r\n    }));\r\n\r\n    return { data: usersWithMockEmails as User[], error: null };\r\n  } catch (error: any) {\r\n    return { data: null, error: error.message };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;MA6IsB,wBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA,8CAAA"}},
    {"offset": {"line": 4318, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/components/admin/UserManager.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { listUsers, updateUser, deleteUser, searchUsers } from '@/actions/userActions';\r\n\r\ninterface User {\r\n  id: string;\r\n  username: string;\r\n  email: string;\r\n  role: string;\r\n  plan: string;\r\n  created_at: string;\r\n}\r\n\r\nconst UserManager = () => {\r\n  const [users, setUsers] = useState<User[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [searchTerm, setSearchTerm] = useState('');\r\n  const [originalUsers, setOriginalUsers] = useState<User[]>([]);\r\n\r\n  useEffect(() => {\r\n    loadUsers();\r\n  }, []);\r\n\r\n  const loadUsers = async () => {\r\n    setLoading(true);\r\n    setError(null);\r\n    try {\r\n      const result = await listUsers();\r\n      if (result.error) {\r\n        setError(result.error);\r\n      } else if (result.data) {\r\n        setUsers(result.data);\r\n        setOriginalUsers(result.data); // Store original for search\r\n      }\r\n    } catch (err) {\r\n      setError('Failed to load users');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  // Use original users for filtering\r\n  const filteredUsers = originalUsers.filter(user => \r\n    user.username.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    user.email.toLowerCase().includes(searchTerm.toLowerCase()) ||\r\n    user.role.toLowerCase().includes(searchTerm.toLowerCase())\r\n  );\r\n\r\n  const updateUserRole = async (userId: string, newRole: string) => {\r\n    try {\r\n      // Use the new hardened service function\r\n      const result = await updateUser(userId, { role: newRole });\r\n      if (result.error) {\r\n        setError(result.error);\r\n        console.error('Update user role error:', result.error);\r\n      } else if (result.data) {\r\n        setUsers(users.map(user => \r\n          user.id === userId ? result.data! : user\r\n        ));\r\n      }\r\n    } catch (err) {\r\n      console.error('Failed to update user role:', err);\r\n      setError('Failed to update user role');\r\n    }\r\n  };\r\n\r\n  const updateUserPlan = async (userId: string, newPlan: string) => {\r\n    try {\r\n      const result = await updateUser(userId, { plan: newPlan });\r\n      if (result.error) {\r\n        setError(result.error);\r\n      } else if (result.data) {\r\n        setUsers(users.map(user => \r\n          user.id === userId ? result.data! : user\r\n        ));\r\n      }\r\n    } catch (err) {\r\n      setError('Failed to update user plan');\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"h-full flex flex-col\">\r\n      <div className=\"p-4 border-b border-gray-700\">\r\n        <h3 className=\"text-lg font-semibold text-white mb-4\">Users</h3>\r\n        \r\n        <div className=\"mb-4\">\r\n          <input\r\n            type=\"text\"\r\n            value={searchTerm}\r\n            onChange={async (e) => {\r\n              const value = e.target.value;\r\n              setSearchTerm(value);\r\n              \r\n              // If search term is empty, load all users again\r\n              if (!value.trim()) {\r\n                loadUsers();\r\n              } else {\r\n                // For now, we'll just filter client-side\r\n                // In a real implementation, you'd call searchUsers(value)\r\n              }\r\n            }}\r\n            placeholder=\"Search users...\"\r\n            className=\"w-full p-2 rounded bg-gray-800 border border-gray-600 text-white\"\r\n          />\r\n        </div>\r\n\r\n        {error && (\r\n          <div className=\"mb-4 p-2 bg-red-900/30 border border-red-700 rounded text-red-300 text-sm\">\r\n            {error}\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div className=\"flex-1 overflow-y-auto\">\r\n        {loading ? (\r\n          <div className=\"p-4 text-center text-gray-400\">Loading users...</div>\r\n        ) : filteredUsers.length === 0 ? (\r\n          <div className=\"p-4 text-center text-gray-400\">No users found</div>\r\n        ) : (\r\n          <div className=\"overflow-x-auto\">\r\n            <table className=\"min-w-full divide-y divide-gray-700\">\r\n              <thead>\r\n                <tr>\r\n                  <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider\">Username</th>\r\n                  <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider\">Email</th>\r\n                  <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider\">Role</th>\r\n                  <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider\">Plan</th>\r\n                  <th className=\"px-4 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider\">Actions</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody className=\"divide-y divide-gray-700\">\r\n                {filteredUsers.map((user) => (\r\n                  <tr key={user.id} className=\"hover:bg-gray-800/50\">\r\n                    <td className=\"px-4 py-3 whitespace-nowrap text-sm text-white\">{user.username}</td>\r\n                    <td className=\"px-4 py-3 whitespace-nowrap text-sm text-gray-300\">{user.email}</td>\r\n                    <td className=\"px-4 py-3 whitespace-nowrap\">\r\n                      <select\r\n                        value={user.role}\r\n                        onChange={(e) => updateUserRole(user.id, e.target.value)}\r\n                        className=\"bg-gray-700 border border-gray-600 rounded text-white text-sm p-1\"\r\n                      >\r\n                        <option value=\"student\">Student</option>\r\n                        <option value=\"teacher\">Teacher</option>\r\n                        <option value=\"admin\">Admin</option>\r\n                      </select>\r\n                    </td>\r\n                    <td className=\"px-4 py-3 whitespace-nowrap\">\r\n                      <select\r\n                        value={user.plan}\r\n                        onChange={(e) => updateUserPlan(user.id, e.target.value)}\r\n                        className=\"bg-gray-700 border border-gray-600 rounded text-white text-sm p-1\"\r\n                      >\r\n                        <option value=\"free\">Free</option>\r\n                        <option value=\"premium\">Premium</option>\r\n                      </select>\r\n                    </td>\r\n                    <td className=\"px-4 py-3 whitespace-nowrap text-sm\">\r\n                      <button \r\n                        className=\"text-red-400 hover:text-red-300 text-sm hover-lift\"\r\n                        onClick={async () => {\r\n                          if (window.confirm('Are you sure you want to delete this user?')) {\r\n                            const result = await deleteUser(user.id);\r\n                            if (result.error) {\r\n                              setError(result.error);\r\n                            } else {\r\n                              setUsers(users.filter(u => u.id !== user.id));\r\n                            }\r\n                          }\r\n                        }}\r\n                      >\r\n                        Delete\r\n                      </button>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default UserManager;"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4693, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/services/storageService.ts"],"sourcesContent":["import { supabase } from '@/lib/supabase';\r\n\r\n// File type validation\r\nconst ALLOWED_FILE_TYPES = [\r\n  'text/html',\r\n  'text/css',\r\n  'text/javascript',\r\n  'application/javascript',\r\n  'application/json',\r\n  'application/zip',\r\n  'application/x-zip-compressed',\r\n  'image/png',\r\n  'image/jpeg',\r\n  'image/gif',\r\n  'image/webp'\r\n];\r\n\r\nconst MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB\r\n\r\ninterface UploadResult {\r\n  url: string;\r\n  path: string;\r\n  fileName: string;\r\n  fileSize: number;\r\n  mimeType: string;\r\n}\r\n\r\ninterface FileValidationResult {\r\n  isValid: boolean;\r\n  error?: string;\r\n}\r\n\r\n// Validate file before upload\r\nconst validateFile = (file: File): FileValidationResult => {\r\n  // Check file size\r\n  if (file.size > MAX_FILE_SIZE) {\r\n    return {\r\n      isValid: false,\r\n      error: `File size exceeds ${MAX_FILE_SIZE / (1024 * 1024)}MB limit`\r\n    };\r\n  }\r\n\r\n  // Check file type\r\n  if (!ALLOWED_FILE_TYPES.includes(file.type)) {\r\n    return {\r\n      isValid: false,\r\n      error: `File type ${file.type} is not allowed. Allowed types: ${ALLOWED_FILE_TYPES.join(', ')}`\r\n    };\r\n  }\r\n\r\n  return { isValid: true };\r\n};\r\n\r\n// Upload file to Supabase Storage\r\nexport const uploadFile = async (\r\n  bucketName: string,\r\n  filePath: string,\r\n  file: File\r\n): Promise<UploadResult> => {\r\n  try {\r\n    console.log('uploadFile: Uploading file to bucket:', bucketName, 'path:', filePath);\r\n\r\n    // Validate file\r\n    const validation = validateFile(file);\r\n    if (!validation.isValid) {\r\n      throw new Error(validation.error);\r\n    }\r\n\r\n    // Upload file\r\n    const { data, error } = await supabase.storage\r\n      .from(bucketName)\r\n      .upload(filePath, file, {\r\n        cacheControl: '3600',\r\n        upsert: false\r\n      });\r\n\r\n    if (error) {\r\n      console.error('uploadFile: Error uploading file:', error);\r\n      throw error;\r\n    }\r\n\r\n    // Get public URL\r\n    const { data: urlData } = supabase.storage\r\n      .from(bucketName)\r\n      .getPublicUrl(filePath);\r\n\r\n    const result: UploadResult = {\r\n      url: urlData.publicUrl,\r\n      path: filePath,\r\n      fileName: file.name,\r\n      fileSize: file.size,\r\n      mimeType: file.type\r\n    };\r\n\r\n    console.log('uploadFile: Successfully uploaded file:', result.url);\r\n    return result;\r\n  } catch (error) {\r\n    console.error('uploadFile: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Download file from Supabase Storage\r\nexport const downloadFile = async (\r\n  bucketName: string,\r\n  filePath: string\r\n): Promise<Blob> => {\r\n  try {\r\n    console.log('downloadFile: Downloading file from bucket:', bucketName, 'path:', filePath);\r\n\r\n    const { data, error } = await supabase.storage\r\n      .from(bucketName)\r\n      .download(filePath);\r\n\r\n    if (error) {\r\n      console.error('downloadFile: Error downloading file:', error);\r\n      throw error;\r\n    }\r\n\r\n    console.log('downloadFile: Successfully downloaded file');\r\n    return data;\r\n  } catch (error) {\r\n    console.error('downloadFile: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Get file URL (public or signed)\r\nexport const getFileUrl = async (\r\n  bucketName: string,\r\n  filePath: string,\r\n  expiresIn?: number\r\n): Promise<string> => {\r\n  try {\r\n    console.log('getFileUrl: Getting URL for file:', filePath, 'expiresIn:', expiresIn);\r\n\r\n    if (expiresIn) {\r\n      // Get signed URL for private files\r\n      const { data, error } = await supabase.storage\r\n        .from(bucketName)\r\n        .createSignedUrl(filePath, expiresIn);\r\n\r\n      if (error) {\r\n        console.error('getFileUrl: Error creating signed URL:', error);\r\n        throw error;\r\n      }\r\n\r\n      console.log('getFileUrl: Returning signed URL');\r\n      return data.signedUrl;\r\n    } else {\r\n      // Get public URL\r\n      const { data } = supabase.storage\r\n        .from(bucketName)\r\n        .getPublicUrl(filePath);\r\n\r\n      console.log('getFileUrl: Returning public URL');\r\n      return data.publicUrl;\r\n    }\r\n  } catch (error) {\r\n    console.error('getFileUrl: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Delete file from Supabase Storage\r\nexport const deleteFile = async (\r\n  bucketName: string,\r\n  filePath: string\r\n): Promise<void> => {\r\n  try {\r\n    console.log('deleteFile: Deleting file from bucket:', bucketName, 'path:', filePath);\r\n\r\n    const { error } = await supabase.storage\r\n      .from(bucketName)\r\n      .remove([filePath]);\r\n\r\n    if (error) {\r\n      console.error('deleteFile: Error deleting file:', error);\r\n      throw error;\r\n    }\r\n\r\n    console.log('deleteFile: Successfully deleted file');\r\n  } catch (error) {\r\n    console.error('deleteFile: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// List files in a directory\r\nexport const listFiles = async (\r\n  bucketName: string,\r\n  prefix?: string\r\n): Promise<any[]> => {\r\n  try {\r\n    console.log('listFiles: Listing files in bucket:', bucketName, 'prefix:', prefix);\r\n\r\n    let query = supabase.storage\r\n      .from(bucketName)\r\n      .list(prefix);\r\n\r\n    const { data, error } = await query;\r\n\r\n    if (error) {\r\n      console.error('listFiles: Error listing files:', error);\r\n      throw error;\r\n    }\r\n\r\n    console.log('listFiles: Found', data?.length || 0, 'files');\r\n    return data || [];\r\n  } catch (error) {\r\n    console.error('listFiles: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Move file within storage\r\nexport const moveFile = async (\r\n  bucketName: string,\r\n  fromPath: string,\r\n  toPath: string\r\n): Promise<void> => {\r\n  try {\r\n    console.log('moveFile: Moving file from', fromPath, 'to', toPath);\r\n\r\n    // Copy file to new location\r\n    const { data: copyData, error: copyError } = await supabase.storage\r\n      .from(bucketName)\r\n      .copy(fromPath, toPath);\r\n\r\n    if (copyError) {\r\n      console.error('moveFile: Error copying file:', copyError);\r\n      throw copyError;\r\n    }\r\n\r\n    // Delete original file\r\n    const { error: deleteError } = await supabase.storage\r\n      .from(bucketName)\r\n      .remove([fromPath]);\r\n\r\n    if (deleteError) {\r\n      console.error('moveFile: Error deleting original file:', deleteError);\r\n      // Don't throw here - the copy succeeded, just log the deletion error\r\n      console.warn('moveFile: Original file deletion failed, but copy succeeded');\r\n    }\r\n\r\n    console.log('moveFile: Successfully moved file');\r\n  } catch (error) {\r\n    console.error('moveFile: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Get file metadata\r\nexport const getFileMetadata = async (\r\n  bucketName: string,\r\n  filePath: string\r\n): Promise<any> => {\r\n  try {\r\n    console.log('getFileMetadata: Getting metadata for file:', filePath);\r\n\r\n    const { data, error } = await supabase.storage\r\n      .from(bucketName)\r\n      .list(undefined, {\r\n        search: filePath.split('/').pop() // Get filename from path\r\n      });\r\n\r\n    if (error) {\r\n      console.error('getFileMetadata: Error getting metadata:', error);\r\n      throw error;\r\n    }\r\n\r\n    const fileMetadata = data?.find((file: any) => \r\n      file.name === filePath.split('/').pop()\r\n    );\r\n\r\n    console.log('getFileMetadata: Returning metadata');\r\n    return fileMetadata;\r\n  } catch (error) {\r\n    console.error('getFileMetadata: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Create presigned URL for upload (useful for direct client uploads)\r\nexport const createPresignedUploadUrl = async (\r\n  bucketName: string,\r\n  filePath: string,\r\n  expiresIn: number = 3600\r\n): Promise<string> => {\r\n  try {\r\n    console.log('createPresignedUploadUrl: Creating presigned URL for:', filePath);\r\n\r\n    const { data, error } = await supabase.storage\r\n      .from(bucketName)\r\n      .createSignedUrl(filePath, expiresIn, {\r\n        transform: {\r\n          resize: { width: 800, height: 600, fit: 'cover' } // Optional transformation\r\n        }\r\n      });\r\n\r\n    if (error) {\r\n      console.error('createPresignedUploadUrl: Error creating signed URL:', error);\r\n      throw error;\r\n    }\r\n\r\n    console.log('createPresignedUploadUrl: Returning signed URL');\r\n    return data.signedUrl;\r\n  } catch (error) {\r\n    console.error('createPresignedUploadUrl: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Batch upload files\r\nexport const uploadFiles = async (\r\n  bucketName: string,\r\n  files: { path: string; file: File }[]\r\n): Promise<UploadResult[]> => {\r\n  try {\r\n    console.log('uploadFiles: Uploading', files.length, 'files to bucket:', bucketName);\r\n\r\n    const results: UploadResult[] = [];\r\n\r\n    for (const { path, file } of files) {\r\n      try {\r\n        const result = await uploadFile(bucketName, path, file);\r\n        results.push(result);\r\n      } catch (error) {\r\n        console.error('uploadFiles: Error uploading file', path, ':', error);\r\n        // Continue with other files even if one fails\r\n      }\r\n    }\r\n\r\n    console.log('uploadFiles: Successfully uploaded', results.length, 'files');\r\n    return results;\r\n  } catch (error) {\r\n    console.error('uploadFiles: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Format file size for display\r\nexport const formatFileSize = (bytes: number): string => {\r\n  if (bytes === 0) return '0 Bytes';\r\n\r\n  const k = 1024;\r\n  const sizes = ['Bytes', 'KB', 'MB', 'GB'];\r\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n\r\n  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\r\n};\r\n\r\n// Get file icon based on MIME type\r\nexport const getFileIcon = (mimeType: string): string => {\r\n  if (mimeType.startsWith('image/')) return 'ðŸ–¼ï¸';\r\n  if (mimeType.startsWith('text/')) return 'ðŸ“„';\r\n  if (mimeType.includes('javascript') || mimeType.includes('json')) return 'ðŸ“';\r\n  if (mimeType.includes('zip')) return 'ðŸ“¦';\r\n  return 'ðŸ“';\r\n};"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4968, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/services/adminChallengeService.ts"],"sourcesContent":["import { supabase } from '@/lib/supabase';\r\nimport { \r\n  Challenge, \r\n  ChallengeParticipant, \r\n  Submission, \r\n  ReviewSubmissionInput,\r\n  ChallengeWithSubmissions,\r\n  CreateChallengeInput,\r\n  UpdateChallengeInput\r\n} from '@/types/challenges';\r\nimport { deleteFile } from '@/services/storageService';\r\n\r\n// Get all challenges (admin view - includes unpublished)\r\nexport const getAllChallengesAdmin = async (): Promise<ChallengeWithSubmissions[]> => {\r\n  try {\r\n    console.log('getAllChallengesAdmin: Fetching all challenges for admin');\r\n\r\n    const { data, error } = await supabase\r\n      .from('challenges')\r\n      .select(`\r\n        *,\r\n        challenge_participants(\r\n          *,\r\n          profiles(username, full_name)\r\n        ),\r\n        submissions(\r\n          *,\r\n          profiles(username, full_name),\r\n          reviewers:reviewed_by(username, full_name)\r\n        )\r\n      `)\r\n      .order('created_at', { ascending: false });\r\n\r\n    if (error) {\r\n      console.error('getAllChallengesAdmin: Error fetching challenges:', error);\r\n      throw error;\r\n    }\r\n\r\n    // Transform data\r\n    const challenges = (data || []).map((challenge: any) => ({\r\n      ...challenge,\r\n      participant_count: challenge.challenge_participants?.length || 0,\r\n      participants: challenge.challenge_participants?.map((p: any) => ({\r\n        ...p,\r\n        user: p.profiles\r\n      })) || [],\r\n      submissions: challenge.submissions?.map((s: any) => ({\r\n        ...s,\r\n        user: s.profiles,\r\n        reviewer: s.reviewers\r\n      })) || []\r\n    }));\r\n\r\n    console.log('getAllChallengesAdmin: Returning', challenges.length, 'challenges');\r\n    return challenges as ChallengeWithSubmissions[];\r\n  } catch (error) {\r\n    console.error('getAllChallengesAdmin: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Review and approve/reject submission\r\nexport const reviewSubmission = async (\r\n  input: ReviewSubmissionInput,\r\n  reviewerId: string\r\n): Promise<Submission> => {\r\n  try {\r\n    console.log('reviewSubmission: Reviewing submission:', input.submission_id, 'by:', reviewerId);\r\n\r\n    // Verify user is admin\r\n    const { data: profile } = await supabase\r\n      .from('profiles')\r\n      .select('role')\r\n      .eq('id', reviewerId)\r\n      .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n      throw new Error('Unauthorized: Only admins can review submissions');\r\n    }\r\n\r\n    // Update submission\r\n    const { data, error } = await supabase\r\n      .from('submissions')\r\n      .update({\r\n        status: input.status,\r\n        reviewed_by: reviewerId,\r\n        reviewed_at: new Date().toISOString(),\r\n        feedback: input.feedback,\r\n        is_winner: input.is_winner || false\r\n      })\r\n      .eq('id', input.submission_id)\r\n      .select(`\r\n        *,\r\n        profiles(username, full_name),\r\n        reviewers:reviewed_by(username, full_name)\r\n      `)\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error('reviewSubmission: Error reviewing submission:', error);\r\n      throw error;\r\n    }\r\n\r\n    console.log('reviewSubmission: Successfully reviewed submission:', data.id);\r\n    return {\r\n      ...data,\r\n      user: (data as any).profiles,\r\n      reviewer: (data as any).reviewers\r\n    } as Submission;\r\n  } catch (error) {\r\n    console.error('reviewSubmission: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Get all submissions for a challenge (admin view)\r\nexport const getChallengeSubmissionsAdmin = async (challengeId: string): Promise<Submission[]> => {\r\n  try {\r\n    console.log('getChallengeSubmissionsAdmin: Fetching submissions for challenge:', challengeId);\r\n\r\n    const { data, error } = await supabase\r\n      .from('submissions')\r\n      .select(`\r\n        *,\r\n        profiles(username, full_name),\r\n        reviewers:reviewed_by(username, full_name)\r\n      `)\r\n      .eq('challenge_id', challengeId)\r\n      .order('submitted_at', { ascending: true });\r\n\r\n    if (error) {\r\n      console.error('getChallengeSubmissionsAdmin: Error fetching submissions:', error);\r\n      throw error;\r\n    }\r\n\r\n    const submissions = (data || []).map((submission: any) => ({\r\n      ...submission,\r\n      user: submission.profiles,\r\n      reviewer: submission.reviewers\r\n    }));\r\n\r\n    console.log('getChallengeSubmissionsAdmin: Returning', submissions.length, 'submissions');\r\n    return submissions as Submission[];\r\n  } catch (error) {\r\n    console.error('getChallengeSubmissionsAdmin: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Delete submission (admin only)\r\nexport const deleteSubmission = async (submissionId: string, adminId: string): Promise<void> => {\r\n  try {\r\n    console.log('deleteSubmission: Deleting submission:', submissionId, 'by admin:', adminId);\r\n\r\n    // Verify user is admin\r\n    const { data: profile } = await supabase\r\n      .from('profiles')\r\n      .select('role')\r\n      .eq('id', adminId)\r\n      .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n      throw new Error('Unauthorized: Only admins can delete submissions');\r\n    }\r\n\r\n    // Get submission to check for files to delete\r\n    const { data: submission } = await supabase\r\n      .from('submissions')\r\n      .select('file_url, challenge_id, user_id')\r\n      .eq('id', submissionId)\r\n      .single();\r\n\r\n    if (submission?.file_url) {\r\n      // Delete associated file\r\n      const filePath = `${submission.user_id}/${submission.challenge_id}/${submission.file_url.split('/').pop()}`;\r\n      await deleteFile('challenge-submissions', filePath);\r\n    }\r\n\r\n    // Delete submission record\r\n    const { error } = await supabase\r\n      .from('submissions')\r\n      .delete()\r\n      .eq('id', submissionId);\r\n\r\n    if (error) {\r\n      console.error('deleteSubmission: Error deleting submission:', error);\r\n      throw error;\r\n    }\r\n\r\n    console.log('deleteSubmission: Successfully deleted submission:', submissionId);\r\n  } catch (error) {\r\n    console.error('deleteSubmission: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Get challenge participants (admin view)\r\nexport const getChallengeParticipantsAdmin = async (challengeId: string): Promise<ChallengeParticipant[]> => {\r\n  try {\r\n    console.log('getChallengeParticipantsAdmin: Fetching participants for challenge:', challengeId);\r\n\r\n    const { data, error } = await supabase\r\n      .from('challenge_participants')\r\n      .select(`\r\n        *,\r\n        profiles(username, full_name, email)\r\n      `)\r\n      .eq('challenge_id', challengeId)\r\n      .order('joined_at', { ascending: true });\r\n\r\n    if (error) {\r\n      console.error('getChallengeParticipantsAdmin: Error fetching participants:', error);\r\n      throw error;\r\n    }\r\n\r\n    const participants = (data || []).map((participant: any) => ({\r\n      ...participant,\r\n      user: participant.profiles\r\n    }));\r\n\r\n    console.log('getChallengeParticipantsAdmin: Returning', participants.length, 'participants');\r\n    return participants as ChallengeParticipant[];\r\n  } catch (error) {\r\n    console.error('getChallengeParticipantsAdmin: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Remove participant from challenge (admin only)\r\nexport const removeParticipant = async (\r\n  challengeId: string, \r\n  userId: string, \r\n  adminId: string\r\n): Promise<void> => {\r\n  try {\r\n    console.log('removeParticipant: Removing user:', userId, 'from challenge:', challengeId, 'by admin:', adminId);\r\n\r\n    // Verify user is admin\r\n    const { data: profile } = await supabase\r\n      .from('profiles')\r\n      .select('role')\r\n      .eq('id', adminId)\r\n      .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n      throw new Error('Unauthorized: Only admins can remove participants');\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('challenge_participants')\r\n      .delete()\r\n      .eq('challenge_id', challengeId)\r\n      .eq('user_id', userId);\r\n\r\n    if (error) {\r\n      console.error('removeParticipant: Error removing participant:', error);\r\n      throw error;\r\n    }\r\n\r\n    console.log('removeParticipant: Successfully removed participant');\r\n  } catch (error) {\r\n    console.error('removeParticipant: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Update participant payment status (admin only)\r\nexport const updateParticipantPayment = async (\r\n  participantId: string,\r\n  paymentStatus: 'paid' | 'refunded' | 'failed',\r\n  adminId: string\r\n): Promise<ChallengeParticipant> => {\r\n  try {\r\n    console.log('updateParticipantPayment: Updating payment status for participant:', participantId, 'by admin:', adminId);\r\n\r\n    // Verify user is admin\r\n    const { data: profile } = await supabase\r\n      .from('profiles')\r\n      .select('role')\r\n      .eq('id', adminId)\r\n      .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n      throw new Error('Unauthorized: Only admins can update payment status');\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('challenge_participants')\r\n      .update({\r\n        payment_status: paymentStatus\r\n      })\r\n      .eq('id', participantId)\r\n      .select(`\r\n        *,\r\n        profiles(username, full_name)\r\n      `)\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error('updateParticipantPayment: Error updating payment status:', error);\r\n      throw error;\r\n    }\r\n\r\n    console.log('updateParticipantPayment: Successfully updated payment status');\r\n    return {\r\n      ...data,\r\n      user: (data as any).profiles\r\n    } as ChallengeParticipant;\r\n  } catch (error) {\r\n    console.error('updateParticipantPayment: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Get admin dashboard statistics\r\nexport const getAdminStats = async (): Promise<any> => {\r\n  try {\r\n    console.log('getAdminStats: Fetching admin statistics');\r\n\r\n    // Get challenge counts by status\r\n    const now = new Date().toISOString();\r\n    \r\n    const { count: totalChallenges } = await supabase\r\n      .from('challenges')\r\n      .select('*', { count: 'exact', head: true });\r\n\r\n    const { count: publishedChallenges } = await supabase\r\n      .from('challenges')\r\n      .select('*', { count: 'exact', head: true })\r\n      .eq('is_published', true);\r\n\r\n    const { count: draftChallenges } = await supabase\r\n      .from('challenges')\r\n      .select('*', { count: 'exact', head: true })\r\n      .eq('is_published', false);\r\n\r\n    const { count: activeChallenges } = await supabase\r\n      .from('challenges')\r\n      .select('*', { count: 'exact', head: true })\r\n      .lte('start_date', now)\r\n      .gte('end_date', now);\r\n\r\n    // Get participant statistics\r\n    const { count: totalParticipants } = await supabase\r\n      .from('challenge_participants')\r\n      .select('*', { count: 'exact', head: true });\r\n\r\n    const { count: paidParticipants } = await supabase\r\n      .from('challenge_participants')\r\n      .select('*', { count: 'exact', head: true })\r\n      .eq('payment_status', 'paid');\r\n\r\n    // Get submission statistics\r\n    const { count: totalSubmissions } = await supabase\r\n      .from('submissions')\r\n      .select('*', { count: 'exact', head: true });\r\n\r\n    const { count: pendingReview } = await supabase\r\n      .from('submissions')\r\n      .select('*', { count: 'exact', head: true })\r\n      .eq('status', 'submitted');\r\n\r\n    const { count: approvedSubmissions } = await supabase\r\n      .from('submissions')\r\n      .select('*', { count: 'exact', head: true })\r\n      .eq('status', 'approved');\r\n\r\n    const { count: rejectedSubmissions } = await supabase\r\n      .from('submissions')\r\n      .select('*', { count: 'exact', head: true })\r\n      .eq('status', 'rejected');\r\n\r\n    const stats = {\r\n      challenges: {\r\n        total: totalChallenges || 0,\r\n        published: publishedChallenges || 0,\r\n        drafts: draftChallenges || 0,\r\n        active: activeChallenges || 0\r\n      },\r\n      participants: {\r\n        total: totalParticipants || 0,\r\n        paid: paidParticipants || 0\r\n      },\r\n      submissions: {\r\n        total: totalSubmissions || 0,\r\n        pending_review: pendingReview || 0,\r\n        approved: approvedSubmissions || 0,\r\n        rejected: rejectedSubmissions || 0\r\n      }\r\n    };\r\n\r\n    console.log('getAdminStats: Returning statistics');\r\n    return stats;\r\n  } catch (error) {\r\n    console.error('getAdminStats: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Bulk update submissions status\r\nexport const bulkUpdateSubmissions = async (\r\n  submissionIds: string[],\r\n  status: 'approved' | 'rejected',\r\n  reviewerId: string\r\n): Promise<Submission[]> => {\r\n  try {\r\n    console.log('bulkUpdateSubmissions: Updating', submissionIds.length, 'submissions by:', reviewerId);\r\n\r\n    // Verify user is admin\r\n    const { data: profile } = await supabase\r\n      .from('profiles')\r\n      .select('role')\r\n      .eq('id', reviewerId)\r\n      .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n      throw new Error('Unauthorized: Only admins can bulk update submissions');\r\n    }\r\n\r\n    const updates = submissionIds.map(id => ({\r\n      id,\r\n      status,\r\n      reviewed_by: reviewerId,\r\n      reviewed_at: new Date().toISOString()\r\n    }));\r\n\r\n    const { data, error } = await supabase\r\n      .from('submissions')\r\n      .upsert(updates)\r\n      .select(`\r\n        *,\r\n        profiles(username, full_name),\r\n        reviewers:reviewed_by(username, full_name)\r\n      `);\r\n\r\n    if (error) {\r\n      console.error('bulkUpdateSubmissions: Error updating submissions:', error);\r\n      throw error;\r\n    }\r\n\r\n    const submissions = (data || []).map((submission: any) => ({\r\n      ...submission,\r\n      user: submission.profiles,\r\n      reviewer: submission.reviewers\r\n    }));\r\n\r\n    console.log('bulkUpdateSubmissions: Successfully updated', submissions.length, 'submissions');\r\n    return submissions as Submission[];\r\n  } catch (error) {\r\n    console.error('bulkUpdateSubmissions: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Create challenge (admin only)\r\nexport const createChallengeAdmin = async (\r\n  input: CreateChallengeInput,\r\n  adminId: string\r\n): Promise<Challenge> => {\r\n  try {\r\n    console.log('createChallengeAdmin: Creating challenge by admin:', adminId, input.title);\r\n\r\n    // Verify user is admin\r\n    const { data: profile } = await supabase\r\n      .from('profiles')\r\n      .select('role')\r\n      .eq('id', adminId)\r\n      .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n      throw new Error('Unauthorized: Only admins can create challenges');\r\n    }\r\n\r\n    const payload = {\r\n      title: input.title,\r\n      description: input.description,\r\n      type: input.type,\r\n      entry_fee: input.entry_fee ?? 0,\r\n      prize_pool: input.prize_pool ?? 0,\r\n      start_date: input.start_date,\r\n      end_date: input.end_date,\r\n      submission_deadline: input.submission_deadline,\r\n      max_participants: input.max_participants ?? null,\r\n      is_published: input.is_published ?? false,\r\n      created_by: adminId\r\n    };\r\n\r\n    const { data, error } = await supabase\r\n      .from('challenges')\r\n      .insert(payload)\r\n      .select('*')\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error('createChallengeAdmin: Error creating challenge:', error);\r\n      throw error;\r\n    }\r\n\r\n    console.log('createChallengeAdmin: Challenge created:', data.id);\r\n    return data as Challenge;\r\n  } catch (error) {\r\n    console.error('createChallengeAdmin: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Update challenge (admin only)\r\nexport const updateChallengeAdmin = async (\r\n  input: UpdateChallengeInput,\r\n  adminId: string\r\n): Promise<Challenge> => {\r\n  try {\r\n    console.log('updateChallengeAdmin: Updating challenge:', input.id, 'by admin:', adminId);\r\n\r\n    // Verify user is admin\r\n    const { data: profile } = await supabase\r\n      .from('profiles')\r\n      .select('role')\r\n      .eq('id', adminId)\r\n      .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n      throw new Error('Unauthorized: Only admins can update challenges');\r\n    }\r\n\r\n    // Build update payload filtering out undefined\r\n    const updatePayload: any = {};\r\n    const keys: (keyof UpdateChallengeInput)[] = [\r\n      'title', 'description', 'type', 'entry_fee', 'prize_pool',\r\n      'start_date', 'end_date', 'submission_deadline', 'max_participants', 'is_published'\r\n    ];\r\n    keys.forEach((key) => {\r\n      const value = input[key];\r\n      if (value !== undefined) {\r\n        updatePayload[key] = value;\r\n      }\r\n    });\r\n    updatePayload['updated_at'] = new Date().toISOString();\r\n\r\n    const { data, error } = await supabase\r\n      .from('challenges')\r\n      .update(updatePayload)\r\n      .eq('id', input.id)\r\n      .select('*')\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error('updateChallengeAdmin: Error updating challenge:', error);\r\n      throw error;\r\n    }\r\n\r\n    console.log('updateChallengeAdmin: Challenge updated:', data.id);\r\n    return data as Challenge;\r\n  } catch (error) {\r\n    console.error('updateChallengeAdmin: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Publish/Unpublish challenge (admin only)\r\nexport const publishChallengeAdmin = async (\r\n  challengeId: string,\r\n  publish: boolean,\r\n  adminId: string\r\n): Promise<Challenge> => {\r\n  try {\r\n    console.log('publishChallengeAdmin: Setting publish to', publish, 'for challenge:', challengeId);\r\n\r\n    // Verify user is admin\r\n    const { data: profile } = await supabase\r\n      .from('profiles')\r\n      .select('role')\r\n      .eq('id', adminId)\r\n      .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n      throw new Error('Unauthorized: Only admins can publish challenges');\r\n    }\r\n\r\n    const { data, error } = await supabase\r\n      .from('challenges')\r\n      .update({ is_published: publish, updated_at: new Date().toISOString() })\r\n      .eq('id', challengeId)\r\n      .select('*')\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error('publishChallengeAdmin: Error updating publish status:', error);\r\n      throw error;\r\n    }\r\n\r\n    console.log('publishChallengeAdmin: Publish status updated for challenge:', data.id);\r\n    return data as Challenge;\r\n  } catch (error) {\r\n    console.error('publishChallengeAdmin: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n// Delete challenge (admin only) - also clean up submission files\r\nexport const deleteChallengeAdmin = async (\r\n  challengeId: string,\r\n  adminId: string\r\n): Promise<void> => {\r\n  try {\r\n    console.log('deleteChallengeAdmin: Deleting challenge:', challengeId, 'by admin:', adminId);\r\n\r\n    // Verify user is admin\r\n    const { data: profile } = await supabase\r\n      .from('profiles')\r\n      .select('role')\r\n      .eq('id', adminId)\r\n      .single();\r\n\r\n    if (profile?.role !== 'admin') {\r\n      throw new Error('Unauthorized: Only admins can delete challenges');\r\n    }\r\n\r\n    // Fetch submissions to delete files from storage\r\n    const { data: subs } = await supabase\r\n      .from('submissions')\r\n      .select('file_url, user_id, challenge_id')\r\n      .eq('challenge_id', challengeId);\r\n\r\n    if (subs && subs.length > 0) {\r\n      for (const s of subs) {\r\n        if (s.file_url) {\r\n          const fileName = s.file_url.split('/').pop();\r\n          if (fileName) {\r\n            const filePath = `${s.user_id}/${s.challenge_id}/${fileName}`;\r\n            try {\r\n              await deleteFile('challenge-submissions', filePath);\r\n            } catch (e) {\r\n              console.warn('deleteChallengeAdmin: Failed to delete file from storage:', filePath, e);\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // Delete challenge (will cascade to participants and submissions)\r\n    const { error } = await supabase\r\n      .from('challenges')\r\n      .delete()\r\n      .eq('id', challengeId);\r\n\r\n    if (error) {\r\n      console.error('deleteChallengeAdmin: Error deleting challenge:', error);\r\n      throw error;\r\n    }\r\n\r\n    console.log('deleteChallengeAdmin: Challenge deleted:', challengeId);\r\n  } catch (error) {\r\n    console.error('deleteChallengeAdmin: Unexpected error:', error);\r\n    throw error;\r\n  }\r\n};"],"names":[],"mappings":"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"}},
    {"offset": {"line": 5449, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/types/challenges.ts"],"sourcesContent":["// Challenge System Types\r\n\r\nexport interface Challenge {\r\n  id: string;\r\n  title: string;\r\n  description: string;\r\n  type: 'free' | 'paid';\r\n  entry_fee: number;\r\n  prize_pool: number;\r\n  start_date: string;\r\n  end_date: string;\r\n  submission_deadline: string;\r\n  max_participants?: number;\r\n  is_published: boolean;\r\n  created_by: string;\r\n  created_at: string;\r\n  updated_at: string;\r\n  \r\n  // Computed fields\r\n  participant_count?: number;\r\n  time_remaining?: string;\r\n  status?: 'upcoming' | 'active' | 'ended' | 'closed';\r\n}\r\n\r\nexport interface ChallengeParticipant {\r\n  id: string;\r\n  challenge_id: string;\r\n  user_id: string;\r\n  payment_intent_id?: string;\r\n  payment_status: 'pending' | 'paid' | 'refunded' | 'failed';\r\n  joined_at: string;\r\n  \r\n  // Related data\r\n  challenge?: Challenge;\r\n  user?: {\r\n    id: string;\r\n    username: string;\r\n    full_name?: string;\r\n  };\r\n  // Optional computed flag, populated by services when winner info is available\r\n  is_winner?: boolean;\r\n}\r\n\r\nexport interface Submission {\r\n  id: string;\r\n  challenge_id: string;\r\n  user_id: string;\r\n  file_url?: string;\r\n  file_name?: string;\r\n  file_size?: number;\r\n  mime_type?: string;\r\n  submission_notes?: string;\r\n  status: 'submitted' | 'under_review' | 'approved' | 'rejected';\r\n  reviewed_by?: string;\r\n  reviewed_at?: string;\r\n  feedback?: string;\r\n  is_winner: boolean;\r\n  submitted_at: string;\r\n  updated_at: string;\r\n  \r\n  // Related data\r\n  challenge?: Challenge;\r\n  user?: {\r\n    id: string;\r\n    username: string;\r\n    full_name?: string;\r\n  };\r\n  reviewer?: {\r\n    id: string;\r\n    username: string;\r\n    full_name?: string;\r\n  };\r\n}\r\n\r\nexport interface ChallengeWithParticipants extends Challenge {\r\n  participant_count: number;\r\n  participants?: ChallengeParticipant[];\r\n  user_participation?: ChallengeParticipant | null;\r\n}\r\n\r\nexport interface ChallengeWithSubmissions extends ChallengeWithParticipants {\r\n  submissions?: Submission[];\r\n}\r\n\r\nexport interface CreateChallengeInput {\r\n  title: string;\r\n  description: string;\r\n  type: 'free' | 'paid';\r\n  entry_fee?: number;\r\n  prize_pool?: number;\r\n  start_date: string;\r\n  end_date: string;\r\n  submission_deadline: string;\r\n  max_participants?: number;\r\n  is_published?: boolean;\r\n}\r\n\r\nexport interface UpdateChallengeInput extends Partial<CreateChallengeInput> {\r\n  id: string;\r\n}\r\n\r\nexport interface JoinChallengeInput {\r\n  challenge_id: string;\r\n  payment_method_id?: string; // For paid challenges\r\n}\r\n\r\nexport interface SubmitChallengeInput {\r\n  challenge_id: string;\r\n  file?: File;\r\n  submission_notes?: string;\r\n}\r\n\r\nexport interface ReviewSubmissionInput {\r\n  submission_id: string;\r\n  status: 'approved' | 'rejected';\r\n  feedback?: string;\r\n  is_winner?: boolean;\r\n}\r\n\r\nexport interface ChallengeFilters {\r\n  type?: 'free' | 'paid' | 'all';\r\n  status?: 'upcoming' | 'active' | 'ended' | 'all';\r\n  search?: string;\r\n  sortBy?: 'created_at' | 'start_date' | 'participant_count';\r\n  sortOrder?: 'asc' | 'desc';\r\n}\r\n\r\nexport interface ChallengeStats {\r\n  total_challenges: number;\r\n  active_challenges: number;\r\n  upcoming_challenges: number;\r\n  ended_challenges: number;\r\n  total_participants: number;\r\n  total_submissions: number;\r\n  total_prize_pool: number;\r\n}\r\n\r\n// Enums\r\nexport enum ChallengeStatus {\r\n  UPCOMING = 'upcoming',\r\n  ACTIVE = 'active',\r\n  ENDED = 'ended',\r\n  CLOSED = 'closed'\r\n}\r\n\r\nexport enum ChallengeType {\r\n  FREE = 'free',\r\n  PAID = 'paid'\r\n}\r\n\r\nexport enum PaymentStatus {\r\n  PENDING = 'pending',\r\n  PAID = 'paid',\r\n  REFUNDED = 'refunded',\r\n  FAILED = 'failed'\r\n}\r\n\r\nexport enum SubmissionStatus {\r\n  SUBMITTED = 'submitted',\r\n  UNDER_REVIEW = 'under_review',\r\n  APPROVED = 'approved',\r\n  REJECTED = 'rejected'\r\n}"],"names":[],"mappings":"AAAA,yBAAyB;;;;;;;;;;;AA0IlB,IAAA,AAAK,yCAAA;;;;;WAAA;;AAOL,IAAA,AAAK,uCAAA;;;WAAA;;AAKL,IAAA,AAAK,uCAAA;;;;;WAAA;;AAOL,IAAA,AAAK,0CAAA;;;;;WAAA"}},
    {"offset": {"line": 5493, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/components/admin/ChallengeManager.tsx"],"sourcesContent":["'use client';\n\nimport { useEffect, useMemo, useState } from 'react';\nimport {\n  getAllChallengesAdmin,\n  createChallengeAdmin,\n  updateChallengeAdmin,\n  publishChallengeAdmin,\n  deleteChallengeAdmin,\n} from '@/services/adminChallengeService';\nimport {\n  Challenge,\n  ChallengeWithSubmissions,\n  CreateChallengeInput,\n  UpdateChallengeInput,\n  ChallengeType,\n} from '@/types/challenges';\nimport { useAuthStore } from '@/context/AuthContext';\nimport { PlusIcon, TrashIcon, EyeIcon, EyeOffIcon, PencilIcon } from 'lucide-react';\n\n// Helper: convert ISO string to datetime-local input value\nfunction isoToLocalInput(iso?: string): string {\n  if (!iso) return '';\n  const d = new Date(iso);\n  const pad = (n: number) => String(n).padStart(2, '0');\n  const year = d.getFullYear();\n  const month = pad(d.getMonth() + 1);\n  const day = pad(d.getDate());\n  const hours = pad(d.getHours());\n  const minutes = pad(d.getMinutes());\n  return `${year}-${month}-${day}T${hours}:${minutes}`;\n}\n\n// Helper: convert datetime-local input to ISO\nfunction localInputToISO(v: string): string {\n  // new Date treats this as local time; toISOString converts to UTC\n  const d = new Date(v);\n  return d.toISOString();\n}\n\nconst defaultForm: CreateChallengeInput = {\n  title: '',\n  description: '',\n  type: ChallengeType.FREE,\n  entry_fee: 0,\n  prize_pool: 0,\n  start_date: new Date().toISOString(),\n  end_date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(), // default +7 days\n  submission_deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),\n  max_participants: undefined,\n  is_published: false,\n};\n\nconst ChallengeManager = () => {\n  const { state } = useAuthStore();\n  const adminId = state.user?.id;\n\n  const [challenges, setChallenges] = useState<ChallengeWithSubmissions[]>([]);\n  const [loading, setLoading] = useState<boolean>(true);\n  const [error, setError] = useState<string | null>(null);\n  const [showCreateForm, setShowCreateForm] = useState<boolean>(false);\n\n  const [editing, setEditing] = useState<boolean>(false);\n  const [editingId, setEditingId] = useState<string | null>(null);\n  const [form, setForm] = useState<CreateChallengeInput>({ ...defaultForm });\n\n  const isPaid = useMemo(() => form.type === ChallengeType.PAID, [form.type]);\n\n  useEffect(() => {\n    loadChallenges();\n  }, []);\n\n  const resetForm = () => {\n    setForm({ ...defaultForm });\n    setEditing(false);\n    setEditingId(null);\n  };\n\n  const loadChallenges = async () => {\n    setLoading(true);\n    setError(null);\n    try {\n      const data = await getAllChallengesAdmin();\n      setChallenges(data);\n    } catch (e: any) {\n      console.error(e);\n      setError('Failed to load challenges');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleCreate = async () => {\n    if (!adminId) {\n      setError('Missing admin ID');\n      return;\n    }\n    // Minimal validation\n    if (!form.title.trim()) {\n      setError('Title is required');\n      return;\n    }\n    if (new Date(form.start_date) > new Date(form.end_date)) {\n      setError('Start date must be before end date');\n      return;\n    }\n    if (new Date(form.submission_deadline) > new Date(form.end_date)) {\n      setError('Submission deadline must be on or before end date');\n      return;\n    }\n\n    try {\n      const created = await createChallengeAdmin(form, adminId);\n      setChallenges([created as any, ...challenges]);\n      resetForm();\n      setShowCreateForm(false);\n    } catch (e: any) {\n      console.error(e);\n      setError(e.message || 'Failed to create challenge');\n    }\n  };\n\n  const handleUpdate = async () => {\n    if (!adminId || !editingId) {\n      setError('Missing admin or challenge ID');\n      return;\n    }\n    const payload: UpdateChallengeInput = {\n      id: editingId,\n      title: form.title,\n      description: form.description,\n      type: form.type,\n      entry_fee: form.entry_fee,\n      prize_pool: form.prize_pool,\n      start_date: form.start_date,\n      end_date: form.end_date,\n      submission_deadline: form.submission_deadline,\n      max_participants: form.max_participants,\n      is_published: form.is_published,\n    };\n    try {\n      const updated = await updateChallengeAdmin(payload, adminId);\n      setChallenges(challenges.map((c) => (c.id === updated.id ? (updated as any) : c)));\n      resetForm();\n    } catch (e: any) {\n      console.error(e);\n      setError(e.message || 'Failed to update challenge');\n    }\n  };\n\n  const handlePublishToggle = async (id: string, isPublished: boolean) => {\n    if (!adminId) return;\n    try {\n      const updated = await publishChallengeAdmin(id, !isPublished, adminId);\n      setChallenges(challenges.map((c) => (c.id === id ? (updated as any) : c)));\n    } catch (e: any) {\n      console.error(e);\n      setError(e.message || 'Failed to update publish status');\n    }\n  };\n\n  const handleDelete = async (id: string) => {\n    if (!adminId) return;\n    const ok = window.confirm('Are you sure you want to delete this challenge? This will also remove participants and submissions.');\n    if (!ok) return;\n    try {\n      await deleteChallengeAdmin(id, adminId);\n      setChallenges(challenges.filter((c) => c.id !== id));\n      if (editingId === id) {\n        resetForm();\n      }\n    } catch (e: any) {\n      console.error(e);\n      setError(e.message || 'Failed to delete challenge');\n    }\n  };\n\n  const beginEdit = (challenge: Challenge) => {\n    setEditing(true);\n    setEditingId(challenge.id);\n    setShowCreateForm(false);\n    setForm({\n      title: challenge.title,\n      description: challenge.description,\n      type: challenge.type,\n      entry_fee: challenge.entry_fee,\n      prize_pool: challenge.prize_pool,\n      start_date: challenge.start_date,\n      end_date: challenge.end_date,\n      submission_deadline: challenge.submission_deadline,\n      max_participants: challenge.max_participants,\n      is_published: challenge.is_published,\n    });\n  };\n\n  return (\n    <div className=\"h-full flex flex-col\">\n      <div className=\"p-4 border-b border-gray-700\">\n        <div className=\"flex justify-between items-center mb-4\">\n          <h3 className=\"text-lg font-semibold text-white\">Challenges</h3>\n          <button\n            onClick={() => {\n              resetForm();\n              setEditing(false);\n              setShowCreateForm(!showCreateForm);\n            }}\n            className=\"bg-accent-primary hover:bg-accent-primary/90 text-white px-3 py-1 rounded-md text-sm font-medium transition-colors hover-lift border border-accent-primary\"\n          >\n            <PlusIcon size={16} />\n          </button>\n        </div>\n\n        {error && (\n          <div className=\"mb-4 p-2 bg-red-900/30 border border-red-700 rounded text-red-300 text-sm\">\n            {error}\n          </div>\n        )}\n\n        {(showCreateForm || editing) && (\n          <div className=\"mb-4 p-3 bg-gray-800 rounded-lg\">\n            <h4 className=\"text-white font-medium mb-2\">{editing ? 'Edit Challenge' : 'Create Challenge'}</h4>\n\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n              <div>\n                <label className=\"block text-xs text-gray-400 mb-1\">Title</label>\n                <input\n                  type=\"text\"\n                  value={form.title}\n                  onChange={(e) => setForm({ ...form, title: e.target.value })}\n                  placeholder=\"Challenge title\"\n                  className=\"w-full p-2 rounded bg-gray-700 border border-gray-600 text-white\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs text-gray-400 mb-1\">Type</label>\n                <select\n                  value={form.type}\n                  onChange={(e) => setForm({ ...form, type: e.target.value as ChallengeType })}\n                  className=\"w-full p-2 rounded bg-gray-700 border border-gray-600 text-white\"\n                >\n                  <option value={ChallengeType.FREE}>Free</option>\n                  <option value={ChallengeType.PAID}>Paid</option>\n                </select>\n              </div>\n              <div className=\"md:col-span-2\">\n                <label className=\"block text-xs text-gray-400 mb-1\">Description</label>\n                <textarea\n                  value={form.description}\n                  onChange={(e) => setForm({ ...form, description: e.target.value })}\n                  placeholder=\"Describe the challenge\"\n                  className=\"w-full p-2 rounded bg-gray-700 border border-gray-600 text-white\"\n                  rows={3}\n                />\n              </div>\n\n              <div>\n                <label className=\"block text-xs text-gray-400 mb-1\">Start</label>\n                <input\n                  type=\"datetime-local\"\n                  value={isoToLocalInput(form.start_date)}\n                  onChange={(e) => setForm({ ...form, start_date: localInputToISO(e.target.value) })}\n                  className=\"w-full p-2 rounded bg-gray-700 border border-gray-600 text-white\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs text-gray-400 mb-1\">End</label>\n                <input\n                  type=\"datetime-local\"\n                  value={isoToLocalInput(form.end_date)}\n                  onChange={(e) => setForm({ ...form, end_date: localInputToISO(e.target.value) })}\n                  className=\"w-full p-2 rounded bg-gray-700 border border-gray-600 text-white\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs text-gray-400 mb-1\">Submission Deadline</label>\n                <input\n                  type=\"datetime-local\"\n                  value={isoToLocalInput(form.submission_deadline)}\n                  onChange={(e) => setForm({ ...form, submission_deadline: localInputToISO(e.target.value) })}\n                  className=\"w-full p-2 rounded bg-gray-700 border border-gray-600 text-white\"\n                />\n              </div>\n              <div>\n                <label className=\"block text-xs text-gray-400 mb-1\">Max Participants (optional)</label>\n                <input\n                  type=\"number\"\n                  value={form.max_participants ?? ''}\n                  onChange={(e) => setForm({ ...form, max_participants: e.target.value ? Number(e.target.value) : undefined })}\n                  className=\"w-full p-2 rounded bg-gray-700 border border-gray-600 text-white\"\n                  placeholder=\"e.g., 100\"\n                />\n              </div>\n\n              {isPaid && (\n                <>\n                  <div>\n                    <label className=\"block text-xs text-gray-400 mb-1\">Entry Fee</label>\n                    <input\n                      type=\"number\"\n                      value={form.entry_fee ?? 0}\n                      onChange={(e) => setForm({ ...form, entry_fee: Number(e.target.value) })}\n                      className=\"w-full p-2 rounded bg-gray-700 border border-gray-600 text-white\"\n                      placeholder=\"e.g., 10\"\n                    />\n                  </div>\n                  <div>\n                    <label className=\"block text-xs text-gray-400 mb-1\">Prize Pool</label>\n                    <input\n                      type=\"number\"\n                      value={form.prize_pool ?? 0}\n                      onChange={(e) => setForm({ ...form, prize_pool: Number(e.target.value) })}\n                      className=\"w-full p-2 rounded bg-gray-700 border border-gray-600 text-white\"\n                      placeholder=\"e.g., 100\"\n                    />\n                  </div>\n                </>\n              )}\n\n              <div className=\"md:col-span-2 flex items-center gap-2 mt-1\">\n                <input\n                  id=\"is_published\"\n                  type=\"checkbox\"\n                  checked={!!form.is_published}\n                  onChange={(e) => setForm({ ...form, is_published: e.target.checked })}\n                  className=\"h-4 w-4 text-accent-primary bg-gray-700 border-gray-600 rounded\"\n                />\n                <label htmlFor=\"is_published\" className=\"text-sm text-gray-300\">Published</label>\n              </div>\n            </div>\n\n            <div className=\"flex gap-2 mt-3\">\n              {editing ? (\n                <button\n                  onClick={handleUpdate}\n                  className=\"bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm hover-lift\"\n                >\n                  Save Changes\n                </button>\n              ) : (\n                <button\n                  onClick={handleCreate}\n                  className=\"bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm hover-lift\"\n                >\n                  Create Challenge\n                </button>\n              )}\n              <button\n                onClick={() => {\n                  resetForm();\n                  setShowCreateForm(false);\n                }}\n                className=\"bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm hover-lift\"\n              >\n                Cancel\n              </button>\n            </div>\n          </div>\n        )}\n      </div>\n\n      <div className=\"flex-1 overflow-y-auto\">\n        {loading ? (\n          <div className=\"p-4 text-center text-gray-400\">Loading challenges...</div>\n        ) : challenges.length === 0 ? (\n          <div className=\"p-4 text-center text-gray-400\">No challenges found</div>\n        ) : (\n          <ul className=\"divide-y divide-gray-700\">\n            {challenges.map((challenge) => (\n              <li\n                key={challenge.id}\n                className={`p-3 transition-colors hover:bg-gray-800/50`}\n              >\n                <div className=\"flex justify-between items-start\">\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"flex items-center gap-2\">\n                      <h4 className=\"font-medium text-white truncate\">{challenge.title}</h4>\n                      <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${\n                        challenge.is_published\n                          ? 'bg-green-900/30 text-green-400 border border-green-800'\n                          : 'bg-yellow-900/30 text-yellow-400 border border-yellow-800'\n                      }`}>\n                        {challenge.is_published ? 'Published' : 'Draft'}\n                      </span>\n                      <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${\n                        challenge.type === 'paid'\n                          ? 'bg-purple-900/30 text-purple-400 border border-purple-800'\n                          : 'bg-blue-900/30 text-blue-400 border border-blue-800'\n                      }`}>\n                        {challenge.type === 'paid' ? 'Paid' : 'Free'}\n                      </span>\n                    </div>\n                    <p className=\"text-xs text-gray-400 truncate\">{challenge.description}</p>\n                    <div className=\"mt-1 flex items-center gap-2 text-xs text-gray-500\">\n                      <span>\n                        {new Date(challenge.start_date).toLocaleString()} â†’ {new Date(challenge.end_date).toLocaleString()}\n                      </span>\n                      <span className=\"text-gray-600\">|</span>\n                      <span>Participants: {challenge.participant_count ?? 0}</span>\n                      {challenge.type === 'paid' && (\n                        <>\n                          <span className=\"text-gray-600\">|</span>\n                          <span>Entry Fee: {challenge.entry_fee}</span>\n                          <span className=\"text-gray-600\">|</span>\n                          <span>Prize Pool: {challenge.prize_pool}</span>\n                        </>\n                      )}\n                    </div>\n                  </div>\n                  <div className=\"flex gap-1 ml-2\">\n                    <button\n                      onClick={() => handlePublishToggle(challenge.id, challenge.is_published)}\n                      className={`p-1 rounded hover-lift ${\n                        challenge.is_published ? 'text-green-400 hover:bg-green-900/20' : 'text-gray-400 hover:bg-gray-700'\n                      }`}\n                      title={challenge.is_published ? 'Unpublish' : 'Publish'}\n                    >\n                      {challenge.is_published ? <EyeOffIcon size={14} /> : <EyeIcon size={14} />}\n                    </button>\n                    <button\n                      onClick={() => beginEdit(challenge)}\n                      className=\"p-1 rounded text-blue-400 hover:bg-blue-900/20 hover-lift\"\n                      title=\"Edit\"\n                    >\n                      <PencilIcon size={14} />\n                    </button>\n                    <button\n                      onClick={() => handleDelete(challenge.id)}\n                      className=\"p-1 rounded text-red-400 hover:bg-red-900/20 hover-lift\"\n                      title=\"Delete\"\n                    >\n                      <TrashIcon size={14} />\n                    </button>\n                  </div>\n                </div>\n              </li>\n            ))}\n          </ul>\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default ChallengeManager;"],"names":[],"mappings":"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"}},
    {"offset": {"line": 6386, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/app/admin/page.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { useAuthStore } from '@/context/AuthContext';\r\nimport { supabase } from '@/lib/supabase';\r\nimport AppShell from '@/components/layout/AppShell';\r\nimport CourseList from '@/components/admin/CourseList';\r\nimport ModuleList from '@/components/admin/ModuleList';\r\nimport LessonList from '@/components/admin/LessonList';\r\nimport LessonEditor from '@/components/admin/LessonEditor';\r\nimport AnnouncementManager from '@/components/admin/AnnouncementManager';\r\nimport UserManager from '@/components/admin/UserManager';\r\nimport { Lesson } from '@/types/course';\r\n// Add Challenges manager import\r\nimport ChallengeManager from '@/components/admin/ChallengeManager';\r\n\r\nconst AdminPage = () => {\r\n  const { state } = useAuthStore();\r\n  const user = state.user;\r\n  const [profile, setProfile] = useState<any>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [activeTab, setActiveTab] = useState('courses');\r\n  \r\n  // Add state for password protection\r\n  const [password, setPassword] = useState('');\r\n  const [showPasswordInput, setShowPasswordInput] = useState(true);\r\n  \r\n  // Check if password is correct (hardcoded for now)\r\n  const checkPassword = () => {\r\n    if (password === '0026') {\r\n      setShowPasswordInput(false);\r\n    } else {\r\n      alert('Incorrect password');\r\n    }\r\n  };\r\n  \r\n  // Course management state\r\n  const [selectedCourseId, setSelectedCourseId] = useState<string | null>(null);\r\n  const [selectedModuleId, setSelectedModuleId] = useState<string | null>(null);\r\n  const [selectedLessonId, setSelectedLessonId] = useState<string | null>(null);\r\n  const [lessonEditorOpen, setLessonEditorOpen] = useState(false);\r\n  const [editingLesson, setEditingLesson] = useState<Lesson | null>(null);\r\n  \r\n  // State for lesson editing\r\n  const [lessons, setLessons] = useState<Lesson[]>([]);\r\n\r\n  // Add debug prints to track course creation\r\n  useEffect(() => {\r\n    console.log('DEBUG: Admin page rendered, activeTab:', activeTab);\r\n    console.log('DEBUG: Selected IDs - Course:', selectedCourseId, 'Module:', selectedModuleId, 'Lesson:', selectedLessonId);\r\n  }, [activeTab, selectedCourseId, selectedModuleId, selectedLessonId]);\r\n\r\n  useEffect(() => {\r\n    if (user) {\r\n      fetchProfile();\r\n    }\r\n  }, [user]);\r\n\r\n  const fetchProfile = async () => {\r\n    try {\r\n      setLoading(true);\r\n      const { data, error } = await supabase\r\n        .from('profiles')\r\n        .select('*')\r\n        .eq('id', user.id)\r\n        .single();\r\n\r\n      if (error) throw error;\r\n      setProfile(data);\r\n      \r\n      // Debug print to show account role and plan\r\n      console.log('DEBUG: Admin page - Account role and plan:', {\r\n        userId: user.id,\r\n        role: data?.role,\r\n        plan: data?.plan,\r\n        username: data?.username\r\n      });\r\n      \r\n      // TEMPORARY: Update role to admin if not already set (for debugging purposes)\r\n      if (data?.role !== 'admin' && data?.role !== 'teacher') {\r\n        console.log('DEBUG: User does not have admin/teacher role. Showing role update option.');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching profile:', error);\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  // Temporary function to update user role to admin (for debugging)\r\n  const updateRoleToAdmin = async () => {\r\n    if (!user || !profile) return;\r\n    \r\n    try {\r\n      const { error } = await supabase\r\n        .from('profiles')\r\n        .update({ role: 'admin' })\r\n        .eq('id', user.id);\r\n        \r\n      if (error) throw error;\r\n      \r\n      // Refresh the profile\r\n      fetchProfile();\r\n      alert('Role updated to admin. Please refresh the page.');\r\n    } catch (error) {\r\n      console.error('Error updating role:', error);\r\n      alert('Error updating role');\r\n    }\r\n  };\r\n\r\n  const handleCreateLesson = (moduleId: string) => {\r\n    setSelectedModuleId(moduleId);\r\n    setEditingLesson(null);\r\n    setLessonEditorOpen(true);\r\n  };\r\n\r\n  const handleEditLesson = (lesson: Lesson) => {\r\n    setEditingLesson(lesson);\r\n    setLessonEditorOpen(true);\r\n  };\r\n\r\n  const handleLessonSaved = (lesson: Lesson) => {\r\n    // Update the selected lesson if it was edited\r\n    if (selectedLessonId === lesson.id) {\r\n      setSelectedLessonId(lesson.id);\r\n    }\r\n  };\r\n\r\n  const handleLessonCreated = (lesson: Lesson) => {\r\n    // Select the newly created lesson\r\n    setSelectedLessonId(lesson.id);\r\n  };\r\n  \r\n  // Function to trigger refresh of public UI\r\n  const triggerPublicUIRefresh = () => {\r\n    // In a real app, this would call router.refresh or similar\r\n    // For now, we'll rely on the client-side cache invalidation\r\n    console.log('Triggering public UI refresh');\r\n    \r\n    // We could potentially use router.refresh() if needed\r\n    // router.refresh();\r\n  };\r\n\r\n  if (loading) {\r\n    return (\r\n      <AppShell>\r\n        <div className=\"container mx-auto px-4 py-8\">\r\n          <h1 className=\"text-3xl font-bold text-white mb-8\">Admin Panel</h1>\r\n          <p className=\"text-gray-400\">Loading...</p>\r\n        </div>\r\n      </AppShell>\r\n    );\r\n  }\r\n\r\n  // Allow access if user has admin/teacher role OR if we're in development mode allowing role updates\r\n  const hasAdminAccess = profile && (profile.role === 'admin' || profile.role === 'teacher');\r\n  \r\n  // If user doesn't have proper role, show a message with option to update role (temporary for debugging)\r\n  if (!hasAdminAccess) {\r\n    return (\r\n      <AppShell>\r\n        <div className=\"container mx-auto px-4 py-8\">\r\n          <h1 className=\"text-3xl font-bold text-white mb-8\">Admin Panel</h1>\r\n          <div className=\"bg-yellow-900/20 border border-yellow-700 rounded-lg p-4 mb-4\">\r\n            <p className=\"text-yellow-300\">You do not have admin access yet. Your role is: {profile?.role || 'not set'}</p>\r\n          </div>\r\n          <div className=\"flex gap-4\">\r\n            <button\r\n              onClick={updateRoleToAdmin}\r\n              className=\"px-4 py-2 bg-accent-primary text-white rounded-md font-medium hover:bg-accent-primary/90 transition-colors border border-accent-primary\"\r\n            >\r\n              Grant Admin Access (Temporary)\r\n            </button>\r\n            <button\r\n              onClick={() => window.location.reload()}\r\n              className=\"px-4 py-2 bg-gray-700 text-white rounded-md font-medium hover:bg-gray-600 transition-colors\"\r\n            >\r\n              Refresh\r\n            </button>\r\n          </div>\r\n        </div>\r\n      </AppShell>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <AppShell>\r\n      {showPasswordInput ? (\r\n        <div className=\"container mx-auto px-4 py-8 flex flex-col items-center justify-center h-screen\">\r\n          <div className=\"bg-gray-800 p-8 rounded-lg shadow-lg w-full max-w-md\">\r\n            <h1 className=\"text-3xl font-bold text-white mb-6 text-center\">Admin Panel Access</h1>\r\n            <p className=\"text-gray-300 mb-6 text-center\">Enter the admin password to continue</p>\r\n            <div className=\"space-y-4\">\r\n              <input\r\n                type=\"password\"\r\n                value={password}\r\n                onChange={(e) => setPassword(e.target.value)}\r\n                placeholder=\"Enter password\"\r\n                className=\"w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-accent-primary\"\r\n              />\r\n              <button\r\n                onClick={checkPassword}\r\n                className=\"w-full bg-accent-primary hover:bg-accent-primary/90 text-white py-3 rounded-md font-medium transition-colors hover-lift border border-accent-primary\"\r\n              >\r\n                Enter Admin Panel\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ) : (\r\n        <div className=\"container mx-auto px-4 py-8 h-screen flex flex-col\">\r\n          <h1 className=\"text-3xl font-bold text-white mb-8\">Admin Panel</h1>\r\n          \r\n          <div className=\"flex space-x-1 mb-6 bg-gray-800 p-1 rounded-lg w-fit\">\r\n            <button \r\n              onClick={() => {\r\n                setActiveTab('courses');\r\n                // Reset selection when switching tabs\r\n                setSelectedCourseId(null);\r\n                setSelectedModuleId(null);\r\n                setSelectedLessonId(null);\r\n              }}\r\n              className={`px-4 py-2 rounded-md transition-colors hover-lift ${activeTab === 'courses' ? 'bg-accent-primary text-white border border-accent-primary' : 'text-gray-300 hover:text-white'}`}\r\n            >\r\n              Manage Courses\r\n            </button>\r\n            <button \r\n              onClick={() => setActiveTab('announcements')} \r\n              className={`px-4 py-2 rounded-md transition-colors hover-lift ${activeTab === 'announcements' ? 'bg-accent-primary text-white border border-accent-primary' : 'text-gray-300 hover:text-white'}`}\r\n            >\r\n              Announcements\r\n            </button>\r\n            {profile?.role === 'admin' && (\r\n              <button \r\n                onClick={() => setActiveTab('challenges')} \r\n                className={`px-4 py-2 rounded-md transition-colors hover-lift ${activeTab === 'challenges' ? 'bg-accent-primary text-white border border-accent-primary' : 'text-gray-300 hover:text-white'}`}\r\n              >\r\n                Challenges\r\n              </button>\r\n            )}\r\n            {profile?.role === 'admin' && (\r\n              <button \r\n                onClick={() => setActiveTab('users')} \r\n                className={`px-4 py-2 rounded-md transition-colors hover-lift ${activeTab === 'users' ? 'bg-accent-primary text-white border border-accent-primary' : 'text-gray-300 hover:text-white'}`}\r\n              >\r\n                User Management\r\n              </button>\r\n            )}\r\n          </div>\r\n          \r\n          {activeTab === 'courses' && (\r\n            <div className=\"flex-1 flex flex-col min-h-0\">\r\n              {/* Course management interface */}\r\n              <div className=\"flex-1 flex gap-4\">\r\n                {/* Course List Column */}\r\n                <div className=\"w-1/3 flex flex-col\">\r\n                  <CourseList \r\n                    selectedCourseId={selectedCourseId}\r\n                    onSelectCourse={(id) => {\r\n                      setSelectedCourseId(id);\r\n                      setSelectedModuleId(null);\r\n                      setSelectedLessonId(null);\r\n                    }}\r\n                    onCourseCreated={() => {\r\n                      // Refresh the course list when a new course is created\r\n                      console.log('DEBUG: Course created, triggering refresh');\r\n                      if (selectedCourseId) {\r\n                        setSelectedCourseId(selectedCourseId);\r\n                      }\r\n                    }}\r\n                    onCourseUpdated={() => {\r\n                      // Refresh modules if current course was updated\r\n                      console.log('DEBUG: Course updated, triggering refresh');\r\n                      if (selectedCourseId) {\r\n                        setSelectedCourseId(selectedCourseId);\r\n                      }\r\n                      \r\n                      // Trigger public UI refresh after course update\r\n                      triggerPublicUIRefresh();\r\n                    }}\r\n                  />\r\n                </div>\r\n                \r\n                {/* Module List Column */}\r\n                <div className=\"w-1/3 flex flex-col\">\r\n                  <ModuleList \r\n                    courseId={selectedCourseId}\r\n                    selectedModuleId={selectedModuleId}\r\n                    onSelectModule={(id) => {\r\n                      setSelectedModuleId(id);\r\n                      setSelectedLessonId(null);\r\n                    }}\r\n                    onModuleCreated={() => {\r\n                      // Refresh the module list when a new module is created\r\n                      console.log('DEBUG: Module created, triggering refresh');\r\n                      if (selectedCourseId) {\r\n                        setSelectedModuleId(selectedModuleId);\r\n                      }\r\n                    }}\r\n                    onModuleUpdated={() => {\r\n                      // Refresh lessons if current module was updated\r\n                      console.log('DEBUG: Module updated, triggering refresh');\r\n                      if (selectedModuleId) {\r\n                        setSelectedModuleId(selectedModuleId);\r\n                      }\r\n                      \r\n                      // Trigger public UI refresh after module update\r\n                      triggerPublicUIRefresh();\r\n                    }}\r\n                  />\r\n                </div>\r\n                \r\n                {/* Lesson List Column */}\r\n                <div className=\"w-1/3 flex flex-col\">\r\n                  <LessonList \r\n                    moduleId={selectedModuleId}\r\n                    selectedLessonId={selectedLessonId}\r\n                    onSelectLesson={(id) => setSelectedLessonId(id)}\r\n                    onLessonCreated={() => {\r\n                      // Refresh lessons when a new lesson is created\r\n                      console.log('DEBUG: Lesson created, triggering refresh');\r\n                      if (selectedModuleId) {\r\n                        // Force refresh by temporarily clearing the module selection\r\n                        const tempModuleId = selectedModuleId;\r\n                        setSelectedModuleId(null);\r\n                        setTimeout(() => setSelectedModuleId(tempModuleId), 100);\r\n                      }\r\n                      \r\n                      // Trigger public UI refresh after lesson creation\r\n                      triggerPublicUIRefresh();\r\n                    }}\r\n                    onLessonUpdated={() => {}}\r\n                    onEditLesson={handleEditLesson}\r\n                  />\r\n                  \r\n                  {/* Add Lesson Button */}\r\n                  {selectedModuleId && (\r\n                    <div className=\"p-4 border-t border-gray-700\">\r\n                      <button\r\n                        onClick={() => handleCreateLesson(selectedModuleId)}\r\n                        className=\"w-full bg-accent-primary hover:bg-accent-primary/90 text-white py-2 rounded-md font-medium transition-colors hover-lift border border-accent-primary\"\r\n                      >\r\n                        + Add Lesson\r\n                      </button>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n          \r\n          {activeTab === 'announcements' && (\r\n            <div className=\"flex-1 flex flex-col min-h-0\">\r\n              <h2 className=\"text-xl font-bold text-white mb-4\">Manage Announcements</h2>\r\n              <div className=\"flex-1 bg-gray-900 border border-gray-700 rounded-lg overflow-hidden\">\r\n                <AnnouncementManager />\r\n              </div>\r\n            </div>\r\n          )}\r\n          \r\n          {activeTab === 'challenges' && profile?.role === 'admin' && (\r\n            <div className=\"flex-1 flex flex-col min-h-0\">\r\n              <h2 className=\"text-xl font-bold text-white mb-4\">Manage Challenges</h2>\r\n              <div className=\"flex-1 bg-gray-900 border border-gray-700 rounded-lg overflow-auto min-h-0\">\r\n                <ChallengeManager />\r\n              </div>\r\n            </div>\r\n          )}\r\n          \r\n          {activeTab === 'users' && profile?.role === 'admin' && (\r\n            <div className=\"flex-1 flex flex-col min-h-0\">\r\n              <h2 className=\"text-xl font-bold text-white mb-4\">User Management</h2>\r\n              <div className=\"flex-1 bg-gray-900 border border-gray-700 rounded-lg overflow-hidden\">\r\n                <UserManager />\r\n              </div>\r\n            </div>\r\n          )}\r\n        </div>\r\n      )}\r\n      \r\n      {/* Lesson Editor Modal */}\r\n      {lessonEditorOpen && (\r\n        <LessonEditor\r\n          lesson={editingLesson}\r\n          moduleId={selectedModuleId}\r\n          onSave={handleLessonSaved}\r\n          onCreate={handleLessonCreated}\r\n          onClose={() => {\r\n            setLessonEditorOpen(false);\r\n            setEditingLesson(null);\r\n          }}\r\n        />\r\n      )}\r\n    </AppShell>\r\n  );\r\n};\r\n\r\nexport default AdminPage;"],"names":[],"mappings":"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"}}]
}