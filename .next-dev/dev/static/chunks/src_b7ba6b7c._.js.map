{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/community/db/LocalDB.ts"],"sourcesContent":["import { CommunityDB, Profile, FriendRequest, Friend, Conversation, ConversationMember, Message, Block, Report } from './types';\r\n\r\ninterface Data {\r\n  profiles: Profile[];\r\n  friendRequests: FriendRequest[];\r\n  friends: Friend[];\r\n  conversations: Conversation[];\r\n  conversationMembers: ConversationMember[];\r\n  messages: Message[];\r\n  blocks: Block[];\r\n  reports: Report[];\r\n  typingIndicators: Record<string, { userId: string; timestamp: number }[]>;\r\n}\r\n\r\nexport class LocalDB implements CommunityDB {\r\n  private storageKey = 'vibeschool-community-data';\r\n  private DEBUG_COMMUNITY = process.env.DEBUG_COMMUNITY === 'true';\r\n\r\n  constructor() {\r\n    // Initialize with default data if not exists\r\n    this.initStorage();\r\n  }\r\n\r\n  private initStorage() {\r\n    if (typeof window !== 'undefined') {\r\n      if (!localStorage.getItem(this.storageKey)) {\r\n        const defaultData: Data = {\r\n          profiles: [],\r\n          friendRequests: [],\r\n          friends: [],\r\n          conversations: [],\r\n          conversationMembers: [],\r\n          messages: [],\r\n          blocks: [],\r\n          reports: [],\r\n          typingIndicators: {},\r\n        };\r\n        localStorage.setItem(this.storageKey, JSON.stringify(defaultData));\r\n      }\r\n    }\r\n  }\r\n\r\n  private getData(): Data {\r\n    if (typeof window === 'undefined') {\r\n      return {\r\n        profiles: [],\r\n        friendRequests: [],\r\n        friends: [],\r\n        conversations: [],\r\n        conversationMembers: [],\r\n        messages: [],\r\n        blocks: [],\r\n        reports: [],\r\n        typingIndicators: {},\r\n      };\r\n    }\r\n    \r\n    const dataStr = localStorage.getItem(this.storageKey);\r\n    if (!dataStr) {\r\n      this.initStorage();\r\n      return this.getData();\r\n    }\r\n    \r\n    try {\r\n      return JSON.parse(dataStr) as Data;\r\n    } catch (error) {\r\n      console.error('[COMMUNITY][LocalDB] Error parsing data:', error);\r\n      this.initStorage();\r\n      return this.getData();\r\n    }\r\n  }\r\n\r\n  private setData(data: Data) {\r\n    if (typeof window !== 'undefined') {\r\n      localStorage.setItem(this.storageKey, JSON.stringify(data));\r\n    }\r\n  }\r\n\r\n  // Profiles\r\n  async getProfile(userId: string): Promise<Profile | null> {\r\n    const data = this.getData();\r\n    const profile = data.profiles.find(p => p.id === userId) || null;\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] getProfile', { userId, profile: profile ? 'found' : 'not found' });\r\n    }\r\n    \r\n    return profile;\r\n  }\r\n\r\n  async updateProfile(userId: string, data: Partial<Omit<Profile, 'id' | 'created_at'>>): Promise<Profile> {\r\n    const currentData = this.getData();\r\n    const existingIndex = currentData.profiles.findIndex(p => p.id === userId);\r\n    \r\n    if (existingIndex !== -1) {\r\n      currentData.profiles[existingIndex] = {\r\n        ...currentData.profiles[existingIndex],\r\n        ...data,\r\n        last_seen_at: new Date().toISOString(),\r\n      };\r\n    } else {\r\n      const newProfile: Profile = {\r\n        id: userId,\r\n        username: data.username || '',\r\n        display_name: data.display_name || '',\r\n        avatar_url: data.avatar_url,\r\n        role: data.role || 'student',\r\n        created_at: new Date().toISOString(),\r\n        last_seen_at: new Date().toISOString(),\r\n        is_online: false,\r\n      };\r\n      currentData.profiles.push(newProfile);\r\n    }\r\n    \r\n    this.setData(currentData);\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] updateProfile', { userId, data });\r\n    }\r\n    \r\n    return currentData.profiles.find(p => p.id === userId)!;\r\n  }\r\n\r\n  async searchProfiles(query: string): Promise<Profile[]> {\r\n    const data = this.getData();\r\n    const lowerQuery = query.toLowerCase();\r\n    const results = data.profiles.filter(p => \r\n      p.username.toLowerCase().includes(lowerQuery) || \r\n      p.display_name.toLowerCase().includes(lowerQuery)\r\n    );\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] searchProfiles', { query, results: results.length });\r\n    }\r\n    \r\n    return results;\r\n  }\r\n\r\n  // Friend Requests\r\n  async createFriendRequest(requesterId: string, addresseeId: string): Promise<FriendRequest> {\r\n    const currentData = this.getData();\r\n    const newRequest: FriendRequest = {\r\n      id: crypto.randomUUID(),\r\n      requester_id: requesterId,\r\n      addressee_id: addresseeId,\r\n      status: 'pending',\r\n      created_at: new Date().toISOString(),\r\n      updated_at: new Date().toISOString(),\r\n    };\r\n    \r\n    currentData.friendRequests.push(newRequest);\r\n    this.setData(currentData);\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] createFriendRequest', { requesterId, addresseeId, requestId: newRequest.id });\r\n    }\r\n    \r\n    return newRequest;\r\n  }\r\n\r\n  async updateFriendRequest(requestId: string, status: 'accepted' | 'declined' | 'cancelled'): Promise<FriendRequest> {\r\n    const currentData = this.getData();\r\n    const index = currentData.friendRequests.findIndex(r => r.id === requestId);\r\n    \r\n    if (index !== -1) {\r\n      currentData.friendRequests[index].status = status;\r\n      currentData.friendRequests[index].updated_at = new Date().toISOString();\r\n      \r\n      // If accepted, create friendship entries\r\n      if (status === 'accepted') {\r\n        const request = currentData.friendRequests[index];\r\n        const friendEntry1: Friend = {\r\n          user_id: request.requester_id,\r\n          friend_id: request.addressee_id,\r\n          created_at: new Date().toISOString(),\r\n        };\r\n        const friendEntry2: Friend = {\r\n          user_id: request.addressee_id,\r\n          friend_id: request.requester_id,\r\n          created_at: new Date().toISOString(),\r\n        };\r\n        currentData.friends.push(friendEntry1, friendEntry2);\r\n      }\r\n      \r\n      this.setData(currentData);\r\n      \r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.log('[COMMUNITY][LocalDB] updateFriendRequest', { requestId, status });\r\n      }\r\n      \r\n      return currentData.friendRequests[index];\r\n    }\r\n    \r\n    throw new Error('Friend request not found');\r\n  }\r\n\r\n  async getFriendRequests(userId: string): Promise<FriendRequest[]> {\r\n    const data = this.getData();\r\n    const requests = data.friendRequests.filter(\r\n      r => r.addressee_id === userId || r.requester_id === userId\r\n    );\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] getFriendRequests', { userId, count: requests.length });\r\n    }\r\n    \r\n    return requests;\r\n  }\r\n\r\n  // Friends\r\n  async getFriends(userId: string): Promise<Friend[]> {\r\n    const data = this.getData();\r\n    const friends = data.friends.filter(f => f.user_id === userId);\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] getFriends', { userId, count: friends.length });\r\n    }\r\n    \r\n    return friends;\r\n  }\r\n\r\n  async unfriend(userId: string, friendId: string): Promise<void> {\r\n    const currentData = this.getData();\r\n    currentData.friends = currentData.friends.filter(\r\n      f => !(f.user_id === userId && f.friend_id === friendId) ||\r\n           !(f.user_id === friendId && f.friend_id === userId)\r\n    );\r\n    this.setData(currentData);\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] unfriend', { userId, friendId });\r\n    }\r\n  }\r\n\r\n  // Conversations\r\n  async createConversation(isGroup: boolean, createdBy: string, title?: string, userIds?: string[]): Promise<Conversation> {\r\n    const currentData = this.getData();\r\n    const newConversation: Conversation = {\r\n      id: crypto.randomUUID(),\r\n      is_group: isGroup,\r\n      title: title || (isGroup ? 'Group Chat' : undefined),\r\n      created_by: createdBy,\r\n      created_at: new Date().toISOString(),\r\n      updated_at: new Date().toISOString(),\r\n    };\r\n    \r\n    currentData.conversations.push(newConversation);\r\n    \r\n    // Add creator as member\r\n    const creatorMember: ConversationMember = {\r\n      conversation_id: newConversation.id,\r\n      user_id: createdBy,\r\n      role: 'owner',\r\n      joined_at: new Date().toISOString(),\r\n    };\r\n    currentData.conversationMembers.push(creatorMember);\r\n    \r\n    // Add other users if provided\r\n    if (userIds) {\r\n      for (const userId of userIds) {\r\n        if (userId !== createdBy) {\r\n          const member: ConversationMember = {\r\n            conversation_id: newConversation.id,\r\n            user_id: userId,\r\n            role: 'member',\r\n            joined_at: new Date().toISOString(),\r\n          };\r\n          currentData.conversationMembers.push(member);\r\n        }\r\n      }\r\n    }\r\n    \r\n    this.setData(currentData);\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] createConversation', { isGroup, createdBy, title, userIds, conversationId: newConversation.id });\r\n    }\r\n    \r\n    return newConversation;\r\n  }\r\n\r\n  async getConversations(userId: string): Promise<Conversation[]> {\r\n    const data = this.getData();\r\n    const userConversations = data.conversationMembers\r\n      .filter(cm => cm.user_id === userId)\r\n      .map(cm => cm.conversation_id);\r\n    \r\n    const conversations = data.conversations.filter(c => \r\n      userConversations.includes(c.id)\r\n    );\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] getConversations', { userId, count: conversations.length });\r\n    }\r\n    \r\n    return conversations;\r\n  }\r\n\r\n  async getConversation(conversationId: string): Promise<Conversation | null> {\r\n    const data = this.getData();\r\n    const conversation = data.conversations.find(c => c.id === conversationId) || null;\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] getConversation', { conversationId, found: !!conversation });\r\n    }\r\n    \r\n    return conversation;\r\n  }\r\n\r\n  async addConversationMember(conversationId: string, userId: string, role: 'owner' | 'admin' | 'member' = 'member'): Promise<void> {\r\n    const currentData = this.getData();\r\n    const existingMember = currentData.conversationMembers.find(\r\n      cm => cm.conversation_id === conversationId && cm.user_id === userId\r\n    );\r\n    \r\n    if (!existingMember) {\r\n      const member: ConversationMember = {\r\n        conversation_id: conversationId,\r\n        user_id: userId,\r\n        role,\r\n        joined_at: new Date().toISOString(),\r\n      };\r\n      currentData.conversationMembers.push(member);\r\n      this.setData(currentData);\r\n      \r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.log('[COMMUNITY][LocalDB] addConversationMember', { conversationId, userId, role });\r\n      }\r\n    }\r\n  }\r\n\r\n  async removeConversationMember(conversationId: string, userId: string): Promise<void> {\r\n    const currentData = this.getData();\r\n    currentData.conversationMembers = currentData.conversationMembers.filter(\r\n      cm => !(cm.conversation_id === conversationId && cm.user_id === userId)\r\n    );\r\n    this.setData(currentData);\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] removeConversationMember', { conversationId, userId });\r\n    }\r\n  }\r\n\r\n  async updateConversation(conversationId: string, data: Partial<Omit<Conversation, 'id' | 'created_by' | 'created_at'>>): Promise<void> {\r\n    const currentData = this.getData();\r\n    const index = currentData.conversations.findIndex(c => c.id === conversationId);\r\n    \r\n    if (index !== -1) {\r\n      currentData.conversations[index] = {\r\n        ...currentData.conversations[index],\r\n        ...data,\r\n        updated_at: new Date().toISOString(),\r\n      };\r\n      this.setData(currentData);\r\n      \r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.log('[COMMUNITY][LocalDB] updateConversation', { conversationId, data });\r\n      }\r\n    }\r\n  }\r\n\r\n  // Messages\r\n  async createMessage(message: Omit<Message, 'id' | 'created_at'>): Promise<Message> {\r\n    const currentData = this.getData();\r\n    const newMessage: Message = {\r\n      ...message,\r\n      id: crypto.randomUUID(),\r\n      created_at: new Date().toISOString(),\r\n    };\r\n    currentData.messages.push(newMessage);\r\n    this.setData(currentData);\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] createMessage', { conversationId: message.conversation_id, senderId: message.sender_id, messageId: newMessage.id });\r\n    }\r\n    \r\n    return newMessage;\r\n  }\r\n\r\n  async getMessages(conversationId: string, offset: number = 0, limit: number = 50): Promise<Message[]> {\r\n    const data = this.getData();\r\n    const messages = data.messages\r\n      .filter(m => m.conversation_id === conversationId && !m.deleted_at)\r\n      .sort((a, b) => new Date(a.created_at).getTime() - new Date(b.created_at).getTime())\r\n      .slice(offset, offset + limit);\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] getMessages', { conversationId, offset, limit, count: messages.length });\r\n    }\r\n    \r\n    return messages;\r\n  }\r\n\r\n  async updateMessage(messageId: string, body: string): Promise<Message> {\r\n    const currentData = this.getData();\r\n    const index = currentData.messages.findIndex(m => m.id === messageId);\r\n    \r\n    if (index !== -1) {\r\n      currentData.messages[index].body = body;\r\n      currentData.messages[index].edited_at = new Date().toISOString();\r\n      this.setData(currentData);\r\n      \r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.log('[COMMUNITY][LocalDB] updateMessage', { messageId, body });\r\n      }\r\n      \r\n      return currentData.messages[index];\r\n    }\r\n    \r\n    throw new Error('Message not found');\r\n  }\r\n\r\n  async deleteMessage(messageId: string): Promise<void> {\r\n    const currentData = this.getData();\r\n    const index = currentData.messages.findIndex(m => m.id === messageId);\r\n    \r\n    if (index !== -1) {\r\n      currentData.messages[index].deleted_at = new Date().toISOString();\r\n      this.setData(currentData);\r\n      \r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.log('[COMMUNITY][LocalDB] deleteMessage', { messageId });\r\n      }\r\n    }\r\n  }\r\n\r\n  // Blocks\r\n  async blockUser(blockerId: string, blockedId: string): Promise<void> {\r\n    const currentData = this.getData();\r\n    const existingBlock = currentData.blocks.find(\r\n      b => b.blocker_id === blockerId && b.blocked_id === blockedId\r\n    );\r\n    \r\n    if (!existingBlock) {\r\n      const block: Block = {\r\n        blocker_id: blockerId,\r\n        blocked_id: blockedId,\r\n        created_at: new Date().toISOString(),\r\n      };\r\n      currentData.blocks.push(block);\r\n      this.setData(currentData);\r\n      \r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.log('[COMMUNITY][LocalDB] blockUser', { blockerId, blockedId });\r\n      }\r\n    }\r\n  }\r\n\r\n  async unblockUser(blockerId: string, blockedId: string): Promise<void> {\r\n    const currentData = this.getData();\r\n    currentData.blocks = currentData.blocks.filter(\r\n      b => !(b.blocker_id === blockerId && b.blocked_id === blockedId)\r\n    );\r\n    this.setData(currentData);\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] unblockUser', { blockerId, blockedId });\r\n    }\r\n  }\r\n\r\n  async isBlocked(blockerId: string, blockedId: string): Promise<boolean> {\r\n    const data = this.getData();\r\n    const isBlocked = data.blocks.some(\r\n      b => b.blocker_id === blockerId && b.blocked_id === blockedId\r\n    );\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] isBlocked', { blockerId, blockedId, isBlocked });\r\n    }\r\n    \r\n    return isBlocked;\r\n  }\r\n\r\n  // Reports\r\n  async reportUser(reporterId: string, reportedUserId: string, reason: string): Promise<Report> {\r\n    const currentData = this.getData();\r\n    const newReport: Report = {\r\n      id: crypto.randomUUID(),\r\n      reporter_id: reporterId,\r\n      reported_user_id: reportedUserId,\r\n      reason,\r\n      created_at: new Date().toISOString(),\r\n    };\r\n    currentData.reports.push(newReport);\r\n    this.setData(currentData);\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] reportUser', { reporterId, reportedUserId, reason });\r\n    }\r\n    \r\n    return newReport;\r\n  }\r\n\r\n  async reportMessage(reporterId: string, messageId: string, reason: string): Promise<Report> {\r\n    const currentData = this.getData();\r\n    const newReport: Report = {\r\n      id: crypto.randomUUID(),\r\n      reporter_id: reporterId,\r\n      message_id: messageId,\r\n      reason,\r\n      created_at: new Date().toISOString(),\r\n    };\r\n    currentData.reports.push(newReport);\r\n    this.setData(currentData);\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] reportMessage', { reporterId, messageId, reason });\r\n    }\r\n    \r\n    return newReport;\r\n  }\r\n\r\n  // Typing Indicators\r\n  setTypingStatus(conversationId: string, userId: string, isTyping: boolean): void {\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] setTypingStatus', { conversationId, userId, isTyping });\r\n    }\r\n    \r\n    const data = this.getData();\r\n    const now = Date.now();\r\n    const conversationTyping = data.typingIndicators[conversationId] || [];\r\n    \r\n    if (isTyping) {\r\n      // Add user to typing list\r\n      const existingIndex = conversationTyping.findIndex(t => t.userId === userId);\r\n      if (existingIndex >= 0) {\r\n        conversationTyping[existingIndex].timestamp = now;\r\n      } else {\r\n        conversationTyping.push({ userId, timestamp: now });\r\n      }\r\n    } else {\r\n      // Remove user from typing list\r\n      const existingIndex = conversationTyping.findIndex(t => t.userId === userId);\r\n      if (existingIndex >= 0) {\r\n        conversationTyping.splice(existingIndex, 1);\r\n      }\r\n    }\r\n    \r\n    data.typingIndicators[conversationId] = conversationTyping;\r\n    this.setData(data);\r\n  }\r\n\r\n  async getTypingUsers(conversationId: string): Promise<string[]> {\r\n    const data = this.getData();\r\n    const now = Date.now();\r\n    const fiveSecondsAgo = now - 5000; // Clear typing indicators older than 5 seconds\r\n    \r\n    const conversationTyping = data.typingIndicators[conversationId] || [];\r\n    const recentTyping = conversationTyping.filter(t => t.timestamp > fiveSecondsAgo);\r\n    \r\n    // Update the typing indicators to remove stale entries\r\n    data.typingIndicators[conversationId] = recentTyping;\r\n    this.setData(data);\r\n    \r\n    const userIds = recentTyping.map(t => t.userId);\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] getTypingUsers', { conversationId, userIds });\r\n    }\r\n    return userIds;\r\n  }\r\n\r\n  // Read Receipts\r\n  async markAsRead(conversationId: string, userId: string, lastReadAt: string): Promise<void> {\r\n    const currentData = this.getData();\r\n    const memberIndex = currentData.conversationMembers.findIndex(\r\n      cm => cm.conversation_id === conversationId && cm.user_id === userId\r\n    );\r\n    \r\n    if (memberIndex !== -1) {\r\n      currentData.conversationMembers[memberIndex].last_read_at = lastReadAt;\r\n      this.setData(currentData);\r\n      \r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.log('[COMMUNITY][LocalDB] markAsRead', { conversationId, userId, lastReadAt });\r\n      }\r\n    }\r\n  }\r\n\r\n  async getUnreadCount(conversationId: string, userId: string): Promise<number> {\r\n    const data = this.getData();\r\n    const member = data.conversationMembers.find(\r\n      cm => cm.conversation_id === conversationId && cm.user_id === userId\r\n    );\r\n    \r\n    const lastReadAt = member?.last_read_at ? new Date(member.last_read_at) : new Date(0);\r\n    \r\n    const unreadCount = data.messages.filter(\r\n      m => m.conversation_id === conversationId &&\r\n           new Date(m.created_at) > lastReadAt &&\r\n           m.sender_id !== userId // Don't count own messages as unread\r\n    ).length;\r\n    \r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][LocalDB] getUnreadCount', { conversationId, userId, unreadCount });\r\n    }\r\n    return unreadCount;\r\n  }\r\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 553, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/community/db/SupabaseDB.ts"],"sourcesContent":["import { CommunityDB, Profile, FriendRequest, Friend, Conversation, ConversationMember, Message, Block, Report } from './types';\r\nimport { createClient } from '@supabase/supabase-js';\r\n\r\nexport class SupabaseDB implements CommunityDB {\r\n  private supabase;\r\n  private DEBUG_COMMUNITY = process.env.DEBUG_COMMUNITY === 'true';\r\n\r\n  constructor() {\r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\n    const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\r\n    \r\n    if (!supabaseUrl || !supabaseAnonKey) {\r\n      throw new Error('Supabase URL and Anon Key are required');\r\n    }\r\n    \r\n    this.supabase = createClient(supabaseUrl, supabaseAnonKey);\r\n  }\r\n\r\n  // Profiles\r\n  async getProfile(userId: string): Promise<Profile | null> {\r\n    const { data, error } = await this.supabase\r\n      .from('profiles')\r\n      .select('*')\r\n      .eq('id', userId)\r\n      .single();\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] getProfile error', error);\r\n      }\r\n      return null;\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] getProfile', { userId, profile: data ? 'found' : 'not found' });\r\n    }\r\n    return data as Profile;\r\n  }\r\n\r\n  async updateProfile(userId: string, data: Partial<Omit<Profile, 'id' | 'created_at'>>): Promise<Profile> {\r\n    const { data: updatedData, error } = await this.supabase\r\n      .from('profiles')\r\n      .update({\r\n        ...data,\r\n        last_seen_at: new Date().toISOString(),\r\n      })\r\n      .eq('id', userId)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] updateProfile error', error);\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] updateProfile', { userId, data });\r\n    }\r\n    return updatedData as Profile;\r\n  }\r\n\r\n  async searchProfiles(query: string): Promise<Profile[]> {\r\n    const { data, error } = await this.supabase\r\n      .from('profiles')\r\n      .select('*')\r\n      .or(`username.ilike.%${query}%,display_name.ilike.%${query}%`);\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] searchProfiles error', error);\r\n      }\r\n      return [];\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] searchProfiles', { query, results: data?.length || 0 });\r\n    }\r\n    return data as Profile[];\r\n  }\r\n\r\n  // Friend Requests\r\n  async createFriendRequest(requesterId: string, addresseeId: string): Promise<FriendRequest> {\r\n    const newRequest = {\r\n      id: crypto.randomUUID(),\r\n      requester_id: requesterId,\r\n      addressee_id: addresseeId,\r\n      status: 'pending',\r\n      created_at: new Date().toISOString(),\r\n      updated_at: new Date().toISOString(),\r\n    };\r\n\r\n    const { data, error } = await this.supabase\r\n      .from('friend_requests')\r\n      .insert([newRequest])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] createFriendRequest error', error);\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] createFriendRequest', { requesterId, addresseeId, requestId: data.id });\r\n    }\r\n    return data as FriendRequest;\r\n  }\r\n\r\n  async updateFriendRequest(requestId: string, status: 'accepted' | 'declined' | 'cancelled'): Promise<FriendRequest> {\r\n    const { data, error } = await this.supabase\r\n      .from('friend_requests')\r\n      .update({ \r\n        status,\r\n        updated_at: new Date().toISOString()\r\n      })\r\n      .eq('id', requestId)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] updateFriendRequest error', error);\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    // If accepted, create friendship entries\r\n    if (status === 'accepted' && data) {\r\n      const request = data as FriendRequest;\r\n      const friendEntry1 = {\r\n        user_id: request.requester_id,\r\n        friend_id: request.addressee_id,\r\n        created_at: new Date().toISOString(),\r\n      };\r\n      const friendEntry2 = {\r\n        user_id: request.addressee_id,\r\n        friend_id: request.requester_id,\r\n        created_at: new Date().toISOString(),\r\n      };\r\n\r\n      await this.supabase.from('friends').insert([friendEntry1, friendEntry2]);\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] updateFriendRequest', { requestId, status });\r\n    }\r\n    return data as FriendRequest;\r\n  }\r\n\r\n  async getFriendRequests(userId: string): Promise<FriendRequest[]> {\r\n    const { data, error } = await this.supabase\r\n      .from('friend_requests')\r\n      .select('*')\r\n      .or(`requester_id.eq.${userId},addressee_id.eq.${userId}`);\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] getFriendRequests error', error);\r\n      }\r\n      return [];\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] getFriendRequests', { userId, count: data?.length || 0 });\r\n    }\r\n    return data as FriendRequest[];\r\n  }\r\n\r\n  // Friends\r\n  async getFriends(userId: string): Promise<Friend[]> {\r\n    const { data, error } = await this.supabase\r\n      .from('friends')\r\n      .select('*')\r\n      .eq('user_id', userId);\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] getFriends error', error);\r\n      }\r\n      return [];\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] getFriends', { userId, count: data?.length || 0 });\r\n    }\r\n    return data as Friend[];\r\n  }\r\n\r\n  async unfriend(userId: string, friendId: string): Promise<void> {\r\n    await this.supabase\r\n      .from('friends')\r\n      .delete()\r\n      .or(`(user_id.eq.${userId},friend_id.eq.${friendId}),(user_id.eq.${friendId},friend_id.eq.${userId})`);\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] unfriend', { userId, friendId });\r\n    }\r\n  }\r\n\r\n  // Conversations\r\n  async createConversation(isGroup: boolean, createdBy: string, title?: string, userIds?: string[]): Promise<Conversation> {\r\n    const newConversation = {\r\n      id: crypto.randomUUID(),\r\n      is_group: isGroup,\r\n      title: title || (isGroup ? 'Group Chat' : undefined),\r\n      created_by: createdBy,\r\n      created_at: new Date().toISOString(),\r\n      updated_at: new Date().toISOString(),\r\n    };\r\n\r\n    const { data, error } = await this.supabase\r\n      .from('conversations')\r\n      .insert([newConversation])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] createConversation error', error);\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    // Add creator as member\r\n    await this.supabase.from('conversation_members').insert([\r\n      {\r\n        conversation_id: data.id,\r\n        user_id: createdBy,\r\n        role: 'owner',\r\n        joined_at: new Date().toISOString(),\r\n      }\r\n    ]);\r\n\r\n    // Add other users if provided\r\n    if (userIds) {\r\n      for (const userId of userIds) {\r\n        if (userId !== createdBy) {\r\n          await this.supabase.from('conversation_members').insert([\r\n            {\r\n              conversation_id: data.id,\r\n              user_id: userId,\r\n              role: 'member',\r\n              joined_at: new Date().toISOString(),\r\n            }\r\n          ]);\r\n        }\r\n      }\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] createConversation', { isGroup, createdBy, title, userIds, conversationId: data.id });\r\n    }\r\n    return data as Conversation;\r\n  }\r\n\r\n  async getConversations(userId: string): Promise<Conversation[]> {\r\n    const { data, error } = await this.supabase\r\n      .from('conversation_members')\r\n      .select('conversation_id')\r\n      .eq('user_id', userId);\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] getConversations error', error);\r\n      }\r\n      return [];\r\n    }\r\n\r\n    const conversationIds = data.map(cm => cm.conversation_id);\r\n\r\n    const { data: conversations, error: convError } = await this.supabase\r\n      .from('conversations')\r\n      .select('*')\r\n      .in('id', conversationIds);\r\n\r\n    if (convError) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] getConversations error fetching conversations', convError);\r\n      }\r\n      return [];\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] getConversations', { userId, count: conversations?.length || 0 });\r\n    }\r\n    return conversations as Conversation[];\r\n  }\r\n\r\n  async getConversation(conversationId: string): Promise<Conversation | null> {\r\n    const { data, error } = await this.supabase\r\n      .from('conversations')\r\n      .select('*')\r\n      .eq('id', conversationId)\r\n      .single();\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] getConversation error', error);\r\n      }\r\n      return null;\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] getConversation', { conversationId, found: !!data });\r\n    }\r\n    return data as Conversation;\r\n  }\r\n\r\n  async addConversationMember(conversationId: string, userId: string, role: 'owner' | 'admin' | 'member' = 'member'): Promise<void> {\r\n    const { error } = await this.supabase\r\n      .from('conversation_members')\r\n      .insert([\r\n        {\r\n          conversation_id: conversationId,\r\n          user_id: userId,\r\n          role,\r\n          joined_at: new Date().toISOString(),\r\n        }\r\n      ]);\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] addConversationMember error', error);\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] addConversationMember', { conversationId, userId, role });\r\n    }\r\n  }\r\n\r\n  async removeConversationMember(conversationId: string, userId: string): Promise<void> {\r\n    const { error } = await this.supabase\r\n      .from('conversation_members')\r\n      .delete()\r\n      .match({ conversation_id: conversationId, user_id: userId });\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] removeConversationMember error', error);\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] removeConversationMember', { conversationId, userId });\r\n    }\r\n  }\r\n\r\n  async updateConversation(conversationId: string, data: Partial<Omit<Conversation, 'id' | 'created_by' | 'created_at'>>): Promise<void> {\r\n    const { error } = await this.supabase\r\n      .from('conversations')\r\n      .update({\r\n        ...data,\r\n        updated_at: new Date().toISOString(),\r\n      })\r\n      .eq('id', conversationId);\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] updateConversation error', error);\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] updateConversation', { conversationId, data });\r\n    }\r\n  }\r\n\r\n  // Messages\r\n  async createMessage(message: Omit<Message, 'id' | 'created_at'>): Promise<Message> {\r\n    const newMessage = {\r\n      ...message,\r\n      id: crypto.randomUUID(),\r\n      created_at: new Date().toISOString(),\r\n    };\r\n\r\n    const { data, error } = await this.supabase\r\n      .from('messages')\r\n      .insert([newMessage])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] createMessage error', error);\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] createMessage', { conversationId: message.conversation_id, senderId: message.sender_id, messageId: data.id });\r\n    }\r\n    return data as Message;\r\n  }\r\n\r\n  async getMessages(conversationId: string, offset: number = 0, limit: number = 50): Promise<Message[]> {\r\n    const { data, error } = await this.supabase\r\n      .from('messages')\r\n      .select('*')\r\n      .eq('conversation_id', conversationId)\r\n      .is('deleted_at', null)\r\n      .order('created_at', { ascending: true })\r\n      .range(offset, offset + limit - 1);\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] getMessages error', error);\r\n      }\r\n      return [];\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] getMessages', { conversationId, offset, limit, count: data?.length || 0 });\r\n    }\r\n    return data as Message[];\r\n  }\r\n\r\n  async updateMessage(messageId: string, body: string): Promise<Message> {\r\n    const { data, error } = await this.supabase\r\n      .from('messages')\r\n      .update({ \r\n        body,\r\n        edited_at: new Date().toISOString(),\r\n      })\r\n      .eq('id', messageId)\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] updateMessage error', error);\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] updateMessage', { messageId, body });\r\n    }\r\n    return data as Message;\r\n  }\r\n\r\n  async deleteMessage(messageId: string): Promise<void> {\r\n    const { error } = await this.supabase\r\n      .from('messages')\r\n      .update({ deleted_at: new Date().toISOString() })\r\n      .eq('id', messageId);\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] deleteMessage error', error);\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] deleteMessage', { messageId });\r\n    }\r\n  }\r\n\r\n  // Blocks\r\n  async blockUser(blockerId: string, blockedId: string): Promise<void> {\r\n    const block = {\r\n      blocker_id: blockerId,\r\n      blocked_id: blockedId,\r\n      created_at: new Date().toISOString(),\r\n    };\r\n\r\n    const { error } = await this.supabase\r\n      .from('blocks')\r\n      .insert([block]);\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] blockUser error', error);\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] blockUser', { blockerId, blockedId });\r\n    }\r\n  }\r\n\r\n  async unblockUser(blockerId: string, blockedId: string): Promise<void> {\r\n    const { error } = await this.supabase\r\n      .from('blocks')\r\n      .delete()\r\n      .match({ blocker_id: blockerId, blocked_id: blockedId });\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] unblockUser error', error);\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] unblockUser', { blockerId, blockedId });\r\n    }\r\n  }\r\n\r\n  async isBlocked(blockerId: string, blockedId: string): Promise<boolean> {\r\n    const { data, error } = await this.supabase\r\n      .from('blocks')\r\n      .select('id')\r\n      .match({ blocker_id: blockerId, blocked_id: blockedId })\r\n      .single();\r\n\r\n    if (error && error.code !== 'PGRST116') { // PGRST116 means no rows returned\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] isBlocked error', error);\r\n      }\r\n      return false;\r\n    }\r\n\r\n    const isBlocked = !!data;\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] isBlocked', { blockerId, blockedId, isBlocked });\r\n    }\r\n    return isBlocked;\r\n  }\r\n\r\n  // Reports\r\n  async reportUser(reporterId: string, reportedUserId: string, reason: string): Promise<Report> {\r\n    const newReport = {\r\n      id: crypto.randomUUID(),\r\n      reporter_id: reporterId,\r\n      reported_user_id: reportedUserId,\r\n      reason,\r\n      created_at: new Date().toISOString(),\r\n    };\r\n\r\n    const { data, error } = await this.supabase\r\n      .from('reports')\r\n      .insert([newReport])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] reportUser error', error);\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] reportUser', { reporterId, reportedUserId, reason });\r\n    }\r\n    return data as Report;\r\n  }\r\n\r\n  async reportMessage(reporterId: string, messageId: string, reason: string): Promise<Report> {\r\n    const newReport = {\r\n      id: crypto.randomUUID(),\r\n      reporter_id: reporterId,\r\n      message_id: messageId,\r\n      reason,\r\n      created_at: new Date().toISOString(),\r\n    };\r\n\r\n    const { data, error } = await this.supabase\r\n      .from('reports')\r\n      .insert([newReport])\r\n      .select()\r\n      .single();\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] reportMessage error', error);\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] reportMessage', { reporterId, messageId, reason });\r\n    }\r\n    return data as Report;\r\n  }\r\n\r\n  // Typing Indicators (ephemeral, not stored long term)\r\n  setTypingStatus(conversationId: string, userId: string, isTyping: boolean): void {\r\n    // In Supabase mode, we'll use Supabase Realtime for typing indicators\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] setTypingStatus', { conversationId, userId, isTyping });\r\n    }\r\n  }\r\n\r\n  async getTypingUsers(conversationId: string): Promise<string[]> {\r\n    // In Supabase mode, typing indicators would be handled via Realtime subscriptions\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] getTypingUsers', { conversationId });\r\n    }\r\n    return [];\r\n  }\r\n\r\n  // Read Receipts\r\n  async markAsRead(conversationId: string, userId: string, lastReadAt: string): Promise<void> {\r\n    const { error } = await this.supabase\r\n      .from('conversation_members')\r\n      .update({ last_read_at: lastReadAt })\r\n      .match({ conversation_id: conversationId, user_id: userId });\r\n\r\n    if (error) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] markAsRead error', error);\r\n      }\r\n      throw error;\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] markAsRead', { conversationId, userId, lastReadAt });\r\n    }\r\n  }\r\n\r\n  async getUnreadCount(conversationId: string, userId: string): Promise<number> {\r\n    // Get the last read time for this user in this conversation\r\n    const { data: member, error: memberError } = await this.supabase\r\n      .from('conversation_members')\r\n      .select('last_read_at')\r\n      .match({ conversation_id: conversationId, user_id: userId })\r\n      .single();\r\n\r\n    if (memberError) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] getUnreadCount error getting member', memberError);\r\n      }\r\n      return 0;\r\n    }\r\n\r\n    const lastReadAt = member?.last_read_at ? new Date(member.last_read_at) : new Date(0);\r\n\r\n    // Count messages sent after last read time by other users\r\n    const { count, error: countError } = await this.supabase\r\n      .from('messages')\r\n      .select('*', { count: 'exact', head: true })\r\n      .eq('conversation_id', conversationId)\r\n      .gt('created_at', lastReadAt.toISOString())\r\n      .neq('sender_id', userId) // Don't count own messages as unread\r\n      .is('deleted_at', null);\r\n\r\n    if (countError) {\r\n      if (this.DEBUG_COMMUNITY) {\r\n        console.error('[COMMUNITY][SupabaseDB] getUnreadCount error getting count', countError);\r\n      }\r\n      return 0;\r\n    }\r\n\r\n    if (this.DEBUG_COMMUNITY) {\r\n      console.log('[COMMUNITY][SupabaseDB] getUnreadCount', { conversationId, userId, unreadCount: count });\r\n    }\r\n    return count || 0;\r\n  }\r\n}"],"names":[],"mappings":";;;;AAK4B;AAJ5B;;AAEO,MAAM;IACH,SAAS;IACT,kBAAkB,2KAAO,CAAC,GAAG,CAAC,eAAe,KAAK,OAAO;IAEjE,aAAc;QACZ,MAAM;QACN,MAAM;QAEN;;QAIA,IAAI,CAAC,QAAQ,GAAG,IAAA,iMAAY,EAAC,aAAa;IAC5C;IAEA,WAAW;IACX,MAAM,WAAW,MAAc,EAA2B;QACxD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACxC,IAAI,CAAC,YACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,QACT,MAAM;QAET,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,4CAA4C;YAC5D;YACA,OAAO;QACT;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,sCAAsC;gBAAE;gBAAQ,SAAS,OAAO,UAAU;YAAY;QACpG;QACA,OAAO;IACT;IAEA,MAAM,cAAc,MAAc,EAAE,IAAiD,EAAoB;QACvG,MAAM,EAAE,MAAM,WAAW,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACrD,IAAI,CAAC,YACL,MAAM,CAAC;YACN,GAAG,IAAI;YACP,cAAc,IAAI,OAAO,WAAW;QACtC,GACC,EAAE,CAAC,MAAM,QACT,MAAM,GACN,MAAM;QAET,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,+CAA+C;YAC/D;YACA,MAAM;QACR;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,yCAAyC;gBAAE;gBAAQ;YAAK;QACtE;QACA,OAAO;IACT;IAEA,MAAM,eAAe,KAAa,EAAsB;QACtD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACxC,IAAI,CAAC,YACL,MAAM,CAAC,KACP,EAAE,CAAC,CAAC,gBAAgB,EAAE,MAAM,sBAAsB,EAAE,MAAM,CAAC,CAAC;QAE/D,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,gDAAgD;YAChE;YACA,OAAO,EAAE;QACX;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,0CAA0C;gBAAE;gBAAO,SAAS,MAAM,UAAU;YAAE;QAC5F;QACA,OAAO;IACT;IAEA,kBAAkB;IAClB,MAAM,oBAAoB,WAAmB,EAAE,WAAmB,EAA0B;QAC1F,MAAM,aAAa;YACjB,IAAI,OAAO,UAAU;YACrB,cAAc;YACd,cAAc;YACd,QAAQ;YACR,YAAY,IAAI,OAAO,WAAW;YAClC,YAAY,IAAI,OAAO,WAAW;QACpC;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACxC,IAAI,CAAC,mBACL,MAAM,CAAC;YAAC;SAAW,EACnB,MAAM,GACN,MAAM;QAET,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,qDAAqD;YACrE;YACA,MAAM;QACR;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,+CAA+C;gBAAE;gBAAa;gBAAa,WAAW,KAAK,EAAE;YAAC;QAC5G;QACA,OAAO;IACT;IAEA,MAAM,oBAAoB,SAAiB,EAAE,MAA6C,EAA0B;QAClH,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACxC,IAAI,CAAC,mBACL,MAAM,CAAC;YACN;YACA,YAAY,IAAI,OAAO,WAAW;QACpC,GACC,EAAE,CAAC,MAAM,WACT,MAAM,GACN,MAAM;QAET,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,qDAAqD;YACrE;YACA,MAAM;QACR;QAEA,yCAAyC;QACzC,IAAI,WAAW,cAAc,MAAM;YACjC,MAAM,UAAU;YAChB,MAAM,eAAe;gBACnB,SAAS,QAAQ,YAAY;gBAC7B,WAAW,QAAQ,YAAY;gBAC/B,YAAY,IAAI,OAAO,WAAW;YACpC;YACA,MAAM,eAAe;gBACnB,SAAS,QAAQ,YAAY;gBAC7B,WAAW,QAAQ,YAAY;gBAC/B,YAAY,IAAI,OAAO,WAAW;YACpC;YAEA,MAAM,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,WAAW,MAAM,CAAC;gBAAC;gBAAc;aAAa;QACzE;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,+CAA+C;gBAAE;gBAAW;YAAO;QACjF;QACA,OAAO;IACT;IAEA,MAAM,kBAAkB,MAAc,EAA4B;QAChE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACxC,IAAI,CAAC,mBACL,MAAM,CAAC,KACP,EAAE,CAAC,CAAC,gBAAgB,EAAE,OAAO,iBAAiB,EAAE,QAAQ;QAE3D,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,mDAAmD;YACnE;YACA,OAAO,EAAE;QACX;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,6CAA6C;gBAAE;gBAAQ,OAAO,MAAM,UAAU;YAAE;QAC9F;QACA,OAAO;IACT;IAEA,UAAU;IACV,MAAM,WAAW,MAAc,EAAqB;QAClD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACxC,IAAI,CAAC,WACL,MAAM,CAAC,KACP,EAAE,CAAC,WAAW;QAEjB,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,4CAA4C;YAC5D;YACA,OAAO,EAAE;QACX;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,sCAAsC;gBAAE;gBAAQ,OAAO,MAAM,UAAU;YAAE;QACvF;QACA,OAAO;IACT;IAEA,MAAM,SAAS,MAAc,EAAE,QAAgB,EAAiB;QAC9D,MAAM,IAAI,CAAC,QAAQ,CAChB,IAAI,CAAC,WACL,MAAM,GACN,EAAE,CAAC,CAAC,YAAY,EAAE,OAAO,cAAc,EAAE,SAAS,cAAc,EAAE,SAAS,cAAc,EAAE,OAAO,CAAC,CAAC;QAEvG,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,oCAAoC;gBAAE;gBAAQ;YAAS;QACrE;IACF;IAEA,gBAAgB;IAChB,MAAM,mBAAmB,OAAgB,EAAE,SAAiB,EAAE,KAAc,EAAE,OAAkB,EAAyB;QACvH,MAAM,kBAAkB;YACtB,IAAI,OAAO,UAAU;YACrB,UAAU;YACV,OAAO,SAAS,CAAC,UAAU,eAAe,SAAS;YACnD,YAAY;YACZ,YAAY,IAAI,OAAO,WAAW;YAClC,YAAY,IAAI,OAAO,WAAW;QACpC;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACxC,IAAI,CAAC,iBACL,MAAM,CAAC;YAAC;SAAgB,EACxB,MAAM,GACN,MAAM;QAET,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,oDAAoD;YACpE;YACA,MAAM;QACR;QAEA,wBAAwB;QACxB,MAAM,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,wBAAwB,MAAM,CAAC;YACtD;gBACE,iBAAiB,KAAK,EAAE;gBACxB,SAAS;gBACT,MAAM;gBACN,WAAW,IAAI,OAAO,WAAW;YACnC;SACD;QAED,8BAA8B;QAC9B,IAAI,SAAS;YACX,KAAK,MAAM,UAAU,QAAS;gBAC5B,IAAI,WAAW,WAAW;oBACxB,MAAM,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,wBAAwB,MAAM,CAAC;wBACtD;4BACE,iBAAiB,KAAK,EAAE;4BACxB,SAAS;4BACT,MAAM;4BACN,WAAW,IAAI,OAAO,WAAW;wBACnC;qBACD;gBACH;YACF;QACF;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,8CAA8C;gBAAE;gBAAS;gBAAW;gBAAO;gBAAS,gBAAgB,KAAK,EAAE;YAAC;QAC1H;QACA,OAAO;IACT;IAEA,MAAM,iBAAiB,MAAc,EAA2B;QAC9D,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACxC,IAAI,CAAC,wBACL,MAAM,CAAC,mBACP,EAAE,CAAC,WAAW;QAEjB,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,kDAAkD;YAClE;YACA,OAAO,EAAE;QACX;QAEA,MAAM,kBAAkB,KAAK,GAAG,CAAC,CAAA,KAAM,GAAG,eAAe;QAEzD,MAAM,EAAE,MAAM,aAAa,EAAE,OAAO,SAAS,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CAClE,IAAI,CAAC,iBACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM;QAEZ,IAAI,WAAW;YACb,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,yEAAyE;YACzF;YACA,OAAO,EAAE;QACX;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,4CAA4C;gBAAE;gBAAQ,OAAO,eAAe,UAAU;YAAE;QACtG;QACA,OAAO;IACT;IAEA,MAAM,gBAAgB,cAAsB,EAAgC;QAC1E,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACxC,IAAI,CAAC,iBACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,gBACT,MAAM;QAET,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,iDAAiD;YACjE;YACA,OAAO;QACT;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,2CAA2C;gBAAE;gBAAgB,OAAO,CAAC,CAAC;YAAK;QACzF;QACA,OAAO;IACT;IAEA,MAAM,sBAAsB,cAAsB,EAAE,MAAc,EAAE,OAAqC,QAAQ,EAAiB;QAChI,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CAClC,IAAI,CAAC,wBACL,MAAM,CAAC;YACN;gBACE,iBAAiB;gBACjB,SAAS;gBACT;gBACA,WAAW,IAAI,OAAO,WAAW;YACnC;SACD;QAEH,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,uDAAuD;YACvE;YACA,MAAM;QACR;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,iDAAiD;gBAAE;gBAAgB;gBAAQ;YAAK;QAC9F;IACF;IAEA,MAAM,yBAAyB,cAAsB,EAAE,MAAc,EAAiB;QACpF,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CAClC,IAAI,CAAC,wBACL,MAAM,GACN,KAAK,CAAC;YAAE,iBAAiB;YAAgB,SAAS;QAAO;QAE5D,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,0DAA0D;YAC1E;YACA,MAAM;QACR;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,oDAAoD;gBAAE;gBAAgB;YAAO;QAC3F;IACF;IAEA,MAAM,mBAAmB,cAAsB,EAAE,IAAqE,EAAiB;QACrI,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CAClC,IAAI,CAAC,iBACL,MAAM,CAAC;YACN,GAAG,IAAI;YACP,YAAY,IAAI,OAAO,WAAW;QACpC,GACC,EAAE,CAAC,MAAM;QAEZ,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,oDAAoD;YACpE;YACA,MAAM;QACR;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,8CAA8C;gBAAE;gBAAgB;YAAK;QACnF;IACF;IAEA,WAAW;IACX,MAAM,cAAc,OAA2C,EAAoB;QACjF,MAAM,aAAa;YACjB,GAAG,OAAO;YACV,IAAI,OAAO,UAAU;YACrB,YAAY,IAAI,OAAO,WAAW;QACpC;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACxC,IAAI,CAAC,YACL,MAAM,CAAC;YAAC;SAAW,EACnB,MAAM,GACN,MAAM;QAET,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,+CAA+C;YAC/D;YACA,MAAM;QACR;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,yCAAyC;gBAAE,gBAAgB,QAAQ,eAAe;gBAAE,UAAU,QAAQ,SAAS;gBAAE,WAAW,KAAK,EAAE;YAAC;QAClJ;QACA,OAAO;IACT;IAEA,MAAM,YAAY,cAAsB,EAAE,SAAiB,CAAC,EAAE,QAAgB,EAAE,EAAsB;QACpG,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACxC,IAAI,CAAC,YACL,MAAM,CAAC,KACP,EAAE,CAAC,mBAAmB,gBACtB,EAAE,CAAC,cAAc,MACjB,KAAK,CAAC,cAAc;YAAE,WAAW;QAAK,GACtC,KAAK,CAAC,QAAQ,SAAS,QAAQ;QAElC,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,6CAA6C;YAC7D;YACA,OAAO,EAAE;QACX;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,uCAAuC;gBAAE;gBAAgB;gBAAQ;gBAAO,OAAO,MAAM,UAAU;YAAE;QAC/G;QACA,OAAO;IACT;IAEA,MAAM,cAAc,SAAiB,EAAE,IAAY,EAAoB;QACrE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACxC,IAAI,CAAC,YACL,MAAM,CAAC;YACN;YACA,WAAW,IAAI,OAAO,WAAW;QACnC,GACC,EAAE,CAAC,MAAM,WACT,MAAM,GACN,MAAM;QAET,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,+CAA+C;YAC/D;YACA,MAAM;QACR;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,yCAAyC;gBAAE;gBAAW;YAAK;QACzE;QACA,OAAO;IACT;IAEA,MAAM,cAAc,SAAiB,EAAiB;QACpD,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CAClC,IAAI,CAAC,YACL,MAAM,CAAC;YAAE,YAAY,IAAI,OAAO,WAAW;QAAG,GAC9C,EAAE,CAAC,MAAM;QAEZ,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,+CAA+C;YAC/D;YACA,MAAM;QACR;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,yCAAyC;gBAAE;YAAU;QACnE;IACF;IAEA,SAAS;IACT,MAAM,UAAU,SAAiB,EAAE,SAAiB,EAAiB;QACnE,MAAM,QAAQ;YACZ,YAAY;YACZ,YAAY;YACZ,YAAY,IAAI,OAAO,WAAW;QACpC;QAEA,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CAClC,IAAI,CAAC,UACL,MAAM,CAAC;YAAC;SAAM;QAEjB,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,2CAA2C;YAC3D;YACA,MAAM;QACR;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,qCAAqC;gBAAE;gBAAW;YAAU;QAC1E;IACF;IAEA,MAAM,YAAY,SAAiB,EAAE,SAAiB,EAAiB;QACrE,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CAClC,IAAI,CAAC,UACL,MAAM,GACN,KAAK,CAAC;YAAE,YAAY;YAAW,YAAY;QAAU;QAExD,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,6CAA6C;YAC7D;YACA,MAAM;QACR;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,uCAAuC;gBAAE;gBAAW;YAAU;QAC5E;IACF;IAEA,MAAM,UAAU,SAAiB,EAAE,SAAiB,EAAoB;QACtE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACxC,IAAI,CAAC,UACL,MAAM,CAAC,MACP,KAAK,CAAC;YAAE,YAAY;YAAW,YAAY;QAAU,GACrD,MAAM;QAET,IAAI,SAAS,MAAM,IAAI,KAAK,YAAY;YACtC,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,2CAA2C;YAC3D;YACA,OAAO;QACT;QAEA,MAAM,YAAY,CAAC,CAAC;QACpB,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,qCAAqC;gBAAE;gBAAW;gBAAW;YAAU;QACrF;QACA,OAAO;IACT;IAEA,UAAU;IACV,MAAM,WAAW,UAAkB,EAAE,cAAsB,EAAE,MAAc,EAAmB;QAC5F,MAAM,YAAY;YAChB,IAAI,OAAO,UAAU;YACrB,aAAa;YACb,kBAAkB;YAClB;YACA,YAAY,IAAI,OAAO,WAAW;QACpC;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACxC,IAAI,CAAC,WACL,MAAM,CAAC;YAAC;SAAU,EAClB,MAAM,GACN,MAAM;QAET,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,4CAA4C;YAC5D;YACA,MAAM;QACR;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,sCAAsC;gBAAE;gBAAY;gBAAgB;YAAO;QACzF;QACA,OAAO;IACT;IAEA,MAAM,cAAc,UAAkB,EAAE,SAAiB,EAAE,MAAc,EAAmB;QAC1F,MAAM,YAAY;YAChB,IAAI,OAAO,UAAU;YACrB,aAAa;YACb,YAAY;YACZ;YACA,YAAY,IAAI,OAAO,WAAW;QACpC;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACxC,IAAI,CAAC,WACL,MAAM,CAAC;YAAC;SAAU,EAClB,MAAM,GACN,MAAM;QAET,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,+CAA+C;YAC/D;YACA,MAAM;QACR;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,yCAAyC;gBAAE;gBAAY;gBAAW;YAAO;QACvF;QACA,OAAO;IACT;IAEA,sDAAsD;IACtD,gBAAgB,cAAsB,EAAE,MAAc,EAAE,QAAiB,EAAQ;QAC/E,sEAAsE;QACtE,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,2CAA2C;gBAAE;gBAAgB;gBAAQ;YAAS;QAC5F;IACF;IAEA,MAAM,eAAe,cAAsB,EAAqB;QAC9D,kFAAkF;QAClF,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,0CAA0C;gBAAE;YAAe;QACzE;QACA,OAAO,EAAE;IACX;IAEA,gBAAgB;IAChB,MAAM,WAAW,cAAsB,EAAE,MAAc,EAAE,UAAkB,EAAiB;QAC1F,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CAClC,IAAI,CAAC,wBACL,MAAM,CAAC;YAAE,cAAc;QAAW,GAClC,KAAK,CAAC;YAAE,iBAAiB;YAAgB,SAAS;QAAO;QAE5D,IAAI,OAAO;YACT,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,4CAA4C;YAC5D;YACA,MAAM;QACR;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,sCAAsC;gBAAE;gBAAgB;gBAAQ;YAAW;QACzF;IACF;IAEA,MAAM,eAAe,cAAsB,EAAE,MAAc,EAAmB;QAC5E,4DAA4D;QAC5D,MAAM,EAAE,MAAM,MAAM,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CAC7D,IAAI,CAAC,wBACL,MAAM,CAAC,gBACP,KAAK,CAAC;YAAE,iBAAiB;YAAgB,SAAS;QAAO,GACzD,MAAM;QAET,IAAI,aAAa;YACf,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,+DAA+D;YAC/E;YACA,OAAO;QACT;QAEA,MAAM,aAAa,QAAQ,eAAe,IAAI,KAAK,OAAO,YAAY,IAAI,IAAI,KAAK;QAEnF,0DAA0D;QAC1D,MAAM,EAAE,KAAK,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,IAAI,CAAC,QAAQ,CACrD,IAAI,CAAC,YACL,MAAM,CAAC,KAAK;YAAE,OAAO;YAAS,MAAM;QAAK,GACzC,EAAE,CAAC,mBAAmB,gBACtB,EAAE,CAAC,cAAc,WAAW,WAAW,IACvC,GAAG,CAAC,aAAa,QAAQ,qCAAqC;SAC9D,EAAE,CAAC,cAAc;QAEpB,IAAI,YAAY;YACd,IAAI,IAAI,CAAC,eAAe,EAAE;gBACxB,QAAQ,KAAK,CAAC,8DAA8D;YAC9E;YACA,OAAO;QACT;QAEA,IAAI,IAAI,CAAC,eAAe,EAAE;YACxB,QAAQ,GAAG,CAAC,0CAA0C;gBAAE;gBAAgB;gBAAQ,aAAa;YAAM;QACrG;QACA,OAAO,SAAS;IAClB;AACF"}},
    {"offset": {"line": 1161, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/community/db/index.ts"],"sourcesContent":["import { LocalDB } from './LocalDB';\r\nimport { SupabaseDB } from './SupabaseDB';\r\nimport { Profile, FriendRequest, Friend, Conversation, ConversationMember, Message, Block, Report, CommunityDB } from './types';\r\n\r\n// Ensure the classes are imported before being used in the factory function\r\nexport { LocalDB, SupabaseDB };\r\nexport type { Profile, FriendRequest, Friend, Conversation, ConversationMember, Message, Block, Report, CommunityDB };\r\n\r\nlet dbInstance: CommunityDB | null = null;\r\n\r\nexport const getCommunityDB = async (): Promise<CommunityDB> => {\r\n  if (dbInstance) {\r\n    return dbInstance;\r\n  }\r\n\r\n  const DEBUG_COMMUNITY = process.env.DEBUG_COMMUNITY === 'true';\r\n  \r\n  // Check if Supabase is available\r\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\r\n  \r\n  if (supabaseUrl) {\r\n    try {\r\n      const response = await fetch(`${supabaseUrl}/auth/v1/health`);\r\n      if (response.ok) {\r\n        if (DEBUG_COMMUNITY) {\r\n          console.log('[COMMUNITY] Using SupabaseDB backend');\r\n        }\r\n        dbInstance = new SupabaseDB();\r\n        return dbInstance as CommunityDB;\r\n      }\r\n    } catch (error) {\r\n      if (DEBUG_COMMUNITY) {\r\n        console.log('[COMMUNITY] Supabase not reachable, using LocalDB backend');\r\n      }\r\n    }\r\n  }\r\n  \r\n  if (DEBUG_COMMUNITY) {\r\n    console.log('[COMMUNITY] Using LocalDB backend');\r\n  }\r\n  dbInstance = new LocalDB();\r\n  return dbInstance!;\r\n};"],"names":[],"mappings":";;;;AAe0B;AAf1B;AACA;;;;AAOA,IAAI,aAAiC;AAE9B,MAAM,iBAAiB;IAC5B,IAAI,YAAY;QACd,OAAO;IACT;IAEA,MAAM,kBAAkB,2KAAO,CAAC,GAAG,CAAC,eAAe,KAAK;IAExD,iCAAiC;IACjC,MAAM;IAEN,wCAAiB;QACf,IAAI;YACF,MAAM,WAAW,MAAM,MAAM,GAAG,YAAY,eAAe,CAAC;YAC5D,IAAI,SAAS,EAAE,EAAE;gBACf,IAAI,iBAAiB;oBACnB,QAAQ,GAAG,CAAC;gBACd;gBACA,aAAa,IAAI,qJAAU;gBAC3B,OAAO;YACT;QACF,EAAE,OAAO,OAAO;YACd,IAAI,iBAAiB;gBACnB,QAAQ,GAAG,CAAC;YACd;QACF;IACF;IAEA,IAAI,iBAAiB;QACnB,QAAQ,GAAG,CAAC;IACd;IACA,aAAa,IAAI,+IAAO;IACxB,OAAO;AACT"}},
    {"offset": {"line": 1208, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/ROY0016/.qoder/VibeSchool/vibe-school/src/app/community/debug/page.tsx"],"sourcesContent":["'use client';\r\n\r\nimport React, { useState, useEffect } from 'react';\r\nimport { useAuthStore } from '@/context/AuthContext';\r\nimport { getCommunityDB } from '@/community/db';\r\n\r\nconst CommunityDebugPage = () => {\r\n  const { state } = useAuthStore();\r\n  const user = state.user;\r\n  const [debugInfo, setDebugInfo] = useState<any>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    const getDebugInfo = async () => {\r\n      try {\r\n        const db = await getCommunityDB();\r\n        \r\n        // Get basic debug info\r\n        const info: any = {\r\n          dbMode: db.constructor.name,\r\n          currentUserId: user?.id || null,\r\n          timestamp: new Date().toISOString(),\r\n          envVars: {\r\n            supabaseUrl: process.env.NEXT_PUBLIC_SUPABASE_URL ? 'SET' : 'NOT SET',\r\n            debugCommunity: process.env.DEBUG_COMMUNITY,\r\n          }\r\n        };\r\n\r\n        // If it's a local DB, get additional stats\r\n        if (db.constructor.name === 'LocalDB') {\r\n          // Note: This is just mock data since we can't access the private fields directly\r\n          info.localStats = {\r\n            profilesCount: 'N/A - Internal access',\r\n            conversationsCount: 'N/A - Internal access',\r\n            messagesCount: 'N/A - Internal access',\r\n          };\r\n        }\r\n\r\n        setDebugInfo(info);\r\n        setLoading(false);\r\n      } catch (err) {\r\n        console.error('[COMMUNITY][DEBUG] Error getting debug info:', err);\r\n        setError('Failed to get debug info: ' + (err as Error).message);\r\n        setLoading(false);\r\n      }\r\n    };\r\n\r\n    if (user) {\r\n      getDebugInfo();\r\n    }\r\n  }, [user]);\r\n\r\n  if (typeof window !== 'undefined' && process.env.NODE_ENV !== 'development') {\r\n    return (\r\n      <div className=\"min-h-screen bg-gray-900 text-white flex items-center justify-center\">\r\n        <div className=\"text-center\">\r\n          <h2 className=\"text-2xl font-bold text-red-400 mb-4\">Access Denied</h2>\r\n          <p className=\"text-gray-300\">Debug page only available in development mode</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gray-900 text-white p-8\">\r\n        <div className=\"max-w-4xl mx-auto\">\r\n          <h1 className=\"text-3xl font-bold mb-8 text-accent-primary\">Community Debug</h1>\r\n          <div className=\"animate-pulse\">\r\n            <div className=\"h-8 bg-gray-700 rounded w-1/4 mb-6\"></div>\r\n            <div className=\"space-y-4\">\r\n              <div className=\"h-4 bg-gray-700 rounded\"></div>\r\n              <div className=\"h-4 bg-gray-700 rounded w-5/6\"></div>\r\n              <div className=\"h-4 bg-gray-700 rounded w-4/6\"></div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <div className=\"min-h-screen bg-gray-900 text-white p-8\">\r\n        <div className=\"max-w-4xl mx-auto\">\r\n          <h1 className=\"text-3xl font-bold mb-8 text-accent-primary\">Community Debug</h1>\r\n          <div className=\"bg-red-900/30 border border-red-700 rounded-lg p-4 text-red-300\">\r\n            {error}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-gray-900 text-white p-8\">\r\n      <div className=\"max-w-4xl mx-auto\">\r\n        <h1 className=\"text-3xl font-bold mb-8 text-accent-primary\">Community Debug</h1>\r\n        \r\n        <div className=\"space-y-6\">\r\n          <div className=\"bg-gray-800/50 rounded-lg p-6 border border-gray-700\">\r\n            <h2 className=\"text-xl font-semibold mb-4 text-accent-primary\">System Info</h2>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n              <div>\r\n                <h3 className=\"font-medium text-gray-400\">Database Mode</h3>\r\n                <p className=\"text-white\">{debugInfo?.dbMode}</p>\r\n              </div>\r\n              <div>\r\n                <h3 className=\"font-medium text-gray-400\">Current User ID</h3>\r\n                <p className=\"text-white\">{debugInfo?.currentUserId || 'None'}</p>\r\n              </div>\r\n              <div>\r\n                <h3 className=\"font-medium text-gray-400\">Timestamp</h3>\r\n                <p className=\"text-white\">{debugInfo?.timestamp}</p>\r\n              </div>\r\n              <div>\r\n                <h3 className=\"font-medium text-gray-400\">Debug Enabled</h3>\r\n                <p className=\"text-white\">{debugInfo?.envVars.debugCommunity || 'false'}</p>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          <div className=\"bg-gray-800/50 rounded-lg p-6 border border-gray-700\">\r\n            <h2 className=\"text-xl font-semibold mb-4 text-accent-primary\">Environment Variables</h2>\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex justify-between\">\r\n                <span className=\"text-gray-400\">NEXT_PUBLIC_SUPABASE_URL</span>\r\n                <span className=\"text-white\">{debugInfo?.envVars.supabaseUrl}</span>\r\n              </div>\r\n              <div className=\"flex justify-between\">\r\n                <span className=\"text-gray-400\">DEBUG_COMMUNITY</span>\r\n                <span className=\"text-white\">{debugInfo?.envVars.debugCommunity || 'false'}</span>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {debugInfo?.localStats && (\r\n            <div className=\"bg-gray-800/50 rounded-lg p-6 border border-gray-700\">\r\n              <h2 className=\"text-xl font-semibold mb-4 text-accent-primary\">Local DB Stats</h2>\r\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                <div>\r\n                  <h3 className=\"font-medium text-gray-400\">Profiles</h3>\r\n                  <p className=\"text-white\">{debugInfo.localStats.profilesCount}</p>\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"font-medium text-gray-400\">Conversations</h3>\r\n                  <p className=\"text-white\">{debugInfo.localStats.conversationsCount}</p>\r\n                </div>\r\n                <div>\r\n                  <h3 className=\"font-medium text-gray-400\">Messages</h3>\r\n                  <p className=\"text-white\">{debugInfo.localStats.messagesCount}</p>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          )}\r\n\r\n          <div className=\"bg-gray-800/50 rounded-lg p-6 border border-gray-700\">\r\n            <h2 className=\"text-xl font-semibold mb-4 text-accent-primary\">Actions</h2>\r\n            <div className=\"flex flex-wrap gap-4\">\r\n              <button \r\n                onClick={() => window.location.reload()}\r\n                className=\"px-4 py-2 bg-accent-primary text-white rounded-lg hover:bg-accent-primary/90 border border-accent-primary\"\r\n              >\r\n                Refresh Debug Info\r\n              </button>\r\n              <button \r\n                onClick={() => console.log('[COMMUNITY] Manual debug log')}\r\n                className=\"px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600\"\r\n              >\r\n                Trigger Debug Log\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default CommunityDebugPage;"],"names":[],"mappings":"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"}}]
}