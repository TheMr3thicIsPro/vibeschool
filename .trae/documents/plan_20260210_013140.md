# Implementation Plan: Friend Request System (Supabase)

This plan transitions the current local/hybrid friend system to a robust Supabase-backed implementation, strictly following your schema and RLS requirements.

## 1. Database Migration (SQL)

**Action:** You will need to run a SQL script in your Supabase SQL Editor.
**Details:**

* Create `friend_requests` table with `sender_id`, `receiver_id`, and constraints.

* Create `friends` table with mutual relationship rules.

* Enable Row Level Security (RLS) on both tables.

* Add strict RLS policies as defined in your prompt.

## 2. Type Definitions Update

**File:** `src/community/db/types.ts`
**Changes:**

* Update `FriendRequest` interface: Rename `requester_id` → `sender_id`, `addressee_id` → `receiver_id`.

* Update `Friend` interface to ensure alignment with the schema.

## 3. Backend Implementation (SupabaseDB)

**File:** `src/community/db/SupabaseDB.ts`
**Changes:**

* **Search:** Implement `searchProfiles` with post-filtering to exclude:

  * Current user

  * Existing friends

  * Users with pending requests (incoming or outgoing)

* **Friend Requests:** Update `createFriendRequest`, `updateFriendRequest`, `getFriendRequests` to use `sender_id`/`receiver_id` and handle RLS.

* **Friends List:** Update `getFriends` to join the `profiles` table and return full user details (avatar, username, status).

## 4. API Routes Update

**Files:** `src/app/api/friends/requests/route.ts` & `[id]/route.ts`
**Changes:**

* Update `POST` route to validate against `sender_id`/`receiver_id`.

* Update `GET` route to correctly map incoming/outgoing requests using the new schema.

* Update `PUT` route (accept/reject) to handle the status update and mutual friend insertion transactionally.

## 5. UI Logic Refinement

**File:** `src/app/community/discover.tsx`
**Changes:**

* Enforce minimum 2-character limit before searching.

* Ensure the "Add Friend" button logic matches the new API response structure.

* Add debug logging as requested (`[SEARCH]`, `[FRIEND REQUEST]`).

## 6. Verification

* **Search:** Verify searching "test" excludes self and existing friends.

* **Request:** Verify sending a request creates a `pending` row in Supabase.

* **Accept:** Verify accepting creates two rows in `friends` table.

* **RLS:** Confirm users cannot see requests they are not involved in.

<br />

some backend data might be implemented so always double check you arent adding things that have already been added

